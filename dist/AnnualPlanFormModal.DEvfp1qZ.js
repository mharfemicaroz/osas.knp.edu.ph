import{c as b,u as B,r as k,o as q,x as E,a as r,d as _,q as u,e,t as i,k as y,h as c,C as S,F as w,B as V,j as f,v as m,M as L}from"./index.B2BJlPrj.js";import{u as z}from"./annualPlan.ClXQPjyh.js";const J={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},G={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},H={class:"flex items-center justify-between mb-3"},K={class:"flex items-center gap-3"},Q={class:"text-lg font-semibold"},W={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},X={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},Z={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},ee=["disabled"],te=["value"],le={key:0,class:"text-[11px] text-red-600 mt-1"},se=["disabled"],ae=["value"],oe={key:0,class:"text-[11px] text-red-600 mt-1"},de=["disabled"],ne={class:"mt-4"},re={class:"flex items-center justify-between"},ue=["disabled"],ie={key:0,class:"text-[12px] text-red-600 mb-1"},ce={class:"mt-1 border rounded overflow-hidden"},pe={class:"w-full text-xs"},me={class:"p-2"},be=["onUpdate:modelValue","disabled"],_e={class:"p-2"},ve=["onUpdate:modelValue","disabled"],ye={class:"p-2"},xe=["onUpdate:modelValue","disabled"],fe={class:"p-2"},he=["onUpdate:modelValue","disabled"],ge={class:"p-2"},ke=["onUpdate:modelValue","disabled"],we={class:"p-2"},Ve=["onUpdate:modelValue","disabled"],Ce={class:"p-2 text-right"},Ae=["disabled","onClick"],Se={class:"mt-2 text-right text-sm"},Ye={class:"flex justify-end gap-2 mt-5"},$e={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},lockedClubId:{type:[String,Number],default:""},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(C,{emit:Y}){const p=C,A=Y,h=b({get:()=>p.modelValue,set:s=>A("update:modelValue",s)}),g=B();z();const U=b(()=>{const s=new Date().getFullYear();return Array.from({length:6},(t,l)=>`${s-l}-${s-l+1}`)}),x=k([]),N=async()=>{try{const{data:s}=await L.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});x.value=Array.isArray(s?.data)?s.data:[]}catch{x.value=[]}};q(async()=>{await N(),p.lockedClubId&&(a.value.club_id=Number(p.lockedClubId))});const a=k(structuredClone(p.initial)),d=k({});E(()=>p.initial,s=>{let t=s?.plans;try{t=Array.isArray(t)?t:JSON.parse(t||"[]")}catch{t=[]}a.value={...s,filed_by_user_id:s?.filed_by_user_id||g.user?.id||"",plans:Array.isArray(t)?t:[]},d.value={}},{immediate:!0});const o=b(()=>p.mode==="edit"&&String(a.value.status||"").toLowerCase()!=="draft"),$=b(()=>p.mode!=="edit"?"New Annual Plan":o.value?"View Annual Plan (read-only)":"Edit Annual Plan"),I=b(()=>p.mode==="edit"?"Save Changes":"Create"),D=s=>Number(s||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),F=s=>Number.isFinite(+s)?+s:0,M=b(()=>Array.isArray(a.value.plans)?a.value.plans.reduce((s,t)=>s+F(t?.funds),0):0),P=()=>{Array.isArray(a.value.plans)||(a.value.plans=[]),a.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},R=s=>{a.value.plans.splice(s,1)},j=/^\d{4}-\d{4}$/,O=()=>{if(o.value)return!1;const s={};return(!a.value.school_year||!j.test(a.value.school_year))&&(s.school_year="Format: YYYY-YYYY"),a.value.club_id||(s.club_id="Required"),(!Array.isArray(a.value.plans)||!a.value.plans.length)&&(s.plans="Add at least one plan item"(a.value.plans||[]).forEach((t,l)=>{t.item||(s[`plans_${l}_item`]="Required"),t.date_of_implementation||(s[`plans_${l}_date`]="Required"),t.funds!=null&&Number(t.funds)<0&&(s[`plans_${l}_funds`]="Must be ≥ 0")})),d.value=s,Object.keys(s).length===0},T=()=>{if(o.value||!O())return;const s={...a.value};!s.filed_by_user_id&&g.user?.id&&(s.filed_by_user_id=g.user.id),A("submit",s)};return(s,t)=>h.value?(u(),r("div",J,[e("div",G,[e("div",H,[e("div",K,[e("h2",Q,i($.value),1),e("span",W,i(a.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:t[0]||(t[0]=l=>h.value=!1)},"Close")]),o.value?(u(),r("div",X,[t[5]||(t[5]=y(" This plan is ",-1)),e("strong",null,i(a.value.status),1),t[6]||(t[6]=y(". Editing is disabled. ",-1))])):_("",!0),e("div",Z,[e("div",null,[t[8]||(t[8]=e("label",{class:"block mb-1"},[y("School Year "),e("span",{class:"text-red-500"},"*")],-1)),c(e("select",{"onUpdate:modelValue":t[1]||(t[1]=l=>a.value.school_year=l),class:"w-full border rounded px-2.5 py-2",disabled:o.value},[t[7]||(t[7]=e("option",{value:""},"Select school year…",-1)),(u(!0),r(w,null,V(U.value,l=>(u(),r("option",{key:l,value:l},i(l),9,te))),128))],8,ee),[[S,a.value.school_year]]),d.value.school_year?(u(),r("p",le,i(d.value.school_year),1)):_("",!0)]),e("div",null,[t[10]||(t[10]=e("label",{class:"block mb-1"},[y("Club "),e("span",{class:"text-red-500"},"*")],-1)),c(e("select",{"onUpdate:modelValue":t[2]||(t[2]=l=>a.value.club_id=l),class:f(["w-full border rounded px-2.5 py-2",d.value.club_id?"border-red-500":""]),disabled:o.value||!x.value.length||!!C.lockedClubId},[t[9]||(t[9]=e("option",{value:""},"Select club…",-1)),(u(!0),r(w,null,V(x.value,l=>(u(),r("option",{key:l.id,value:l.id},i(l.name)+" ("+i(l.code)+") ",9,ae))),128))],10,se),[[S,a.value.club_id]]),d.value.club_id?(u(),r("p",oe,i(d.value.club_id),1)):_("",!0)]),e("div",null,[t[11]||(t[11]=e("label",{class:"block mb-1"},"Remarks",-1)),c(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>a.value.remarks=l),class:"w-full border rounded px-2.5 py-2",disabled:o.value,placeholder:"Optional remarks"},null,8,de),[[m,a.value.remarks]])])]),e("div",ne,[e("div",re,[t[12]||(t[12]=e("label",{class:"block mb-1 font-medium"},[y("Plan Items "),e("span",{class:"text-red-500"},"*")],-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:o.value,onClick:P},"Add Item",8,ue)]),d.value.plans?(u(),r("p",ie,i(d.value.plans),1)):_("",!0),e("div",ce,[e("table",pe,[t[13]||(t[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Description"),e("th",{class:"text-left p-2"},"Date of Implementation"),e("th",{class:"text-left p-2"},"Funds"),e("th",{class:"text-left p-2"},"Venue"),e("th",{class:"text-left p-2"},"Notes"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(u(!0),r(w,null,V(a.value.plans,(l,v)=>(u(),r("tr",{key:v,class:"border-t"},[e("td",me,[c(e("input",{"onUpdate:modelValue":n=>l.item=n,class:f(["w-40 border rounded px-2 py-1",d.value[`plans_${v}_item`]?"border-red-500":""]),disabled:o.value,placeholder:"Item name"},null,10,be),[[m,l.item]])]),e("td",_e,[c(e("input",{"onUpdate:modelValue":n=>l.description=n,class:"w-60 border rounded px-2 py-1",disabled:o.value,placeholder:"Short description"},null,8,ve),[[m,l.description]])]),e("td",ye,[c(e("input",{type:"date","onUpdate:modelValue":n=>l.date_of_implementation=n,class:f(["border rounded px-2 py-1",d.value[`plans_${v}_date`]?"border-red-500":""]),disabled:o.value,placeholder:"YYYY-MM-DD"},null,10,xe),[[m,l.date_of_implementation]])]),e("td",fe,[c(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":n=>l.funds=n,class:f(["w-28 border rounded px-2 py-1",d.value[`plans_${v}_funds`]?"border-red-500":""]),disabled:o.value,placeholder:"0.00"},null,10,he),[[m,l.funds,void 0,{number:!0}]])]),e("td",ge,[c(e("input",{"onUpdate:modelValue":n=>l.venue=n,class:"w-40 border rounded px-2 py-1",disabled:o.value,placeholder:"Venue / location"},null,8,ke),[[m,l.venue]])]),e("td",we,[c(e("input",{"onUpdate:modelValue":n=>l.notes=n,class:"w-52 border rounded px-2 py-1",disabled:o.value,placeholder:"Notes (optional)"},null,8,Ve),[[m,l.notes]])]),e("td",Ce,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:o.value,onClick:n=>R(v)},"Remove",8,Ae)])]))),128))])])]),e("div",Se,[t[14]||(t[14]=e("span",{class:"mr-4"},"Client total (preview):",-1)),e("strong",null,i(D(M.value)),1),t[15]||(t[15]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),e("div",Ye,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[4]||(t[4]=l=>h.value=!1)},"Close"),o.value?_("",!0):(u(),r("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:T},i(I.value),1))])])])):_("",!0)}};export{$e as _};
