import{c as k,r as B,o as ee,G as ve,a as u,q as i,f as P,A as G,d as x,e,g as _,u as ce,E as se,t as g,k as D,h as R,C as Z,F as q,B as J,j as K,v as W,M as me,S as V,l as N,O as fe}from"./index.DPBVxXpV.js";import{u as be,v as ye,Z as xe,y as ge,$ as he,a0 as we,a1 as _e,z as pe,A as $e,B as Ce,E as ke,F as Ae,G as Se,H as Ve,I as Be,C as je,D as Fe,_ as Pe,a as Re,g as Ee,J as Ue,i as De,K as Te,N as Ie,O as Le,Y as ze}from"./SectionMain.zWpJ8iur.js";import{_ as Me,a as Oe,b as de,B as Ne,c as Ye}from"./Badge.uALBx_aa.js";import{_ as Y}from"./IconifyButton.weeUsbLu.js";import{u as oe}from"./annualPlan.CvBMbhg9.js";import{t as We,u as qe,v as Ge,F as Je}from"./index.zM4ynjFZ.js";import"./ToasterComponent.CYegXfee.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";const Ke={class:"flex items-center gap-1 md:gap-2"},Xe=["aria-expanded"],Qe={style:{width:"18px",height:"18px"},viewBox:"0 0 24 24"},He=["d"],Ze={__name:"AnnualPlanRowActions",props:{row:{type:Object,required:!0},moderator:{type:Boolean,default:!1}},emits:["attachments","submit","approve","reject","edit","delete","view","cancel"],setup(h,{emit:v}){const $=h,A=k(()=>String($.row?.status||"").toLowerCase()),j=k(()=>A.value==="draft"),C=k(()=>A.value==="draft"),y=k(()=>A.value!=="draft"),S=k(()=>$.moderator&&A.value==="pending"),T=k(()=>A.value==="approved"),r=B(!1),f=B(null),m=B(null),w=d=>{if(!r.value)return;const s=f.value,b=m.value;s&&!s.contains(d.target)&&b&&!b.contains(d.target)&&(r.value=!1)};return ee(()=>document.addEventListener("click",w)),ve(()=>document.removeEventListener("click",w)),(d,s)=>(i(),u("div",Ke,[P(Y,{"icon-path":_(be),color:"text-indigo-600",label:"Attachments",tooltip:"Attachments",size:"sm",onClick:s[0]||(s[0]=b=>d.$emit("attachments",h.row))},null,8,["icon-path"]),y.value?(i(),G(Y,{key:0,"icon-path":_(ye),color:"text-gray-700",label:"View",tooltip:"View (read-only)",size:"sm",onClick:s[1]||(s[1]=b=>d.$emit("view",h.row))},null,8,["icon-path"])):x("",!0),j.value?(i(),G(Y,{key:1,"icon-path":_(xe),color:"text-blue-600",label:"Submit",tooltip:"Submit",size:"sm",onClick:s[2]||(s[2]=b=>d.$emit("submit",h.row))},null,8,["icon-path"])):x("",!0),C.value?(i(),G(Y,{key:2,"icon-path":_(ge),color:"text-amber-600",label:"Edit",tooltip:"Edit",size:"sm",onClick:s[3]||(s[3]=b=>d.$emit("edit",h.row))},null,8,["icon-path"])):x("",!0),S.value?(i(),G(Y,{key:3,"icon-path":_(he),color:"text-emerald-600",label:"Approve",tooltip:"Approve",size:"sm",onClick:s[4]||(s[4]=b=>d.$emit("approve",h.row))},null,8,["icon-path"])):x("",!0),S.value?(i(),G(Y,{key:4,"icon-path":_(we),color:"text-rose-600",label:"Reject",tooltip:"Reject",size:"sm",onClick:s[5]||(s[5]=b=>d.$emit("reject",h.row))},null,8,["icon-path"])):x("",!0),T.value?(i(),G(Y,{key:5,"icon-path":_(_e),color:"text-orange-600",label:"Cancel",tooltip:"Cancel plan",size:"sm",onClick:s[6]||(s[6]=b=>d.$emit("cancel",h.row))},null,8,["icon-path"])):x("",!0),P(Y,{"icon-path":_(pe),color:"text-red-600",label:"Delete",tooltip:"Delete",size:"sm",onClick:s[7]||(s[7]=b=>d.$emit("delete",h.row))},null,8,["icon-path"]),e("div",{class:"relative md:hidden",ref_key:"btnRef",ref:m},[e("button",{class:"inline-flex items-center justify-center rounded-xl p-1.5 hover:bg-gray-100","aria-expanded":r.value,"aria-haspopup":"menu",title:"More",onClick:s[8]||(s[8]=b=>r.value=!r.value)},[(i(),u("svg",Qe,[e("path",{d:_($e)},null,8,He)]))],8,Xe),r.value?(i(),u("div",{key:0,ref_key:"menuRef",ref:f,role:"menu",class:"absolute right-0 z-20 mt-1 w-44 overflow-hidden rounded-xl border bg-white shadow-lg"},[e("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[9]||(s[9]=b=>{r.value=!1,d.$emit("attachments",h.row)})},"Attachments"),y.value?(i(),u("button",{key:0,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[10]||(s[10]=b=>{r.value=!1,d.$emit("view",h.row)})},"View (read-only)")):x("",!0),j.value?(i(),u("button",{key:1,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[11]||(s[11]=b=>{r.value=!1,d.$emit("submit",h.row)})},"Submit")):x("",!0),C.value?(i(),u("button",{key:2,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[12]||(s[12]=b=>{r.value=!1,d.$emit("edit",h.row)})},"Edit")):x("",!0),S.value?(i(),u("button",{key:3,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[13]||(s[13]=b=>{r.value=!1,d.$emit("approve",h.row)})},"Approve")):x("",!0),S.value?(i(),u("button",{key:4,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-rose-600 hover:bg-rose-50",onClick:s[14]||(s[14]=b=>{r.value=!1,d.$emit("reject",h.row)})},"Reject")):x("",!0),T.value?(i(),u("button",{key:5,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[15]||(s[15]=b=>{r.value=!1,d.$emit("cancel",h.row)})},"Cancel")):x("",!0),e("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50",onClick:s[16]||(s[16]=b=>{r.value=!1,d.$emit("delete",h.row)})},"Delete")],512)):x("",!0)],512)]))}},et={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},tt={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},at={class:"flex items-center justify-between mb-3"},lt={class:"flex items-center gap-3"},nt={class:"text-lg font-semibold"},st={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},ot={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},it={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},rt=["disabled"],dt=["value"],ut={key:0,class:"text-[11px] text-red-600 mt-1"},ct=["disabled"],mt=["value"],pt={key:0,class:"text-[11px] text-red-600 mt-1"},vt=["disabled"],ft={class:"mt-4"},bt={class:"flex items-center justify-between"},yt=["disabled"],xt={key:0,class:"text-[12px] text-red-600 mb-1"},gt={class:"mt-1 border rounded overflow-hidden"},ht={class:"w-full text-xs"},wt={class:"p-2"},_t=["onUpdate:modelValue","disabled"],$t={class:"p-2"},Ct=["onUpdate:modelValue","disabled"],kt={class:"p-2"},At=["onUpdate:modelValue","disabled"],St={class:"p-2"},Vt=["onUpdate:modelValue","disabled"],Bt={class:"p-2"},jt=["onUpdate:modelValue","disabled"],Ft={class:"p-2"},Pt=["onUpdate:modelValue","disabled"],Rt={class:"p-2 text-right"},Et=["disabled","onClick"],Ut={class:"mt-2 text-right text-sm"},Dt={class:"flex justify-end gap-2 mt-5"},ue={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(h,{emit:v}){const $=h,A=v,j=k({get:()=>$.modelValue,set:p=>A("update:modelValue",p)}),C=ce();oe();const y=k(()=>{const p=new Date().getFullYear();return Array.from({length:6},(o,c)=>`${p-c}-${p-c+1}`)}),S=B([]);ee(async()=>{try{const{data:p}=await me.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});S.value=Array.isArray(p?.data)?p.data:[]}catch{S.value=[]}});const r=B(structuredClone($.initial)),f=B({});se(()=>$.initial,p=>{let o=p?.plans;try{o=Array.isArray(o)?o:JSON.parse(o||"[]")}catch{o=[]}r.value={...p,filed_by_user_id:p?.filed_by_user_id||C.user?.id||"",plans:Array.isArray(o)?o:[]},f.value={}},{immediate:!0});const m=k(()=>$.mode==="edit"&&String(r.value.status||"").toLowerCase()!=="draft"),w=k(()=>$.mode!=="edit"?"New Annual Plan":m.value?"View Annual Plan (read-only)":"Edit Annual Plan"),d=k(()=>$.mode==="edit"?"Save Changes":"Create"),s=p=>Number(p||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),b=p=>Number.isFinite(+p)?+p:0,L=k(()=>Array.isArray(r.value.plans)?r.value.plans.reduce((p,o)=>p+b(o?.funds),0):0),z=()=>{Array.isArray(r.value.plans)||(r.value.plans=[]),r.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},U=p=>{r.value.plans.splice(p,1)},E=/^\d{4}-\d{4}$/,O=()=>{if(m.value)return!1;const p={};return(!r.value.school_year||!E.test(r.value.school_year))&&(p.school_year="Format: YYYY-YYYY"),r.value.club_id||(p.club_id="Required"),(!Array.isArray(r.value.plans)||!r.value.plans.length)&&(p.plans="Add at least one plan item"(r.value.plans||[]).forEach((o,c)=>{o.item||(p[`plans_${c}_item`]="Required"),o.date_of_implementation||(p[`plans_${c}_date`]="Required"),o.funds!=null&&Number(o.funds)<0&&(p[`plans_${c}_funds`]="Must be ≥ 0")})),f.value=p,Object.keys(p).length===0},X=()=>{if(m.value||!O())return;const p={...r.value};!p.filed_by_user_id&&C.user?.id&&(p.filed_by_user_id=C.user.id),A("submit",p)};return(p,o)=>j.value?(i(),u("div",et,[e("div",tt,[e("div",at,[e("div",lt,[e("h2",nt,g(w.value),1),e("span",st,g(r.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:o[0]||(o[0]=c=>j.value=!1)},"Close")]),m.value?(i(),u("div",ot,[o[5]||(o[5]=D(" This plan is ",-1)),e("strong",null,g(r.value.status),1),o[6]||(o[6]=D(". Editing is disabled. ",-1))])):x("",!0),e("div",it,[e("div",null,[o[8]||(o[8]=e("label",{class:"block mb-1"},[D("School Year "),e("span",{class:"text-red-500"},"*")],-1)),R(e("select",{"onUpdate:modelValue":o[1]||(o[1]=c=>r.value.school_year=c),class:"w-full border rounded px-2.5 py-2",disabled:m.value},[o[7]||(o[7]=e("option",{value:""},"Select school year…",-1)),(i(!0),u(q,null,J(y.value,c=>(i(),u("option",{key:c,value:c},g(c),9,dt))),128))],8,rt),[[Z,r.value.school_year]]),f.value.school_year?(i(),u("p",ut,g(f.value.school_year),1)):x("",!0)]),e("div",null,[o[10]||(o[10]=e("label",{class:"block mb-1"},[D("Club "),e("span",{class:"text-red-500"},"*")],-1)),R(e("select",{"onUpdate:modelValue":o[2]||(o[2]=c=>r.value.club_id=c),class:K(["w-full border rounded px-2.5 py-2",f.value.club_id?"border-red-500":""]),disabled:m.value||!S.value.length},[o[9]||(o[9]=e("option",{value:""},"Select club…",-1)),(i(!0),u(q,null,J(S.value,c=>(i(),u("option",{key:c.id,value:c.id},g(c.name)+" ("+g(c.code)+") ",9,mt))),128))],10,ct),[[Z,r.value.club_id]]),f.value.club_id?(i(),u("p",pt,g(f.value.club_id),1)):x("",!0)]),e("div",null,[o[11]||(o[11]=e("label",{class:"block mb-1"},"Remarks",-1)),R(e("input",{"onUpdate:modelValue":o[3]||(o[3]=c=>r.value.remarks=c),class:"w-full border rounded px-2.5 py-2",disabled:m.value},null,8,vt),[[W,r.value.remarks]])])]),e("div",ft,[e("div",bt,[o[12]||(o[12]=e("label",{class:"block mb-1 font-medium"},[D("Plan Items "),e("span",{class:"text-red-500"},"*")],-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:m.value,onClick:z},"Add Item",8,yt)]),f.value.plans?(i(),u("p",xt,g(f.value.plans),1)):x("",!0),e("div",gt,[e("table",ht,[o[13]||(o[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Description"),e("th",{class:"text-left p-2"},"Date of Implementation"),e("th",{class:"text-left p-2"},"Funds"),e("th",{class:"text-left p-2"},"Venue"),e("th",{class:"text-left p-2"},"Notes"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(i(!0),u(q,null,J(r.value.plans,(c,M)=>(i(),u("tr",{key:M,class:"border-t"},[e("td",wt,[R(e("input",{"onUpdate:modelValue":F=>c.item=F,class:K(["w-40 border rounded px-2 py-1",f.value[`plans_${M}_item`]?"border-red-500":""]),disabled:m.value},null,10,_t),[[W,c.item]])]),e("td",$t,[R(e("input",{"onUpdate:modelValue":F=>c.description=F,class:"w-60 border rounded px-2 py-1",disabled:m.value},null,8,Ct),[[W,c.description]])]),e("td",kt,[R(e("input",{type:"date","onUpdate:modelValue":F=>c.date_of_implementation=F,class:K(["border rounded px-2 py-1",f.value[`plans_${M}_date`]?"border-red-500":""]),disabled:m.value},null,10,At),[[W,c.date_of_implementation]])]),e("td",St,[R(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":F=>c.funds=F,class:K(["w-28 border rounded px-2 py-1",f.value[`plans_${M}_funds`]?"border-red-500":""]),disabled:m.value},null,10,Vt),[[W,c.funds,void 0,{number:!0}]])]),e("td",Bt,[R(e("input",{"onUpdate:modelValue":F=>c.venue=F,class:"w-40 border rounded px-2 py-1",disabled:m.value},null,8,jt),[[W,c.venue]])]),e("td",Ft,[R(e("input",{"onUpdate:modelValue":F=>c.notes=F,class:"w-52 border rounded px-2 py-1",disabled:m.value},null,8,Pt),[[W,c.notes]])]),e("td",Rt,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:m.value,onClick:F=>U(M)},"Remove",8,Et)])]))),128))])])]),e("div",Ut,[o[14]||(o[14]=e("span",{class:"mr-4"},"Client total (preview):",-1)),e("strong",null,g(s(L.value)),1),o[15]||(o[15]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),e("div",Dt,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:o[4]||(o[4]=c=>j.value=!1)},"Close"),m.value?x("",!0):(i(),u("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:X},g(d.value),1))])])])):x("",!0)}},Tt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},It={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},Lt={class:"flex items-center justify-between mb-3"},zt={class:"text-lg font-semibold"},Mt={class:"text-gray-600"},Ot={class:"flex items-center justify-between gap-2"},Nt={class:"text-sm text-gray-600"},Yt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Wt=["d"],qt=["disabled"],Gt={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},Jt={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Kt=["src"],Xt={key:1,class:"flex items-center justify-center w-full h-full"},Qt=["d"],Ht={class:"mt-2 text-xs"},Zt=["title"],ea={class:"text-gray-500 flex items-center justify-between"},ta={key:0},aa={key:0},la={class:"mt-2 flex items-center justify-between gap-2"},na=["onClick","title"],sa={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},oa=["d"],ia=["onClick"],ra={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},da=["d"],ua={key:0,class:"mt-6 text-center text-sm text-gray-500"},ca=10*1024*1024,ma={__name:"AnnualPlanAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(h,{emit:v}){const $=h,A=v,j=k({get:()=>$.modelValue,set:a=>A("update:modelValue",a)}),C=oe(),y=B(null),S=B(!1),T=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),r=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),f=(a="")=>String(a).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",m=(a="")=>typeof a=="string"&&a.match(/^data:([^;]+);base64,/i)?.[1]||"",w=a=>a?.type&&T.has(a.type)||a?.name&&r.has(f(a.name)),d=(a="")=>String(a).startsWith("image/"),s=(a="")=>a==="application/pdf",b=(a="")=>a==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",L=(a="")=>a==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",z=(a="")=>s(a)?ke:b(a)?Ae:L(a)?Se:d(a)?Ve:Be,U=(a="")=>s(a)?"PDF":b(a)?"Word":L(a)?"Excel":d(a)?"Image":"File",E=(a="")=>s(a)?"pdf":b(a)?"docx":L(a)?"xlsx":a==="image/png"?"png":a==="image/jpeg"?"jpg":a==="image/webp"?"webp":"",O=(a="attachment",l="")=>/\.[a-z0-9]+$/i.test(a)?a:l?`${a}.${l.startsWith(".")?l.slice(1):l}`:a,X=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,p=k(()=>{const a=y.value?.attachments;if(!a)return[];try{return Array.isArray(a)?a:JSON.parse(a||"[]")}catch{return[]}}),o=k(()=>(p.value||[]).map((a,l)=>{const t=a.mime||m(a.data)||"",n=f(a.name||"")||E(t),I=a.size??null,H=a.name||`${U(t)} ${l+1}`;return{id:a.id??l+1,name:H,data:a.data||"",url:a.url||a.href||a.path||"",mime:t,ext:n,size:I,filename:O(H,n)}}));se(()=>$.modelValue,async a=>{a&&$.row?.id&&(await C.fetchById($.row.id),y.value=C.selected||$.row)});const c=async a=>{const l=a.target.files?.[0];if(a.target.value="",!(!l||!y.value?.id)){if(l.size>ca){await V.fire("File too large","Maximum size is 10 MB.","warning");return}if(!w(l)){await V.fire("Unsupported file","Only images, PDF, DOCX, XLSX allowed.","warning");return}try{S.value=!0,await C.uploadAttachment(y.value.id,l),await C.fetchById(y.value.id),y.value=C.selected}finally{S.value=!1}}},M=async a=>{!y.value?.id||!(await V.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await C.deleteAttachment(y.value.id,a),await C.fetchById(y.value.id),y.value=C.selected)},F=a=>{if(a.data&&String(a.data).startsWith("data:")&&d(a.mime)){const l=window.open();l&&l.document.write(`<img src="${a.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}a.url&&window.open(String(a.url),"_blank")},ie=a=>{const[l,t]=a.split(","),n=l.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",I=atob(t),H=new Uint8Array(I.length);for(let ne=0;ne<I.length;ne++)H[ne]=I.charCodeAt(ne);return new Blob([H],{type:n})},te=(a,l)=>{const t=URL.createObjectURL(a),n=document.createElement("a");n.href=t,n.download=l||"download",document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>URL.revokeObjectURL(t),1e3)},re=async a=>{if(a.data&&String(a.data).startsWith("data:")){te(ie(a.data),a.filename);return}if(a.url)try{const t=await(await fetch(a.url,{credentials:"include"})).blob();te(t,a.filename)}catch{const l=document.createElement("a");l.href=String(a.url),l.setAttribute("download",a.filename),document.body.appendChild(l),l.click(),l.remove()}},ae=a=>d(a.mime)?"Open":"Download",Q=a=>d(a.mime)?je:Fe,le=a=>d(a.mime)?F(a):re(a);return(a,l)=>j.value?(i(),u("div",Tt,[e("div",It,[e("div",Lt,[e("h2",zt,[l[1]||(l[1]=D(" Annual Plan Attachments — ",-1)),e("span",Mt,g(y.value?.reference_code||""),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:l[0]||(l[0]=t=>j.value=!1)},"Close")]),e("div",Ot,[e("div",Nt,[l[2]||(l[2]=D(" School Year: ",-1)),e("strong",null,g(y.value?.school_year||"—"),1)]),e("label",{class:K(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":S.value}])},[(i(),u("svg",Yt,[e("path",{d:_(Ce)},null,8,Wt)])),e("span",null,g(S.value?"Uploading…":"Upload"),1),e("input",{type:"file",class:"hidden",disabled:S.value,onChange:c,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,qt)],2)]),e("div",Gt,[(i(!0),u(q,null,J(o.value,t=>(i(),u("div",{key:t.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[e("div",Jt,[t.data&&t.data.startsWith("data:")&&t.mime?.startsWith("image/")?(i(),u("img",{key:0,src:t.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Kt)):(i(),u("div",Xt,[(i(),u("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:K({"text-red-600":t.mime==="application/pdf","text-blue-600":t.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":t.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!t.mime||!t.mime.startsWith("image/")&&t.mime!=="application/pdf"})},[e("path",{d:z(t.mime)},null,8,Qt)],2))]))]),e("div",Ht,[e("div",{class:"font-medium truncate",title:t.name},g(t.name),9,Zt),e("div",ea,[e("span",null,[D(g(U(t.mime))+" ",1),t.ext?(i(),u("span",ta,"("+g(t.ext.toUpperCase())+")",1)):x("",!0)]),t.size?(i(),u("span",aa,g(X(t.size)),1)):x("",!0)])]),e("div",la,[e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:n=>le(t),title:ae(t)},[(i(),u("svg",sa,[e("path",{d:Q(t)},null,8,oa)])),D(" "+g(ae(t)),1)],8,na),e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:n=>M(t.id),title:"Remove"},[(i(),u("svg",ra,[e("path",{d:_(pe)},null,8,da)])),l[3]||(l[3]=D(" Remove ",-1))],8,ia)])]))),128))]),o.value.length?x("",!0):(i(),u("div",ua," No attachments yet. "))])])):x("",!0)}},pa={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},va={class:"bg-white rounded-2xl shadow-2xl w-[1200px] max-w-[95vw] max-h-[90vh] overflow-hidden"},fa={class:"px-4 py-3 border-b flex items-center justify-between"},ba={class:"p-3 overflow-auto"},ya={__name:"AnnualPlansCalendarModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(h,{emit:v}){const $=h,A=v,j=k({get:()=>$.modelValue,set:w=>A("update:modelValue",w)}),C=oe(),y=B([]),S=w=>{if(Array.isArray(w))return w;try{return JSON.parse(w||"[]")}catch{return[]}},T=(w=[])=>{const d=[];w.forEach(s=>{const b=S(s.plans),L=s.club?.name?`[${s.club.name}] `:"";b.forEach((z,U)=>{const E=z?.date_of_implementation;if(!E)return;const O=`${L}${z.item||"Planned Activity"}`;d.push({id:`${s.id}-${U}`,title:O,start:`${E}T00:00:00`,end:`${E}T23:59:59`,backgroundColor:"#10b981",borderColor:"#0ea5e9",textColor:"#0b1b13",extendedProps:{annual_plan_id:s.id,reference_code:s.reference_code,school_year:s.school_year,funds:z?.funds??0,status:s.status}})})}),y.value=d},r=async()=>{await C.fetchAll({page:1,limit:500,status:"approved",sort:"created_at",order:"ASC"},!0),T(C.items.data||[])},f=w=>{const d=w?.event?.extendedProps?.annual_plan_id;d&&A("open",Number(d))},m=k(()=>({plugins:[We,qe,Ge],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:f,events:y.value}));return se(()=>$.modelValue,w=>{w&&r()}),se(()=>C.items.data,w=>{j.value&&T(w||[])},{deep:!0}),ee(()=>{j.value&&r()}),(w,d)=>j.value?(i(),u("div",pa,[e("div",va,[e("div",fa,[d[1]||(d[1]=e("h2",{class:"text-base font-semibold"},"Annual Plans Calendar (Approved)",-1)),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=s=>j.value=!1)},"Close")]),e("div",ba,[P(_(Je),{options:m.value},null,8,["options"])]),d[2]||(d[2]=e("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click a plan item to open its Annual Plan. ",-1))])])):x("",!0)}},xa={class:"flex items-center gap-2"},ga={class:"p-3 mb-4 rounded-xl border bg-white/60"},ha={class:"flex items-center gap-2 mb-2 text-gray-700"},wa={class:"w-4 h-4",viewBox:"0 0 24 24"},_a=["d"],$a={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},Ca={class:"md:col-span-2 flex"},ka={class:"w-5 h-5",viewBox:"0 0 24 24"},Aa=["d"],Sa=["value"],Va=["disabled"],Ba=["value"],ja=["value"],Fa={class:"flex items-center gap-2 md:col-span-2"},Pa={class:"font-medium"},Ma={__name:"AnnualPlansPage",setup(h){const v=oe(),$=ce(),A=B(!1),j=()=>{A.value=!0},C=async l=>{try{await v.fetchById(l);const t=v.selected;t&&await o(t)}catch(t){console.error(t)}finally{A.value=!1}},y=B([]);ee(async()=>{try{const{data:l}=await me.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});y.value=Array.isArray(l?.data)?l.data:[]}catch{y.value=[]}});const T=l=>y.value.find(t=>t.id===Number(l))?.name||"—",r=k(()=>{const l=new Date().getFullYear();return Array.from({length:6},(t,n)=>`${l-n}-${l-n+1}`)}),f=B({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:""}),m=async(l={},t=!0)=>{f.value={...f.value,...l};const n={...f.value};["q","status","school_year","club_id","filed_by_user_id","approver_user_id"].forEach(I=>{(n[I]===""||n[I]==null)&&delete n[I]}),await v.fetchAll(n,t)};ee(async()=>{await m({page:1,limit:10})});const w=k(()=>({total:v.items.total||0,totalPages:v.items.totalPages||1,currentPage:v.items.currentPage||1,pageSize:v.items.pageSize||10,data:v.items.data||[]})),d=["draft","pending","approved","rejected","cancelled","archived"],s=l=>{switch(String(l||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"archived":return"slate";default:return"gray"}},b=l=>{const t=Number(l);return Number.isFinite(t)?t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},L=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"school_year",label:"School Year",sortable:!0,width:120},{key:"club",label:"Club",sortable:!1,minWidth:200,formatter:(l,t)=>t.club?.name||T(t.club_id)||""},{key:"total_budget",label:"Total Budget",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:110},{key:"created_at",label:"Created",sortable:!0,width:170}],z=async l=>{await m(l)},U=B(!1),E=B(!1),O=B(null),X=()=>{U.value=!0},p=async l=>{await v.create(l),U.value=!1,await m({},!0)},o=async l=>{await v.fetchById(l.id);const t=v.selected||l;let n=[];try{n=Array.isArray(t.plans)?t.plans:JSON.parse(t.plans||"[]")}catch{}O.value={id:t.id,reference_code:t.reference_code,school_year:t.school_year||"",club_id:t.club_id||"",filed_by_user_id:t.filed_by_user_id||$.user?.id||"",approver_user_id:t.approver_user_id||"",plans:n,remarks:t.remarks||"",status:t.status||"draft"},E.value=!0},c=async l=>{const{id:t,...n}=l;await v.updateById(t,n),E.value=!1,await m({},!0)},M=async l=>{if(!l?.id)return;(await V.fire({title:`Delete annual plan "${l.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await v.deleteById(l.id),await m({},!0),await V.fire("Deleted","The annual plan has been deleted.","success"))},F=async l=>{await o(l)},ie=async l=>{if((await V.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel"})).isConfirmed)try{await v.submit(l.id),await m({},!0),await V.fire("Submitted","Annual plan is now pending approval.","success")}catch{await V.fire("Error",v.error||"Failed to submit.","error")}},te=async l=>{const t=await V.fire({title:"Approve annual plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(t.isConfirmed)try{await v.approve(l.id,t.value||""),await m({},!0),await V.fire("Approved","Annual plan has been approved.","success")}catch{await V.fire("Error",v.error||"Failed to approve.","error")}},re=async l=>{const t=await V.fire({title:"Reject annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(t.isConfirmed)try{await v.reject(l.id,t.value),await m({},!0),await V.fire("Rejected","Annual plan has been rejected.","success")}catch{await V.fire("Error",v.error||"Failed to reject.","error")}},ae=async l=>{const t=await V.fire({title:"Cancel annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Plan",cancelButtonText:"Keep"});if(t.isConfirmed)try{await v.cancel(l.id,t.value),await m({},!0),await V.fire("Cancelled","Annual plan has been cancelled.","success")}catch{await V.fire("Error",v.error||"Failed to cancel.","error")}},Q=B(!1),le=B(null),a=async l=>{await v.fetchById(l.id),le.value=v.selected||l,Q.value=!0};return(l,t)=>(i(),u(q,null,[P(Pe,null,{default:N(()=>[P(Re,null,{default:N(()=>[_(v).error?(i(),G(Me,{key:0,icon:_(Ee),color:"danger"},{default:N(()=>[D(g(_(v).error),1)]),_:1},8,["icon"])):x("",!0),P(Oe,{icon:_(Ue),title:"Annual Plans",main:""},{default:N(()=>[e("div",xa,[P(de,{icon:_(De),color:"info",label:"View Calendar",onClick:j},null,8,["icon"]),P(de,{icon:_(Te),color:"primary",label:"New Annual Plan",onClick:X},null,8,["icon"]),P(de,{icon:_(Ie),color:"info",label:"Refresh",onClick:t[0]||(t[0]=n=>m({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),e("div",ga,[e("div",ha,[(i(),u("svg",wa,[e("path",{d:_(Le)},null,8,_a)])),t[13]||(t[13]=e("span",{class:"font-medium text-sm"},"Filters",-1))]),e("div",$a,[e("div",Ca,[R(e("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>f.value.q=n),placeholder:"Search by ref, school year, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:t[2]||(t[2]=fe(n=>m({page:1}),["enter"]))},null,544),[[W,f.value.q]]),e("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:t[3]||(t[3]=n=>m({page:1}))},[(i(),u("svg",ka,[e("path",{d:_(ze)},null,8,Aa)]))])]),R(e("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>f.value.status=n),class:"border rounded px-2 py-2"},[t[14]||(t[14]=e("option",{value:""},"All status",-1)),(i(),u(q,null,J(d,n=>e("option",{key:n,value:n},g(n),9,Sa)),64))],512),[[Z,f.value.status]]),R(e("select",{"onUpdate:modelValue":t[5]||(t[5]=n=>f.value.school_year=n),class:"border rounded px-2 py-2",disabled:l.readOnly},[t[15]||(t[15]=e("option",{value:""},"Select school year…",-1)),(i(!0),u(q,null,J(r.value,n=>(i(),u("option",{key:n,value:n},g(n),9,Ba))),128))],8,Va),[[Z,f.value.school_year]]),R(e("select",{"onUpdate:modelValue":t[6]||(t[6]=n=>f.value.club_id=n),class:"border rounded px-2 py-2"},[t[16]||(t[16]=e("option",{value:""},"Any club",-1)),(i(!0),u(q,null,J(y.value,n=>(i(),u("option",{key:n.id,value:n.id},g(n.name),9,ja))),128))],512),[[Z,f.value.club_id]]),e("div",Fa,[e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:t[7]||(t[7]=n=>m({page:1}))}," Apply Filters "),e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[8]||(t[8]=()=>{f.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:""},m({page:1},!0)})},"Reset")])])]),P(Ne,{columns:L,data:w.value,loading:_(v).isLoading,onQueryChange:z},{"cell-total_budget":N(({value:n})=>[e("span",Pa,g(b(n)),1)]),"cell-created_at":N(({value:n})=>[e("span",null,g(n?new Date(n).toLocaleString():"—"),1)]),"cell-status":N(({value:n})=>[P(Ye,{text:n||"—",tone:s(n)},null,8,["text","tone"])]),"cell-actions":N(({row:n})=>[P(Ze,{row:n,moderator:["admin","manager"].includes(String(_($).user?.role||"").toLowerCase()),onAttachments:a,onSubmit:ie,onApprove:te,onReject:re,onEdit:o,onDelete:M,onView:I=>F(n),onCancel:ae},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),P(ue,{modelValue:U.value,"onUpdate:modelValue":t[9]||(t[9]=n=>U.value=n),mode:"create",onSubmit:p},null,8,["modelValue"]),P(ue,{modelValue:E.value,"onUpdate:modelValue":t[10]||(t[10]=n=>E.value=n),mode:"edit",initial:O.value||{},onSubmit:c},null,8,["modelValue","initial"]),P(ma,{modelValue:Q.value,"onUpdate:modelValue":t[11]||(t[11]=n=>Q.value=n),row:le.value},null,8,["modelValue","row"]),P(ya,{modelValue:A.value,"onUpdate:modelValue":t[12]||(t[12]=n=>A.value=n),onOpen:C},null,8,["modelValue"])],64))}};export{Ma as default};
