import{c as _,u as q,r as w,o as E,x as L,G as z,a as r,d as v,q as u,e,t as i,k as y,h as c,C as Y,F as V,B as A,j as h,v as b,N as G}from"./index.bm0HPCz8.js";import{u as J}from"./annualPlan.CkRwuJ1a.js";const H={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},K={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},Q={class:"flex items-center justify-between mb-3"},W={class:"flex items-center gap-3"},X={class:"text-lg font-semibold"},Z={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},ee={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},te={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},le=["disabled"],se=["value"],ae={key:0,class:"text-[11px] text-red-600 mt-1"},oe=["disabled"],de=["value"],ne={key:0,class:"text-[11px] text-red-600 mt-1"},re=["disabled"],ue={class:"mt-4"},ie={class:"flex items-center justify-between"},ce=["disabled"],pe={key:0,class:"text-[12px] text-red-600 mb-1"},me={class:"mt-1 border rounded overflow-hidden"},be={class:"w-full text-xs"},_e={class:"p-2"},ve=["onUpdate:modelValue","disabled"],ye={class:"p-2"},xe=["onUpdate:modelValue","disabled"],fe={class:"p-2"},he=["onUpdate:modelValue","disabled"],ge={class:"p-2"},ke=["onUpdate:modelValue","disabled"],we={class:"p-2"},Ve=["onUpdate:modelValue","disabled"],Ae={class:"p-2"},Ce=["onUpdate:modelValue","disabled"],Se={class:"p-2 text-right"},Ye=["disabled","onClick"],Ue={class:"mt-2 text-right text-sm"},Ne={class:"flex justify-end gap-2 mt-5"},$e={key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs"},Fe={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},lockedClubId:{type:[String,Number],default:""},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(C,{emit:U}){const p=C,S=U,g=_({get:()=>p.modelValue,set:l=>S("update:modelValue",l)}),k=q();J();const N=_(()=>{const l=new Date().getFullYear();return Array.from({length:6},(t,m)=>`${l-m}-${l-m+1}`)}),f=w([]),$=async()=>{try{const{data:l}=await G.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});f.value=Array.isArray(l?.data)?l.data:[]}catch{f.value=[]}};E(async()=>{await $(),p.lockedClubId&&(a.value.club_id=Number(p.lockedClubId))});const a=w(structuredClone(p.initial)),d=w({});L(()=>p.initial,l=>{let t=l?.plans;try{t=Array.isArray(t)?t:JSON.parse(t||"[]")}catch{t=[]}a.value={...l,filed_by_user_id:l?.filed_by_user_id||k.user?.id||"",plans:Array.isArray(t)?t:[]},d.value={}},{immediate:!0});const o=_(()=>p.mode==="edit"&&String(a.value.status||"").toLowerCase()!=="draft"),D=_(()=>p.mode!=="edit"?"New Annual Plan":o.value?"View Annual Plan (read-only)":"Edit Annual Plan"),I=_(()=>p.mode==="edit"?"Save Changes":"Create"),F=l=>Number(l||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),P=l=>Number.isFinite(+l)?+l:0,R=_(()=>Array.isArray(a.value.plans)?a.value.plans.reduce((l,t)=>l+P(t?.funds),0):0),j=()=>{Array.isArray(a.value.plans)||(a.value.plans=[]),a.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},M=l=>{a.value.plans.splice(l,1)},O=/^\d{4}-\d{4}$/,T=()=>{if(o.value)return!1;const l={};return(!a.value.school_year||!O.test(a.value.school_year))&&(l.school_year="Format: YYYY-YYYY"),a.value.club_id||(l.club_id="Required"),(!Array.isArray(a.value.plans)||!a.value.plans.length)&&(l.plans="Add at least one plan item"(a.value.plans||[]).forEach((t,m)=>{t.item||(l[`plans_${m}_item`]="Required"),t.date_of_implementation||(l[`plans_${m}_date`]="Required"),t.funds!=null&&Number(t.funds)<0&&(l[`plans_${m}_funds`]="Must be ≥ 0")})),d.value=l,Object.keys(l).length===0},B=()=>{if(o.value||!T())return;const l={...a.value};!l.filed_by_user_id&&k.user?.id&&(l.filed_by_user_id=k.user.id),S("submit",l)};return(l,t)=>{const m=z("pending-click");return g.value?(u(),r("div",H,[e("div",K,[e("div",Q,[e("div",W,[e("h2",X,i(D.value),1),e("span",Z,i(a.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:t[0]||(t[0]=s=>g.value=!1)},"Close")]),o.value?(u(),r("div",ee,[t[5]||(t[5]=y(" This plan is ",-1)),e("strong",null,i(a.value.status),1),t[6]||(t[6]=y(". Editing is disabled. ",-1))])):v("",!0),e("div",te,[e("div",null,[t[8]||(t[8]=e("label",{class:"block mb-1"},[y("School Year "),e("span",{class:"text-red-500"},"*")],-1)),c(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>a.value.school_year=s),class:"w-full border rounded px-2.5 py-2",disabled:o.value},[t[7]||(t[7]=e("option",{value:""},"Select school year…",-1)),(u(!0),r(V,null,A(N.value,s=>(u(),r("option",{key:s,value:s},i(s),9,se))),128))],8,le),[[Y,a.value.school_year]]),d.value.school_year?(u(),r("p",ae,i(d.value.school_year),1)):v("",!0)]),e("div",null,[t[10]||(t[10]=e("label",{class:"block mb-1"},[y("Club "),e("span",{class:"text-red-500"},"*")],-1)),c(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>a.value.club_id=s),class:h(["w-full border rounded px-2.5 py-2",d.value.club_id?"border-red-500":""]),disabled:o.value||!f.value.length||!!C.lockedClubId},[t[9]||(t[9]=e("option",{value:""},"Select club…",-1)),(u(!0),r(V,null,A(f.value,s=>(u(),r("option",{key:s.id,value:s.id},i(s.name)+" ("+i(s.code)+") ",9,de))),128))],10,oe),[[Y,a.value.club_id]]),d.value.club_id?(u(),r("p",ne,i(d.value.club_id),1)):v("",!0)]),e("div",null,[t[11]||(t[11]=e("label",{class:"block mb-1"},"Remarks",-1)),c(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>a.value.remarks=s),class:"w-full border rounded px-2.5 py-2",disabled:o.value,placeholder:"Optional remarks"},null,8,re),[[b,a.value.remarks]])])]),e("div",ue,[e("div",ie,[t[12]||(t[12]=e("label",{class:"block mb-1 font-medium"},[y("Plan Items "),e("span",{class:"text-red-500"},"*")],-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:o.value,onClick:j},"Add Item",8,ce)]),d.value.plans?(u(),r("p",pe,i(d.value.plans),1)):v("",!0),e("div",me,[e("table",be,[t[13]||(t[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Description"),e("th",{class:"text-left p-2"},"Date of Implementation"),e("th",{class:"text-left p-2"},"Funds"),e("th",{class:"text-left p-2"},"Venue"),e("th",{class:"text-left p-2"},"Notes"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(u(!0),r(V,null,A(a.value.plans,(s,x)=>(u(),r("tr",{key:x,class:"border-t"},[e("td",_e,[c(e("input",{"onUpdate:modelValue":n=>s.item=n,class:h(["w-40 border rounded px-2 py-1",d.value[`plans_${x}_item`]?"border-red-500":""]),disabled:o.value,placeholder:"Item name"},null,10,ve),[[b,s.item]])]),e("td",ye,[c(e("input",{"onUpdate:modelValue":n=>s.description=n,class:"w-60 border rounded px-2 py-1",disabled:o.value,placeholder:"Short description"},null,8,xe),[[b,s.description]])]),e("td",fe,[c(e("input",{type:"date","onUpdate:modelValue":n=>s.date_of_implementation=n,class:h(["border rounded px-2 py-1",d.value[`plans_${x}_date`]?"border-red-500":""]),disabled:o.value,placeholder:"YYYY-MM-DD"},null,10,he),[[b,s.date_of_implementation]])]),e("td",ge,[c(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":n=>s.funds=n,class:h(["w-28 border rounded px-2 py-1",d.value[`plans_${x}_funds`]?"border-red-500":""]),disabled:o.value,placeholder:"0.00"},null,10,ke),[[b,s.funds,void 0,{number:!0}]])]),e("td",we,[c(e("input",{"onUpdate:modelValue":n=>s.venue=n,class:"w-40 border rounded px-2 py-1",disabled:o.value,placeholder:"Venue / location"},null,8,Ve),[[b,s.venue]])]),e("td",Ae,[c(e("input",{"onUpdate:modelValue":n=>s.notes=n,class:"w-52 border rounded px-2 py-1",disabled:o.value,placeholder:"Notes (optional)"},null,8,Ce),[[b,s.notes]])]),e("td",Se,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:o.value,onClick:n=>M(x)},"Remove",8,Ye)])]))),128))])])]),e("div",Ue,[t[14]||(t[14]=e("span",{class:"mr-4"},"Client total (preview):",-1)),e("strong",null,i(F(R.value)),1),t[15]||(t[15]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),e("div",Ne,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[4]||(t[4]=s=>g.value=!1)},"Close"),o.value?v("",!0):c((u(),r("button",$e,[y(i(I.value),1)])),[[m,B]])])])])):v("",!0)}}};export{Fe as _};
