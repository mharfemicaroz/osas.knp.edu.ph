import{c as J,r as E,x as he,a as S,d as H,q as x,e as s,k as G,t as T,j as de,g as A,F as ce,B as _e,S as b,u as $e,z as Be,o as me,f as R,l as q,h as X,v as ie,s as Pe,p as Ne,A as De,M as Oe,C as Ie,Q as Le}from"./index.w1fTWaRQ.js";import{E as Ue,a as F,d as be,Q as Ye,_ as qe}from"./dayjs.min.C6Ah_atX.js";import{B as Me,E as Ve,F as ze,G as je,H as We,I as Ge,C as He,D as Je,z as Ke,_ as Qe,a as Xe,g as Ze,J as et,K as tt,L as at,M as nt,V as it}from"./SectionMain.Co2y8BLV.js";import{_ as ot,a as fe}from"./SectionTitleLineWithButton.AVJG-kj_.js";import{_ as st,B as lt,a as rt}from"./Badge.BfbdF7_K.js";import{_ as pe}from"./LiquidationFundFormModal.EfWtlYXo.js";import{u as ve}from"./liquidationFund.CD6UNGyx.js";import{u as dt}from"./clubScope.C_EnuWrj.js";import{Q as ct}from"./browser.CYIVxMbb.js";import{_ as ut}from"./StatusTrailModal.Dq5INm-V.js";import"./IconifyButton.CaN1pAk4.js";import"./appContext.Db1VNKoe.js";import"./activityDesignService.DKPfTybd.js";import"./utilizationRequestService.BsNdNhg3.js";import"./liquidationFundService.n_EUG0wO.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./ToasterComponent.C4X8owM8.js";import"./activityDesign.DQYQQrXQ.js";import"./club.CZEs4jG_.js";const mt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ft={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},pt={class:"flex items-center justify-between mb-3"},yt={class:"text-lg font-semibold"},gt={class:"text-gray-600"},ht={class:"flex items-center justify-between gap-2"},_t={class:"text-sm text-gray-600"},bt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},vt=["d"],wt=["disabled"],xt={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},St={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Ct=["src"],At={key:1,class:"flex items-center justify-center w-full h-full"},Ft=["d"],kt={class:"mt-2 text-xs"},Tt=["title"],Rt={class:"text-gray-500 flex items-center justify-between"},Et={key:0},$t={key:0},Bt={class:"mt-2 flex items-center justify-between gap-2"},Pt=["onClick","title"],Nt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Dt=["d"],Ot=["onClick"],It={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Lt=["d"],Ut={key:0,class:"mt-6 text-center text-sm text-gray-500"},Yt=10*1024*1024,qt={__name:"LiquidationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(t,{emit:n}){const u=t,r=n,f=J({get:()=>u.modelValue,set:a=>r("update:modelValue",a)}),h=ve(),l=E(null),y=E(!1),I=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),j=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),L=(a="")=>String(a).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",M=(a="")=>typeof a=="string"&&a.match(/^data:([^;]+);base64,/i)?.[1]||"",_=a=>{const d=a?.type&&I.has(a.type),c=a?.name&&j.has(L(a.name));return d||c},$=(a="")=>String(a).startsWith("image/"),p=(a="")=>a==="application/pdf",m=(a="")=>a==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",v=(a="")=>a==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",D=(a="")=>p(a)?Ve:m(a)?ze:v(a)?je:$(a)?We:Ge,U=(a="")=>p(a)?"PDF":m(a)?"Word":v(a)?"Excel":$(a)?"Image":"File",w=(a="")=>p(a)?"pdf":m(a)?"docx":v(a)?"xlsx":a==="image/png"?"png":a==="image/jpeg"?"jpg":a==="image/webp"?"webp":"",B=(a="attachment",d="")=>/\.[a-z0-9]+$/i.test(a)?a:d?`${a}.${d.startsWith(".")?d.slice(1):d}`:a,P=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,Y=J(()=>{const a=l.value?.attachments;if(!a)return[];try{return Array.isArray(a)?a:JSON.parse(a||"[]")}catch{return[]}}),ee=J(()=>(Y.value||[]).map((a,d)=>{const c=a.mime||M(a.data)||(a.name?L(a.name)==="pdf"&&"application/pdf":"")||"",k=L(a.name||"")||w(c),N=a.size??null,O=a.name||`${U(c)} ${d+1}`;return{id:a.id??d+1,name:O,data:a.data||"",url:a.url||a.href||a.path||"",mime:c,ext:k,size:N,filename:B(O,k)}}));he(()=>u.modelValue,async a=>{a&&u.row?.id&&(await h.fetchById(u.row.id),l.value=h.selected||u.row)});const K=async a=>{const d=a.target.files?.[0];if(a.target.value="",!(!d||!l.value?.id)){if(d.size>Yt){await b.fire("File too large","Maximum size is 10 MB.","warning");return}if(!_(d)){await b.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{y.value=!0,await h.uploadAttachment(l.value.id,d),await h.fetchById(l.value.id),l.value=h.selected}finally{y.value=!1}}},oe=async a=>{!l.value?.id||!(await b.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await h.deleteAttachment(l.value.id,a),await h.fetchById(l.value.id),l.value=h.selected)},se=a=>{if(a.data&&String(a.data).startsWith("data:")&&$(a.mime)){const d=window.open();d&&d.document.write(`<img src="${a.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}a.url&&window.open(String(a.url),"_blank")},W=a=>{const[d,c]=a.split(","),k=d.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",N=atob(c),O=new Uint8Array(N.length);for(let C=0;C<N.length;C++)O[C]=N.charCodeAt(C);return new Blob([O],{type:k})},V=(a,d)=>{const c=URL.createObjectURL(a),k=document.createElement("a");k.href=c,k.download=d||"download",document.body.appendChild(k),k.click(),k.remove(),setTimeout(()=>URL.revokeObjectURL(c),1e3)},te=async a=>{if(a.data&&String(a.data).startsWith("data:")){const d=W(a.data);V(d,a.filename);return}if(a.url)try{const c=await(await fetch(a.url,{credentials:"include"})).blob();V(c,a.filename)}catch{const d=document.createElement("a");d.href=String(a.url),d.setAttribute("download",a.filename),document.body.appendChild(d),d.click(),d.remove()}},ae=a=>$(a.mime)?"Open":"Download",le=a=>$(a.mime)?He:Je,ne=a=>$(a.mime)?se(a):te(a);return(a,d)=>f.value?(x(),S("div",mt,[s("div",ft,[s("div",pt,[s("h2",yt,[d[1]||(d[1]=G(" Liquidation Attachments — ",-1)),s("span",gt,T(l.value?.reference_code||""),1)]),s("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=c=>f.value=!1)},"Close")]),s("div",ht,[s("div",_t,[d[2]||(d[2]=G(" Activity: ",-1)),s("strong",null,T(l.value?.activity_design?.name_of_activity||"—"),1)]),s("label",{class:de(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":y.value}])},[(x(),S("svg",bt,[s("path",{d:A(Me)},null,8,vt)])),s("span",null,T(y.value?"Uploading…":"Upload"),1),s("input",{type:"file",class:"hidden",disabled:y.value,onChange:K,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,wt)],2)]),s("div",xt,[(x(!0),S(ce,null,_e(ee.value,c=>(x(),S("div",{key:c.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[s("div",St,[c.data&&c.data.startsWith("data:")&&c.mime?.startsWith("image/")?(x(),S("img",{key:0,src:c.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Ct)):(x(),S("div",At,[(x(),S("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:de({"text-red-600":c.mime==="application/pdf","text-blue-600":c.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":c.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!c.mime||!c.mime.startsWith("image/")&&c.mime!=="application/pdf"})},[s("path",{d:D(c.mime)},null,8,Ft)],2))]))]),s("div",kt,[s("div",{class:"font-medium truncate",title:c.name},T(c.name),9,Tt),s("div",Rt,[s("span",null,[G(T(U(c.mime))+" ",1),c.ext?(x(),S("span",Et,"("+T(c.ext.toUpperCase())+")",1)):H("",!0)]),c.size?(x(),S("span",$t,T(P(c.size)),1)):H("",!0)])]),s("div",Bt,[s("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:k=>ne(c),title:ae(c)},[(x(),S("svg",Nt,[s("path",{d:le(c)},null,8,Dt)])),G(" "+T(ae(c)),1)],8,Pt),s("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:k=>oe(c.id),title:"Remove"},[(x(),S("svg",It,[s("path",{d:A(Ke)},null,8,Lt)])),d[3]||(d[3]=G(" Remove ",-1))],8,Ot)])]))),128))]),ee.value.length?H("",!0):(x(),S("div",Ut," No attachments yet. "))])])):H("",!0)}},Mt="KOLEHIYO NG PANTUKAN",Vt="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",zt="https://osas.knp.edu.ph/#/verify-liquidation?id=",Z=t=>t?be(t).format("MMMM DD, YYYY"):"—",z=(t,n=2)=>t==null||t===""||Number.isNaN(Number(t))?"—":Number(t).toLocaleString(void 0,{minimumFractionDigits:n,maximumFractionDigits:n}),ye=(t,n)=>{if(Array.isArray(t)||t&&typeof t=="object")return t;try{return JSON.parse(t||"null")??n}catch{return n}},we="./",jt=`${we}images/logo.png`,Wt=`${we}images/bg.jpg`;async function ge(t){try{const u=await(await fetch(t)).blob();return new Promise(r=>{const f=new FileReader;f.onloadend=()=>r(f.result),f.readAsDataURL(u)})}catch{return null}}function Gt(t){switch(t){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}async function Ht(t){const n=t.internal.pageSize.getWidth(),u=110,r=15,f=await ge(Wt);f?(t.addImage(f,"JPEG",0,0,n,u,void 0,"FAST"),t.setGState(new t.GState({opacity:.18})),t.setFillColor(0,0,0),t.rect(0,0,n,u,"F"),t.setGState(new t.GState({opacity:1}))):(t.setFillColor(21,62,121),t.rect(0,0,n,u,"F"));const h=await ge(jt);return h&&t.addImage(h,"PNG",r,20,70,70,void 0,"FAST"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(20),t.text(Mt,r+86,38),t.setFont("helvetica","normal"),t.setFontSize(10),t.text(Vt,r+86,58),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(14),t.text("LIQUIDATION FUND",n/2,u+24,{align:"center"}),u+34}async function Jt(t,n,u){const r=t.internal.pageSize.getWidth(),f=15,h=n?.id??n?.reference_code??"",l=`${zt}${encodeURIComponent(String(h))}`,y=await ct.toDataURL(l,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),I=String(n.status||"").toUpperCase(),[j,L,M]=Gt(I),_=n.approved_at?Z(n.approved_at):n.date_filed?Z(n.date_filed):"—",$=`osas.knp.edu.ph/#/verify-liquidation?id=${String(h)}`;return F(t,{startY:u,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:f,right:f},tableWidth:r-f*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:r-f*2-280},1:{cellWidth:280}},didDrawCell:p=>{if(p.section!=="body")return;const{x:m,y:v,width:D,height:U}=p.cell,w=10;if(p.column.index===0){t.setFillColor(255,255,255),t.roundedRect(m,v,D-1,U,6,6,"F");const B=24,P=Math.min(180,D-22);t.setFillColor(j,L,M),t.roundedRect(m+w,v+w,P,B,12,12,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text(I||"STATUS",m+w+10,v+w+16),t.setTextColor(20),t.setFont("helvetica","normal"),t.setFontSize(9);let Y=v+w+B+16;t.text(`Ref No.: ${n.reference_code||"—"}`,m+w,Y),Y+=16,t.text(`Date Filed: ${Z(n.date_filed)}`,m+w,Y),Y+=16,t.text(`Date Issued: ${_}`,m+w,Y),t.setDrawColor(230),t.roundedRect(m,v,D-1,U,6,6,"S")}if(p.column.index===1){t.setFillColor(255,255,255),t.roundedRect(m,v,D-1,U,6,6,"F"),t.setFillColor(66,103,178),t.roundedRect(m,v,D-1,22,6,6,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("VERIFY",m+w,v+15);const B=m+w,P=v+28;t.addImage(y,"PNG",B,P,75,75,void 0,"FAST"),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("Scan to verify",B+100,P+14),t.setFont("helvetica","normal"),t.setFontSize(9),t.text("This document can be verified",B+100,P+32),t.text("online via the OSAS portal.",B+100,P+46),t.setTextColor(110),t.setFontSize(8),t.text($,B+100,P+72),t.setDrawColor(230),t.roundedRect(m,v,D-1,U,6,6,"S")}}}),t.lastAutoTable.finalY}async function xe(t){const n=new Ue({unit:"pt",format:[612,936],orientation:"landscape"}),u=n.internal.pageSize.getWidth(),r=36,f=ye(t.sources_of_fund,{}),h=ye(t.uses_of_fund,[]);let l=await Ht(n);l=await Jt(n,t,l)+10,F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY;const y=t.activity_design||{};F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},y.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Z(y.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},y.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},y.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},y.office_department||y?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),l=n.lastAutoTable.finalY+10,F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SUMMARY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY,F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["Total Sources",z(t.total_sources_amount,2)],["Total Uses",z(t.total_uses_amount,2)],["Total Cash on Hand",z(t.total_cash_on_hand,2)]],columnStyles:{0:{cellWidth:220,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),l=n.lastAutoTable.finalY+10,F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SOURCES OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY;const I=[["Contribution",f.contribution],["Payment from Fines",f.payment_from_fines],["Solicitations",f.solicitations],["Donations",f.donations],["Other Sources",f.other_sources],["Current Available Funds",f.current_available_funds]];F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PARTICULAR","AMOUNT"]],body:I.map(([p,m])=>[p,z(m,2)]),columnStyles:{0:{cellWidth:320},1:{cellWidth:"auto",halign:"right"}},margin:{left:r,right:r}}),l=n.lastAutoTable.finalY,f?.other_sources_note&&(F(n,{startY:l,theme:"plain",styles:{fontSize:9},body:[[{content:`Note: ${String(f.other_sources_note)}`,styles:{cellPadding:6,textColor:[71,85,105]}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY),l+=10,F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"USE OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY,Array.isArray(h)&&h.length?F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["DATE","QTY","UNIT","PARTICULARS","SHEET NO.","AMOUNT","IN-CHARGE"]],body:h.map(p=>[p?.date?Z(p.date):"—",z(p?.qty??"",0),p?.unit||"—",p?.particulars||"—",p?.sheet_no||"—",z(p?.amount??"",2),p?.in_charge||"—"]),columnStyles:{0:{cellWidth:82},1:{cellWidth:44,halign:"right"},2:{cellWidth:56},3:{cellWidth:200},4:{cellWidth:76},5:{cellWidth:78,halign:"right"},6:{cellWidth:"auto"}},margin:{left:r,right:r},foot:[["","","","","TOTAL",z(t.total_uses_amount,2),""]],footStyles:{fontStyle:"bold"}}):F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY+10,F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"REMARKS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY,F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[t.remarks&&String(t.remarks).trim()?t.remarks:"—"]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY+10;{const p=n.internal.pageSize.getHeight();l+180>p-30&&(n.addPage(),l=36)}F(n,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SIGNATORIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=n.lastAutoTable.finalY;const L=String(t?.file_by_user_name||"").trim()||(t?.filed_by?`${t.filed_by.first_name||""} ${t.filed_by.last_name||""}`.trim():""),M=String(t?.noted_by||"").trim(),_=t?.approver?`${t.approver.first_name||""} ${t.approver.last_name||""}`.trim():"";F(n,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},showHead:"firstPage",rowPageBreak:"avoid",head:[["PREPARED BY:","NOTED BY:","RECOMMENDING APPROVAL:"]],body:[[L||" ",M||" ",_||" "],[{content:`APPROVED BY:


DR. MARY ANN R. ARAULA
Acting College President`,colSpan:3,styles:{halign:"center",fontStyle:"bold",cellPadding:{top:14,right:10,bottom:16,left:10}}}]],columnStyles:{0:{cellWidth:(u-r*2)/2},1:{cellWidth:"auto"}},didParseCell:p=>{p.section==="body"&&p.row.index===0&&(p.cell.styles.halign="center",p.cell.styles.fontStyle="bold",p.cell.styles.cellPadding={top:16,right:10,bottom:4,left:10})},margin:{left:r,right:r}});const $=n.internal.pageSize.getHeight()-20;return n.setFontSize(8),n.setTextColor(120),n.text(`Generated on ${be().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,r,$),n}async function Kt(t){(await xe(t)).save(`${t.reference_code||"Liquidation_Fund"}.pdf`)}const Qt={class:"flex items-center gap-2"},Xt={class:"p-2 mb-4 rounded-xl border bg-white/60"},Zt={class:"flex items-center gap-2 mb-2 text-gray-700"},ea={class:"w-4 h-4",viewBox:"0 0 24 24"},ta=["d"],aa={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},na={class:"md:col-span-2 flex"},ia={class:"w-5 h-5",viewBox:"0 0 24 24"},oa=["d"],sa=["value"],la={class:"md:col-span-2"},ra={class:"flex items-center gap-2 md:col-span-1"},da={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30"},ca={class:"bg-white w-[560px] rounded-xl shadow p-4"},ua={class:"flex items-center justify-between mb-2"},ma={class:"grid grid-cols-1 gap-2 text-sm"},fa={class:"flex gap-2"},pa={class:"text-[11px] text-gray-600"},ya={class:"mt-3 flex justify-end gap-2"},Da={__name:"LiquidationFundsPage",setup(t){const n=ve(),u=$e(),r=Be(),f=J(()=>{const o=u.user?.last_name||"",e=(u.user?.first_name||"").slice(0,1);return`${o}${o?", ":""}${e?e+".":""}`}),h=o=>{try{return((Array.isArray(o)?o:JSON.parse(o||"[]")||[])||[]).map(i=>(!i||typeof i!="object"||Array.isArray(i.read_by)||(i.read_by=i.user_id!=null?[i.user_id]:[]),i))}catch{return[]}},l={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},y=E({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",activity_design_id:"",filed_by_user_id:"",date_filed_from:"",date_filed_to:""}),I=J({get:()=>{const{date_filed_from:o,date_filed_to:e}=y.value;return o||e?[o||null,e||null]:null},set:o=>{if(!o)y.value.date_filed_from=null,y.value.date_filed_to=null;else{const[e,i]=o;y.value.date_filed_from=e||null,y.value.date_filed_to=i||null}}}),{isClub:j,activeClubId:L,withClub:M}=dt(),_=async(o={},e=!0)=>{y.value={...y.value,...o};const i=M({...y.value});["q","status","activity_design_id","filed_by_user_id","date_filed_from","date_filed_to"].forEach(g=>{(i[g]===""||i[g]==null)&&delete i[g]}),await n.fetchAll(i,e)};me(async()=>{await _({page:1,limit:10,club_id:j?L:""})});const $=J(()=>({total:n.items.total||0,totalPages:n.items.totalPages||1,currentPage:n.items.currentPage||1,pageSize:n.items.pageSize||10,data:n.items.data||[]})),p=E(!1),m=E(null),v=async o=>{try{await n.fetchById(o.id),m.value=n.selected||o}catch{m.value=o}p.value=!0},D=async o=>{if(!m.value)return;const e=h(m.value.remarks);e.push({user_id:u.user?.id||null,user_name:f.value,message:o?.message||"",datetime:o?.datetime||new Date().toISOString(),is_read:!1,read_by:[u.user?.id||null]});try{m.value.remarks=JSON.stringify(e)}catch{}try{await n.updateById(m.value.id,{remarks:JSON.stringify(e)}),await _({},!0)}catch{}},U=async()=>{if(!m.value)return;const o=u.user?.id||null,i=h(m.value.remarks).map(g=>{if(!g||g.user_id===o)return g;const Q=Array.isArray(g.read_by)?g.read_by.slice():[];return Q.includes(o)||Q.push(o),{...g,read_by:Q}});try{m.value.remarks=JSON.stringify(i)}catch{}try{await n.updateById(m.value.id,{remarks:JSON.stringify(i)}),await _({},!0)}catch{}},w=Pe(),B=Ne(),P=async()=>{const o=String(w.query.open_remarks_type||""),e=Number(w.query.open_remarks_id||"");if(o==="LF"&&Number.isFinite(e)){try{await n.fetchById(e)}catch{}const i=n.selected;i&&await v(i);const g={...w.query};delete g.open_remarks_type,delete g.open_remarks_id,B.replace({query:g})}};me(P),he(()=>[w.query.open_remarks_type,w.query.open_remarks_id],()=>{P()});const Y=["draft","pending","approved","rejected","cancelled","completed"],ee=o=>{switch(String(o||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},K=o=>{const e=Number(o);return Number.isFinite(e)?e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},oe=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:240,formatter:(o,e)=>e.activity_design?e.activity_design.name_of_activity:""},{key:"total_sources_amount",label:"Sources",sortable:!0,width:120},{key:"total_uses_amount",label:"Uses",sortable:!0,width:120},{key:"total_cash_on_hand",label:"Cash on Hand",sortable:!0,width:140},{key:"date_filed",label:"Date Filed",sortable:!0,width:120},{key:"status",label:"Status",sortable:!0,width:120}],se=async o=>{await _(o)},W=E(!1),V=E(!1),te=E(null),ae=()=>{W.value=!0},le=async o=>{await n.create(o),W.value=!1,await _({},!0)},ne=async o=>{await n.fetchById(o.id);const e=n.selected||o;let i={},g=[];try{i=typeof e.sources_of_fund=="string"?JSON.parse(e.sources_of_fund||"{}"):e.sources_of_fund||{}}catch{}try{g=Array.isArray(e.uses_of_fund)?e.uses_of_fund:JSON.parse(e.uses_of_fund||"[]")}catch{}te.value={id:e.id,reference_code:e.reference_code,date_filed:e.date_filed||"",activity_design_id:e.activity_design_id||"",file_by_user_name:e.file_by_user_name||"",sources_of_fund:i,uses_of_fund:g,remarks:e.remarks||"",status:e.status||"draft"},V.value=!0},a=async o=>{const{id:e,...i}=o;await n.updateById(e,i),V.value=!1,await _({},!0)},d=async o=>{if(!o?.id)return;(await b.fire({title:`Delete liquidation "${o.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await n.deleteById(o.id),await _({},!0),await b.fire("Deleted","The liquidation fund has been deleted.","success"))},c=async o=>{await ne(o)},k=async o=>{if((await b.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await n.submit(o.id),await _({},!0),await b.fire("Submitted","Liquidation is now pending approval.","success")}catch{await b.fire("Error",n.error||"Failed to submit.","error")}},N=E(!1),O=E(null),C=E({from_email:"",from_name:"",to:"",subject:"",html:"",attachments:[]}),Se=async o=>{try{await n.fetchById(o.id);const e=n.selected||o,g=(await xe(e)).output("datauristring"),Q=String(g).split(",")[1]||"",Ee=`${e.reference_code||"Liquidation_Fund"}.pdf`;O.value=e,C.value={from_email:"osas@knp.edu.ph",from_name:`${u.user?.first_name||""} ${u.user?.last_name||""}`.trim(),to:"",subject:`Liquidation Fund ${e.reference_code||""}`.trim(),html:"Please see the attached file.",attachments:[{filename:Ee,content:Q,type:"application/pdf"}]},N.value=!0}catch{await b.fire("Error",n.error||"Failed to prepare email.","error")}},Ce=async()=>{const o=O.value;if(o)try{await n.sendEmail(o.id,{...C.value}),N.value=!1,await b.fire("Sent","Email sent successfully.","success")}catch{await b.fire("Error",n.error||"Failed to send email.","error")}},Ae=async o=>{const e=await b.fire({title:"Approve liquidation?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(e.isConfirmed)try{const i=h(o.remarks),g=e.value||"";i.push({user_id:u.user?.id||null,user_name:f.value,message:`${f.value} approved liquidation.${g?" - "+g:""}`,datetime:new Date().toISOString(),is_read:!1,read_by:[u.user?.id||null]}),await n.approve(o.id,JSON.stringify(i)),await _({},!0),await b.fire("Approved","Liquidation has been approved.","success")}catch{await b.fire("Error",n.error||"Failed to approve.","error")}},Fe=async o=>{const e=await b.fire({title:"Reject liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:i=>i?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(e.isConfirmed)try{const i=h(o.remarks);i.push({user_id:u.user?.id||null,user_name:f.value,message:`${f.value} rejected liquidation - ${e.value}.`,datetime:new Date().toISOString(),is_read:!1,read_by:[u.user?.id||null]}),await n.reject(o.id,JSON.stringify(i)),await _({},!0),await b.fire("Rejected","Liquidation has been rejected.","success")}catch{await b.fire("Error",n.error||"Failed to reject.","error")}},ke=async o=>{const e=await b.fire({title:"Cancel liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:i=>i?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Liquidation",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(e.isConfirmed)try{const i=h(o.remarks);i.push({user_id:u.user?.id||null,user_name:f.value,message:`${f.value} cancelled liquidation - ${e.value}.`,datetime:new Date().toISOString(),is_read:!1,read_by:[u.user?.id||null]}),await n.cancel(o.id,JSON.stringify(i)),await _({},!0),await b.fire("Cancelled","Liquidation has been cancelled.","success")}catch{await b.fire("Error",n.error||"Failed to cancel.","error")}},Te=async o=>{if(String(o?.status||"").toLowerCase()!=="approved"){await b.fire("Not allowed","Only approved liquidation can be printed.","info");return}try{await n.fetchById(o.id);const i=n.selected||o;await Kt(i)}catch(i){await b.fire("Error",n.error||"Failed to generate PDF.","error"),console.error(i)}},re=E(!1),ue=E(null),Re=async o=>{await n.fetchById(o.id),ue.value=n.selected||o,re.value=!0};return(o,e)=>(x(),S(ce,null,[R(Qe,null,{default:q(()=>[R(Xe,null,{default:q(()=>[A(n).error?(x(),De(st,{key:0,icon:A(Ze),color:"danger"},{default:q(()=>[G(T(A(n).error),1)]),_:1},8,["icon"])):H("",!0),R(ot,{icon:A(et),title:"Liquidation Funds",main:""},{default:q(()=>[s("div",Qt,[R(fe,{icon:A(tt),color:"primary",label:"New Liquidation",onClick:ae},null,8,["icon"]),R(fe,{icon:A(at),color:"info",label:"Refresh",onClick:e[0]||(e[0]=i=>_({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),s("div",Xt,[s("div",Zt,[(x(),S("svg",ea,[s("path",{d:A(nt)},null,8,ta)])),e[19]||(e[19]=s("span",{class:"font-medium text-sm"},"Filters",-1))]),s("div",aa,[s("div",na,[X(s("input",{"onUpdate:modelValue":e[1]||(e[1]=i=>y.value.q=i),placeholder:"Search by ref, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:e[2]||(e[2]=Oe(i=>_({page:1}),["enter"]))},null,544),[[ie,y.value.q]]),s("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:e[3]||(e[3]=i=>_({page:1}))},[(x(),S("svg",ia,[s("path",{d:A(it)},null,8,oa)]))])]),X(s("select",{"onUpdate:modelValue":e[4]||(e[4]=i=>y.value.status=i),class:"border rounded px-2 py-2"},[e[20]||(e[20]=s("option",{value:""},"All status",-1)),(x(),S(ce,null,_e(Y,i=>s("option",{key:i,value:i},T(i),9,sa)),64))],512),[[Ie,y.value.status]]),s("div",la,[R(A(Ye),Le({modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=i=>I.value=i)},l,{placeholder:"Date filed range"}),null,16,["modelValue"])]),s("div",ra,[s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:e[6]||(e[6]=i=>_({page:1}))}," Apply Filters "),s("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:e[7]||(e[7]=()=>{y.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",date_filed_from:"",date_filed_to:""},_({page:1},!0)})},"Reset")])])]),R(lt,{columns:oe,data:$.value,loading:A(n).isLoading,onQueryChange:se},{"cell-total_sources_amount":q(({value:i})=>[s("span",null,T(K(i)),1)]),"cell-total_uses_amount":q(({value:i})=>[s("span",null,T(K(i)),1)]),"cell-total_cash_on_hand":q(({value:i})=>[s("span",{class:de(["font-medium",Number(i)<0?"text-red-600":"text-emerald-700"])},T(K(i)),3)]),"cell-status":q(({value:i})=>[R(rt,{text:i||"—",tone:ee(i)},null,8,["text","tone"])]),"cell-actions":q(({row:i})=>[R(qe,{row:i,"current-user-id":A(u).user?.id,moderator:["admin","manager"].includes(String(A(u).user?.role||"").toLowerCase()),onAttachments:Re,onSubmit:k,onApprove:Ae,onReject:Fe,onRemarks:v,onEdit:ne,onDelete:d,onView:g=>c(i),onCancel:ke,onPrint:Te,onEmail:Se},null,8,["row","current-user-id","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),R(pe,{modelValue:W.value,"onUpdate:modelValue":e[8]||(e[8]=i=>W.value=i),mode:"create",onSubmit:le},null,8,["modelValue"]),R(pe,{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=i=>V.value=i),mode:"edit",initial:te.value||{},onSubmit:a},null,8,["modelValue","initial"]),R(qt,{modelValue:re.value,"onUpdate:modelValue":e[10]||(e[10]=i=>re.value=i),row:ue.value},null,8,["modelValue","row"]),R(ut,{modelValue:p.value,"onUpdate:modelValue":e[11]||(e[11]=i=>p.value=i),title:"Remarks • "+(m.value?.reference_code||m.value?.activity_design?.name_of_activity||"Item"),items:h(m.value?.remarks),"can-add":!0,onAdd:D,onMarkAllRead:U},null,8,["modelValue","title","items"]),N.value?(x(),S("div",da,[s("div",ca,[s("div",ua,[e[21]||(e[21]=s("h3",{class:"text-base font-semibold"},"Send Email",-1)),s("button",{class:"px-2 py-1 text-xs bg-gray-200 rounded",onClick:e[12]||(e[12]=i=>N.value=!1)},"Close")]),s("div",ma,[s("div",null,[e[22]||(e[22]=s("label",{class:"block mb-0.5"},"To",-1)),s("div",fa,[X(s("input",{"onUpdate:modelValue":e[13]||(e[13]=i=>C.value.to=i),class:"flex-1 border rounded px-2 py-1.5",placeholder:"recipient@example.com"},null,512),[[ie,C.value.to]]),s("button",{class:"px-2 py-1 text-[11px] rounded border bg-gray-50 hover:bg-gray-100",onClick:e[14]||(e[14]=()=>{const i=O.value?.filed_by_user_id||O.value?.filed_by?.id;i&&A(r).fetchById(i).then(()=>{const g=A(r).selectedUser?.email;g&&(C.value.to=g)})})},"Use Filer"),s("button",{class:"px-2 py-1 text-[11px] rounded border bg-rose-50 hover:bg-rose-100",onClick:e[15]||(e[15]=()=>{C.value.attachments=[]})},"Remove Attachment")])]),s("div",null,[e[23]||(e[23]=s("label",{class:"block mb-0.5"},"Subject",-1)),X(s("input",{"onUpdate:modelValue":e[16]||(e[16]=i=>C.value.subject=i),class:"w-full border rounded px-2 py-1.5"},null,512),[[ie,C.value.subject]])]),s("div",null,[e[24]||(e[24]=s("label",{class:"block mb-0.5"},"Message",-1)),X(s("textarea",{"onUpdate:modelValue":e[17]||(e[17]=i=>C.value.html=i),rows:"4",class:"w-full border rounded px-2 py-1.5"},null,512),[[ie,C.value.html]])]),s("div",pa,"Attachment: "+T(C.value.attachments?.[0]?.filename||"liquidation.pdf"),1)]),s("div",ya,[s("button",{class:"px-3 py-1.5 text-xs bg-gray-200 rounded",onClick:e[18]||(e[18]=i=>N.value=!1)},"Cancel"),s("button",{class:"px-3 py-1.5 text-xs bg-emerald-600 text-white rounded",onClick:Ce},"Send")])])])):H("",!0)],64))}};export{Da as default};
