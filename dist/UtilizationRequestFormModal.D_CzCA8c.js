import{c as v,u as H,o as Z,r as N,D,a as l,d as c,q as d,e as t,t as u,k as _,h as p,B as V,g as T,j as h,F as k,A as w,v as b,S as U}from"./index.Qp_B280l.js";import{u as ee}from"./utilizationRequest.B5E0JSLM.js";import{u as te}from"./activityDesign.BLYeU7nx.js";const se={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ae={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-[720px] max-h-[85vh] overflow-y-auto"},ie={class:"flex items-center justify-between mb-2"},le={class:"flex items-center gap-2"},de={class:"text-base font-semibold"},ne={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},oe={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},re={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},ue={class:"md:col-span-2"},ce=["disabled"],me=["value"],pe={key:0,class:"text-red-600 text-[11px] mt-0.5"},ve={key:1,class:"text-[11px] text-gray-500 mt-0.5"},_e={key:2,class:"text-[11px] text-amber-700 mt-0.5"},be={key:0,class:"text-red-600 text-[11px] mt-0.5"},fe=["disabled"],ye={key:0,class:"text-red-600 text-[11px] mt-0.5"},xe=["disabled"],ge={key:0,class:"text-red-600 text-[11px] mt-0.5"},he=["disabled"],ke={key:0,class:"text-red-600 text-[11px] mt-0.5"},we={class:"mt-2 text-sm"},qe={class:"flex gap-1.5"},Se=["disabled"],Ae=["value"],Be=["disabled"],Ce={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ne={class:"mt-1.5 flex flex-wrap gap-1.5"},Ve=["onClick"],Ue={key:0,class:"text-gray-400 text-xs"},$e={class:"mt-3 text-sm"},Ee={class:"flex items-center justify-between"},Oe=["disabled"],De={class:"mt-1 border rounded overflow-hidden"},Te={class:"w-full text-[12px]"},je={class:"p-1.5"},Fe=["onUpdate:modelValue","disabled","onChange"],Le=["value"],Re={key:0,class:"text-red-600 mt-0.5 text-[11px]"},ze={class:"p-1.5"},Ie=["onUpdate:modelValue","disabled"],Me={class:"p-1.5"},Pe=["onUpdate:modelValue","disabled"],We={class:"p-1.5 text-right"},Ge=["disabled","onClick"],Qe={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},Je=["disabled"],Ye={key:0},Ke=["disabled"],Xe={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},He=["disabled"],Ze={class:"mt-2 p-2 rounded-lg border bg-white"},et={class:"flex items-center justify-between"},tt=["disabled"],st={class:"flex justify-end gap-1.5 mt-4"},dt={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(j,{emit:F}){const q=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],y=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],f=j,$=F,S=v({get:()=>f.modelValue,set:i=>$("update:modelValue",i)}),A=H(),E=ee(),x=te(),O=v(()=>String(A.user?.role||"").toLowerCase()==="admin"),B=v(()=>Array.isArray(x.items?.data)?x.items.data.filter(i=>String(i.status).toLowerCase()==="approved"):[]);Z(async()=>{await x.fetchAll({page:1,limit:200,status:"approved",officer:!0},!0)});const s=N({...f.initial}),n=N({}),L=v(()=>{const i=Number(s.value.activity_design_id||0);return B.value.find(e=>Number(e.id)===i)||null});D(()=>f.initial,i=>{s.value={...i,facilities:Array.isArray(i.facilities)?i.facilities:(()=>{try{return JSON.parse(i.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(i.equipment_items)?i.equipment_items:(()=>{try{return JSON.parse(i.equipment_items||"[]")}catch{return[]}})()},s.value.facilities=(s.value.facilities||[]).filter(e=>q.includes(e)),s.value.equipment_items=(s.value.equipment_items||[]).filter(e=>!e?.name||y.includes(e.name)),n.value={}},{immediate:!0}),D(()=>s.value.activity_design_id,()=>{const i=L.value;i?.date_of_implementation?s.value.start_date=String(i.date_of_implementation).slice(0,10):s.value.start_date=""},{immediate:!0});const R=v(()=>String(s.value?.status||"").toLowerCase()),o=v(()=>f.mode==="edit"&&R.value!=="draft"),z=v(()=>f.mode!=="edit"?"New Utilization Request":o.value?"View Utilization (read-only)":"Edit Utilization"),I=v(()=>f.mode==="edit"?"Save Changes":"Create"),M=i=>{const e=i?.name_of_activity||"Untitled",a=i?.school_year?` • SY ${i.school_year}`:"",r=i?.semester?` • ${i.semester}`:"",m=i?.reference_code?` [${i.reference_code}]`:"";return`${e}${a}${r}${m}`},g=N(""),P=v(()=>q.filter(i=>!(s.value.facilities||[]).includes(i))),W=()=>{const i=g.value;!i||!q.includes(i)||(Array.isArray(s.value.facilities)||(s.value.facilities=[]),s.value.facilities.includes(i)||s.value.facilities.push(i),g.value="")},G=i=>{s.value.facilities.splice(i,1)},Q=()=>{Array.isArray(s.value.equipment_items)||(s.value.equipment_items=[]);const i=new Set((s.value.equipment_items||[]).map(a=>a?.name).filter(Boolean)),e=y.find(a=>!i.has(a))||y[0];i.has(e)||s.value.equipment_items.push({name:e,qty:1,unit:""})},J=i=>{s.value.equipment_items.splice(i,1)},C=i=>{const e=new Set((s.value.equipment_items||[]).map((a,r)=>r===i?null:a?.name).filter(Boolean));return y.filter(a=>!e.has(a))},Y=()=>{if(o.value)return!1;const i={};s.value.activity_design_id||(i.activity_design_id="Required"),s.value.start_date||(i.start_date="Start date is required (from Activity Design)"),s.value.start_time||(i.start_time="Required"),s.value.end_date||(i.end_date="Required"),s.value.end_time||(i.end_time="Required"),!Array.isArray(s.value.facilities)||!s.value.facilities.length?i.facilities="Select at least one":s.value.facilities.every(a=>q.includes(a))||(i.facilities="Invalid facility selected");const e=new Set;if(Array.isArray(s.value.equipment_items)&&s.value.equipment_items.forEach((a,r)=>{a?.name&&!y.includes(a.name)&&(i[`equipment_${r}`]="Invalid equipment"),a?.name&&e.has(a.name)&&(i[`equipment_${r}`]="Duplicate item; adjust quantity instead"),a?.name&&e.add(a.name),a?.name&&(isNaN(Number(a.qty))||Number(a.qty)<=0)&&(i[`equipment_${r}`]="Qty must be > 0")}),s.value.start_date&&s.value.end_date&&s.value.start_time&&s.value.end_time){const a=new Date(`${s.value.start_date}T${s.value.start_time}:00`);new Date(`${s.value.end_date}T${s.value.end_time}:00`)<a&&(i.end_time="End must be after or equal to start")}return n.value=i,Object.keys(i).length===0},K=async()=>{if(!s.value.start_date||!s.value.end_date||!s.value.facilities?.length){await U.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const i=await E.checkAvailability({start_date:s.value.start_date,start_time:s.value.start_time||"00:00",end_date:s.value.end_date,end_time:s.value.end_time||"00:00",facilities:s.value.facilities}),e=i.available_for_all?"All selected facilities are available.":`Conflicts on: ${(i.conflict_facilities||[]).join(", ")||"—"}`;await U.fire({icon:i.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(i.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${e}</div>
      </div>`})}catch(i){await U.fire("Error",E.error||"Failed to check availability.","error"),console.error(i)}},X=()=>{if(o.value||!Y())return;const i={...s.value};A.user?.id&&(i.filed_by_user_id=A.user.id),O.value||delete i.file_by_user_name,$("submit",i)};return(i,e)=>S.value?(d(),l("div",se,[t("div",ae,[t("div",ie,[t("div",le,[t("h2",de,u(z.value),1),t("span",ne,u(s.value.status),1)]),t("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:e[0]||(e[0]=a=>S.value=!1)},"Close")]),o.value?(d(),l("div",oe,[e[11]||(e[11]=_(" This request is ",-1)),t("strong",null,u(s.value.status),1),e[12]||(e[12]=_(". Editing is disabled. ",-1))])):c("",!0),t("div",re,[t("div",ue,[e[14]||(e[14]=t("label",{class:"block mb-0.5"},[_("Activity Design "),t("span",{class:"text-red-500"},"*")],-1)),p(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.value.activity_design_id=a),class:h(["w-full border rounded px-2 py-1.5",n.value.activity_design_id?"border-red-500":""]),disabled:o.value||T(x).isLoading},[e[13]||(e[13]=t("option",{value:""},"Select approved activity design…",-1)),(d(!0),l(k,null,w(B.value,a=>(d(),l("option",{key:a.id,value:a.id},u(M(a)),9,me))),128))],10,ce),[[V,s.value.activity_design_id]]),n.value.activity_design_id?(d(),l("p",pe,u(n.value.activity_design_id),1)):c("",!0),T(x).isLoading?(d(),l("p",ve,"Loading approved activities… ")):B.value.length?c("",!0):(d(),l("p",_e," No approved activity designs found. Approve an Activity Design first. "))]),t("div",null,[e[15]||(e[15]=t("label",{class:"block mb-0.5"},[_("Start Date "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.start_date=a),type:"date",class:h(["w-full border rounded px-2 py-1.5 bg-gray-50",n.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[b,s.value.start_date]]),n.value.start_date?(d(),l("p",be,u(n.value.start_date),1)):c("",!0)]),t("div",null,[e[16]||(e[16]=t("label",{class:"block mb-0.5"},[_("Start Time "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.start_time=a),type:"time",class:h(["w-full border rounded px-2 py-1.5",n.value.start_time?"border-red-500":""]),disabled:o.value},null,10,fe),[[b,s.value.start_time]]),n.value.start_time?(d(),l("p",ye,u(n.value.start_time),1)):c("",!0)]),t("div",null,[e[17]||(e[17]=t("label",{class:"block mb-0.5"},[_("End Date "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.end_date=a),type:"date",class:h(["w-full border rounded px-2 py-1.5",n.value.end_date?"border-red-500":""]),disabled:o.value},null,10,xe),[[b,s.value.end_date]]),n.value.end_date?(d(),l("p",ge,u(n.value.end_date),1)):c("",!0)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block mb-0.5"},[_("End Time "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.end_time=a),type:"time",class:h(["w-full border rounded px-2 py-1.5",n.value.end_time?"border-red-500":""]),disabled:o.value},null,10,he),[[b,s.value.end_time]]),n.value.end_time?(d(),l("p",ke,u(n.value.end_time),1)):c("",!0)])]),t("div",we,[e[20]||(e[20]=t("label",{class:"block mb-0.5"},[_("Facilities "),t("span",{class:"text-red-500"},"*")],-1)),t("div",qe,[p(t("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>g.value=a),class:"border rounded px-2 py-1.5 min-w-[200px]",disabled:o.value},[e[19]||(e[19]=t("option",{value:""},"Select facility…",-1)),(d(!0),l(k,null,w(P.value,a=>(d(),l("option",{key:a,value:a},u(a),9,Ae))),128))],8,Se),[[V,g.value]]),t("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:o.value||!g.value,onClick:W}," Add ",8,Be)]),n.value.facilities?(d(),l("p",Ce,u(n.value.facilities),1)):c("",!0),t("div",Ne,[(d(!0),l(k,null,w(s.value.facilities,(a,r)=>(d(),l("span",{key:a,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[_(u(a)+" ",1),o.value?c("",!0):(d(),l("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:m=>G(r)},"×",8,Ve))]))),128)),s.value.facilities?.length?c("",!0):(d(),l("span",Ue,"No facilities selected"))])]),t("div",$e,[t("div",Ee,[e[21]||(e[21]=t("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),t("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:o.value||C(-1).length===0,onClick:Q}," Add Row ",8,Oe)]),t("div",De,[t("table",Te,[e[22]||(e[22]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-1.5"},"Item"),t("th",{class:"text-left p-1.5"},"Qty"),t("th",{class:"text-left p-1.5"},"Unit"),t("th",{class:"p-1.5 w-14"})])],-1)),t("tbody",null,[(d(!0),l(k,null,w(s.value.equipment_items,(a,r)=>(d(),l("tr",{key:r,class:"border-t"},[t("td",je,[p(t("select",{"onUpdate:modelValue":m=>a.name=m,class:"w-full border rounded px-2 py-1.5",disabled:o.value,onChange:()=>{(a.qty==null||a.qty<=0)&&(a.qty=1)}},[(d(!0),l(k,null,w(C(r).concat(a.name&&!C(r).includes(a.name)?[a.name]:[]),m=>(d(),l("option",{key:m,value:m},u(m),9,Le))),128))],40,Fe),[[V,a.name]]),n.value[`equipment_${r}`]?(d(),l("div",Re,u(n.value[`equipment_${r}`]),1)):c("",!0)]),t("td",ze,[p(t("input",{"onUpdate:modelValue":m=>a.qty=m,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:o.value},null,8,Ie),[[b,a.qty,void 0,{number:!0}]])]),t("td",Me,[p(t("input",{"onUpdate:modelValue":m=>a.unit=m,class:"w-24 border rounded px-2 py-1.5",disabled:o.value,placeholder:"e.g., pcs"},null,8,Pe),[[b,a.unit]])]),t("td",We,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:o.value,onClick:m=>J(r)}," Remove ",8,Ge)])]))),128))])])]),e[23]||(e[23]=t("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),t("div",Qe,[t("div",null,[e[24]||(e[24]=t("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),p(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.utilization_details=a),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:o.value},null,8,Je),[[b,s.value.utilization_details]])]),O.value?(d(),l("div",Ye,[e[25]||(e[25]=t("label",{class:"block mb-0.5"},"Filer Name Override (optional)",-1)),p(t("input",{"onUpdate:modelValue":e[8]||(e[8]=a=>s.value.file_by_user_name=a),class:"w-full border rounded px-2 py-1.5",disabled:o.value,placeholder:"If provided, this name appears as the filer"},null,8,Ke),[[b,s.value.file_by_user_name]])])):c("",!0)]),t("div",Xe,[t("div",null,[e[26]||(e[26]=t("label",{class:"block mb-0.5"},"Remarks",-1)),p(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.remarks=a),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:o.value},null,8,He),[[b,s.value.remarks]])])]),t("div",Ze,[t("div",et,[e[27]||(e[27]=t("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),t("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:o.value,onClick:K}," Run Check ",8,tt)]),e[28]||(e[28]=t("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),t("div",st,[t("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:e[10]||(e[10]=a=>S.value=!1)},"Close"),o.value?c("",!0):(d(),l("button",{key:0,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs",onClick:X},u(I.value),1))])])])):c("",!0)}};export{dt as _};
