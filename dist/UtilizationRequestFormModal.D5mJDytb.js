import{c as b,u as te,o as se,r as V,x as F,G as ae,a as l,d as c,q as d,e as t,t as u,k as _,h as m,C as $,g as L,j as h,F as k,B as w,v as f,S as E}from"./index.DeYqkDTV.js";import{u as ie}from"./clubScope.CfEZn50H.js";import{u as le}from"./utilizationRequest.Do6T66-V.js";import{u as de}from"./activityDesign.C3L1DJ4t.js";const ne={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},oe={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-full sm:w-[720px] max-w-[95vw] h-[100vh] sm:h-auto sm:max-h-[90vh] overflow-y-auto"},re={class:"flex items-center justify-between mb-2"},ue={class:"flex items-center gap-2"},ce={class:"text-base font-semibold"},me={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},pe={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},ve={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},_e={class:"md:col-span-2"},be=["disabled"],fe=["value"],ye={key:0,class:"text-red-600 text-[11px] mt-0.5"},xe={key:1,class:"text-[11px] text-gray-500 mt-0.5"},ge={key:2,class:"text-[11px] text-amber-700 mt-0.5"},he={key:0,class:"text-red-600 text-[11px] mt-0.5"},ke=["disabled"],we={key:0,class:"text-red-600 text-[11px] mt-0.5"},qe=["disabled"],Se={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ae=["disabled"],Ce={key:0,class:"text-red-600 text-[11px] mt-0.5"},Be={class:"mt-2 text-sm"},Ne={class:"flex gap-1.5"},Ue=["disabled"],Ve=["value"],$e={class:"flex flex-col gap-1"},Ee=["disabled"],Oe={key:0,class:"text-red-600 text-[11px] mt-0.5"},De={class:"mt-1.5 flex flex-wrap gap-1.5"},Te=["onClick"],je={key:0,class:"text-gray-400 text-xs"},Fe={class:"mt-3 text-sm"},Le={class:"flex items-center justify-between"},Me=["disabled"],Re={class:"mt-1 border rounded overflow-hidden"},ze={class:"w-full text-[12px]"},Ie={class:"p-1.5"},Pe=["onUpdate:modelValue","disabled","onChange"],Ge=["value"],He={key:0,class:"text-red-600 mt-0.5 text-[11px]"},We={class:"p-1.5"},Qe=["onUpdate:modelValue","disabled"],Je={class:"p-1.5"},Ye=["onUpdate:modelValue","disabled"],Ke={class:"p-1.5 text-right"},Xe=["disabled","onClick"],Ze={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},et=["disabled"],tt={key:0},st=["disabled"],at={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},it=["disabled"],lt={class:"mt-2 p-2 rounded-lg border bg-white"},dt={class:"flex items-center justify-between"},nt=["disabled"],ot={class:"flex justify-end gap-1.5 mt-4"},rt={key:0,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs"},vt={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(M,{emit:R}){const q=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],A=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],x=M,O=R,C=b({get:()=>x.modelValue,set:a=>O("update:modelValue",a)}),B=te(),D=le(),g=de(),T=b(()=>String(B.user?.role||"").toLowerCase()==="admin"),N=b(()=>{const a=Array.isArray(g.items?.data)?g.items.data.filter(e=>String(e.status).toLowerCase()==="approved"):[];if(j.value&&S.value){const e=Number(S.value);return a.filter(n=>Number(n.club_id||n.club?.id)===e)}return a}),{isClub:j,activeClubId:S}=ie();se(async()=>{const a={page:1,limit:200,status:"approved",officer:!0},e=j.value&&S.value?{...a,club_id:S.value}:a;await g.fetchAll(e,!0)});const s=V({...x.initial}),o=V({}),z=b(()=>{const a=Number(s.value.activity_design_id||0);return N.value.find(e=>Number(e.id)===a)||null});F(()=>x.initial,a=>{s.value={...a,facilities:Array.isArray(a.facilities)?a.facilities:(()=>{try{return JSON.parse(a.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(a.equipment_items)?a.equipment_items:(()=>{try{return JSON.parse(a.equipment_items||"[]")}catch{return[]}})()},s.value.facilities=(s.value.facilities||[]).filter(e=>q.includes(e)),s.value.equipment_items=(s.value.equipment_items||[]).filter(e=>!e?.name||A.includes(e.name)),o.value={}},{immediate:!0}),F(()=>s.value.activity_design_id,()=>{const a=z.value;a?.date_of_implementation?s.value.start_date=String(a.date_of_implementation).slice(0,10):s.value.start_date=""},{immediate:!0});const I=b(()=>String(s.value?.status||"").toLowerCase()),r=b(()=>x.mode==="edit"&&I.value!=="draft"),P=b(()=>x.mode!=="edit"?"New Utilization Request":r.value?"View Utilization (read-only)":"Edit Utilization"),G=b(()=>x.mode==="edit"?"Save Changes":"Create"),H=a=>{const e=a?.name_of_activity||"Untitled",n=a?.school_year?` • SY ${a.school_year}`:"",i=a?.semester?` • ${a.semester}`:"",v=a?.reference_code?` [${a.reference_code}]`:"";return`${e}${n}${i}${v}`},y=V([]),W=b(()=>q.filter(a=>!(s.value.facilities||[]).includes(a))),Q=()=>{const a=Array.isArray(y.value)?y.value.slice():[];a.length&&(Array.isArray(s.value.facilities)||(s.value.facilities=[]),a.forEach(e=>{q.includes(e)&&!s.value.facilities.includes(e)&&s.value.facilities.push(e)}),y.value=[])},J=a=>{s.value.facilities.splice(a,1)},Y=()=>{Array.isArray(s.value.equipment_items)||(s.value.equipment_items=[]),s.value.equipment_items.push({name:"",qty:1,unit:""})},K=a=>{s.value.equipment_items.splice(a,1)},U=a=>{const e=new Set((s.value.equipment_items||[]).map((n,i)=>i===a?null:n?.name).filter(Boolean));return A.filter(n=>!e.has(n))},X=()=>{if(r.value)return!1;const a={};s.value.activity_design_id||(a.activity_design_id="Required"),s.value.start_date||(a.start_date="Start date is required (from Activity Design)"),s.value.start_time||(a.start_time="Required"),s.value.end_date||(a.end_date="Required"),s.value.end_time||(a.end_time="Required"),!Array.isArray(s.value.facilities)||!s.value.facilities.length?a.facilities="Select at least one":s.value.facilities.every(n=>q.includes(n))||(a.facilities="Invalid facility selected");const e=new Set;if(Array.isArray(s.value.equipment_items)&&s.value.equipment_items.forEach((n,i)=>{n?.name&&!A.includes(n.name)&&(a[`equipment_${i}`]="Invalid equipment"),n?.name&&e.has(n.name)&&(a[`equipment_${i}`]="Duplicate item; adjust quantity instead"),n?.name&&e.add(n.name),n?.name&&(isNaN(Number(n.qty))||Number(n.qty)<=0)&&(a[`equipment_${i}`]="Qty must be > 0")}),s.value.start_date&&s.value.end_date&&s.value.start_time&&s.value.end_time){const n=new Date(`${s.value.start_date}T${s.value.start_time}:00`);new Date(`${s.value.end_date}T${s.value.end_time}:00`)<n&&(a.end_time="End must be after or equal to start")}return o.value=a,Object.keys(a).length===0},Z=async()=>{if(!s.value.start_date||!s.value.end_date||!s.value.facilities?.length){await E.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const a=await D.checkAvailability({start_date:s.value.start_date,start_time:s.value.start_time||"00:00",end_date:s.value.end_date,end_time:s.value.end_time||"00:00",facilities:s.value.facilities}),e=a.available_for_all?"All selected facilities are available.":`Conflicts on: ${(a.conflict_facilities||[]).join(", ")||"—"}`;await E.fire({icon:a.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(a.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${e}</div>
      </div>`})}catch(a){await E.fire("Error",D.error||"Failed to check availability.","error"),console.error(a)}},ee=()=>{if(r.value||!X())return;const a={...s.value};B.user?.id&&(a.filed_by_user_id=B.user.id),T.value||delete a.file_by_user_name,O("submit",a)};return(a,e)=>{const n=ae("pending-click");return C.value?(d(),l("div",ne,[t("div",oe,[t("div",re,[t("div",ue,[t("h2",ce,u(P.value),1),t("span",me,u(s.value.status),1)]),t("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:e[0]||(e[0]=i=>C.value=!1)},"Close")]),r.value?(d(),l("div",pe,[e[11]||(e[11]=_(" This request is ",-1)),t("strong",null,u(s.value.status),1),e[12]||(e[12]=_(". Editing is disabled. ",-1))])):c("",!0),t("div",ve,[t("div",_e,[e[14]||(e[14]=t("label",{class:"block mb-0.5"},[_("Activity Design "),t("span",{class:"text-red-500"},"*")],-1)),m(t("select",{"onUpdate:modelValue":e[1]||(e[1]=i=>s.value.activity_design_id=i),class:h(["w-full border rounded px-2 py-1.5",o.value.activity_design_id?"border-red-500":""]),disabled:r.value||L(g).isLoading},[e[13]||(e[13]=t("option",{value:""},"Select approved activity design…",-1)),(d(!0),l(k,null,w(N.value,i=>(d(),l("option",{key:i.id,value:i.id},u(H(i)),9,fe))),128))],10,be),[[$,s.value.activity_design_id]]),o.value.activity_design_id?(d(),l("p",ye,u(o.value.activity_design_id),1)):c("",!0),L(g).isLoading?(d(),l("p",xe,"Loading approved activities… ")):N.value.length?c("",!0):(d(),l("p",ge," No approved activity designs found. Approve an Activity Design first. "))]),t("div",null,[e[15]||(e[15]=t("label",{class:"block mb-0.5"},[_("Start Date "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>s.value.start_date=i),type:"date",class:h(["w-full border rounded px-2 py-1.5 bg-gray-50",o.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[f,s.value.start_date]]),o.value.start_date?(d(),l("p",he,u(o.value.start_date),1)):c("",!0)]),t("div",null,[e[16]||(e[16]=t("label",{class:"block mb-0.5"},[_("Start Time "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>s.value.start_time=i),type:"time",class:h(["w-full border rounded px-2 py-1.5",o.value.start_time?"border-red-500":""]),placeholder:"HH:MM",disabled:r.value},null,10,ke),[[f,s.value.start_time]]),o.value.start_time?(d(),l("p",we,u(o.value.start_time),1)):c("",!0)]),t("div",null,[e[17]||(e[17]=t("label",{class:"block mb-0.5"},[_("End Date "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>s.value.end_date=i),type:"date",class:h(["w-full border rounded px-2 py-1.5",o.value.end_date?"border-red-500":""]),disabled:r.value},null,10,qe),[[f,s.value.end_date]]),o.value.end_date?(d(),l("p",Se,u(o.value.end_date),1)):c("",!0)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block mb-0.5"},[_("End Time "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=i=>s.value.end_time=i),type:"time",class:h(["w-full border rounded px-2 py-1.5",o.value.end_time?"border-red-500":""]),placeholder:"HH:MM",disabled:r.value},null,10,Ae),[[f,s.value.end_time]]),o.value.end_time?(d(),l("p",Ce,u(o.value.end_time),1)):c("",!0)])]),t("div",Be,[e[21]||(e[21]=t("label",{class:"block mb-0.5"},[_("Facilities "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Ne,[m(t("select",{"onUpdate:modelValue":e[6]||(e[6]=i=>y.value=i),multiple:"",size:"6",class:"border rounded px-2 py-1.5 min-w-[240px]",disabled:r.value},[e[19]||(e[19]=t("option",{value:""},"Select facility…",-1)),(d(!0),l(k,null,w(W.value,i=>(d(),l("option",{key:i,value:i},u(i),9,Ve))),128))],8,Ue),[[$,y.value]]),t("div",$e,[t("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:r.value||!(y.value&&y.value.length),onClick:Q}," Add Selected ",8,Ee),e[20]||(e[20]=t("span",{class:"text-[10px] text-gray-500"},"Use Ctrl/Cmd or Shift to select multiple.",-1))])]),o.value.facilities?(d(),l("p",Oe,u(o.value.facilities),1)):c("",!0),t("div",De,[(d(!0),l(k,null,w(s.value.facilities,(i,v)=>(d(),l("span",{key:i,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[_(u(i)+" ",1),r.value?c("",!0):(d(),l("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:p=>J(v)},"×",8,Te))]))),128)),s.value.facilities?.length?c("",!0):(d(),l("span",je,"No facilities selected"))])]),t("div",Fe,[t("div",Le,[e[22]||(e[22]=t("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),t("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:r.value||U(-1).length===0,onClick:Y}," Add Row ",8,Me)]),t("div",Re,[t("table",ze,[e[24]||(e[24]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-1.5"},"Item"),t("th",{class:"text-left p-1.5"},"Qty"),t("th",{class:"text-left p-1.5"},"Unit"),t("th",{class:"p-1.5 w-14"})])],-1)),t("tbody",null,[(d(!0),l(k,null,w(s.value.equipment_items,(i,v)=>(d(),l("tr",{key:v,class:"border-t"},[t("td",Ie,[m(t("select",{"onUpdate:modelValue":p=>i.name=p,class:"w-full border rounded px-2 py-1.5",disabled:r.value,onChange:()=>{(i.qty==null||i.qty<=0)&&(i.qty=1)}},[e[23]||(e[23]=t("option",{disabled:"",value:""},"Select item…",-1)),(d(!0),l(k,null,w(U(v).concat(i.name&&!U(v).includes(i.name)?[i.name]:[]),p=>(d(),l("option",{key:p,value:p},u(p),9,Ge))),128))],40,Pe),[[$,i.name]]),o.value[`equipment_${v}`]?(d(),l("div",He,u(o.value[`equipment_${v}`]),1)):c("",!0)]),t("td",We,[m(t("input",{"onUpdate:modelValue":p=>i.qty=p,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:r.value,placeholder:"1"},null,8,Qe),[[f,i.qty,void 0,{number:!0}]])]),t("td",Je,[m(t("input",{"onUpdate:modelValue":p=>i.unit=p,class:"w-24 border rounded px-2 py-1.5",disabled:r.value,placeholder:"e.g., pcs"},null,8,Ye),[[f,i.unit]])]),t("td",Ke,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:r.value,onClick:p=>K(v)}," Remove ",8,Xe)])]))),128))])])]),e[25]||(e[25]=t("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),t("div",Ze,[t("div",null,[e[26]||(e[26]=t("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),m(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=i=>s.value.utilization_details=i),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"e.g., 2 hours practice; stage and sound system"},null,8,et),[[f,s.value.utilization_details]])]),T.value?(d(),l("div",tt,[e[27]||(e[27]=t("label",{class:"block mb-0.5"},"Filer Name Override (optional)",-1)),m(t("input",{"onUpdate:modelValue":e[8]||(e[8]=i=>s.value.file_by_user_name=i),class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"If provided, this name appears as the filer"},null,8,st),[[f,s.value.file_by_user_name]])])):c("",!0)]),t("div",at,[t("div",null,[e[28]||(e[28]=t("label",{class:"block mb-0.5"},"Remarks",-1)),m(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=i=>s.value.remarks=i),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"Optional notes for approvers"},null,8,it),[[f,s.value.remarks]])])]),t("div",lt,[t("div",dt,[e[29]||(e[29]=t("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),t("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:r.value,onClick:Z}," Run Check ",8,nt)]),e[30]||(e[30]=t("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),t("div",ot,[t("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:e[10]||(e[10]=i=>C.value=!1)},"Close"),r.value?c("",!0):m((d(),l("button",rt,[_(u(G.value),1)])),[[n,ee]])])])])):c("",!0)}}};export{vt as _};
