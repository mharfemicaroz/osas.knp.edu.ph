import{r as v,o as ae,c as V,A as j,l as y,q as o,f as _,d as b,e as s,g as r,k as h,t as D,a as c,h as F,L as ie,v as se,C as le,F as ne,B as re,S as g}from"./index.DcMZnzI8.js";import{_ as oe,a as de,J as ce,L as ue,M as pe,ae as me,a0 as fe,ab as _e,z as ve}from"./SectionMain.BSyQ8TLJ.js";import{_ as ye,a as be}from"./SectionTitleLineWithButton.BFx1OWxt.js";import{_ as ge,B as he,a as T}from"./Badge.DdCJC6Us.js";import{_ as ke}from"./ActivityDesignFormModal.BGIxUArp.js";import{_ as xe}from"./UtilizationRequestFormModal.BSnhfxOI.js";import{_ as Ce}from"./LiquidationFundFormModal.eIWsP3T6.js";import{_ as we}from"./AnnualPlanFormModal.BoCE_h16.js";import{u as Ae}from"./annualPlan.Dvzo6nnT.js";import{u as Re}from"./activityDesign.DxfG4ai5.js";import{u as Se}from"./utilizationRequest.BDrIXOuT.js";import{u as $e}from"./liquidationFund.Cqs6SfMi.js";import{u as Ve}from"./grievance.uLki7MK8.js";import"./activityDesignService.DsiCMwQY.js";import"./utilizationRequestService.B8BBVACK.js";import"./liquidationFundService.C8VpVc-v.js";import"./ToasterComponent.D34mniiU.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./club.C45oiN9-.js";const De={class:"flex items-center gap-2"},Le={class:"p-2 mb-4 rounded-xl border bg-white/60"},Be={class:"flex items-center gap-2 mb-2 text-gray-700"},Ie={class:"w-4 h-4",viewBox:"0 0 24 24"},Pe=["d"],Ue={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},je={class:"md:col-span-3 flex items-center gap-2 flex-wrap"},Fe=["checked","onChange"],Te={class:"text-xs"},Ge={class:"flex items-center gap-2 md:col-span-2"},qe={class:"flex items-center gap-1"},ze=["onClick"],Me=["onClick"],Ee={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},Ne=["d"],Je=["onClick"],Oe={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},We=["d"],Qe=["onClick"],Ke={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},Ye=["d"],He=["onClick"],Xe=["onClick"],Ze=["onClick"],et=["onClick"],tt={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},at=["d"],Ct={__name:"WorkFlowsPage",setup(it){const u=Ae(),p=Re(),m=Se(),f=$e(),k=Ve(),G=[{key:"AP",label:"Annual Plan"},{key:"AD",label:"Activity Design"},{key:"UR",label:"Utilization"},{key:"LF",label:"Liquidation"},{key:"GRV",label:"Grievance"}],l=v({page:1,limit:10,q:"",status:"",types:new Set(["AP","AD","UR","LF","GRV"])}),q=t=>{const e=l.value.types;e.has(t)?e.delete(t):e.add(t)},d=async(t=!0)=>{const e={limit:300,officer:"true"},{q:a,status:n}=l.value,i=($={})=>({...e,...a?{q:a}:{},...n?{status:n}:{},...$});await Promise.allSettled([u.fetchAll(i({order:"DESC",sort:"approved_at"}),t),p.fetchAll(i({order:"DESC",sort:"created_at"}),t),m.fetchAll(i({order:"DESC",sort:"start_at"}),t),f.fetchAll(i({order:"DESC",sort:"created_at"}),t),k.fetchAll(i({order:"DESC",sort:"created_at"}),t)])};ae(async()=>{await d(!0)});const x=V(()=>{const t=[];if(l.value.types.has("AP"))for(const i of u.items.data||[])t.push({id:i.id,type:"AP",reference:i.reference_code||`AP-${i.id}`,title:i.school_year?`Annual Plan SY ${i.school_year}`:"Annual Plan",club:i.club?.name||"",date:i.approved_at||i.submitted_at||i.created_at,status:i.status||"",raw:i});if(l.value.types.has("AD"))for(const i of p.items.data||[])t.push({id:i.id,type:"AD",reference:i.reference_code||`AD-${i.id}`,title:i.name_of_activity||"Activity",club:i.club?.name||"",date:i.date_of_implementation||i.created_at,status:i.status||"",raw:i});if(l.value.types.has("UR"))for(const i of m.items.data||[])t.push({id:i.id,type:"UR",reference:i.reference_code||`UR-${i.id}`,title:i.activity_design?.name_of_activity?`Utilization • ${i.activity_design.name_of_activity}`:"Utilization",club:i.activity_design?.club?.name||"",date:i.start_at||i.created_at,status:i.status||"",raw:i});if(l.value.types.has("LF"))for(const i of f.items.data||[])t.push({id:i.id,type:"LF",reference:i.reference_code||`LF-${i.id}`,title:i.purpose||"Liquidation",club:i.activity_design?.club?.name||i.club?.name||"",date:i.date_filed||i.created_at,status:i.status||"",raw:i});if(l.value.types.has("GRV"))for(const i of k.items.data||[])t.push({id:i.id,type:"GRV",reference:i.reference_code||`GRV-${i.id}`,title:i.title||"Grievance",club:i.club?.name||"",date:i.created_at,status:i.status||"",raw:i});const e=(l.value.q||"").trim().toLowerCase();let a=t;e&&(a=a.filter(i=>`${i.reference} ${i.title} ${i.club}`.toLowerCase().includes(e)));const n=(l.value.status||"").trim().toLowerCase();return n&&(a=a.filter(i=>String(i.status||"").toLowerCase()===n)),a.sort((i,$)=>new Date($.date||0)-new Date(i.date||0))}),z=V(()=>{const t=Math.max(parseInt(l.value.page,10)||1,1),e=Math.max(parseInt(l.value.limit,10)||10,1),a=(t-1)*e;return x.value.slice(a,a+e)}),M=V(()=>({total:x.value.length,totalPages:Math.max(Math.ceil(x.value.length/(parseInt(l.value.limit,10)||10)),1),currentPage:Math.max(parseInt(l.value.page,10)||1,1),pageSize:Math.max(parseInt(l.value.limit,10)||10,1),data:z.value})),E=t=>{t?.page!=null&&(l.value.page=t.page),t?.limit!=null&&(l.value.limit=t.limit)},N={draft:"gray",pending:"amber",approved:"emerald",rejected:"red",cancelled:"zinc",completed:"indigo",submitted:"amber",in_review:"blue",resolved:"emerald"},J=t=>N[String(t||"").toLowerCase()]||"gray",L=t=>String(t?.status||"").toLowerCase()==="pending",O=t=>String(t?.status||"").toLowerCase()==="approved",W=async t=>{await k.updateById(t.id,{status:"in_review"}),await d(!0)},Q=async t=>{await k.updateById(t.id,{status:"resolved"}),await d(!0)},K=async t=>{await k.updateById(t.id,{status:"rejected"}),await d(!0)};async function C(t,e){const a=await g.fire({title:t,input:"text",inputLabel:"Remarks (optional)",inputPlaceholder:"Enter remarks...",showCancelButton:!0,confirmButtonText:e||"Confirm",cancelButtonText:"Cancel"});return a.isConfirmed?a.value||"":null}async function Y(t){const e=await C(`Approve ${t.type}-${t.reference}?`,"Approve");if(e!==null){switch(t.type){case"AP":await u.approve(t.id,e);break;case"AD":await p.approve(t.id,e);break;case"UR":await m.approve(t.id,e);break;case"LF":await f.approve(t.id,e);break}await d(!0),await g.fire("Approved","Item has been approved.","success")}}async function H(t){const e=await C(`Reject ${t.type}-${t.reference}?`,"Reject");if(e!==null){switch(t.type){case"AP":await u.reject(t.id,e);break;case"AD":await p.reject(t.id,e);break;case"UR":await m.reject(t.id,e);break;case"LF":await f.reject(t.id,e);break}await d(!0),await g.fire("Rejected","Item has been rejected.","success")}}async function X(t){const e=await C(`Cancel ${t.type}-${t.reference}?`,"Cancel");if(e!==null){switch(t.type){case"AP":await u.cancel(t.id,e);break;case"AD":await p.cancel(t.id,e);break;case"UR":await m.cancel(t.id,e);break;case"LF":await f.cancel(t.id,e);break}await d(!0),await g.fire("Cancelled","Item has been cancelled.","success")}}async function Z(t){if((await g.fire({title:`Delete ${t.type}-${t.reference}?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33"})).isConfirmed){switch(t.type){case"AP":await u.deleteById(t.id);break;case"AD":await p.deleteById(t.id);break;case"UR":await m.deleteById(t.id);break;case"LF":await f.deleteById(t.id);break}await d(!0),await g.fire("Deleted","Item removed.","success")}}const ee=[{key:"type",label:"Type",sortable:!1,width:110},{key:"reference",label:"Reference",sortable:!0,width:140},{key:"title",label:"Title",sortable:!1,minWidth:240},{key:"club",label:"Club",sortable:!1,minWidth:160},{key:"date",label:"Date",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:120}],w=v(!1),A=v(!1),R=v(!1),S=v(!1),B=v(null),I=v(null),P=v(null),U=v(null),te=async t=>{try{if(t.type==="AP"){await u.fetchById(t.id);const e=u.selected;if(!e)return;let a=e.plans;try{a=Array.isArray(a)?a:JSON.parse(a||"[]")}catch{a=[]}B.value={id:e.id,reference_code:e.reference_code||"",school_year:e.school_year||"",club_id:e.club_id||e.club?.id||"",filed_by_user_id:e.filed_by_user_id||"",approver_user_id:e.approver_user_id||null,plans:a||[],remarks:e.remarks||"",status:e.status||"draft"},w.value=!0}else if(t.type==="AD"){await p.fetchById(t.id);const e=p.selected;if(!e)return;I.value={...e,date_filed:e.date_filed||"",date_of_implementation:e.date_of_implementation||""},A.value=!0}else if(t.type==="UR"){await m.fetchById(t.id);const e=m.selected;if(!e)return;let a=[],n=[];try{a=Array.isArray(e.facilities)?e.facilities:JSON.parse(e.facilities||"[]")}catch{}try{n=Array.isArray(e.equipment_items)?e.equipment_items:JSON.parse(e.equipment_items||"[]")}catch{}P.value={id:e.id,reference_code:e.reference_code,date_filed:e.date_filed||"",activity_design_id:e.activity_design_id||"",facilities:a,equipment_items:n,utilization_details:e.utilization_details||"",start_date:e.start_date||String(e.start_at||"").slice(0,10),start_time:e.start_time||(e.start_at?new Date(e.start_at).toTimeString().slice(0,5):""),end_date:e.end_date||String(e.end_at||"").slice(0,10),end_time:e.end_time||(e.end_at?new Date(e.end_at).toTimeString().slice(0,5):""),status:e.status||"draft",availability_status:e.availability_status||"pending-check",remarks:e.remarks||""},R.value=!0}else if(t.type==="LF"){await f.fetchById(t.id);const e=f.selected;if(!e)return;let a={},n=[];try{a=typeof e.sources_of_fund=="string"?JSON.parse(e.sources_of_fund||"{}"):e.sources_of_fund||{}}catch{}try{n=Array.isArray(e.uses_of_fund)?e.uses_of_fund:JSON.parse(e.uses_of_fund||"[]")}catch{}U.value={id:e.id,reference_code:e.reference_code,date_filed:e.date_filed||"",activity_design_id:e.activity_design_id||"",sources_of_fund:a,uses_of_fund:n,remarks:e.remarks||"",status:e.status||"draft"},S.value=!0}}catch(e){console.error(e),await g.fire("Error","Failed to load details.","error")}};return(t,e)=>(o(),j(oe,null,{default:y(()=>[_(de,null,{default:y(()=>[r(u).error||r(p).error||r(m).error||r(f).error?(o(),j(ge,{key:0,color:"danger"},{default:y(()=>[h(D(r(u).error||r(p).error||r(m).error||r(f).error),1)]),_:1})):b("",!0),_(ye,{icon:r(ce),title:"Workflows",main:""},{default:y(()=>[s("div",De,[_(be,{icon:r(ue),color:"info",label:"Refresh",onClick:e[0]||(e[0]=a=>d(!0))},null,8,["icon"])])]),_:1},8,["icon"]),s("div",Le,[s("div",Be,[(o(),c("svg",Ie,[s("path",{d:r(pe)},null,8,Pe)])),e[10]||(e[10]=s("span",{class:"font-medium text-sm"},"Filters",-1))]),s("div",Ue,[F(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.q=a),placeholder:"Search title, ref, club…",class:"border rounded px-2 py-2 md:col-span-2",onKeyup:e[2]||(e[2]=ie(a=>d(),["enter"]))},null,544),[[se,l.value.q]]),F(s("select",{"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.status=a),class:"border rounded px-2 py-2"},e[11]||(e[11]=[s("option",{value:""},"All status",-1),s("option",{value:"draft"},"draft",-1),s("option",{value:"pending"},"pending",-1),s("option",{value:"approved"},"approved",-1),s("option",{value:"rejected"},"rejected",-1),s("option",{value:"cancelled"},"cancelled",-1),s("option",{value:"completed"},"completed",-1)]),512),[[le,l.value.status]]),s("div",je,[(o(),c(ne,null,re(G,a=>s("label",{key:a.key,class:"inline-flex items-center gap-2 px-2 py-1 rounded-full bg-gray-100"},[s("input",{type:"checkbox",checked:l.value.types.has(a.key),onChange:n=>q(a.key)},null,40,Fe),s("span",Te,D(a.label),1)])),64))]),s("div",Ge,[s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:e[4]||(e[4]=a=>d())},"Apply"),s("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:e[5]||(e[5]=a=>(l.value.q="",l.value.status="",l.value.types=new Set(["AP","AD","UR","LF","GRV"]),d(!0)))},"Reset")])])]),_(he,{columns:ee,data:M.value,onQueryChange:E,loading:r(u).isLoading||r(p).isLoading||r(m).isLoading||r(f).isLoading},{"cell-type":y(({value:a})=>[_(T,{text:a,tone:"indigo"},null,8,["text"])]),"cell-date":y(({value:a})=>[h(D(a?new Date(a).toLocaleDateString():"—"),1)]),"cell-status":y(({value:a})=>[_(T,{text:a||"—",tone:J(a)},null,8,["text","tone"])]),"cell-actions":y(({row:a})=>[s("div",qe,[s("button",{class:"px-2 py-1 text-[12px] rounded bg-gray-100 hover:bg-gray-200 inline-flex items-center gap-1",onClick:n=>te(a),title:"View"}," View ",8,ze),a.type!=="GRV"&&L(a)?(o(),c("button",{key:0,class:"px-2 py-1 text-[12px] rounded bg-emerald-100 hover:bg-emerald-200 inline-flex items-center gap-1",onClick:n=>Y(a),title:"Approve"},[(o(),c("svg",Ee,[s("path",{d:r(me)},null,8,Ne)])),e[12]||(e[12]=h(" Approve ",-1))],8,Me)):b("",!0),a.type!=="GRV"&&L(a)?(o(),c("button",{key:1,class:"px-2 py-1 text-[12px] rounded bg-amber-100 hover:bg-amber-200 inline-flex items-center gap-1",onClick:n=>H(a),title:"Reject"},[(o(),c("svg",Oe,[s("path",{d:r(fe)},null,8,We)])),e[13]||(e[13]=h(" Reject ",-1))],8,Je)):b("",!0),a.type!=="GRV"&&O(a)?(o(),c("button",{key:2,class:"px-2 py-1 text-[12px] rounded bg-zinc-100 hover:bg-zinc-200 inline-flex items-center gap-1",onClick:n=>X(a),title:"Cancel"},[(o(),c("svg",Ke,[s("path",{d:r(_e)},null,8,Ye)])),e[14]||(e[14]=h(" Cancel ",-1))],8,Qe)):b("",!0),a.type==="GRV"&&String(a.status).toLowerCase()==="submitted"?(o(),c("button",{key:3,class:"px-2 py-1 text-[12px] rounded bg-blue-100 hover:bg-blue-200 inline-flex items-center gap-1",onClick:n=>W(a),title:"In Review"},"In Review",8,He)):b("",!0),a.type==="GRV"&&String(a.status).toLowerCase()==="in_review"?(o(),c("button",{key:4,class:"px-2 py-1 text-[12px] rounded bg-emerald-100 hover:bg-emerald-200 inline-flex items-center gap-1",onClick:n=>Q(a),title:"Resolve"},"Resolve",8,Xe)):b("",!0),a.type==="GRV"&&String(a.status).toLowerCase()==="in_review"?(o(),c("button",{key:5,class:"px-2 py-1 text-[12px] rounded bg-rose-100 hover:bg-rose-200 inline-flex items-center gap-1",onClick:n=>K(a),title:"Reject"},"Reject",8,Ze)):b("",!0),s("button",{class:"px-2 py-1 text-[12px] rounded bg-rose-100 hover:bg-rose-200 inline-flex items-center gap-1",onClick:n=>Z(a),title:"Delete"},[(o(),c("svg",tt,[s("path",{d:r(ve)},null,8,at)])),e[15]||(e[15]=h(" Delete ",-1))],8,et)])]),_:1},8,["data","loading"]),_(we,{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=a=>w.value=a),mode:"edit",initial:B.value||{}},null,8,["modelValue","initial"]),_(ke,{modelValue:A.value,"onUpdate:modelValue":e[7]||(e[7]=a=>A.value=a),mode:"edit",initial:I.value||{}},null,8,["modelValue","initial"]),_(xe,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=a=>R.value=a),mode:"edit",initial:P.value||{}},null,8,["modelValue","initial"]),_(Ce,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=a=>S.value=a),mode:"edit",initial:U.value||{}},null,8,["modelValue","initial"])]),_:1})]),_:1}))}};export{Ct as default};
