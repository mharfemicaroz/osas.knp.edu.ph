import{c,u as be,o as _e,r as k,x as F,G as ye,a as n,d as u,q as r,e as s,t as m,k as _,h as p,C as I,g as Q,j as w,F as A,B,v as f,S as q}from"./index.BiRlO2qs.js";import{u as fe}from"./clubScope.JJLzrS1R.js";import{u as xe}from"./utilizationRequest.RcdcV9XD.js";import{u as ge}from"./club.BTPgQUot.js";import{u as he}from"./activityDesign.CyLx0Gic.js";const ke={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},we={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-full sm:w-[720px] max-w-[95vw] h-[100vh] sm:h-auto sm:max-h-[90vh] overflow-y-auto"},qe={class:"flex items-center justify-between mb-2"},Se={class:"flex items-center gap-2"},Ce={class:"text-base font-semibold"},Ae={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},Be={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},Ne={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},$e={class:"md:col-span-2"},Ue=["disabled"],Oe=["value"],Ve={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ee={key:1,class:"text-[11px] text-gray-500 mt-0.5"},Re={key:2,class:"text-[11px] text-amber-700 mt-0.5"},De={key:0,class:"text-red-600 text-[11px] mt-0.5"},ze=["disabled"],Le={key:0,class:"text-red-600 text-[11px] mt-0.5"},Te=["disabled"],Fe={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ie=["disabled"],je={key:0,class:"text-red-600 text-[11px] mt-0.5"},Me={class:"mt-2 text-sm"},Pe={class:"flex gap-1.5"},Je=["disabled"],Ge=["value"],He={class:"flex flex-col gap-1"},We=["disabled"],Qe={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ye={class:"mt-1.5 flex flex-wrap gap-1.5"},Ke=["onClick"],Xe={key:0,class:"text-gray-400 text-xs"},Ze={class:"mt-3 text-sm"},et={class:"flex items-center justify-between"},tt=["disabled"],st={class:"mt-1 border rounded overflow-hidden"},at={class:"w-full text-[12px]"},lt={class:"p-1.5"},it=["onUpdate:modelValue","disabled","onChange"],nt=["value"],rt={key:0,class:"text-red-600 mt-0.5 text-[11px]"},dt={class:"p-1.5"},ot=["onUpdate:modelValue","disabled"],ut={class:"p-1.5"},ct=["onUpdate:modelValue","disabled"],mt={class:"p-1.5 text-right"},vt=["disabled","onClick"],pt={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},bt=["disabled"],_t=["disabled"],yt={key:0,class:"text-red-600 text-[11px] mt-0.5"},ft={key:0},xt=["disabled"],gt={key:1,class:"mt-2 text-sm"},ht={class:"mt-2 p-2 rounded-lg border bg-white"},kt={class:"flex items-center justify-between"},wt=["disabled"],qt={class:"flex justify-end gap-1.5 mt-4"},St={key:1,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs"},Ut={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",noted_by:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(Y,{emit:K}){const N=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],O=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],y=Y,j=K,V=c({get:()=>y.modelValue,set:t=>j("update:modelValue",t)}),x=be(),$=xe(),S=ge(),C=he(),E=c(()=>String(x.user?.role||"").toLowerCase()==="admin"),R=c(()=>{const t=Array.isArray(C.items?.data)?C.items.data.filter(e=>String(e.status).toLowerCase()==="approved"):[];if(M.value&&g.value){const e=Number(g.value);return t.filter(i=>Number(i.club_id||i.club?.id)===e)}return t}),{isClub:M,activeClubId:g}=fe();_e(async()=>{const t={page:1,limit:200,status:"approved",officer:!0},e=M.value&&g.value?{...t,club_id:g.value}:t;await C.fetchAll(e,!0),(!Array.isArray(S.clubs?.data)||!S.clubs.data.length)&&await S.fetchAll({page:1,limit:200},!0)});const a=k({...y.initial}),d=k({}),D=k([]),P=t=>{if(!t)return[];if(Array.isArray(t))return t;try{return JSON.parse(t||"[]")||[]}catch{return[]}},U=c(()=>{const t=x.user?.last_name||"",e=(x.user?.first_name||"").slice(0,1);return`${t}${t?", ":""}${e?e+".":""}`}),z=k(!0),L=k(""),J=c(()=>{const t=Number(a.value.activity_design_id||0);return R.value.find(e=>Number(e.id)===t)||null}),G=c(()=>{const t=J.value;return Number(t?.club_id||t?.club?.id||0)||null}),H=t=>{const e=Number(t);return(S.clubs?.data||[]).find(l=>Number(l.id)===e)?.adviser||""},X=c(()=>{const t=G.value||g.value||null;return t?(H(t)||"").trim():""}),Z=c(()=>X.value.length>0),W=()=>{const t=G.value||g.value||null,e=t&&H(t)||"";(z.value||a.value.noted_by===L.value)&&(a.value.noted_by=e,L.value=e)};F(()=>y.initial,async t=>{a.value={...t,facilities:Array.isArray(t.facilities)?t.facilities:(()=>{try{return JSON.parse(t.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(t.equipment_items)?t.equipment_items:(()=>{try{return JSON.parse(t.equipment_items||"[]")}catch{return[]}})()},a.value.facilities=(a.value.facilities||[]).filter(e=>N.includes(e)),a.value.equipment_items=(a.value.equipment_items||[]).filter(e=>!e?.name||O.includes(e.name)),d.value={},D.value=P(t?.remarks),z.value=!(t&&String(t.noted_by||"").trim()),L.value=""},{immediate:!0}),F(()=>a.value.activity_design_id,()=>{const t=J.value;t?.date_of_implementation?a.value.start_date=String(t.date_of_implementation).slice(0,10):a.value.start_date="",W()},{immediate:!0}),F(()=>[g.value,S.clubs?.data?.length],()=>{W()},{immediate:!0});const ee=c(()=>String(a.value?.status||"").toLowerCase()),o=c(()=>y.mode==="edit"&&ee.value!=="draft"),te=c(()=>y.mode!=="edit"?"New Utilization Request":o.value?"View Utilization (read-only)":"Edit Utilization"),se=c(()=>y.mode==="edit"?"Save Changes":"Create");c(()=>y.mode==="edit");const ae=c(()=>y.mode==="edit"),le=t=>{const e=t?.name_of_activity||"Untitled",i=t?.school_year?` • SY ${t.school_year}`:"",l=t?.semester?` • ${t.semester}`:"",v=t?.reference_code?` [${t.reference_code}]`:"";return`${e}${i}${l}${v}`},h=k([]),ie=c(()=>N.filter(t=>!(a.value.facilities||[]).includes(t))),ne=()=>{const t=Array.isArray(h.value)?h.value.slice():[];t.length&&(Array.isArray(a.value.facilities)||(a.value.facilities=[]),t.forEach(e=>{N.includes(e)&&!a.value.facilities.includes(e)&&a.value.facilities.push(e)}),h.value=[])},re=t=>{a.value.facilities.splice(t,1)},de=()=>{Array.isArray(a.value.equipment_items)||(a.value.equipment_items=[]),a.value.equipment_items.push({name:"",qty:1,unit:""})},oe=t=>{a.value.equipment_items.splice(t,1)},T=t=>{const e=new Set((a.value.equipment_items||[]).map((i,l)=>l===t?null:i?.name).filter(Boolean));return O.filter(i=>!e.has(i))},ue=()=>{if(o.value)return!1;const t={};a.value.activity_design_id||(t.activity_design_id="Required"),a.value.noted_by?.trim()||(t.noted_by="Required"),a.value.start_date||(t.start_date="Start date is required (from Activity Design)"),a.value.start_time||(t.start_time="Required"),a.value.end_date||(t.end_date="Required"),a.value.end_time||(t.end_time="Required"),!Array.isArray(a.value.facilities)||!a.value.facilities.length?t.facilities="Select at least one":a.value.facilities.every(i=>N.includes(i))||(t.facilities="Invalid facility selected");const e=new Set;if(Array.isArray(a.value.equipment_items)&&a.value.equipment_items.forEach((i,l)=>{i?.name&&!O.includes(i.name)&&(t[`equipment_${l}`]="Invalid equipment"),i?.name&&e.has(i.name)&&(t[`equipment_${l}`]="Duplicate item; adjust quantity instead"),i?.name&&e.add(i.name),i?.name&&(isNaN(Number(i.qty))||Number(i.qty)<=0)&&(t[`equipment_${l}`]="Qty must be > 0")}),a.value.start_date&&a.value.end_date&&a.value.start_time&&a.value.end_time){const i=new Date(`${a.value.start_date}T${a.value.start_time}:00`);new Date(`${a.value.end_date}T${a.value.end_time}:00`)<i&&(t.end_time="End must be after or equal to start")}return d.value=t,Object.keys(t).length===0},ce=async()=>{if(!a.value.start_date||!a.value.end_date||!a.value.facilities?.length){await q.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const t=await $.checkAvailability({start_date:a.value.start_date,start_time:a.value.start_time||"00:00",end_date:a.value.end_date,end_time:a.value.end_time||"00:00",facilities:a.value.facilities}),e=t.available_for_all?"All selected facilities are available.":`Conflicts on: ${(t.conflict_facilities||[]).join(", ")||"—"}`;await q.fire({icon:t.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(t.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${e}</div>
      </div>`})}catch(t){await q.fire("Error",$.error||"Failed to check availability.","error"),console.error(t)}},me=()=>{if(o.value||!ue())return;const t={...a.value};x.user?.id&&(t.filed_by_user_id=x.user.id),E.value||delete t.file_by_user_name;const e=y.mode!=="edit"?"created utilization request":"updated utilization request";D.value.push({user_id:x.user?.id||null,user_name:U.value,message:`${U.value} ${e}.`,datetime:new Date().toISOString(),is_read:!1}),t.remarks=JSON.stringify(D.value),j("submit",t)},ve=c(()=>y.mode==="edit"&&E.value&&String(a.value.status||"").toLowerCase()==="pending"),pe=async()=>{if(!a.value?.id)return;const{value:t,isConfirmed:e}=await q.fire({title:"Cancel Utilization Request?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Reason for cancellation",showCancelButton:!0,confirmButtonText:"Cancel Request",confirmButtonColor:"#dc2626"});if(e)try{const i=P(a.value?.remarks),l=`${U.value} cancelled utilization request.${t?" - "+t:""}`;i.push({user_id:x.user?.id||null,user_name:U.value,message:l,datetime:new Date().toISOString()});const v=await $.cancel(a.value.id,JSON.stringify(i));a.value={...a.value,...v||{},status:v?.status||"cancelled"},await q.fire("Cancelled","Utilization Request has been cancelled.","success")}catch{await q.fire("Error",$.error||"Failed to cancel utilization request.","error")}};return(t,e)=>{const i=ye("pending-click");return V.value?(r(),n("div",ke,[s("div",we,[s("div",qe,[s("div",Se,[s("h2",Ce,m(te.value),1),s("span",Ae,m(a.value.status),1)]),s("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:e[0]||(e[0]=l=>V.value=!1)},"Close")]),o.value?(r(),n("div",Be,[e[12]||(e[12]=_(" This request is ",-1)),s("strong",null,m(a.value.status),1),e[13]||(e[13]=_(". Editing is disabled. ",-1))])):u("",!0),s("div",Ne,[s("div",$e,[e[15]||(e[15]=s("label",{class:"block mb-0.5"},[_("Activity Design "),s("span",{class:"text-red-500"},"*")],-1)),p(s("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.activity_design_id=l),class:w(["w-full border rounded px-2 py-1.5",d.value.activity_design_id?"border-red-500":""]),disabled:o.value||Q(C).isLoading},[e[14]||(e[14]=s("option",{value:""},"Select approved activity design…",-1)),(r(!0),n(A,null,B(R.value,l=>(r(),n("option",{key:l.id,value:l.id},m(le(l)),9,Oe))),128))],10,Ue),[[I,a.value.activity_design_id]]),d.value.activity_design_id?(r(),n("p",Ve,m(d.value.activity_design_id),1)):u("",!0),Q(C).isLoading?(r(),n("p",Ee,"Loading approved activities… ")):R.value.length?u("",!0):(r(),n("p",Re," No approved activity designs found. Approve an Activity Design first. "))]),s("div",null,[e[16]||(e[16]=s("label",{class:"block mb-0.5"},[_("Start Date "),s("span",{class:"text-red-500"},"*")],-1)),p(s("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>a.value.start_date=l),type:"date",class:w(["w-full border rounded px-2 py-1.5 bg-gray-50",d.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[f,a.value.start_date]]),d.value.start_date?(r(),n("p",De,m(d.value.start_date),1)):u("",!0)]),s("div",null,[e[17]||(e[17]=s("label",{class:"block mb-0.5"},[_("Start Time "),s("span",{class:"text-red-500"},"*")],-1)),p(s("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.start_time=l),type:"time",class:w(["w-full border rounded px-2 py-1.5",d.value.start_time?"border-red-500":""]),placeholder:"HH:MM",disabled:o.value},null,10,ze),[[f,a.value.start_time]]),d.value.start_time?(r(),n("p",Le,m(d.value.start_time),1)):u("",!0)]),s("div",null,[e[18]||(e[18]=s("label",{class:"block mb-0.5"},[_("End Date "),s("span",{class:"text-red-500"},"*")],-1)),p(s("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.end_date=l),type:"date",class:w(["w-full border rounded px-2 py-1.5",d.value.end_date?"border-red-500":""]),disabled:o.value},null,10,Te),[[f,a.value.end_date]]),d.value.end_date?(r(),n("p",Fe,m(d.value.end_date),1)):u("",!0)]),s("div",null,[e[19]||(e[19]=s("label",{class:"block mb-0.5"},[_("End Time "),s("span",{class:"text-red-500"},"*")],-1)),p(s("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>a.value.end_time=l),type:"time",class:w(["w-full border rounded px-2 py-1.5",d.value.end_time?"border-red-500":""]),placeholder:"HH:MM",disabled:o.value},null,10,Ie),[[f,a.value.end_time]]),d.value.end_time?(r(),n("p",je,m(d.value.end_time),1)):u("",!0)])]),s("div",Me,[e[22]||(e[22]=s("label",{class:"block mb-0.5"},[_("Facilities "),s("span",{class:"text-red-500"},"*")],-1)),s("div",Pe,[p(s("select",{"onUpdate:modelValue":e[6]||(e[6]=l=>h.value=l),multiple:"",size:"6",class:"border rounded px-2 py-1.5 min-w-[240px]",disabled:o.value},[e[20]||(e[20]=s("option",{value:""},"Select facility…",-1)),(r(!0),n(A,null,B(ie.value,l=>(r(),n("option",{key:l,value:l},m(l),9,Ge))),128))],8,Je),[[I,h.value]]),s("div",He,[s("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:o.value||!(h.value&&h.value.length),onClick:ne}," Add Selected ",8,We),e[21]||(e[21]=s("span",{class:"text-[10px] text-gray-500"},"Use Ctrl/Cmd or Shift to select multiple.",-1))])]),d.value.facilities?(r(),n("p",Qe,m(d.value.facilities),1)):u("",!0),s("div",Ye,[(r(!0),n(A,null,B(a.value.facilities,(l,v)=>(r(),n("span",{key:l,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[_(m(l)+" ",1),o.value?u("",!0):(r(),n("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:b=>re(v)},"×",8,Ke))]))),128)),a.value.facilities?.length?u("",!0):(r(),n("span",Xe,"No facilities selected"))])]),s("div",Ze,[s("div",et,[e[23]||(e[23]=s("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),s("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:o.value||T(-1).length===0,onClick:de}," Add Row ",8,tt)]),s("div",st,[s("table",at,[e[25]||(e[25]=s("thead",{class:"bg-gray-50"},[s("tr",null,[s("th",{class:"text-left p-1.5"},"Item"),s("th",{class:"text-left p-1.5"},"Qty"),s("th",{class:"text-left p-1.5"},"Unit"),s("th",{class:"p-1.5 w-14"})])],-1)),s("tbody",null,[(r(!0),n(A,null,B(a.value.equipment_items,(l,v)=>(r(),n("tr",{key:v,class:"border-t"},[s("td",lt,[p(s("select",{"onUpdate:modelValue":b=>l.name=b,class:"w-full border rounded px-2 py-1.5",disabled:o.value,onChange:()=>{(l.qty==null||l.qty<=0)&&(l.qty=1)}},[e[24]||(e[24]=s("option",{disabled:"",value:""},"Select item…",-1)),(r(!0),n(A,null,B(T(v).concat(l.name&&!T(v).includes(l.name)?[l.name]:[]),b=>(r(),n("option",{key:b,value:b},m(b),9,nt))),128))],40,it),[[I,l.name]]),d.value[`equipment_${v}`]?(r(),n("div",rt,m(d.value[`equipment_${v}`]),1)):u("",!0)]),s("td",dt,[p(s("input",{"onUpdate:modelValue":b=>l.qty=b,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:o.value,placeholder:"1"},null,8,ot),[[f,l.qty,void 0,{number:!0}]])]),s("td",ut,[p(s("input",{"onUpdate:modelValue":b=>l.unit=b,class:"w-24 border rounded px-2 py-1.5",disabled:o.value,placeholder:"e.g., pcs"},null,8,ct),[[f,l.unit]])]),s("td",mt,[s("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:o.value,onClick:b=>oe(v)}," Remove ",8,vt)])]))),128))])])]),e[26]||(e[26]=s("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),s("div",pt,[s("div",null,[e[27]||(e[27]=s("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),p(s("textarea",{"onUpdate:modelValue":e[7]||(e[7]=l=>a.value.utilization_details=l),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:o.value,placeholder:"e.g., 2 hours practice; stage and sound system"},null,8,bt),[[f,a.value.utilization_details]])]),s("div",null,[e[28]||(e[28]=s("label",{class:"block mb-0.5"},[_("Adviser (Noted by) "),s("span",{class:"text-red-500"},"*")],-1)),p(s("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>a.value.noted_by=l),class:w(["w-full border rounded px-2 py-1.5",d.value.noted_by?"border-red-500":""]),disabled:o.value||Z.value,placeholder:"Adviser name (noted by)",onInput:e[9]||(e[9]=l=>z.value=!1)},null,42,_t),[[f,a.value.noted_by]]),d.value.noted_by?(r(),n("p",yt,m(d.value.noted_by),1)):u("",!0)]),E.value?(r(),n("div",ft,[e[29]||(e[29]=s("label",{class:"block mb-0.5"},"Filer Name Override (optional)",-1)),p(s("input",{"onUpdate:modelValue":e[10]||(e[10]=l=>a.value.file_by_user_name=l),class:"w-full border rounded px-2 py-1.5",disabled:o.value,placeholder:"If provided, this name appears as the filer"},null,8,xt),[[f,a.value.file_by_user_name]])])):u("",!0)]),ae.value?(r(),n("div",gt)):u("",!0),s("div",ht,[s("div",kt,[e[30]||(e[30]=s("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),s("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:o.value,onClick:ce}," Run Check ",8,wt)]),e[31]||(e[31]=s("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),s("div",qt,[s("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:e[11]||(e[11]=l=>V.value=!1)},"Close"),ve.value?(r(),n("button",{key:0,class:"px-3 py-1.5 bg-red-600 text-white rounded text-xs",onClick:pe}," Cancel Request ")):u("",!0),o.value?u("",!0):p((r(),n("button",St,[_(m(se.value),1)])),[[i,me]])])])])):u("",!0)}}};export{Ut as _};
