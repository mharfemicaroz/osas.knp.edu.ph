import{c as B,u as de,r as k,o as ae,D as se,a as u,d as P,q as d,e as t,t as f,k as R,h as V,B as Q,F as Y,A as W,j as G,v as O,M as ue,g as C,S as g,f as $,l as N,z as ce,L as pe}from"./index.C4ttRr7x.js";import{B as me,E as fe,F as be,G as ve,H as _e,I as ye,C as he,D as xe,z as ge,_ as we,a as $e,g as Ce,J as ke,i as Ae,K as Se,L as Ve,M as Be,$ as Fe}from"./SectionMain.gJa-xx1u.js";import{_ as je,a as Pe,b as ie,B as Ue,c as Re}from"./Badge.DkMygoqP.js";import{_ as Te}from"./ActivityRowActions.Dt4eBRme.js";import{u as le}from"./annualPlan._3vfP-Xb.js";import{i as De,a as Ee,b as Ie,F as Le}from"./index.DOmgzfuE.js";import"./ToasterComponent.BkcYJvl0.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./IconifyButton.DB0jVMzH.js";const Me={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},Ne={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},Oe={class:"flex items-center justify-between mb-3"},Ye={class:"flex items-center gap-3"},ze={class:"text-lg font-semibold"},We={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},qe={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},Ge={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},Je=["disabled"],Ke=["value"],Xe={key:0,class:"text-[11px] text-red-600 mt-1"},Qe=["disabled"],He=["value"],Ze={key:0,class:"text-[11px] text-red-600 mt-1"},et=["disabled"],tt={class:"mt-4"},at={class:"flex items-center justify-between"},st=["disabled"],lt={key:0,class:"text-[12px] text-red-600 mb-1"},nt={class:"mt-1 border rounded overflow-hidden"},ot={class:"w-full text-xs"},it={class:"p-2"},rt=["onUpdate:modelValue","disabled"],dt={class:"p-2"},ut=["onUpdate:modelValue","disabled"],ct={class:"p-2"},pt=["onUpdate:modelValue","disabled"],mt={class:"p-2"},ft=["onUpdate:modelValue","disabled"],bt={class:"p-2"},vt=["onUpdate:modelValue","disabled"],_t={class:"p-2"},yt=["onUpdate:modelValue","disabled"],ht={class:"p-2 text-right"},xt=["disabled","onClick"],gt={class:"mt-2 text-right text-sm"},wt={class:"flex justify-end gap-2 mt-5"},re={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(q,{emit:c}){const y=q,F=c,A=B({get:()=>y.modelValue,set:i=>F("update:modelValue",i)}),h=de();le();const v=B(()=>{const i=new Date().getFullYear();return Array.from({length:6},(n,o)=>`${i-o}-${i-o+1}`)}),S=k([]);ae(async()=>{try{const{data:i}=await ue.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});S.value=Array.isArray(i?.data)?i.data:[]}catch{S.value=[]}});const p=k(structuredClone(y.initial)),m=k({});se(()=>y.initial,i=>{let n=i?.plans;try{n=Array.isArray(n)?n:JSON.parse(n||"[]")}catch{n=[]}p.value={...i,filed_by_user_id:i?.filed_by_user_id||h.user?.id||"",plans:Array.isArray(n)?n:[]},m.value={}},{immediate:!0});const r=B(()=>y.mode==="edit"&&String(p.value.status||"").toLowerCase()!=="draft"),_=B(()=>y.mode!=="edit"?"New Annual Plan":r.value?"View Annual Plan (read-only)":"Edit Annual Plan"),b=B(()=>y.mode==="edit"?"Save Changes":"Create"),x=i=>Number(i||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),D=i=>Number.isFinite(+i)?+i:0,E=B(()=>Array.isArray(p.value.plans)?p.value.plans.reduce((i,n)=>i+D(n?.funds),0):0),I=()=>{Array.isArray(p.value.plans)||(p.value.plans=[]),p.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},U=i=>{p.value.plans.splice(i,1)},j=/^\d{4}-\d{4}$/,M=()=>{if(r.value)return!1;const i={};return(!p.value.school_year||!j.test(p.value.school_year))&&(i.school_year="Format: YYYY-YYYY"),p.value.club_id||(i.club_id="Required"),(!Array.isArray(p.value.plans)||!p.value.plans.length)&&(i.plans="Add at least one plan item"(p.value.plans||[]).forEach((n,o)=>{n.item||(i[`plans_${o}_item`]="Required"),n.date_of_implementation||(i[`plans_${o}_date`]="Required"),n.funds!=null&&Number(n.funds)<0&&(i[`plans_${o}_funds`]="Must be ≥ 0")})),m.value=i,Object.keys(i).length===0},J=()=>{if(r.value||!M())return;const i={...p.value};!i.filed_by_user_id&&h.user?.id&&(i.filed_by_user_id=h.user.id),F("submit",i)};return(i,n)=>A.value?(d(),u("div",Me,[t("div",Ne,[t("div",Oe,[t("div",Ye,[t("h2",ze,f(_.value),1),t("span",We,f(p.value.status),1)]),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:n[0]||(n[0]=o=>A.value=!1)},"Close")]),r.value?(d(),u("div",qe,[n[5]||(n[5]=R(" This plan is ",-1)),t("strong",null,f(p.value.status),1),n[6]||(n[6]=R(". Editing is disabled. ",-1))])):P("",!0),t("div",Ge,[t("div",null,[n[8]||(n[8]=t("label",{class:"block mb-1"},[R("School Year "),t("span",{class:"text-red-500"},"*")],-1)),V(t("select",{"onUpdate:modelValue":n[1]||(n[1]=o=>p.value.school_year=o),class:"w-full border rounded px-2.5 py-2",disabled:r.value},[n[7]||(n[7]=t("option",{value:""},"Select school year…",-1)),(d(!0),u(Y,null,W(v.value,o=>(d(),u("option",{key:o,value:o},f(o),9,Ke))),128))],8,Je),[[Q,p.value.school_year]]),m.value.school_year?(d(),u("p",Xe,f(m.value.school_year),1)):P("",!0)]),t("div",null,[n[10]||(n[10]=t("label",{class:"block mb-1"},[R("Club "),t("span",{class:"text-red-500"},"*")],-1)),V(t("select",{"onUpdate:modelValue":n[2]||(n[2]=o=>p.value.club_id=o),class:G(["w-full border rounded px-2.5 py-2",m.value.club_id?"border-red-500":""]),disabled:r.value||!S.value.length},[n[9]||(n[9]=t("option",{value:""},"Select club…",-1)),(d(!0),u(Y,null,W(S.value,o=>(d(),u("option",{key:o.id,value:o.id},f(o.name)+" ("+f(o.code)+") ",9,He))),128))],10,Qe),[[Q,p.value.club_id]]),m.value.club_id?(d(),u("p",Ze,f(m.value.club_id),1)):P("",!0)]),t("div",null,[n[11]||(n[11]=t("label",{class:"block mb-1"},"Remarks",-1)),V(t("input",{"onUpdate:modelValue":n[3]||(n[3]=o=>p.value.remarks=o),class:"w-full border rounded px-2.5 py-2",disabled:r.value},null,8,et),[[O,p.value.remarks]])])]),t("div",tt,[t("div",at,[n[12]||(n[12]=t("label",{class:"block mb-1 font-medium"},[R("Plan Items "),t("span",{class:"text-red-500"},"*")],-1)),t("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:r.value,onClick:I},"Add Item",8,st)]),m.value.plans?(d(),u("p",lt,f(m.value.plans),1)):P("",!0),t("div",nt,[t("table",ot,[n[13]||(n[13]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-2"},"Item"),t("th",{class:"text-left p-2"},"Description"),t("th",{class:"text-left p-2"},"Date of Implementation"),t("th",{class:"text-left p-2"},"Funds"),t("th",{class:"text-left p-2"},"Venue"),t("th",{class:"text-left p-2"},"Notes"),t("th",{class:"p-2 w-16"})])],-1)),t("tbody",null,[(d(!0),u(Y,null,W(p.value.plans,(o,L)=>(d(),u("tr",{key:L,class:"border-t"},[t("td",it,[V(t("input",{"onUpdate:modelValue":w=>o.item=w,class:G(["w-40 border rounded px-2 py-1",m.value[`plans_${L}_item`]?"border-red-500":""]),disabled:r.value},null,10,rt),[[O,o.item]])]),t("td",dt,[V(t("input",{"onUpdate:modelValue":w=>o.description=w,class:"w-60 border rounded px-2 py-1",disabled:r.value},null,8,ut),[[O,o.description]])]),t("td",ct,[V(t("input",{type:"date","onUpdate:modelValue":w=>o.date_of_implementation=w,class:G(["border rounded px-2 py-1",m.value[`plans_${L}_date`]?"border-red-500":""]),disabled:r.value},null,10,pt),[[O,o.date_of_implementation]])]),t("td",mt,[V(t("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":w=>o.funds=w,class:G(["w-28 border rounded px-2 py-1",m.value[`plans_${L}_funds`]?"border-red-500":""]),disabled:r.value},null,10,ft),[[O,o.funds,void 0,{number:!0}]])]),t("td",bt,[V(t("input",{"onUpdate:modelValue":w=>o.venue=w,class:"w-40 border rounded px-2 py-1",disabled:r.value},null,8,vt),[[O,o.venue]])]),t("td",_t,[V(t("input",{"onUpdate:modelValue":w=>o.notes=w,class:"w-52 border rounded px-2 py-1",disabled:r.value},null,8,yt),[[O,o.notes]])]),t("td",ht,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:r.value,onClick:w=>U(L)},"Remove",8,xt)])]))),128))])])]),t("div",gt,[n[14]||(n[14]=t("span",{class:"mr-4"},"Client total (preview):",-1)),t("strong",null,f(x(E.value)),1),n[15]||(n[15]=t("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),t("div",wt,[t("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:n[4]||(n[4]=o=>A.value=!1)},"Close"),r.value?P("",!0):(d(),u("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:J},f(b.value),1))])])])):P("",!0)}},$t={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},Ct={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},kt={class:"flex items-center justify-between mb-3"},At={class:"text-lg font-semibold"},St={class:"text-gray-600"},Vt={class:"flex items-center justify-between gap-2"},Bt={class:"text-sm text-gray-600"},Ft={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},jt=["d"],Pt=["disabled"],Ut={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},Rt={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Tt=["src"],Dt={key:1,class:"flex items-center justify-center w-full h-full"},Et=["d"],It={class:"mt-2 text-xs"},Lt=["title"],Mt={class:"text-gray-500 flex items-center justify-between"},Nt={key:0},Ot={key:0},Yt={class:"mt-2 flex items-center justify-between gap-2"},zt=["onClick","title"],Wt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},qt=["d"],Gt=["onClick"],Jt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Kt=["d"],Xt={key:0,class:"mt-6 text-center text-sm text-gray-500"},Qt=10*1024*1024,Ht={__name:"AnnualPlanAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(q,{emit:c}){const y=q,F=c,A=B({get:()=>y.modelValue,set:a=>F("update:modelValue",a)}),h=le(),v=k(null),S=k(!1),z=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),p=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),m=(a="")=>String(a).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",r=(a="")=>typeof a=="string"&&a.match(/^data:([^;]+);base64,/i)?.[1]||"",_=a=>a?.type&&z.has(a.type)||a?.name&&p.has(m(a.name)),b=(a="")=>String(a).startsWith("image/"),x=(a="")=>a==="application/pdf",D=(a="")=>a==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",E=(a="")=>a==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",I=(a="")=>x(a)?fe:D(a)?be:E(a)?ve:b(a)?_e:ye,U=(a="")=>x(a)?"PDF":D(a)?"Word":E(a)?"Excel":b(a)?"Image":"File",j=(a="")=>x(a)?"pdf":D(a)?"docx":E(a)?"xlsx":a==="image/png"?"png":a==="image/jpeg"?"jpg":a==="image/webp"?"webp":"",M=(a="attachment",s="")=>/\.[a-z0-9]+$/i.test(a)?a:s?`${a}.${s.startsWith(".")?s.slice(1):s}`:a,J=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,i=B(()=>{const a=v.value?.attachments;if(!a)return[];try{return Array.isArray(a)?a:JSON.parse(a||"[]")}catch{return[]}}),n=B(()=>(i.value||[]).map((a,s)=>{const e=a.mime||r(a.data)||"",l=m(a.name||"")||j(e),T=a.size??null,X=a.name||`${U(e)} ${s+1}`;return{id:a.id??s+1,name:X,data:a.data||"",url:a.url||a.href||a.path||"",mime:e,ext:l,size:T,filename:M(X,l)}}));se(()=>y.modelValue,async a=>{a&&y.row?.id&&(await h.fetchById(y.row.id),v.value=h.selected||y.row)});const o=async a=>{const s=a.target.files?.[0];if(a.target.value="",!(!s||!v.value?.id)){if(s.size>Qt){await g.fire("File too large","Maximum size is 10 MB.","warning");return}if(!_(s)){await g.fire("Unsupported file","Only images, PDF, DOCX, XLSX allowed.","warning");return}try{S.value=!0,await h.uploadAttachment(v.value.id,s),await h.fetchById(v.value.id),v.value=h.selected}finally{S.value=!1}}},L=async a=>{!v.value?.id||!(await g.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await h.deleteAttachment(v.value.id,a),await h.fetchById(v.value.id),v.value=h.selected)},w=a=>{if(a.data&&String(a.data).startsWith("data:")&&b(a.mime)){const s=window.open();s&&s.document.write(`<img src="${a.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}a.url&&window.open(String(a.url),"_blank")},ne=a=>{const[s,e]=a.split(","),l=s.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",T=atob(e),X=new Uint8Array(T.length);for(let te=0;te<T.length;te++)X[te]=T.charCodeAt(te);return new Blob([X],{type:l})},H=(a,s)=>{const e=URL.createObjectURL(a),l=document.createElement("a");l.href=e,l.download=s||"download",document.body.appendChild(l),l.click(),l.remove(),setTimeout(()=>URL.revokeObjectURL(e),1e3)},oe=async a=>{if(a.data&&String(a.data).startsWith("data:")){H(ne(a.data),a.filename);return}if(a.url)try{const e=await(await fetch(a.url,{credentials:"include"})).blob();H(e,a.filename)}catch{const s=document.createElement("a");s.href=String(a.url),s.setAttribute("download",a.filename),document.body.appendChild(s),s.click(),s.remove()}},Z=a=>b(a.mime)?"Open":"Download",K=a=>b(a.mime)?he:xe,ee=a=>b(a.mime)?w(a):oe(a);return(a,s)=>A.value?(d(),u("div",$t,[t("div",Ct,[t("div",kt,[t("h2",At,[s[1]||(s[1]=R(" Annual Plan Attachments — ",-1)),t("span",St,f(v.value?.reference_code||""),1)]),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:s[0]||(s[0]=e=>A.value=!1)},"Close")]),t("div",Vt,[t("div",Bt,[s[2]||(s[2]=R(" School Year: ",-1)),t("strong",null,f(v.value?.school_year||"—"),1)]),t("label",{class:G(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":S.value}])},[(d(),u("svg",Ft,[t("path",{d:C(me)},null,8,jt)])),t("span",null,f(S.value?"Uploading…":"Upload"),1),t("input",{type:"file",class:"hidden",disabled:S.value,onChange:o,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,Pt)],2)]),t("div",Ut,[(d(!0),u(Y,null,W(n.value,e=>(d(),u("div",{key:e.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[t("div",Rt,[e.data&&e.data.startsWith("data:")&&e.mime?.startsWith("image/")?(d(),u("img",{key:0,src:e.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Tt)):(d(),u("div",Dt,[(d(),u("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:G({"text-red-600":e.mime==="application/pdf","text-blue-600":e.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":e.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!e.mime||!e.mime.startsWith("image/")&&e.mime!=="application/pdf"})},[t("path",{d:I(e.mime)},null,8,Et)],2))]))]),t("div",It,[t("div",{class:"font-medium truncate",title:e.name},f(e.name),9,Lt),t("div",Mt,[t("span",null,[R(f(U(e.mime))+" ",1),e.ext?(d(),u("span",Nt,"("+f(e.ext.toUpperCase())+")",1)):P("",!0)]),e.size?(d(),u("span",Ot,f(J(e.size)),1)):P("",!0)])]),t("div",Yt,[t("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:l=>ee(e),title:Z(e)},[(d(),u("svg",Wt,[t("path",{d:K(e)},null,8,qt)])),R(" "+f(Z(e)),1)],8,zt),t("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:l=>L(e.id),title:"Remove"},[(d(),u("svg",Jt,[t("path",{d:C(ge)},null,8,Kt)])),s[3]||(s[3]=R(" Remove ",-1))],8,Gt)])]))),128))]),n.value.length?P("",!0):(d(),u("div",Xt," No attachments yet. "))])])):P("",!0)}},Zt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},ea={class:"bg-white rounded-2xl shadow-2xl w-[1200px] max-w-[95vw] max-h-[90vh] overflow-hidden"},ta={class:"px-4 py-3 border-b flex items-center justify-between"},aa={class:"p-3 overflow-auto"},sa={__name:"AnnualPlansCalendarModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(q,{emit:c}){const y=q,F=c,A=B({get:()=>y.modelValue,set:_=>F("update:modelValue",_)}),h=le(),v=k([]),S=_=>{if(Array.isArray(_))return _;try{return JSON.parse(_||"[]")}catch{return[]}},z=(_=[])=>{const b=[];_.forEach(x=>{const D=S(x.plans),E=x.club?.name?`[${x.club.name}] `:"";D.forEach((I,U)=>{const j=I?.date_of_implementation;if(!j)return;const M=`${E}${I.item||"Planned Activity"}`;b.push({id:`${x.id}-${U}`,title:M,start:`${j}T00:00:00`,end:`${j}T23:59:59`,backgroundColor:"#10b981",borderColor:"#0ea5e9",textColor:"#0b1b13",extendedProps:{annual_plan_id:x.id,reference_code:x.reference_code,school_year:x.school_year,funds:I?.funds??0,status:x.status}})})}),v.value=b},p=async()=>{await h.fetchAll({page:1,limit:500,status:"approved",sort:"created_at",order:"ASC"},!0),z(h.items.data||[])},m=_=>{const b=_?.event?.extendedProps?.annual_plan_id;b&&F("open",Number(b))},r=B(()=>({plugins:[De,Ee,Ie],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:m,events:v.value}));return se(()=>y.modelValue,_=>{_&&p()}),se(()=>h.items.data,_=>{A.value&&z(_||[])},{deep:!0}),ae(()=>{A.value&&p()}),(_,b)=>A.value?(d(),u("div",Zt,[t("div",ea,[t("div",ta,[b[1]||(b[1]=t("h2",{class:"text-base font-semibold"},"Annual Plans Calendar (Approved)",-1)),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:b[0]||(b[0]=x=>A.value=!1)},"Close")]),t("div",aa,[$(C(Le),{options:r.value},null,8,["options"])]),b[2]||(b[2]=t("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click a plan item to open its Annual Plan. ",-1))])])):P("",!0)}},la={class:"flex items-center gap-2"},na={class:"p-3 mb-4 rounded-xl border bg-white/60"},oa={class:"flex items-center gap-2 mb-2 text-gray-700"},ia={class:"w-4 h-4",viewBox:"0 0 24 24"},ra=["d"],da={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},ua={class:"md:col-span-2 flex"},ca={class:"w-5 h-5",viewBox:"0 0 24 24"},pa=["d"],ma=["value"],fa=["disabled"],ba=["value"],va=["value"],_a={class:"flex items-center gap-2 md:col-span-2"},ya={class:"font-medium"},Va={__name:"AnnualPlansPage",setup(q){const c=le(),y=de(),F=k(!1),A=()=>{F.value=!0},h=async s=>{try{await c.fetchById(s);const e=c.selected;e&&await n(e)}catch(e){console.error(e)}finally{F.value=!1}},v=k([]);ae(async()=>{try{const{data:s}=await ue.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});v.value=Array.isArray(s?.data)?s.data:[]}catch{v.value=[]}});const z=s=>v.value.find(e=>e.id===Number(s))?.name||"—",p=B(()=>{const s=new Date().getFullYear();return Array.from({length:6},(e,l)=>`${s-l}-${s-l+1}`)}),m=k({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:""}),r=async(s={},e=!0)=>{m.value={...m.value,...s};const l={...m.value};["q","status","school_year","club_id","filed_by_user_id","approver_user_id"].forEach(T=>{(l[T]===""||l[T]==null)&&delete l[T]}),await c.fetchAll(l,e)};ae(async()=>{await r({page:1,limit:10})});const _=B(()=>({total:c.items.total||0,totalPages:c.items.totalPages||1,currentPage:c.items.currentPage||1,pageSize:c.items.pageSize||10,data:c.items.data||[]})),b=["draft","pending","approved","rejected","cancelled","archived"],x=s=>{switch(String(s||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"archived":return"slate";default:return"gray"}},D=s=>{const e=Number(s);return Number.isFinite(e)?e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},E=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"school_year",label:"School Year",sortable:!0,width:120},{key:"club",label:"Club",sortable:!1,minWidth:200,formatter:(s,e)=>e.club?.name||z(e.club_id)||""},{key:"total_budget",label:"Total Budget",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:110},{key:"created_at",label:"Created",sortable:!0,width:170}],I=async s=>{await r(s)},U=k(!1),j=k(!1),M=k(null),J=()=>{U.value=!0},i=async s=>{await c.create(s),U.value=!1,await r({},!0)},n=async s=>{await c.fetchById(s.id);const e=c.selected||s;let l=[];try{l=Array.isArray(e.plans)?e.plans:JSON.parse(e.plans||"[]")}catch{}M.value={id:e.id,reference_code:e.reference_code,school_year:e.school_year||"",club_id:e.club_id||"",filed_by_user_id:e.filed_by_user_id||y.user?.id||"",approver_user_id:e.approver_user_id||"",plans:l,remarks:e.remarks||"",status:e.status||"draft"},j.value=!0},o=async s=>{const{id:e,...l}=s;await c.updateById(e,l),j.value=!1,await r({},!0)},L=async s=>{if(!s?.id)return;(await g.fire({title:`Delete annual plan "${s.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await c.deleteById(s.id),await r({},!0),await g.fire("Deleted","The annual plan has been deleted.","success"))},w=async s=>{await n(s)},ne=async s=>{if((await g.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel"})).isConfirmed)try{await c.submit(s.id),await r({},!0),await g.fire("Submitted","Annual plan is now pending approval.","success")}catch{await g.fire("Error",c.error||"Failed to submit.","error")}},H=async s=>{const e=await g.fire({title:"Approve annual plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(e.isConfirmed)try{await c.approve(s.id,e.value||""),await r({},!0),await g.fire("Approved","Annual plan has been approved.","success")}catch{await g.fire("Error",c.error||"Failed to approve.","error")}},oe=async s=>{const e=await g.fire({title:"Reject annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:l=>l?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(e.isConfirmed)try{await c.reject(s.id,e.value),await r({},!0),await g.fire("Rejected","Annual plan has been rejected.","success")}catch{await g.fire("Error",c.error||"Failed to reject.","error")}},Z=async s=>{const e=await g.fire({title:"Cancel annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:l=>l?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Plan",cancelButtonText:"Keep"});if(e.isConfirmed)try{await c.cancel(s.id,e.value),await r({},!0),await g.fire("Cancelled","Annual plan has been cancelled.","success")}catch{await g.fire("Error",c.error||"Failed to cancel.","error")}},K=k(!1),ee=k(null),a=async s=>{await c.fetchById(s.id),ee.value=c.selected||s,K.value=!0};return(s,e)=>(d(),u(Y,null,[$(we,null,{default:N(()=>[$($e,null,{default:N(()=>[C(c).error?(d(),ce(je,{key:0,icon:C(Ce),color:"danger"},{default:N(()=>[R(f(C(c).error),1)]),_:1},8,["icon"])):P("",!0),$(Pe,{icon:C(ke),title:"Annual Plans",main:""},{default:N(()=>[t("div",la,[$(ie,{icon:C(Ae),color:"info",label:"View Calendar",onClick:A},null,8,["icon"]),$(ie,{icon:C(Se),color:"primary",label:"New Annual Plan",onClick:J},null,8,["icon"]),$(ie,{icon:C(Ve),color:"info",label:"Refresh",onClick:e[0]||(e[0]=l=>r({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),t("div",na,[t("div",oa,[(d(),u("svg",ia,[t("path",{d:C(Be)},null,8,ra)])),e[13]||(e[13]=t("span",{class:"font-medium text-sm"},"Filters",-1))]),t("div",da,[t("div",ua,[V(t("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>m.value.q=l),placeholder:"Search by ref, school year, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:e[2]||(e[2]=pe(l=>r({page:1}),["enter"]))},null,544),[[O,m.value.q]]),t("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:e[3]||(e[3]=l=>r({page:1}))},[(d(),u("svg",ca,[t("path",{d:C(Fe)},null,8,pa)]))])]),V(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>m.value.status=l),class:"border rounded px-2 py-2"},[e[14]||(e[14]=t("option",{value:""},"All status",-1)),(d(),u(Y,null,W(b,l=>t("option",{key:l,value:l},f(l),9,ma)),64))],512),[[Q,m.value.status]]),V(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>m.value.school_year=l),class:"border rounded px-2 py-2",disabled:s.readOnly},[e[15]||(e[15]=t("option",{value:""},"Select school year…",-1)),(d(!0),u(Y,null,W(p.value,l=>(d(),u("option",{key:l,value:l},f(l),9,ba))),128))],8,fa),[[Q,m.value.school_year]]),V(t("select",{"onUpdate:modelValue":e[6]||(e[6]=l=>m.value.club_id=l),class:"border rounded px-2 py-2"},[e[16]||(e[16]=t("option",{value:""},"Any club",-1)),(d(!0),u(Y,null,W(v.value,l=>(d(),u("option",{key:l.id,value:l.id},f(l.name),9,va))),128))],512),[[Q,m.value.club_id]]),t("div",_a,[t("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:e[7]||(e[7]=l=>r({page:1}))}," Apply Filters "),t("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:e[8]||(e[8]=()=>{m.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:""},r({page:1},!0)})},"Reset")])])]),$(Ue,{columns:E,data:_.value,loading:C(c).isLoading,onQueryChange:I},{"cell-total_budget":N(({value:l})=>[t("span",ya,f(D(l)),1)]),"cell-created_at":N(({value:l})=>[t("span",null,f(l?new Date(l).toLocaleString():"—"),1)]),"cell-status":N(({value:l})=>[$(Re,{text:l||"—",tone:x(l)},null,8,["text","tone"])]),"cell-actions":N(({row:l})=>[$(Te,{row:l,moderator:["admin","manager"].includes(String(C(y).user?.role||"").toLowerCase()),onAttachments:a,onSubmit:ne,onApprove:H,onReject:oe,onEdit:n,onDelete:L,onView:T=>w(l),onCancel:Z},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),$(re,{modelValue:U.value,"onUpdate:modelValue":e[9]||(e[9]=l=>U.value=l),mode:"create",onSubmit:i},null,8,["modelValue"]),$(re,{modelValue:j.value,"onUpdate:modelValue":e[10]||(e[10]=l=>j.value=l),mode:"edit",initial:M.value||{},onSubmit:o},null,8,["modelValue","initial"]),$(Ht,{modelValue:K.value,"onUpdate:modelValue":e[11]||(e[11]=l=>K.value=l),row:ee.value},null,8,["modelValue","row"]),$(sa,{modelValue:F.value,"onUpdate:modelValue":e[12]||(e[12]=l=>F.value=l),onOpen:h},null,8,["modelValue"])],64))}};export{Va as default};
