import{c as O,u as Ae,o as ve,r as B,D as de,a as b,d as U,q as v,e,t as k,k as Y,h as q,B as ne,g as z,j as se,F as H,A as Z,v as J,S as T,f as D,l as le,z as be,L as Te,P as ge}from"./index.BbiYfjGA.js";import{E as Be,a as G,d as ye,Q as Ee,b as _e}from"./browser.D62p3eKz.js";import{B as Fe,E as Ve,F as Ue,G as Re,H as qe,I as Ne,C as De,D as ze,z as Oe,_ as Ie,a as Le,g as Pe,J as je,i as Me,Z as Ye,K as We,L as Ge,M as Ke,$ as Qe}from"./SectionMain.DHtdM3Z9.js";import{_ as Je,a as He,b as me,B as Xe,c as pe}from"./Badge.CYAmDVIK.js";import{_ as Ze}from"./ActivityRowActions.DftTmDMU.js";import{u as ue}from"./utilizationRequest.BeEz6hfJ.js";import{u as et}from"./activityDesign.DDUDpsi_.js";import{i as tt,a as at,b as lt,F as it}from"./index.Dcw8rJLs.js";import"./ToasterComponent.CsWuApyM.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./IconifyButton.koJBRCal.js";const st={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},nt={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-[720px] max-h-[85vh] overflow-y-auto"},ot={class:"flex items-center justify-between mb-2"},rt={class:"flex items-center gap-2"},dt={class:"text-base font-semibold"},ut={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},ct={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},mt={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},pt={class:"md:col-span-2"},ft=["disabled"],vt=["value"],yt={key:0,class:"text-red-600 text-[11px] mt-0.5"},bt={key:1,class:"text-[11px] text-gray-500 mt-0.5"},gt={key:2,class:"text-[11px] text-amber-700 mt-0.5"},_t={key:0,class:"text-red-600 text-[11px] mt-0.5"},xt=["disabled"],ht={key:0,class:"text-red-600 text-[11px] mt-0.5"},wt=["disabled"],Ct={key:0,class:"text-red-600 text-[11px] mt-0.5"},St=["disabled"],At={key:0,class:"text-red-600 text-[11px] mt-0.5"},kt={class:"mt-2 text-sm"},$t={class:"flex gap-1.5"},Tt=["disabled"],Bt=["value"],Et=["disabled"],Ft={key:0,class:"text-red-600 text-[11px] mt-0.5"},Vt={class:"mt-1.5 flex flex-wrap gap-1.5"},Ut=["onClick"],Rt={key:0,class:"text-gray-400 text-xs"},qt={class:"mt-3 text-sm"},Nt={class:"flex items-center justify-between"},Dt=["disabled"],zt={class:"mt-1 border rounded overflow-hidden"},Ot={class:"w-full text-[12px]"},It={class:"p-1.5"},Lt=["onUpdate:modelValue","disabled","onChange"],Pt=["value"],jt={key:0,class:"text-red-600 mt-0.5 text-[11px]"},Mt={class:"p-1.5"},Yt=["onUpdate:modelValue","disabled"],Wt={class:"p-1.5"},Gt=["onUpdate:modelValue","disabled"],Kt={class:"p-1.5 text-right"},Qt=["disabled","onClick"],Jt={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},Ht=["disabled"],Xt=["disabled"],Zt={class:"mt-2 p-2 rounded-lg border bg-white"},ea={class:"flex items-center justify-between"},ta=["disabled"],aa={class:"flex justify-end gap-1.5 mt-4"},xe={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(t,{emit:i}){const A=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],m=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],h=t,C=i,p=O({get:()=>h.modelValue,set:d=>C("update:modelValue",d)}),$=Ae(),R=ue(),F=et(),x=O(()=>Array.isArray(F.items?.data)?F.items.data.filter(d=>String(d.status).toLowerCase()==="approved"):[]);ve(async()=>{await F.fetchAll({page:1,limit:200,status:"approved",officer:!0},!0)});const n=B({...h.initial}),y=B({}),c=O(()=>{const d=Number(n.value.activity_design_id||0);return x.value.find(o=>Number(o.id)===d)||null});de(()=>h.initial,d=>{n.value={...d,facilities:Array.isArray(d.facilities)?d.facilities:(()=>{try{return JSON.parse(d.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(d.equipment_items)?d.equipment_items:(()=>{try{return JSON.parse(d.equipment_items||"[]")}catch{return[]}})()},n.value.facilities=(n.value.facilities||[]).filter(o=>A.includes(o)),n.value.equipment_items=(n.value.equipment_items||[]).filter(o=>!o?.name||m.includes(o.name)),y.value={}},{immediate:!0}),de(()=>n.value.activity_design_id,()=>{const d=c.value;d?.date_of_implementation?n.value.start_date=String(d.date_of_implementation).slice(0,10):n.value.start_date=""},{immediate:!0});const S=O(()=>String(n.value?.status||"").toLowerCase()),r=O(()=>h.mode==="edit"&&S.value!=="draft"),w=O(()=>h.mode!=="edit"?"New Utilization Request":r.value?"View Utilization (read-only)":"Edit Utilization"),ee=O(()=>h.mode==="edit"?"Save Changes":"Create"),W=d=>{const o=d?.name_of_activity||"Untitled",u=d?.school_year?` • SY ${d.school_year}`:"",V=d?.semester?` • ${d.semester}`:"",a=d?.reference_code?` [${d.reference_code}]`:"";return`${o}${u}${V}${a}`},E=B(""),I=O(()=>A.filter(d=>!(n.value.facilities||[]).includes(d))),L=()=>{const d=E.value;!d||!A.includes(d)||(Array.isArray(n.value.facilities)||(n.value.facilities=[]),n.value.facilities.includes(d)||n.value.facilities.push(d),E.value="")},K=d=>{n.value.facilities.splice(d,1)},N=()=>{Array.isArray(n.value.equipment_items)||(n.value.equipment_items=[]);const d=new Set((n.value.equipment_items||[]).map(u=>u?.name).filter(Boolean)),o=m.find(u=>!d.has(u))||m[0];d.has(o)||n.value.equipment_items.push({name:o,qty:1,unit:""})},P=d=>{n.value.equipment_items.splice(d,1)},j=d=>{const o=new Set((n.value.equipment_items||[]).map((u,V)=>V===d?null:u?.name).filter(Boolean));return m.filter(u=>!o.has(u))},X=()=>{if(r.value)return!1;const d={};n.value.activity_design_id||(d.activity_design_id="Required"),n.value.start_date||(d.start_date="Start date is required (from Activity Design)"),n.value.start_time||(d.start_time="Required"),n.value.end_date||(d.end_date="Required"),n.value.end_time||(d.end_time="Required"),!Array.isArray(n.value.facilities)||!n.value.facilities.length?d.facilities="Select at least one":n.value.facilities.every(u=>A.includes(u))||(d.facilities="Invalid facility selected");const o=new Set;if(Array.isArray(n.value.equipment_items)&&n.value.equipment_items.forEach((u,V)=>{u?.name&&!m.includes(u.name)&&(d[`equipment_${V}`]="Invalid equipment"),u?.name&&o.has(u.name)&&(d[`equipment_${V}`]="Duplicate item; adjust quantity instead"),u?.name&&o.add(u.name),u?.name&&(isNaN(Number(u.qty))||Number(u.qty)<=0)&&(d[`equipment_${V}`]="Qty must be > 0")}),n.value.start_date&&n.value.end_date&&n.value.start_time&&n.value.end_time){const u=new Date(`${n.value.start_date}T${n.value.start_time}:00`);new Date(`${n.value.end_date}T${n.value.end_time}:00`)<u&&(d.end_time="End must be after or equal to start")}return y.value=d,Object.keys(d).length===0},ie=async()=>{if(!n.value.start_date||!n.value.end_date||!n.value.facilities?.length){await T.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const d=await R.checkAvailability({start_date:n.value.start_date,start_time:n.value.start_time||"00:00",end_date:n.value.end_date,end_time:n.value.end_time||"00:00",facilities:n.value.facilities}),o=d.available_for_all?"All selected facilities are available.":`Conflicts on: ${(d.conflict_facilities||[]).join(", ")||"—"}`;await T.fire({icon:d.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(d.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${o}</div>
      </div>`})}catch(d){await T.fire("Error",R.error||"Failed to check availability.","error"),console.error(d)}},te=()=>{if(r.value||!X())return;const d={...n.value};$.user?.id&&(d.filed_by_user_id=$.user.id),C("submit",d)};return(d,o)=>p.value?(v(),b("div",st,[e("div",nt,[e("div",ot,[e("div",rt,[e("h2",dt,k(w.value),1),e("span",ut,k(n.value.status),1)]),e("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:o[0]||(o[0]=u=>p.value=!1)},"Close")]),r.value?(v(),b("div",ct,[o[10]||(o[10]=Y(" This request is ",-1)),e("strong",null,k(n.value.status),1),o[11]||(o[11]=Y(". Editing is disabled. ",-1))])):U("",!0),e("div",mt,[e("div",pt,[o[13]||(o[13]=e("label",{class:"block mb-0.5"},[Y("Activity Design "),e("span",{class:"text-red-500"},"*")],-1)),q(e("select",{"onUpdate:modelValue":o[1]||(o[1]=u=>n.value.activity_design_id=u),class:se(["w-full border rounded px-2 py-1.5",y.value.activity_design_id?"border-red-500":""]),disabled:r.value||z(F).isLoading},[o[12]||(o[12]=e("option",{value:""},"Select approved activity design…",-1)),(v(!0),b(H,null,Z(x.value,u=>(v(),b("option",{key:u.id,value:u.id},k(W(u)),9,vt))),128))],10,ft),[[ne,n.value.activity_design_id]]),y.value.activity_design_id?(v(),b("p",yt,k(y.value.activity_design_id),1)):U("",!0),z(F).isLoading?(v(),b("p",bt,"Loading approved activities… ")):x.value.length?U("",!0):(v(),b("p",gt," No approved activity designs found. Approve an Activity Design first. "))]),e("div",null,[o[14]||(o[14]=e("label",{class:"block mb-0.5"},[Y("Start Date "),e("span",{class:"text-red-500"},"*")],-1)),q(e("input",{"onUpdate:modelValue":o[2]||(o[2]=u=>n.value.start_date=u),type:"date",class:se(["w-full border rounded px-2 py-1.5 bg-gray-50",y.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[J,n.value.start_date]]),y.value.start_date?(v(),b("p",_t,k(y.value.start_date),1)):U("",!0)]),e("div",null,[o[15]||(o[15]=e("label",{class:"block mb-0.5"},[Y("Start Time "),e("span",{class:"text-red-500"},"*")],-1)),q(e("input",{"onUpdate:modelValue":o[3]||(o[3]=u=>n.value.start_time=u),type:"time",class:se(["w-full border rounded px-2 py-1.5",y.value.start_time?"border-red-500":""]),disabled:r.value},null,10,xt),[[J,n.value.start_time]]),y.value.start_time?(v(),b("p",ht,k(y.value.start_time),1)):U("",!0)]),e("div",null,[o[16]||(o[16]=e("label",{class:"block mb-0.5"},[Y("End Date "),e("span",{class:"text-red-500"},"*")],-1)),q(e("input",{"onUpdate:modelValue":o[4]||(o[4]=u=>n.value.end_date=u),type:"date",class:se(["w-full border rounded px-2 py-1.5",y.value.end_date?"border-red-500":""]),disabled:r.value},null,10,wt),[[J,n.value.end_date]]),y.value.end_date?(v(),b("p",Ct,k(y.value.end_date),1)):U("",!0)]),e("div",null,[o[17]||(o[17]=e("label",{class:"block mb-0.5"},[Y("End Time "),e("span",{class:"text-red-500"},"*")],-1)),q(e("input",{"onUpdate:modelValue":o[5]||(o[5]=u=>n.value.end_time=u),type:"time",class:se(["w-full border rounded px-2 py-1.5",y.value.end_time?"border-red-500":""]),disabled:r.value},null,10,St),[[J,n.value.end_time]]),y.value.end_time?(v(),b("p",At,k(y.value.end_time),1)):U("",!0)])]),e("div",kt,[o[19]||(o[19]=e("label",{class:"block mb-0.5"},[Y("Facilities "),e("span",{class:"text-red-500"},"*")],-1)),e("div",$t,[q(e("select",{"onUpdate:modelValue":o[6]||(o[6]=u=>E.value=u),class:"border rounded px-2 py-1.5 min-w-[200px]",disabled:r.value},[o[18]||(o[18]=e("option",{value:""},"Select facility…",-1)),(v(!0),b(H,null,Z(I.value,u=>(v(),b("option",{key:u,value:u},k(u),9,Bt))),128))],8,Tt),[[ne,E.value]]),e("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:r.value||!E.value,onClick:L}," Add ",8,Et)]),y.value.facilities?(v(),b("p",Ft,k(y.value.facilities),1)):U("",!0),e("div",Vt,[(v(!0),b(H,null,Z(n.value.facilities,(u,V)=>(v(),b("span",{key:u,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[Y(k(u)+" ",1),r.value?U("",!0):(v(),b("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:a=>K(V)},"×",8,Ut))]))),128)),n.value.facilities?.length?U("",!0):(v(),b("span",Rt,"No facilities selected"))])]),e("div",qt,[e("div",Nt,[o[20]||(o[20]=e("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),e("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:r.value||j(-1).length===0,onClick:N}," Add Row ",8,Dt)]),e("div",zt,[e("table",Ot,[o[21]||(o[21]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-1.5"},"Item"),e("th",{class:"text-left p-1.5"},"Qty"),e("th",{class:"text-left p-1.5"},"Unit"),e("th",{class:"p-1.5 w-14"})])],-1)),e("tbody",null,[(v(!0),b(H,null,Z(n.value.equipment_items,(u,V)=>(v(),b("tr",{key:V,class:"border-t"},[e("td",It,[q(e("select",{"onUpdate:modelValue":a=>u.name=a,class:"w-full border rounded px-2 py-1.5",disabled:r.value,onChange:()=>{(u.qty==null||u.qty<=0)&&(u.qty=1)}},[(v(!0),b(H,null,Z(j(V).concat(u.name&&!j(V).includes(u.name)?[u.name]:[]),a=>(v(),b("option",{key:a,value:a},k(a),9,Pt))),128))],40,Lt),[[ne,u.name]]),y.value[`equipment_${V}`]?(v(),b("div",jt,k(y.value[`equipment_${V}`]),1)):U("",!0)]),e("td",Mt,[q(e("input",{"onUpdate:modelValue":a=>u.qty=a,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:r.value},null,8,Yt),[[J,u.qty,void 0,{number:!0}]])]),e("td",Wt,[q(e("input",{"onUpdate:modelValue":a=>u.unit=a,class:"w-24 border rounded px-2 py-1.5",disabled:r.value,placeholder:"e.g., pcs"},null,8,Gt),[[J,u.unit]])]),e("td",Kt,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:r.value,onClick:a=>P(V)}," Remove ",8,Qt)])]))),128))])])]),o[22]||(o[22]=e("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),e("div",Jt,[e("div",null,[o[23]||(o[23]=e("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),q(e("textarea",{"onUpdate:modelValue":o[7]||(o[7]=u=>n.value.utilization_details=u),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value},null,8,Ht),[[J,n.value.utilization_details]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"block mb-0.5"},"Remarks",-1)),q(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=u=>n.value.remarks=u),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value},null,8,Xt),[[J,n.value.remarks]])])]),e("div",Zt,[e("div",ea,[o[25]||(o[25]=e("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),e("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:r.value,onClick:ie}," Run Check ",8,ta)]),o[26]||(o[26]=e("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),e("div",aa,[e("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:o[9]||(o[9]=u=>p.value=!1)},"Close"),r.value?U("",!0):(v(),b("button",{key:0,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs",onClick:te},k(ee.value),1))])])])):U("",!0)}},la={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ia={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},sa={class:"flex items-center justify-between mb-3"},na={class:"text-lg font-semibold"},oa={class:"text-gray-600"},ra={class:"flex items-center justify-between gap-2"},da={class:"text-sm text-gray-600"},ua={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},ca=["d"],ma=["disabled"],pa={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},fa={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},va=["src"],ya={key:1,class:"flex items-center justify-center w-full h-full"},ba=["d"],ga={class:"mt-2 text-xs"},_a=["title"],xa={class:"text-gray-500 flex items-center justify-between"},ha={key:0},wa={key:0},Ca={class:"mt-2 flex items-center justify-between gap-2"},Sa=["onClick","title"],Aa={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},ka=["d"],$a=["onClick"],Ta={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},Ba=["d"],Ea={key:0,class:"mt-6 text-center text-sm text-gray-500"},Fa=10*1024*1024,Va={__name:"UtilizationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(t,{emit:i}){const A=t,m=i,h=O({get:()=>A.modelValue,set:a=>m("update:modelValue",a)}),C=ue(),p=B(null),$=B(!1),R=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),F=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),x=(a="")=>String(a).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",n=(a="")=>typeof a=="string"&&a.match(/^data:([^;]+);base64,/i)?.[1]||"",y=a=>{const g=a?.type&&R.has(a.type),_=a?.name&&F.has(x(a.name));return g||_},c=(a="")=>String(a).startsWith("image/"),S=(a="")=>a==="application/pdf",r=(a="")=>a==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",w=(a="")=>a==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ee=(a="")=>S(a)?Ve:r(a)?Ue:w(a)?Re:c(a)?qe:Ne,W=(a="")=>S(a)?"PDF":r(a)?"Word":w(a)?"Excel":c(a)?"Image":"File",E=(a="")=>S(a)?"pdf":r(a)?"docx":w(a)?"xlsx":a==="image/png"?"png":a==="image/jpeg"?"jpg":a==="image/webp"?"webp":"",I=(a="attachment",g="")=>/\.[a-z0-9]+$/i.test(a)?a:g?`${a}.${g.startsWith(".")?g.slice(1):g}`:a,L=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,K=O(()=>{const a=p.value?.attachments;if(!a)return[];try{return Array.isArray(a)?a:JSON.parse(a||"[]")}catch{return[]}}),N=O(()=>(K.value||[]).map((a,g)=>{const _=a.mime||n(a.data)||(a.name?x(a.name)==="pdf"&&"application/pdf":"")||"",M=x(a.name||"")||E(_),oe=a.size??null,ae=a.name||`${W(_)} ${g+1}`;return{id:a.id??g+1,name:ae,data:a.data||"",url:a.url||a.href||a.path||"",mime:_,ext:M,size:oe,filename:I(ae,M)}}));de(()=>A.modelValue,async a=>{a&&A.row?.id&&(await C.fetchById(A.row.id),p.value=C.selected||A.row)},{immediate:!1});const P=async a=>{const g=a.target.files?.[0];if(a.target.value="",!(!g||!p.value?.id)){if(g.size>Fa){await T.fire("File too large","Maximum size is 10 MB.","warning");return}if(!y(g)){await T.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{$.value=!0,await C.uploadAttachment(p.value.id,g),await C.fetchById(p.value.id),p.value=C.selected}finally{$.value=!1}}},j=async a=>{!p.value?.id||!(await T.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await C.deleteAttachment(p.value.id,a),await C.fetchById(p.value.id),p.value=C.selected)},X=a=>{if(a.data&&String(a.data).startsWith("data:")&&c(a.mime)){const g=window.open();g&&g.document.write(`<img src="${a.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}a.url&&window.open(String(a.url),"_blank")},ie=a=>{const[g,_]=a.split(","),M=g.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",oe=atob(_),ae=oe.length,ce=new Uint8Array(ae);for(let re=0;re<ae;re++)ce[re]=oe.charCodeAt(re);return new Blob([ce],{type:M})},te=(a,g)=>{const _=URL.createObjectURL(a),M=document.createElement("a");M.href=_,M.download=g||"download",document.body.appendChild(M),M.click(),M.remove(),setTimeout(()=>URL.revokeObjectURL(_),1e3)},d=async a=>{if(a.data&&String(a.data).startsWith("data:")){const g=ie(a.data);te(g,a.filename);return}if(a.url)try{const _=await(await fetch(a.url,{credentials:"include"})).blob();te(_,a.filename)}catch{const g=document.createElement("a");g.href=String(a.url),g.setAttribute("download",a.filename),document.body.appendChild(g),g.click(),g.remove()}},o=a=>c(a.mime)?"Open":"Download",u=a=>c(a.mime)?De:ze,V=a=>c(a.mime)?X(a):d(a);return(a,g)=>h.value?(v(),b("div",la,[e("div",ia,[e("div",sa,[e("h2",na,[g[1]||(g[1]=Y(" Utilization Attachments — ",-1)),e("span",oa,k(p.value?.reference_code||""),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:g[0]||(g[0]=_=>h.value=!1)},"Close")]),e("div",ra,[e("div",da,[g[2]||(g[2]=Y(" Activity: ",-1)),e("strong",null,k(p.value?.activity_design?.name_of_activity||"—"),1)]),e("label",{class:se(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":$.value}])},[(v(),b("svg",ua,[e("path",{d:z(Fe)},null,8,ca)])),e("span",null,k($.value?"Uploading…":"Upload"),1),e("input",{type:"file",class:"hidden",disabled:$.value,onChange:P,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,ma)],2)]),e("div",pa,[(v(!0),b(H,null,Z(N.value,_=>(v(),b("div",{key:_.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[e("div",fa,[c(_.mime)&&_.data&&_.data.startsWith("data:")?(v(),b("img",{key:0,src:_.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,va)):(v(),b("div",ya,[(v(),b("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24","aria-hidden":"true",class:se({"text-red-600":S(_.mime),"text-blue-600":r(_.mime),"text-emerald-600":w(_.mime),"text-gray-500":!_.mime||!c(_.mime)&&!S(_.mime)})},[e("path",{d:ee(_.mime)},null,8,ba)],2))]))]),e("div",ga,[e("div",{class:"font-medium truncate",title:_.name},k(_.name),9,_a),e("div",xa,[e("span",null,[Y(k(W(_.mime))+" ",1),_.ext?(v(),b("span",ha,"("+k(_.ext.toUpperCase())+")",1)):U("",!0)]),_.size?(v(),b("span",wa,k(L(_.size)),1)):U("",!0)])]),e("div",Ca,[e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:M=>V(_),title:o(_)},[(v(),b("svg",Aa,[e("path",{d:u(_)},null,8,ka)])),Y(" "+k(o(_)),1)],8,Sa),e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:M=>j(_.id),title:"Remove"},[(v(),b("svg",Ta,[e("path",{d:z(Oe)},null,8,Ba)])),g[3]||(g[3]=Y(" Remove ",-1))],8,$a)])]))),128))]),N.value.length?U("",!0):(v(),b("div",Ea," No attachments yet. "))])])):U("",!0)}},Ua={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},Ra={class:"bg-white rounded-2xl shadow-2xl w-[1200px] max-w-[95vw] max-h-[90vh] overflow-hidden"},qa={class:"px-4 py-3 border-b flex items-center justify-between"},Na={class:"p-3 overflow-auto"},Da={__name:"CalendarViewModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(t,{emit:i}){const A=t,m=i,h=O({get:()=>A.modelValue,set:y=>m("update:modelValue",y)}),C=ue(),p=B([]),$=(y,c=[])=>{if(Array.isArray(y))return y;try{return JSON.parse(y||"[]")||c}catch{return c}},R=(y=[])=>{p.value=y.map(c=>{const S=$(c.facilities),r=[];c.activity_design?.name_of_activity&&r.push(c.activity_design.name_of_activity),S.length&&r.push(S.join(", "));const w=r.join(" — ")||c.reference_code||"Utilization",ee=c.start_date&&c.start_time&&`${c.start_date}T${c.start_time}:00`||c.start_at||null,W=c.end_date&&c.end_time&&`${c.end_date}T${c.end_time}:00`||c.end_at||null;return!ee||!W?null:{id:String(c.id),title:w,start:ee,end:W,backgroundColor:"#10b981",borderColor:"#0ea5e9",textColor:"#0b1b13",extendedProps:{reference_code:c.reference_code,facilities:S,availability_status:c.availability_status,status:c.status}}}).filter(Boolean)},F=async()=>{await C.fetchAll({page:1,limit:500,status:"approved",order:"ASC",sort:"start_at"},!0),R(C.items.data||[])},x=y=>{const c=y?.event?.id;c&&m("open",Number(c))},n=O(()=>({plugins:[tt,at,lt],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:x,events:p.value}));return de(()=>A.modelValue,y=>{y&&F()}),de(()=>C.items.data,y=>{h.value&&R(y||[])},{deep:!0}),ve(()=>{h.value&&F()}),(y,c)=>h.value?(v(),b("div",Ua,[e("div",Ra,[e("div",qa,[c[1]||(c[1]=e("h2",{class:"text-base font-semibold"},"Utilization Calendar (Approved)",-1)),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:c[0]||(c[0]=S=>h.value=!1)},"Close")]),e("div",Na,[D(z(it),{options:n.value},null,8,["options"])]),c[2]||(c[2]=e("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click an event to open it. ",-1))])])):U("",!0)}},za={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},Oa={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-[560px] max-h-[85vh] overflow-y-auto"},Ia={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},La={class:"md:col-span-2"},Pa=["value"],ja={__name:"QuickAvailabilityModal",props:{modelValue:{type:Boolean,default:!1},facilities:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(t,{emit:i}){const A=t,m=i,h=ue(),C=B(""),p=B("08:00"),$=B(""),R=B("10:00"),F=B([]),x=O(()=>(F.value||[]).filter(S=>A.facilities.includes(S))),n=()=>m("update:modelValue",!1),y=()=>{C.value="",p.value="08:00",$.value="",R.value="10:00",F.value=[]},c=async()=>{if(!C.value||!$.value||!x.value.length){await T.fire("Missing fields","Start/End dates and at least one facility are required.","info");return}try{const S=await h.checkAvailability({start_date:C.value,start_time:p.value||"00:00",end_date:$.value,end_time:R.value||"00:00",facilities:x.value}),r=S.available_for_all?"All selected facilities are available.":`Conflicts on: ${(S.conflict_facilities||[]).join(", ")||"—"}`;await T.fire({icon:S.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(S.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${r}</div>
        <div class="mt-2"><strong>Conflicts:</strong> ${Array.isArray(S.conflicts)&&S.conflicts.length?`<ul class="list-disc ml-5">${S.conflicts.map(w=>`<li>${w.reference_code} — ${new Date(w.start_at).toLocaleString()} to ${new Date(w.end_at).toLocaleString()}</li>`).join("")}</ul>`:"None"}</div>
      </div>`})}catch(S){await T.fire("Error",h.error||"Failed to check availability.","error"),console.error(S)}};return(S,r)=>t.modelValue?(v(),b("div",za,[e("div",Oa,[e("div",{class:"flex items-center justify-between mb-2"},[r[5]||(r[5]=e("h3",{class:"text-base font-semibold"},"Quick Availability Check",-1)),e("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:n},"Close")]),e("div",Ia,[e("div",null,[r[6]||(r[6]=e("label",{class:"block mb-0.5"},"Start Date",-1)),q(e("input",{"onUpdate:modelValue":r[0]||(r[0]=w=>C.value=w),type:"date",class:"w-full border rounded px-2 py-1.5"},null,512),[[J,C.value]])]),e("div",null,[r[7]||(r[7]=e("label",{class:"block mb-0.5"},"Start Time",-1)),q(e("input",{"onUpdate:modelValue":r[1]||(r[1]=w=>p.value=w),type:"time",class:"w-full border rounded px-2 py-1.5"},null,512),[[J,p.value]])]),e("div",null,[r[8]||(r[8]=e("label",{class:"block mb-0.5"},"End Date",-1)),q(e("input",{"onUpdate:modelValue":r[2]||(r[2]=w=>$.value=w),type:"date",class:"w-full border rounded px-2 py-1.5"},null,512),[[J,$.value]])]),e("div",null,[r[9]||(r[9]=e("label",{class:"block mb-0.5"},"End Time",-1)),q(e("input",{"onUpdate:modelValue":r[3]||(r[3]=w=>R.value=w),type:"time",class:"w-full border rounded px-2 py-1.5"},null,512),[[J,R.value]])]),e("div",La,[r[10]||(r[10]=e("label",{class:"block mb-0.5"},"Facilities",-1)),q(e("select",{"onUpdate:modelValue":r[4]||(r[4]=w=>F.value=w),multiple:"",class:"w-full border rounded px-2 py-1.5 min-h-[40px]"},[(v(!0),b(H,null,Z(t.facilities,w=>(v(),b("option",{key:w,value:w},k(w),9,Pa))),128))],512),[[ne,F.value]]),r[11]||(r[11]=e("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Hold Ctrl/Cmd to select multiple.",-1))])]),e("div",{class:"flex justify-end gap-1.5 mt-4"},[e("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:y},"Reset"),e("button",{class:"px-3 py-1.5 bg-indigo-600 text-white rounded text-xs",onClick:c},"Check")])])])):U("",!0)}},Ma="KOLEHIYO NG PANTUKAN",Ya="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",Wa="https://osas.knp.edu.ph/verify-utilization?id=",fe=t=>t?ye(t).format("MMMM DD, YYYY"):"—",he=t=>t?ye(t).format("MMM DD, YYYY, h:mm A"):"—",we=(t,i=0)=>t==null||t===""||Number.isNaN(Number(t))?"—":Number(t).toLocaleString(void 0,{minimumFractionDigits:i,maximumFractionDigits:i}),Ce=(t,i)=>{if(Array.isArray(t))return t;try{return JSON.parse(t||"null")??i}catch{return i}},ke="./",Ga=`${ke}images/logo.png`,Ka=`${ke}images/bg.jpg`;async function Se(t){const A=await(await fetch(t)).blob();return new Promise(m=>{const h=new FileReader;h.onloadend=()=>m(h.result),h.readAsDataURL(A)})}function Qa(t){switch(t){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}function Ja(t){switch(String(t||"").toUpperCase()){case"AVAILABLE":return[16,185,129];case"RESERVED":return[99,102,241];case"CONFLICT":return[239,68,68];case"MAINTENANCE":return[245,158,11];case"PENDING-CHECK":return[245,158,11];default:return[107,114,128]}}async function Ha(t){const i=t.internal.pageSize.getWidth(),A=110,m=36;try{const h=await Se(Ka);t.addImage(h,"JPEG",0,0,i,A,void 0,"FAST")}catch{t.setFillColor(21,62,121),t.rect(0,0,i,A,"F")}t.setGState(new t.GState({opacity:.18})),t.setFillColor(0,0,0),t.rect(0,0,i,A,"F"),t.setGState(new t.GState({opacity:1}));try{const h=await Se(Ga);t.addImage(h,"PNG",m,20,70,70,void 0,"FAST")}catch{}return t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(20),t.text(Ma,m+86,38),t.setFont("helvetica","normal"),t.setFontSize(10),t.text(Ya,m+86,58),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(14),t.text("UTILIZATION REQUEST",i/2,A+24,{align:"center"}),A+34}async function Xa(t,i,A){const m=t.internal.pageSize.getWidth(),h=36,C=i?.id??i?.reference_code??"",p=`${Wa}${encodeURIComponent(String(C))}`,$=await Ee.toDataURL(p,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),R=String(i.status||"").toUpperCase(),[F,x,n]=Qa(R),y=String(i.availability_status||"").toUpperCase(),[c,S,r]=Ja(y),w=i.approved_at?fe(i.approved_at):i.date_filed?fe(i.date_filed):"—",ee=`osas.knp.edu.ph/verify-utilization?id=${String(C)}`;return G(t,{startY:A,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:h,right:h},tableWidth:m-h*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:m-h*2-260},1:{cellWidth:260}},didDrawCell:W=>{if(W.section!=="body")return;const{x:E,y:I,width:L,height:K}=W.cell,N=10;if(W.column.index===0){t.setFillColor(255,255,255),t.roundedRect(E,I,L-1,K,6,6,"F");const P=24,j=Math.min(160,L-22);t.setFillColor(F,x,n),t.roundedRect(E+N,I+N,j,P,12,12,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text(R||"STATUS",E+N+10,I+N+16);const X=I+N+P+10,ie=Math.min(160,L-22);t.setFillColor(c,S,r),t.roundedRect(E+N,X,ie,P,12,12,"F"),t.setTextColor(255,255,255),t.text(y||"AVAILABILITY",E+N+10,X+16),t.setTextColor(20),t.setFont("helvetica","normal"),t.setFontSize(9);let te=X+P+12;t.text(`Ref No.: ${i.reference_code||"—"}`,E+N,te),te+=16,t.text(`Date Issued: ${w}`,E+N,te),t.setDrawColor(230),t.roundedRect(E,I,L-1,K,6,6,"S")}if(W.column.index===1){t.setFillColor(255,255,255),t.roundedRect(E,I,L-1,K,6,6,"F"),t.setFillColor(66,103,178),t.roundedRect(E,I,L-1,22,6,6,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("VERIFY",E+N,I+15);const P=E+N,j=I+28;t.addImage($,"PNG",P,j,75,75,void 0,"FAST"),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("Scan to verify",P+100,j+14),t.setFont("helvetica","normal"),t.setFontSize(9),t.text("This document can be verified",P+100,j+32),t.text("online via the OSAS portal.",P+100,j+46),t.setTextColor(110),t.setFontSize(8),t.text(ee,P+100,j+72),t.setDrawColor(230),t.roundedRect(E,I,L-1,K,6,6,"S")}}}),t.lastAutoTable.finalY}async function Za(t){const i=new Be({unit:"pt",format:[612,936],orientation:"portrait"}),A=i.internal.pageSize.getWidth(),m=36,h=Ce(t.facilities,[]),C=Ce(t.equipment_items,[]);let p=await Ha(i);p=await Xa(i,t,p)+10,G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY;const $=t.activity_design||{};G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},fe($.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.office_department||$?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:m,right:m}}),p=i.lastAutoTable.finalY+10,G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"SCHEDULE",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY;const R=t.start_at||(t.start_date&&t.start_time?`${t.start_date}T${t.start_time}:00`:null),F=t.end_at||(t.end_date&&t.end_time?`${t.end_date}T${t.end_time}:00`:null);G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"START",styles:{fillColor:[243,248,255],fontStyle:"bold"}},he(R)],[{content:"END",styles:{fillColor:[243,248,255],fontStyle:"bold"}},he(F)],[{content:"DURATION (mins)",styles:{fillColor:[243,248,255],fontStyle:"bold"}},we(t.duration_minutes)]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:m,right:m}}),p=i.lastAutoTable.finalY+10,G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"FACILITIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY;const x=Array.isArray(h)&&h.length?"• "+h.join(`
• `):"—";G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[x]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY+10,G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"EQUIPMENT / MATERIALS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY,Array.isArray(C)&&C.length?G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["ITEM","QTY","UNIT"]],body:C.map(r=>[r?.name||"—",we(r?.qty),r?.unit||"—"]),columnStyles:{0:{cellWidth:300},1:{cellWidth:70},2:{cellWidth:"auto"}},margin:{left:m,right:m}}):G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY+10;const n=[["UTILIZATION DETAILS",t.utilization_details],["REMARKS",t.remarks]];for(const[r,w]of n)G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:r,styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY,G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[w&&String(w).trim()?w:"—"]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY+10;G(i,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"APPROVAL",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=i.lastAutoTable.finalY;const y=t?.filed_by?`${t.filed_by.first_name||""} ${t.filed_by.last_name||""}`.trim():"",c=t?.approver?`${t.approver.first_name||""} ${t.approver.last_name||""}`.trim():"";G(i,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PREPARED BY:","APPROVED BY:"]],body:[[y||" ",c||" "]],columnStyles:{0:{cellWidth:(A-m*2)/2},1:{cellWidth:"auto"}},didParseCell:r=>{r.section==="body"&&(r.cell.styles.halign="center",r.cell.styles.fontStyle="bold",r.cell.styles.cellPadding={top:16,right:10,bottom:18,left:10})},margin:{left:m,right:m}});const S=i.internal.pageSize.getHeight()-20;i.setFontSize(8),i.setTextColor(120),i.text(`Generated on ${ye().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,m,S),i.save(`${t.reference_code||"Utilization_Request"}.pdf`)}const el={class:"flex items-center gap-2"},tl={class:"p-3 mb-4 rounded-xl border bg-white/60"},al={class:"flex items-center gap-2 mb-2 text-gray-700"},ll={class:"w-4 h-4",viewBox:"0 0 24 24"},il=["d"],sl={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},nl={class:"md:col-span-2 flex"},ol={class:"w-5 h-5",viewBox:"0 0 24 24"},rl=["d"],dl=["value"],ul=["value"],cl={class:"md:col-span-1"},ml={class:"md:col-span-1"},pl={class:"md:col-span-2"},fl=["value"],vl={class:"flex flex-wrap gap-1 max-w-[380px]"},yl={key:0,class:"text-gray-400"},Tl={__name:"UtilizationRequestsPage",setup(t){const i=ue(),A=Ae(),m=B(!1),h=()=>{m.value=!0},C=B(!1),p=()=>{C.value=!0},$=async f=>{try{await i.fetchById(f);const l=i.selected;l&&await X(l)}catch(l){console.error(l)}finally{m.value=!1}},R=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],F={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},x=B({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[]}),n=O({get:()=>{const{start_from:f,start_to:l}=x.value;return f||l?[f||null,l||null]:null},set:f=>{if(!f)x.value.start_from=null,x.value.start_to=null;else{const[l,s]=f;x.value.start_from=l||null,x.value.start_to=s||null}}}),y=O({get:()=>{const{end_from:f,end_to:l}=x.value;return f||l?[f||null,l||null]:null},set:f=>{if(!f)x.value.end_from=null,x.value.end_to=null;else{const[l,s]=f;x.value.end_from=l||null,x.value.end_to=s||null}}}),c=async(f={},l=!0)=>{x.value={...x.value,...f};const s={...x.value};["q","status","availability_status","start_from","start_to","end_from","end_to"].forEach(Q=>{(s[Q]===""||s[Q]==null)&&delete s[Q]}),(!Array.isArray(s.facilities_any)||!s.facilities_any.length)&&delete s.facilities_any,await i.fetchAll(s,l)};ve(async()=>{await c({page:1,limit:10})});const S=O(()=>({total:i.items.total||0,totalPages:i.items.totalPages||1,currentPage:i.items.currentPage||1,pageSize:i.items.pageSize||10,data:i.items.data||[]})),r=["draft","pending","approved","rejected","cancelled","completed"],w=["unknown","pending-check","available","conflict","reserved","maintenance"],ee=f=>{switch(String(f||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},W=f=>{switch(String(f||"").toLowerCase()){case"available":return"emerald";case"reserved":return"indigo";case"conflict":return"red";case"maintenance":return"orange";case"pending-check":return"amber";default:return"gray"}},E=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:220,formatter:(f,l)=>l.activity_design?l.activity_design.name_of_activity:""},{key:"facilities",label:"Facilities",sortable:!1,minWidth:260},{key:"start_at",label:"Start",sortable:!0,width:170},{key:"end_at",label:"End",sortable:!0,width:170},{key:"availability_status",label:"Availability",sortable:!0,width:130},{key:"status",label:"Status",sortable:!0,width:120}],I=async f=>{await c(f)},L=B(!1),K=B(!1),N=B(null),P=()=>{L.value=!0},j=async f=>{await i.create(f),L.value=!1,await c({},!0)},X=async f=>{await i.fetchById(f.id);const l=i.selected||f;let s=[],Q=[];try{s=Array.isArray(l.facilities)?l.facilities:JSON.parse(l.facilities||"[]")}catch{}try{Q=Array.isArray(l.equipment_items)?l.equipment_items:JSON.parse(l.equipment_items||"[]")}catch{}N.value={id:l.id,reference_code:l.reference_code,date_filed:l.date_filed||"",activity_design_id:l.activity_design_id||"",facilities:s,equipment_items:Q,utilization_details:l.utilization_details||"",start_date:l.start_date||String(l.start_at||"").slice(0,10),start_time:l.start_time||(l.start_at?new Date(l.start_at).toTimeString().slice(0,5):""),end_date:l.end_date||String(l.end_at||"").slice(0,10),end_time:l.end_time||(l.end_at?new Date(l.end_at).toTimeString().slice(0,5):""),status:l.status||"draft",availability_status:l.availability_status||"pending-check",remarks:l.remarks||""},K.value=!0},ie=async f=>{const{id:l,...s}=f;await i.updateById(l,s),K.value=!1,await c({},!0)},te=async f=>{if(!f?.id)return;(await T.fire({title:`Delete utilization "${f.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await i.deleteById(f.id),await c({},!0),await T.fire("Deleted","The utilization request has been deleted.","success"))},d=async f=>{await X(f)},o=async f=>{if((await T.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await i.submit(f.id),await c({},!0),await T.fire("Submitted","Utilization request is now pending approval.","success")}catch{await T.fire("Error",i.error||"Failed to submit request.","error")}},u=async f=>{const l=await T.fire({title:"Approve utilization?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const s=l.value||"";try{await i.approve(f.id,s),await c({},!0),await T.fire("Approved","Utilization has been approved and reserved.","success")}catch{await T.fire("Error",i.error||"Failed to approve request.","error")}},V=async f=>{const l=await T.fire({title:"Reject utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:Q=>Q?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const s=l.value;try{await i.reject(f.id,s),await c({},!0),await T.fire("Rejected","Utilization has been rejected.","success")}catch{await T.fire("Error",i.error||"Failed to reject request.","error")}},a=async f=>{const l=await T.fire({title:"Cancel utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:Q=>Q?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Utilization",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const s=l.value;try{await i.cancel(f.id,s),await c({},!0),await T.fire("Cancelled","Utilization has been cancelled.","success")}catch{await T.fire("Error",i.error||"Failed to cancel request.","error")}},g=async f=>{if(String(f?.status||"").toLowerCase()!=="approved"){await T.fire("Not allowed","Only approved utilization request can be printed.","info");return}try{await i.fetchById(f.id);const s=i.selected||f;await Za(s)}catch(s){await T.fire("Error",i.error||"Failed to generate PDF.","error"),console.error(s)}},_=B(!1),M=B(null),oe=async f=>{await i.fetchById(f.id),M.value=i.selected||f,_.value=!0};B(""),B("08:00"),B(""),B("10:00"),B([]);const ae=B([]),ce=async()=>{x.value.facilities_any=(ae.value||[]).slice(),await c({page:1})},re=async()=>{ae.value=[],await c({q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[],page:1})};return(f,l)=>(v(),b(H,null,[D(Ie,null,{default:le(()=>[D(Le,null,{default:le(()=>[z(i).error?(v(),be(Je,{key:0,icon:z(Pe),color:"danger"},{default:le(()=>[Y(k(z(i).error),1)]),_:1},8,["icon"])):U("",!0),D(He,{icon:z(je),title:"Utilization Requests",main:""},{default:le(()=>[e("div",el,[D(me,{icon:z(Me),color:"info",label:"View Calendar",onClick:h},null,8,["icon"]),D(me,{icon:z(Ye),color:"info",label:"Quick Check",onClick:p},null,8,["icon"]),D(me,{icon:z(We),color:"primary",label:"New Request",onClick:P},null,8,["icon"]),D(me,{icon:z(Ge),color:"info",label:"Refresh",onClick:l[0]||(l[0]=s=>c({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),e("div",tl,[e("div",al,[(v(),b("svg",ll,[e("path",{d:z(Ke)},null,8,il)])),l[14]||(l[14]=e("span",{class:"font-medium text-sm"},"Filters",-1))]),e("div",sl,[e("div",nl,[q(e("input",{"onUpdate:modelValue":l[1]||(l[1]=s=>x.value.q=s),placeholder:"Search by ref, details, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:l[2]||(l[2]=Te(s=>c({page:1}),["enter"]))},null,544),[[J,x.value.q]]),e("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:l[3]||(l[3]=s=>c({page:1}))},[(v(),b("svg",ol,[e("path",{d:z(Qe)},null,8,rl)]))])]),q(e("select",{"onUpdate:modelValue":l[4]||(l[4]=s=>x.value.status=s),class:"border rounded px-2 py-2"},[l[15]||(l[15]=e("option",{value:""},"All status",-1)),(v(),b(H,null,Z(r,s=>e("option",{key:s,value:s},k(s),9,dl)),64))],512),[[ne,x.value.status]]),q(e("select",{"onUpdate:modelValue":l[5]||(l[5]=s=>x.value.availability_status=s),class:"border rounded px-2 py-2"},[l[16]||(l[16]=e("option",{value:""},"Any availability",-1)),(v(),b(H,null,Z(w,s=>e("option",{key:s,value:s},k(s),9,ul)),64))],512),[[ne,x.value.availability_status]]),e("div",cl,[D(z(_e),ge({modelValue:n.value,"onUpdate:modelValue":l[6]||(l[6]=s=>n.value=s)},F,{placeholder:"Start date range"}),null,16,["modelValue"])]),e("div",ml,[D(z(_e),ge({modelValue:y.value,"onUpdate:modelValue":l[7]||(l[7]=s=>y.value=s)},F,{placeholder:"End date range"}),null,16,["modelValue"])]),e("div",pl,[l[17]||(l[17]=e("label",{class:"block text-[11px] text-gray-600 mb-1"},"Facilities (any)",-1)),q(e("select",{"onUpdate:modelValue":l[8]||(l[8]=s=>ae.value=s),multiple:"",class:"w-full border rounded px-2 py-2 min-h-[38px]"},[(v(),b(H,null,Z(R,s=>e("option",{key:s,value:s},k(s),9,fl)),64))],512),[[ne,ae.value]])]),e("div",{class:"flex items-center gap-2 md:col-span-2"},[e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:ce}," Apply Filters "),e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:re},"Reset")])])]),D(Xe,{columns:E,data:S.value,loading:z(i).isLoading,onQueryChange:I},{"cell-facilities":le(({row:s})=>[e("div",vl,[(v(!0),b(H,null,Z((()=>{try{return Array.isArray(s.facilities)?s.facilities:JSON.parse(s.facilities||"[]")}catch{return[]}})(),(Q,$e)=>(v(),be(pe,{key:$e,text:Q,tone:"slate"},null,8,["text"]))),128)),s.facilities&&JSON.parse(s.facilities||"[]").length?U("",!0):(v(),b("span",yl,"—"))])]),"cell-start_at":le(({value:s})=>[e("span",null,k(s?new Date(s).toLocaleString():"—"),1)]),"cell-end_at":le(({value:s})=>[e("span",null,k(s?new Date(s).toLocaleString():"—"),1)]),"cell-availability_status":le(({value:s})=>[D(pe,{text:s||"—",tone:W(s)},null,8,["text","tone"])]),"cell-status":le(({value:s})=>[D(pe,{text:s||"—",tone:ee(s)},null,8,["text","tone"])]),"cell-actions":le(({row:s})=>[D(Ze,{row:s,moderator:["admin","manager"].includes(String(z(A).user?.role||"").toLowerCase()),onAttachments:oe,onSubmit:o,onApprove:u,onReject:V,onEdit:X,onDelete:te,onView:Q=>d(s),onCancel:a,onPrint:g},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),D(xe,{modelValue:L.value,"onUpdate:modelValue":l[9]||(l[9]=s=>L.value=s),mode:"create",onSubmit:j},null,8,["modelValue"]),D(xe,{modelValue:K.value,"onUpdate:modelValue":l[10]||(l[10]=s=>K.value=s),mode:"edit",initial:N.value||{},onSubmit:ie},null,8,["modelValue","initial"]),D(Va,{modelValue:_.value,"onUpdate:modelValue":l[11]||(l[11]=s=>_.value=s),row:M.value},null,8,["modelValue","row"]),D(Da,{modelValue:m.value,"onUpdate:modelValue":l[12]||(l[12]=s=>m.value=s),onOpen:$},null,8,["modelValue"]),D(ja,{modelValue:C.value,"onUpdate:modelValue":l[13]||(l[13]=s=>C.value=s),facilities:R},null,8,["modelValue"])],64))}};export{Tl as default};
