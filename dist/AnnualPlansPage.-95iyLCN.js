import{c as j,r as R,o as X,E as $e,a as p,q as i,f as B,A as U,d as w,e as l,g as v,t as D,k as J,x as ne,j as ve,F as H,B as ae,S as V,u as _e,l as L,s as Ae,p as Se,N as Be,h as te,M as Ve,v as Re,C as ce}from"./index.w1fTWaRQ.js";import{u as je,v as De,a8 as Fe,y as Ie,a9 as Ee,aa as Oe,ab as Pe,ae as Ne,z as be,A as Te,B as Me,E as ze,F as Le,G as Ue,H as qe,I as We,C as Je,D as Ge,_ as Ye,a as Ke,g as Xe,J as Qe,i as He,K as Ze,L as et,M as tt,V as at}from"./SectionMain.Co2y8BLV.js";import{_ as nt,a as me}from"./SectionTitleLineWithButton.AVJG-kj_.js";import{_ as lt,B as st,a as ot}from"./Badge.BfbdF7_K.js";import{_ as z}from"./IconifyButton.CaN1pAk4.js";import{_ as ye}from"./AnnualPlanFormModal.DSf9Z5-a.js";import{u as pe}from"./annualPlan.CNmvSRSj.js";import{i as it,a as rt,b as dt,F as ut}from"./index.A6PdmpQc.js";import{_ as ct}from"./StatusTrailModal.Dq5INm-V.js";import{u as mt}from"./clubScope.C_EnuWrj.js";import"./appContext.Db1VNKoe.js";import"./activityDesignService.DKPfTybd.js";import"./utilizationRequestService.BsNdNhg3.js";import"./liquidationFundService.n_EUG0wO.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./ToasterComponent.C4X8owM8.js";const pt={class:"flex items-center gap-1 md:gap-2"},ft={class:"relative inline-flex"},vt={key:0,class:"absolute -top-1 -right-1 text-[10px] leading-none px-1.5 py-0.5 rounded-full bg-rose-600 text-white"},yt=["aria-expanded"],bt={style:{width:"18px",height:"18px"},viewBox:"0 0 24 24"},gt=["d"],ht={key:0},wt={__name:"AnnualPlanRowActions",props:{row:{type:Object,required:!0},moderator:{type:Boolean,default:!1},busy:{type:Boolean,default:!1},currentUserId:{type:[String,Number],default:null}},emits:["attachments","submit","approve","reject","edit","delete","view","cancel","remarks"],setup(m,{emit:r}){const f=m,E=j(()=>String(f.row?.status||"").toLowerCase()),k=j(()=>E.value==="draft"),b=j(()=>E.value==="draft"),g=j(()=>E.value!=="draft"),F=j(()=>f.moderator&&E.value==="pending"),O=j(()=>f.moderator&&(E.value==="approved"||E.value==="pending")),C=j(()=>f.moderator),h=R(!1),P=R(null),N=R(null),S=o=>{if(!h.value)return;const s=P.value,c=N.value;s&&!s.contains(o.target)&&c&&!c.contains(o.target)&&(h.value=!1)};X(()=>document.addEventListener("click",S)),$e(()=>document.removeEventListener("click",S));const x=o=>{if(!o)return[];if(Array.isArray(o))return o;try{return JSON.parse(o||"[]")||[]}catch{return[]}},y=j(()=>{const o=f.currentUserId==null?null:Number(f.currentUserId);return(x(f.row?.remarks)||[]).filter(c=>{if(!c||c.is_read===!0)return!1;const T=c.user_id==null?null:Number(c.user_id);if(o!=null&&T===o)return!1;const q=Array.isArray(c.read_by)?c.read_by.map($=>Number($)):[];return o!=null?!q.includes(o):!1}).length});return(o,s)=>(i(),p("div",pt,[B(z,{"icon-path":v(je),color:"text-indigo-600",label:"Attachments",tooltip:"Attachments",size:"sm",disabled:m.busy,onClick:s[0]||(s[0]=c=>o.$emit("attachments",m.row))},null,8,["icon-path","disabled"]),g.value?(i(),U(z,{key:0,"icon-path":v(De),color:"text-gray-700",label:"View",tooltip:"View (read-only)",size:"sm",disabled:m.busy,onClick:s[1]||(s[1]=c=>o.$emit("view",m.row))},null,8,["icon-path","disabled"])):w("",!0),k.value?(i(),U(z,{key:1,"icon-path":v(Fe),color:"text-blue-600",label:"Submit",tooltip:"Submit",size:"sm",disabled:m.busy,onClick:s[2]||(s[2]=c=>o.$emit("submit",m.row))},null,8,["icon-path","disabled"])):w("",!0),b.value?(i(),U(z,{key:2,"icon-path":v(Ie),color:"text-amber-600",label:"Edit",tooltip:"Edit",size:"sm",disabled:m.busy,onClick:s[3]||(s[3]=c=>o.$emit("edit",m.row))},null,8,["icon-path","disabled"])):w("",!0),F.value?(i(),U(z,{key:3,"icon-path":v(Ee),color:"text-emerald-600",label:"Approve",tooltip:"Approve",size:"sm",disabled:m.busy,onClick:s[4]||(s[4]=c=>o.$emit("approve",m.row))},null,8,["icon-path","disabled"])):w("",!0),F.value?(i(),U(z,{key:4,"icon-path":v(Oe),color:"text-rose-600",label:"Reject",tooltip:"Reject",size:"sm",disabled:m.busy,onClick:s[5]||(s[5]=c=>o.$emit("reject",m.row))},null,8,["icon-path","disabled"])):w("",!0),O.value?(i(),U(z,{key:5,"icon-path":v(Pe),color:"text-orange-600",label:"Cancel",tooltip:"Cancel plan",size:"sm",disabled:m.busy,onClick:s[6]||(s[6]=c=>o.$emit("cancel",m.row))},null,8,["icon-path","disabled"])):w("",!0),l("div",ft,[B(z,{"icon-path":v(Ne),color:"text-slate-700",label:"Remarks",tooltip:"Remarks / Audit Trail",size:"sm",disabled:m.busy,onClick:s[7]||(s[7]=c=>o.$emit("remarks",m.row))},null,8,["icon-path","disabled"]),y.value>0?(i(),p("span",vt,D(y.value),1)):w("",!0)]),C.value?(i(),U(z,{key:6,"icon-path":v(be),color:"text-red-600",label:"Delete",tooltip:"Delete",size:"sm",disabled:m.busy,onClick:s[8]||(s[8]=c=>o.$emit("delete",m.row))},null,8,["icon-path","disabled"])):w("",!0),l("div",{class:"relative md:hidden",ref_key:"btnRef",ref:N},[l("button",{class:"inline-flex items-center justify-center rounded-xl p-1.5 hover:bg-gray-100","aria-expanded":h.value,"aria-haspopup":"menu",title:"More",onClick:s[9]||(s[9]=c=>h.value=!h.value)},[(i(),p("svg",bt,[l("path",{d:v(Te)},null,8,gt)]))],8,yt),h.value?(i(),p("div",{key:0,ref_key:"menuRef",ref:P,role:"menu",class:"absolute right-0 z-20 mt-1 w-44 overflow-hidden rounded-xl border bg-white shadow-lg"},[l("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[10]||(s[10]=c=>{h.value=!1,o.$emit("attachments",m.row)})},"Attachments"),g.value?(i(),p("button",{key:0,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[11]||(s[11]=c=>{h.value=!1,o.$emit("view",m.row)})},"View (read-only)")):w("",!0),k.value?(i(),p("button",{key:1,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[12]||(s[12]=c=>{h.value=!1,o.$emit("submit",m.row)})},"Submit")):w("",!0),b.value?(i(),p("button",{key:2,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[13]||(s[13]=c=>{h.value=!1,o.$emit("edit",m.row)})},"Edit")):w("",!0),F.value?(i(),p("button",{key:3,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[14]||(s[14]=c=>{h.value=!1,o.$emit("approve",m.row)})},"Approve")):w("",!0),F.value?(i(),p("button",{key:4,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-rose-600 hover:bg-rose-50",onClick:s[15]||(s[15]=c=>{h.value=!1,o.$emit("reject",m.row)})},"Reject")):w("",!0),O.value?(i(),p("button",{key:5,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[16]||(s[16]=c=>{h.value=!1,o.$emit("cancel",m.row)})},"Cancel")):w("",!0),l("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[17]||(s[17]=c=>{h.value=!1,o.$emit("remarks",m.row)})},[s[19]||(s[19]=J("Remarks ",-1)),y.value?(i(),p("span",ht,"("+D(y.value)+" new)",1)):w("",!0)]),C.value?(i(),p("button",{key:6,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50",onClick:s[18]||(s[18]=c=>{h.value=!1,o.$emit("delete",m.row)})},"Delete")):w("",!0)],512)):w("",!0)],512)]))}},xt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},kt={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},Ct={class:"flex items-center justify-between mb-3"},$t={class:"text-lg font-semibold"},_t={class:"text-gray-600"},At={class:"flex items-center justify-between gap-2"},St={class:"text-sm text-gray-600"},Bt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Vt=["d"],Rt=["disabled"],jt={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},Dt={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Ft=["src"],It={key:1,class:"flex items-center justify-center w-full h-full"},Et=["d"],Ot={class:"mt-2 text-xs"},Pt=["title"],Nt={class:"text-gray-500 flex items-center justify-between"},Tt={key:0},Mt={key:0},zt={class:"mt-2 flex items-center justify-between gap-2"},Lt=["onClick","title"],Ut={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},qt=["d"],Wt=["onClick"],Jt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Gt=["d"],Yt={key:0,class:"mt-6 text-center text-sm text-gray-500"},Kt=10*1024*1024,Xt={__name:"AnnualPlanAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(m,{emit:r}){const f=m,E=r,k=j({get:()=>f.modelValue,set:e=>E("update:modelValue",e)}),b=pe(),g=R(null),F=R(!1),O=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),C=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),h=(e="")=>String(e).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",P=(e="")=>typeof e=="string"&&e.match(/^data:([^;]+);base64,/i)?.[1]||"",N=e=>e?.type&&O.has(e.type)||e?.name&&C.has(h(e.name)),S=(e="")=>String(e).startsWith("image/"),x=(e="")=>e==="application/pdf",y=(e="")=>e==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",o=(e="")=>e==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",s=(e="")=>x(e)?ze:y(e)?Le:o(e)?Ue:S(e)?qe:We,c=(e="")=>x(e)?"PDF":y(e)?"Word":o(e)?"Excel":S(e)?"Image":"File",T=(e="")=>x(e)?"pdf":y(e)?"docx":o(e)?"xlsx":e==="image/png"?"png":e==="image/jpeg"?"jpg":e==="image/webp"?"webp":"",q=(e="attachment",d="")=>/\.[a-z0-9]+$/i.test(e)?e:d?`${e}.${d.startsWith(".")?d.slice(1):d}`:e,$=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`,G=j(()=>{const e=g.value?.attachments;if(!e)return[];try{return Array.isArray(e)?e:JSON.parse(e||"[]")}catch{return[]}}),Q=j(()=>(G.value||[]).map((e,d)=>{const u=e.mime||P(e.data)||"",I=h(e.name||"")||T(u),M=e.size??null,W=e.name||`${c(u)} ${d+1}`;return{id:e.id??d+1,name:W,data:e.data||"",url:e.url||e.href||e.path||"",mime:u,ext:I,size:M,filename:q(W,I)}}));ne(()=>f.modelValue,async e=>{e&&f.row?.id&&(await b.fetchById(f.row.id),g.value=b.selected||f.row)});const le=async e=>{const d=e.target.files?.[0];if(e.target.value="",!(!d||!g.value?.id)){if(d.size>Kt){await V.fire("File too large","Maximum size is 10 MB.","warning");return}if(!N(d)){await V.fire("Unsupported file","Only images, PDF, DOCX, XLSX allowed.","warning");return}try{F.value=!0,await b.uploadAttachment(g.value.id,d),await b.fetchById(g.value.id),g.value=b.selected}finally{F.value=!1}}},_=async e=>{!g.value?.id||!(await V.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await b.deleteAttachment(g.value.id,e),await b.fetchById(g.value.id),g.value=b.selected)},se=e=>{if(e.data&&String(e.data).startsWith("data:")&&S(e.mime)){const d=window.open();d&&d.document.write(`<img src="${e.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}e.url&&window.open(String(e.url),"_blank")},oe=e=>{const[d,u]=e.split(","),I=d.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",M=atob(u),W=new Uint8Array(M.length);for(let K=0;K<M.length;K++)W[K]=M.charCodeAt(K);return new Blob([W],{type:I})},Z=(e,d)=>{const u=URL.createObjectURL(e),I=document.createElement("a");I.href=u,I.download=d||"download",document.body.appendChild(I),I.click(),I.remove(),setTimeout(()=>URL.revokeObjectURL(u),1e3)},ie=async e=>{if(e.data&&String(e.data).startsWith("data:")){Z(oe(e.data),e.filename);return}if(e.url)try{const u=await(await fetch(e.url,{credentials:"include"})).blob();Z(u,e.filename)}catch{const d=document.createElement("a");d.href=String(e.url),d.setAttribute("download",e.filename),document.body.appendChild(d),d.click(),d.remove()}},ee=e=>S(e.mime)?"Open":"Download",re=e=>S(e.mime)?Je:Ge,Y=e=>S(e.mime)?se(e):ie(e);return(e,d)=>k.value?(i(),p("div",xt,[l("div",kt,[l("div",Ct,[l("h2",$t,[d[1]||(d[1]=J(" Annual Plan Attachments — ",-1)),l("span",_t,D(g.value?.reference_code||""),1)]),l("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=u=>k.value=!1)},"Close")]),l("div",At,[l("div",St,[d[2]||(d[2]=J(" School Year: ",-1)),l("strong",null,D(g.value?.school_year||"—"),1)]),l("label",{class:ve(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":F.value}])},[(i(),p("svg",Bt,[l("path",{d:v(Me)},null,8,Vt)])),l("span",null,D(F.value?"Uploading…":"Upload"),1),l("input",{type:"file",class:"hidden",disabled:F.value,onChange:le,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,Rt)],2)]),l("div",jt,[(i(!0),p(H,null,ae(Q.value,u=>(i(),p("div",{key:u.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[l("div",Dt,[u.data&&u.data.startsWith("data:")&&u.mime?.startsWith("image/")?(i(),p("img",{key:0,src:u.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Ft)):(i(),p("div",It,[(i(),p("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:ve({"text-red-600":u.mime==="application/pdf","text-blue-600":u.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":u.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!u.mime||!u.mime.startsWith("image/")&&u.mime!=="application/pdf"})},[l("path",{d:s(u.mime)},null,8,Et)],2))]))]),l("div",Ot,[l("div",{class:"font-medium truncate",title:u.name},D(u.name),9,Pt),l("div",Nt,[l("span",null,[J(D(c(u.mime))+" ",1),u.ext?(i(),p("span",Tt,"("+D(u.ext.toUpperCase())+")",1)):w("",!0)]),u.size?(i(),p("span",Mt,D($(u.size)),1)):w("",!0)])]),l("div",zt,[l("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:I=>Y(u),title:ee(u)},[(i(),p("svg",Ut,[l("path",{d:re(u)},null,8,qt)])),J(" "+D(ee(u)),1)],8,Lt),l("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:I=>_(u.id),title:"Remove"},[(i(),p("svg",Jt,[l("path",{d:v(be)},null,8,Gt)])),d[3]||(d[3]=J(" Remove ",-1))],8,Wt)])]))),128))]),Q.value.length?w("",!0):(i(),p("div",Yt," No attachments yet. "))])])):w("",!0)}},Qt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},Ht={class:"bg-white rounded-2xl shadow-2xl w-full sm:w-[1200px] max-w-[100vw] sm:max-w-[95vw] h-[100vh] sm:h-auto sm:max-h-[90vh] overflow-hidden"},Zt={class:"px-4 py-3 border-b flex items-center justify-between"},ea={class:"p-2 overflow-auto"},ta={__name:"AnnualPlansCalendarModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(m,{emit:r}){const f=m,E=r,k=j({get:()=>f.modelValue,set:x=>E("update:modelValue",x)}),b=pe(),g=R([]),F=x=>{if(Array.isArray(x))return x;try{return JSON.parse(x||"[]")}catch{return[]}},O=(x=[])=>{const y=[];x.forEach(o=>{const s=F(o.plans),c=o.club?.name?`[${o.club.name}] `:"";s.forEach((T,q)=>{const $=T?.date_of_implementation;if(!$)return;const G=`${c}${T.item||"Planned Activity"}`;y.push({id:`${o.id}-${q}`,title:G,start:`${$}T00:00:00`,end:`${$}T23:59:59`,backgroundColor:"#b45309",borderColor:"#92400e",textColor:"#ffffff",extendedProps:{annual_plan_id:o.id,reference_code:o.reference_code,school_year:o.school_year,funds:T?.funds??0,status:o.status}})})}),g.value=y},C=async()=>{await b.fetchAll({page:1,limit:500,status:"approved",sort:"created_at",order:"ASC"},!0),O(b.items.data||[])},h=x=>{const y=x?.event?.extendedProps?.annual_plan_id;y&&E("open",Number(y))},P=R(!1),N=()=>{P.value=window.innerWidth<640};X(()=>{N(),window.addEventListener("resize",N)});const S=j(()=>({plugins:[it,rt,dt],initialView:"dayGridMonth",headerToolbar:P.value?{left:"prev,next",center:"title",right:"dayGridMonth"}:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",handleWindowResize:!0,expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:h,events:g.value}));return ne(()=>f.modelValue,x=>{x&&C()}),ne(()=>b.items.data,x=>{k.value&&O(x||[])},{deep:!0}),X(()=>{k.value&&C()}),(x,y)=>k.value?(i(),p("div",Qt,[l("div",Ht,[l("div",Zt,[y[1]||(y[1]=l("h2",{class:"text-base font-semibold"},"Annual Plans Calendar (Approved)",-1)),l("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:y[0]||(y[0]=o=>k.value=!1)},"Close")]),l("div",ea,[B(v(ut),{options:S.value},null,8,["options"])]),y[2]||(y[2]=l("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click a plan item to open its Annual Plan. ",-1))])])):w("",!0)}},aa={class:"flex flex-wrap items-center gap-2 w-full sm:w-auto justify-start sm:justify-end"},na={class:"p-3 mb-4 rounded-xl border bg-white/60"},la={class:"flex items-center gap-2 mb-2 text-gray-700"},sa={class:"w-4 h-4",viewBox:"0 0 24 24"},oa=["d"],ia={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},ra={class:"md:col-span-2 flex"},da={class:"w-5 h-5",viewBox:"0 0 24 24"},ua=["d"],ca=["value"],ma=["disabled"],pa=["value"],fa=["value"],va={class:"flex items-center gap-2 md:col-span-2"},ya={class:"font-medium"},Fa={__name:"AnnualPlansPage",setup(m){const r=pe(),f=_e(),E=j(()=>["admin","manager"].includes(String(f.user?.role||"").toLowerCase())),k=j(()=>{const n=f.user?.last_name||"",t=(f.user?.first_name||"").slice(0,1);return`${n}${n?", ":""}${t?t+".":""}`}),b=n=>{try{return((Array.isArray(n)?n:JSON.parse(n||"[]")||[])||[]).map(a=>(!a||typeof a!="object"||Array.isArray(a.read_by)||(a.read_by=a.user_id!=null?[a.user_id]:[]),a))}catch{return[]}},g=R(!1),F=()=>{g.value=!0},O=R(!1),C=R(null),h=async n=>{try{await r.fetchById(n.id),C.value=r.selected||n}catch{C.value=n}O.value=!0},P=async n=>{if(!C.value)return;const t=b(C.value.remarks);t.push({user_id:f.user?.id||null,user_name:k.value,message:n?.message||"",datetime:n?.datetime||new Date().toISOString(),is_read:!1,read_by:[f.user?.id||null]});try{C.value.remarks=JSON.stringify(t)}catch{}try{await r.updateById(C.value.id,{remarks:JSON.stringify(t)}),await _({},!0)}catch{}},N=async()=>{if(!C.value)return;const n=f.user?.id||null,a=b(C.value.remarks).map(A=>{if(!A||A.user_id===n)return A;const ue=Array.isArray(A.read_by)?A.read_by.slice():[];return ue.includes(n)||ue.push(n),{...A,read_by:ue}});try{C.value.remarks=JSON.stringify(a)}catch{}try{await r.updateById(C.value.id,{remarks:JSON.stringify(a)}),await _({},!0)}catch{}},S=Ae(),x=Se(),y=async()=>{const n=String(S.query.open_remarks_type||""),t=Number(S.query.open_remarks_id||"");if(n==="AP"&&Number.isFinite(t)){try{await r.fetchById(t)}catch{}const a=r.selected;a&&await h(a);const A={...S.query};delete A.open_remarks_type,delete A.open_remarks_id,x.replace({query:A})}};X(y),ne(()=>[S.query.open_remarks_type,S.query.open_remarks_id],()=>{y()});const o=async n=>{try{await r.fetchById(n);const t=r.selected;t&&await M(t)}catch(t){console.error(t)}finally{g.value=!1}},s=R([]);X(async()=>{try{const{data:n}=await Be.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});s.value=Array.isArray(n?.data)?n.data:[]}catch{s.value=[]}});const T=n=>s.value.find(t=>t.id===Number(n))?.name||"—",q=j(()=>{const n=new Date().getFullYear();return Array.from({length:6},(t,a)=>`${n-a}-${n-a+1}`)}),$=R({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:""}),{isClub:G,activeClubId:Q,withClub:le}=mt(),_=async(n={},t=!0)=>{$.value={...$.value,...n};const a=le({...$.value});["q","status","school_year","club_id","filed_by_user_id","approver_user_id"].forEach(A=>{(a[A]===""||a[A]==null)&&delete a[A]}),await r.fetchAll(a,t)};X(async()=>{await _({page:1,limit:10,club_id:G?Q:""})});const se=j(()=>({total:r.items.total||0,totalPages:r.items.totalPages||1,currentPage:r.items.currentPage||1,pageSize:r.items.pageSize||10,data:r.items.data||[]})),oe=["draft","pending","approved","rejected","cancelled","archived"],Z=n=>{switch(String(n||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"archived":return"slate";default:return"gray"}},ie=n=>{const t=Number(n);return Number.isFinite(t)?t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},ee=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"school_year",label:"School Year",sortable:!0,width:120},{key:"club",label:"Club",sortable:!1,minWidth:200,formatter:(n,t)=>t.club?.name||T(t.club_id)||""},{key:"total_budget",label:"Total Budget",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:110},{key:"created_at",label:"Created",sortable:!0,width:170}],re=async n=>{await _(n)},Y=R(!1),e=R(!1),d=R(null),u=()=>{Y.value=!0},I=async n=>{await r.create(n),Y.value=!1,await _({},!0)},M=async n=>{await r.fetchById(n.id);const t=r.selected||n;let a=[];try{a=Array.isArray(t.plans)?t.plans:JSON.parse(t.plans||"[]")}catch{}d.value={id:t.id,reference_code:t.reference_code,school_year:t.school_year||"",club_id:t.club_id||"",filed_by_user_id:t.filed_by_user_id||f.user?.id||"",approver_user_id:t.approver_user_id||"",plans:a,remarks:t.remarks||"",status:t.status||"draft"},e.value=!0},W=async n=>{const{id:t,...a}=n;await r.updateById(t,a),e.value=!1,await _({},!0)},K=async n=>{if(!n?.id)return;(await V.fire({title:`Delete annual plan "${n.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await r.deleteById(n.id),await _({},!0),await V.fire("Deleted","The annual plan has been deleted.","success"))},ge=async n=>{await M(n)},he=async n=>{if((await V.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel"})).isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} submitted annual plan.`,datetime:new Date().toISOString(),is_read:!1}),await r.updateById(n.id,{remarks:JSON.stringify(a)}),await r.submit(n.id),await _({},!0),await V.fire("Submitted","Annual plan is now pending approval.","success")}catch{await V.fire("Error",r.error||"Failed to submit.","error")}},we=async n=>{const t=await V.fire({title:"Approve annual plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(t.isConfirmed)try{const a=b(n.remarks),A=t.value||"";a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} approved annual plan.${A?" - "+A:""}`,datetime:new Date().toISOString(),is_read:!1}),await r.approve(n.id,JSON.stringify(a)),await _({},!0),await V.fire("Approved","Annual plan has been approved.","success")}catch{await V.fire("Error",r.error||"Failed to approve.","error")}},xe=async n=>{const t=await V.fire({title:"Reject annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:a=>a?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(t.isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} rejected annual plan - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1}),await r.reject(n.id,JSON.stringify(a)),await _({},!0),await V.fire("Rejected","Annual plan has been rejected.","success")}catch{await V.fire("Error",r.error||"Failed to reject.","error")}},ke=async n=>{const t=await V.fire({title:"Cancel annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:a=>a?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Plan",cancelButtonText:"Keep"});if(t.isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} cancelled annual plan - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1}),await r.cancel(n.id,JSON.stringify(a)),await r.updateById(n.id,{status:"draft"}),await _({},!0),await V.fire("Moved to Draft","Annual plan was cancelled and returned to Draft for editing.","success")}catch{await V.fire("Error",r.error||"Failed to cancel.","error")}},de=R(!1),fe=R(null),Ce=async n=>{await r.fetchById(n.id),fe.value=r.selected||n,de.value=!0};return(n,t)=>(i(),p(H,null,[B(Ye,null,{default:L(()=>[B(Ke,null,{default:L(()=>[v(r).error?(i(),U(lt,{key:0,icon:v(Xe),color:"danger"},{default:L(()=>[J(D(v(r).error),1)]),_:1},8,["icon"])):w("",!0),B(nt,{icon:v(Qe),title:"Annual Plans",main:""},{default:L(()=>[l("div",aa,[B(me,{icon:v(He),color:"info",label:"View Calendar",onClick:F},null,8,["icon"]),B(me,{icon:v(Ze),color:"primary",label:"New Annual Plan",onClick:u},null,8,["icon"]),B(me,{icon:v(et),color:"info",label:"Refresh",onClick:t[0]||(t[0]=a=>_({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),l("div",na,[l("div",la,[(i(),p("svg",sa,[l("path",{d:v(tt)},null,8,oa)])),t[14]||(t[14]=l("span",{class:"font-medium text-sm"},"Filters",-1))]),l("div",ia,[l("div",ra,[te(l("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>$.value.q=a),placeholder:"Search by ref, school year, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:t[2]||(t[2]=Ve(a=>_({page:1}),["enter"]))},null,544),[[Re,$.value.q]]),l("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:t[3]||(t[3]=a=>_({page:1}))},[(i(),p("svg",da,[l("path",{d:v(at)},null,8,ua)]))])]),te(l("select",{"onUpdate:modelValue":t[4]||(t[4]=a=>$.value.status=a),class:"border rounded px-2 py-2"},[t[15]||(t[15]=l("option",{value:""},"All status",-1)),(i(),p(H,null,ae(oe,a=>l("option",{key:a,value:a},D(a),9,ca)),64))],512),[[ce,$.value.status]]),te(l("select",{"onUpdate:modelValue":t[5]||(t[5]=a=>$.value.school_year=a),class:"border rounded px-2 py-2",disabled:n.readOnly},[t[16]||(t[16]=l("option",{value:""},"Select school year…",-1)),(i(!0),p(H,null,ae(q.value,a=>(i(),p("option",{key:a,value:a},D(a),9,pa))),128))],8,ma),[[ce,$.value.school_year]]),te(l("select",{"onUpdate:modelValue":t[6]||(t[6]=a=>$.value.club_id=a),class:"border rounded px-2 py-2"},[t[17]||(t[17]=l("option",{value:""},"Any club",-1)),(i(!0),p(H,null,ae(s.value,a=>(i(),p("option",{key:a.id,value:a.id},D(a.name),9,fa))),128))],512),[[ce,$.value.club_id]]),l("div",va,[l("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:t[7]||(t[7]=a=>_({page:1}))}," Apply Filters "),l("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[8]||(t[8]=()=>{$.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:""},_({page:1},!0)})},"Reset")])])]),B(st,{columns:ee,data:se.value,loading:v(r).isLoading,onQueryChange:re},{"cell-total_budget":L(({value:a})=>[l("span",ya,D(ie(a)),1)]),"cell-created_at":L(({value:a})=>[l("span",null,D(a?new Date(a).toLocaleString():"—"),1)]),"cell-status":L(({value:a})=>[B(ot,{text:a||"—",tone:Z(a)},null,8,["text","tone"])]),"cell-actions":L(({row:a})=>[B(wt,{row:a,busy:v(r).isActing(a.id),"current-user-id":v(f).user?.id,moderator:E.value,onAttachments:Ce,onSubmit:he,onApprove:we,onReject:xe,onEdit:M,onDelete:K,onView:A=>ge(a),onCancel:ke,onRemarks:h},null,8,["row","busy","current-user-id","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),B(ye,{modelValue:Y.value,"onUpdate:modelValue":t[9]||(t[9]=a=>Y.value=a),mode:"create","locked-club-id":v(G)?v(Q):"",onSubmit:I},null,8,["modelValue","locked-club-id"]),B(ye,{modelValue:e.value,"onUpdate:modelValue":t[10]||(t[10]=a=>e.value=a),mode:"edit",initial:d.value||{},onSubmit:W},null,8,["modelValue","initial"]),B(Xt,{modelValue:de.value,"onUpdate:modelValue":t[11]||(t[11]=a=>de.value=a),row:fe.value},null,8,["modelValue","row"]),B(ta,{modelValue:g.value,"onUpdate:modelValue":t[12]||(t[12]=a=>g.value=a),onOpen:o},null,8,["modelValue"]),B(ct,{modelValue:O.value,"onUpdate:modelValue":t[13]||(t[13]=a=>O.value=a),title:"Remarks • "+(C.value?.reference_code||"Annual Plan"),items:b(C.value?.remarks),"can-add":!0,onAdd:P,onMarkAllRead:N},null,8,["modelValue","title","items"])],64))}};export{Fa as default};
