import{c as J,r as D,x as _e,a as _,d as H,q as b,e as i,k as G,t as T,j as le,g as F,F as se,B as me,S as y,u as ve,z as xe,o as we,f as k,l as I,h as K,v as ee,A as Se,L as Ce,C as Fe,P as Ae}from"./index.BmXZGcv4.js";import{E as Te,a as C,d as fe,Q as Ee,_ as $e}from"./dayjs.min.BJMPBNCU.js";import{B as Re,E as Be,F as Pe,G as ke,H as Le,I as De,C as Ue,D as Ie,z as Ye,_ as Ne,a as Oe,g as ze,J as Me,K as Ve,L as je,M as We,V as qe}from"./SectionMain.D5U6dZyp.js";import{_ as Ge,a as re}from"./SectionTitleLineWithButton.MsKhGGZx.js";import{_ as He,B as Ke,a as Je}from"./Badge.Dj6hCUww.js";import{_ as de}from"./LiquidationFundFormModal.zOEEuJY-.js";import{u as pe}from"./liquidationFund.CL5N7rpc.js";import{u as Qe}from"./clubScope.DlyCzdae.js";import{Q as Xe}from"./browser.CLnyj_cO.js";import"./IconifyButton.YR-Tfzig.js";import"./appContext.T9nj14G-.js";import"./activityDesignService.CLt1R_1P.js";import"./utilizationRequestService.Ck8H3yER.js";import"./liquidationFundService.DYEiIIaD.js";import"./ToasterComponent.C3TePPoQ.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./activityDesign.Dwg6OXmB.js";const Ze={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},et={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},tt={class:"flex items-center justify-between mb-3"},at={class:"text-lg font-semibold"},ot={class:"text-gray-600"},it={class:"flex items-center justify-between gap-2"},nt={class:"text-sm text-gray-600"},lt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},st=["d"],rt=["disabled"],dt={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},ct={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},ut=["src"],mt={key:1,class:"flex items-center justify-center w-full h-full"},ft=["d"],pt={class:"mt-2 text-xs"},gt=["title"],yt={class:"text-gray-500 flex items-center justify-between"},ht={key:0},bt={key:0},_t={class:"mt-2 flex items-center justify-between gap-2"},vt=["onClick","title"],xt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},wt=["d"],St=["onClick"],Ct={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Ft=["d"],At={key:0,class:"mt-6 text-center text-sm text-gray-500"},Tt=10*1024*1024,Et={__name:"LiquidationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(e,{emit:o}){const p=e,r=o,f=J({get:()=>p.modelValue,set:t=>r("update:modelValue",t)}),u=pe(),s=D(null),v=D(!1),Y=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),q=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),g=(t="")=>String(t).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",O=(t="")=>typeof t=="string"&&t.match(/^data:([^;]+);base64,/i)?.[1]||"",z=t=>{const d=t?.type&&Y.has(t.type),c=t?.name&&q.has(g(t.name));return d||c},m=(t="")=>String(t).startsWith("image/"),A=(t="")=>t==="application/pdf",h=(t="")=>t==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",x=(t="")=>t==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",E=(t="")=>A(t)?Be:h(t)?Pe:x(t)?ke:m(t)?Le:De,R=(t="")=>A(t)?"PDF":h(t)?"Word":x(t)?"Excel":m(t)?"Image":"File",S=(t="")=>A(t)?"pdf":h(t)?"docx":x(t)?"xlsx":t==="image/png"?"png":t==="image/jpeg"?"jpg":t==="image/webp"?"webp":"",B=(t="attachment",d="")=>/\.[a-z0-9]+$/i.test(t)?t:d?`${t}.${d.startsWith(".")?d.slice(1):d}`:t,L=t=>t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`,U=J(()=>{const t=s.value?.attachments;if(!t)return[];try{return Array.isArray(t)?t:JSON.parse(t||"[]")}catch{return[]}}),X=J(()=>(U.value||[]).map((t,d)=>{const c=t.mime||O(t.data)||(t.name?g(t.name)==="pdf"&&"application/pdf":"")||"",w=g(t.name||"")||S(c),N=t.size??null,j=t.name||`${R(c)} ${d+1}`;return{id:t.id??d+1,name:j,data:t.data||"",url:t.url||t.href||t.path||"",mime:c,ext:w,size:N,filename:B(j,w)}}));_e(()=>p.modelValue,async t=>{t&&p.row?.id&&(await u.fetchById(p.row.id),s.value=u.selected||p.row)});const te=async t=>{const d=t.target.files?.[0];if(t.target.value="",!(!d||!s.value?.id)){if(d.size>Tt){await y.fire("File too large","Maximum size is 10 MB.","warning");return}if(!z(d)){await y.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{v.value=!0,await u.uploadAttachment(s.value.id,d),await u.fetchById(s.value.id),s.value=u.selected}finally{v.value=!1}}},ae=async t=>{!s.value?.id||!(await y.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await u.deleteAttachment(s.value.id,t),await u.fetchById(s.value.id),s.value=u.selected)},oe=t=>{if(t.data&&String(t.data).startsWith("data:")&&m(t.mime)){const d=window.open();d&&d.document.write(`<img src="${t.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}t.url&&window.open(String(t.url),"_blank")},M=t=>{const[d,c]=t.split(","),w=d.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",N=atob(c),j=new Uint8Array(N.length);for(let l=0;l<N.length;l++)j[l]=N.charCodeAt(l);return new Blob([j],{type:w})},V=(t,d)=>{const c=URL.createObjectURL(t),w=document.createElement("a");w.href=c,w.download=d||"download",document.body.appendChild(w),w.click(),w.remove(),setTimeout(()=>URL.revokeObjectURL(c),1e3)},$=async t=>{if(t.data&&String(t.data).startsWith("data:")){const d=M(t.data);V(d,t.filename);return}if(t.url)try{const c=await(await fetch(t.url,{credentials:"include"})).blob();V(c,t.filename)}catch{const d=document.createElement("a");d.href=String(t.url),d.setAttribute("download",t.filename),document.body.appendChild(d),d.click(),d.remove()}},Z=t=>m(t.mime)?"Open":"Download",ie=t=>m(t.mime)?Ue:Ie,ne=t=>m(t.mime)?oe(t):$(t);return(t,d)=>f.value?(b(),_("div",Ze,[i("div",et,[i("div",tt,[i("h2",at,[d[1]||(d[1]=G(" Liquidation Attachments — ",-1)),i("span",ot,T(s.value?.reference_code||""),1)]),i("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=c=>f.value=!1)},"Close")]),i("div",it,[i("div",nt,[d[2]||(d[2]=G(" Activity: ",-1)),i("strong",null,T(s.value?.activity_design?.name_of_activity||"—"),1)]),i("label",{class:le(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":v.value}])},[(b(),_("svg",lt,[i("path",{d:F(Re)},null,8,st)])),i("span",null,T(v.value?"Uploading…":"Upload"),1),i("input",{type:"file",class:"hidden",disabled:v.value,onChange:te,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,rt)],2)]),i("div",dt,[(b(!0),_(se,null,me(X.value,c=>(b(),_("div",{key:c.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[i("div",ct,[c.data&&c.data.startsWith("data:")&&c.mime?.startsWith("image/")?(b(),_("img",{key:0,src:c.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,ut)):(b(),_("div",mt,[(b(),_("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:le({"text-red-600":c.mime==="application/pdf","text-blue-600":c.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":c.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!c.mime||!c.mime.startsWith("image/")&&c.mime!=="application/pdf"})},[i("path",{d:E(c.mime)},null,8,ft)],2))]))]),i("div",pt,[i("div",{class:"font-medium truncate",title:c.name},T(c.name),9,gt),i("div",yt,[i("span",null,[G(T(R(c.mime))+" ",1),c.ext?(b(),_("span",ht,"("+T(c.ext.toUpperCase())+")",1)):H("",!0)]),c.size?(b(),_("span",bt,T(L(c.size)),1)):H("",!0)])]),i("div",_t,[i("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:w=>ne(c),title:Z(c)},[(b(),_("svg",xt,[i("path",{d:ie(c)},null,8,wt)])),G(" "+T(Z(c)),1)],8,vt),i("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:w=>ae(c.id),title:"Remove"},[(b(),_("svg",Ct,[i("path",{d:F(Ye)},null,8,Ft)])),d[3]||(d[3]=G(" Remove ",-1))],8,St)])]))),128))]),X.value.length?H("",!0):(b(),_("div",At," No attachments yet. "))])])):H("",!0)}},$t="KOLEHIYO NG PANTUKAN",Rt="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",Bt="https://osas.knp.edu.ph/verify-liquidation?id=",Q=e=>e?fe(e).format("MMMM DD, YYYY"):"—",W=(e,o=2)=>e==null||e===""||Number.isNaN(Number(e))?"—":Number(e).toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o}),ce=(e,o)=>{if(Array.isArray(e)||e&&typeof e=="object")return e;try{return JSON.parse(e||"null")??o}catch{return o}},ge="./",Pt=`${ge}images/logo.png`,kt=`${ge}images/bg.jpg`;async function ue(e){try{const p=await(await fetch(e)).blob();return new Promise(r=>{const f=new FileReader;f.onloadend=()=>r(f.result),f.readAsDataURL(p)})}catch{return null}}function Lt(e){switch(e){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}async function Dt(e){const o=e.internal.pageSize.getWidth(),p=110,r=36,f=await ue(kt);f?(e.addImage(f,"JPEG",0,0,o,p,void 0,"FAST"),e.setGState(new e.GState({opacity:.18})),e.setFillColor(0,0,0),e.rect(0,0,o,p,"F"),e.setGState(new e.GState({opacity:1}))):(e.setFillColor(21,62,121),e.rect(0,0,o,p,"F"));const u=await ue(Pt);return u&&e.addImage(u,"PNG",r,20,70,70,void 0,"FAST"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(20),e.text($t,r+86,38),e.setFont("helvetica","normal"),e.setFontSize(10),e.text(Rt,r+86,58),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(14),e.text("LIQUIDATION FUND",o/2,p+24,{align:"center"}),p+34}async function Ut(e,o,p){const r=e.internal.pageSize.getWidth(),f=36,u=o?.id??o?.reference_code??"",s=`${Bt}${encodeURIComponent(String(u))}`,v=await Xe.toDataURL(s,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),Y=String(o.status||"").toUpperCase(),[q,g,O]=Lt(Y),z=o.approved_at?Q(o.approved_at):o.date_filed?Q(o.date_filed):"—",m=`osas.knp.edu.ph/verify-liquidation?id=${String(u)}`;return C(e,{startY:p,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:f,right:f},tableWidth:r-f*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:r-f*2-260},1:{cellWidth:260}},didDrawCell:A=>{if(A.section!=="body")return;const{x:h,y:x,width:E,height:R}=A.cell,S=10;if(A.column.index===0){e.setFillColor(255,255,255),e.roundedRect(h,x,E-1,R,6,6,"F");const B=24,L=Math.min(180,E-22);e.setFillColor(q,g,O),e.roundedRect(h+S,x+S,L,B,12,12,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text(Y||"STATUS",h+S+10,x+S+16),e.setTextColor(20),e.setFont("helvetica","normal"),e.setFontSize(9);let U=x+S+B+16;e.text(`Ref No.: ${o.reference_code||"—"}`,h+S,U),U+=16,e.text(`Date Filed: ${Q(o.date_filed)}`,h+S,U),U+=16,e.text(`Date Issued: ${z}`,h+S,U),e.setDrawColor(230),e.roundedRect(h,x,E-1,R,6,6,"S")}if(A.column.index===1){e.setFillColor(255,255,255),e.roundedRect(h,x,E-1,R,6,6,"F"),e.setFillColor(66,103,178),e.roundedRect(h,x,E-1,22,6,6,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("VERIFY",h+S,x+15);const B=h+S,L=x+28;e.addImage(v,"PNG",B,L,75,75,void 0,"FAST"),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("Scan to verify",B+100,L+14),e.setFont("helvetica","normal"),e.setFontSize(9),e.text("This document can be verified",B+100,L+32),e.text("online via the OSAS portal.",B+100,L+46),e.setTextColor(110),e.setFontSize(8),e.text(m,B+100,L+72),e.setDrawColor(230),e.roundedRect(h,x,E-1,R,6,6,"S")}}}),e.lastAutoTable.finalY}async function ye(e){const o=new Te({unit:"pt",format:[612,936],orientation:"landscape"}),p=o.internal.pageSize.getWidth(),r=36,f=ce(e.sources_of_fund,{}),u=ce(e.uses_of_fund,[]);let s=await Dt(o);s=await Ut(o,e,s)+10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY;const v=e.activity_design||{};C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},v.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Q(v.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},v.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},v.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},v.office_department||v?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),s=o.lastAutoTable.finalY+10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"SUMMARY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY,C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["Total Sources",W(e.total_sources_amount,2)],["Total Uses",W(e.total_uses_amount,2)],["Total Cash on Hand",W(e.total_cash_on_hand,2)]],columnStyles:{0:{cellWidth:220,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),s=o.lastAutoTable.finalY+10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"SOURCES OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY;const Y=[["Contribution",f.contribution],["Payment from Fines",f.payment_from_fines],["Solicitations",f.solicitations],["Donations",f.donations],["Other Sources",f.other_sources],["Current Available Funds",f.current_available_funds]];C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PARTICULAR","AMOUNT"]],body:Y.map(([m,A])=>[m,W(A,2)]),columnStyles:{0:{cellWidth:320},1:{cellWidth:"auto",halign:"right"}},margin:{left:r,right:r}}),s=o.lastAutoTable.finalY,f?.other_sources_note&&(C(o,{startY:s,theme:"plain",styles:{fontSize:9},body:[[{content:`Note: ${String(f.other_sources_note)}`,styles:{cellPadding:6,textColor:[71,85,105]}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY),s+=10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"USE OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY,Array.isArray(u)&&u.length?C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["DATE","QTY","UNIT","PARTICULARS","SHEET NO.","AMOUNT","IN-CHARGE"]],body:u.map(m=>[m?.date?Q(m.date):"—",W(m?.qty??"",0),m?.unit||"—",m?.particulars||"—",m?.sheet_no||"—",W(m?.amount??"",2),m?.in_charge||"—"]),columnStyles:{0:{cellWidth:82},1:{cellWidth:44,halign:"right"},2:{cellWidth:56},3:{cellWidth:200},4:{cellWidth:76},5:{cellWidth:78,halign:"right"},6:{cellWidth:"auto"}},margin:{left:r,right:r},foot:[["","","","","TOTAL",W(e.total_uses_amount,2),""]],footStyles:{fontStyle:"bold"}}):C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY+10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"REMARKS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY,C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[e.remarks&&String(e.remarks).trim()?e.remarks:"—"]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY+10,C(o,{startY:s,theme:"plain",styles:{fontSize:10},body:[[{content:"SIGNATORIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),s=o.lastAutoTable.finalY;const g=String(e?.file_by_user_name||"").trim()||(e?.filed_by?`${e.filed_by.first_name||""} ${e.filed_by.last_name||""}`.trim():""),O=e?.approver?`${e.approver.first_name||""} ${e.approver.last_name||""}`.trim():"";C(o,{startY:s,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PREPARED BY:","NOTED BY:","APPROVED BY:"]],body:[[g||" ","Albert P. Mapalo, LPT, MAEd",O||" "]],columnStyles:{0:{cellWidth:(p-r*2)/2},1:{cellWidth:"auto"}},didParseCell:m=>{m.section==="body"&&(m.cell.styles.halign="center",m.cell.styles.fontStyle="bold",m.cell.styles.cellPadding={top:16,right:10,bottom:18,left:10})},margin:{left:r,right:r}});const z=o.internal.pageSize.getHeight()-20;return o.setFontSize(8),o.setTextColor(120),o.text(`Generated on ${fe().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,r,z),o}async function It(e){(await ye(e)).save(`${e.reference_code||"Liquidation_Fund"}.pdf`)}const Yt={class:"flex items-center gap-2"},Nt={class:"p-2 mb-4 rounded-xl border bg-white/60"},Ot={class:"flex items-center gap-2 mb-2 text-gray-700"},zt={class:"w-4 h-4",viewBox:"0 0 24 24"},Mt=["d"],Vt={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},jt={class:"md:col-span-2 flex"},Wt={class:"w-5 h-5",viewBox:"0 0 24 24"},qt=["d"],Gt=["value"],Ht={class:"md:col-span-2"},Kt={class:"flex items-center gap-2 md:col-span-1"},Jt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30"},Qt={class:"bg-white w-[560px] rounded-xl shadow p-4"},Xt={class:"flex items-center justify-between mb-2"},Zt={class:"grid grid-cols-1 gap-2 text-sm"},ea={class:"flex gap-2"},ta={class:"text-[11px] text-gray-600"},aa={class:"mt-3 flex justify-end gap-2"},va={__name:"LiquidationFundsPage",setup(e){const o=pe(),p=ve(),r=xe(),f={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},u=D({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",activity_design_id:"",filed_by_user_id:"",date_filed_from:"",date_filed_to:""}),s=J({get:()=>{const{date_filed_from:l,date_filed_to:a}=u.value;return l||a?[l||null,a||null]:null},set:l=>{if(!l)u.value.date_filed_from=null,u.value.date_filed_to=null;else{const[a,n]=l;u.value.date_filed_from=a||null,u.value.date_filed_to=n||null}}}),{isClub:v,activeClubId:Y,withClub:q}=Qe(),g=async(l={},a=!0)=>{u.value={...u.value,...l};const n=q({...u.value});["q","status","activity_design_id","filed_by_user_id","date_filed_from","date_filed_to"].forEach(P=>{(n[P]===""||n[P]==null)&&delete n[P]}),await o.fetchAll(n,a)};we(async()=>{await g({page:1,limit:10,club_id:v?Y:""})});const O=J(()=>({total:o.items.total||0,totalPages:o.items.totalPages||1,currentPage:o.items.currentPage||1,pageSize:o.items.pageSize||10,data:o.items.data||[]})),z=["draft","pending","approved","rejected","cancelled","completed"],m=l=>{switch(String(l||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},A=l=>{const a=Number(l);return Number.isFinite(a)?a.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},h=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:240,formatter:(l,a)=>a.activity_design?a.activity_design.name_of_activity:""},{key:"total_sources_amount",label:"Sources",sortable:!0,width:120},{key:"total_uses_amount",label:"Uses",sortable:!0,width:120},{key:"total_cash_on_hand",label:"Cash on Hand",sortable:!0,width:140},{key:"date_filed",label:"Date Filed",sortable:!0,width:120},{key:"status",label:"Status",sortable:!0,width:120}],x=async l=>{await g(l)},E=D(!1),R=D(!1),S=D(null),B=()=>{E.value=!0},L=async l=>{await o.create(l),E.value=!1,await g({},!0)},U=async l=>{await o.fetchById(l.id);const a=o.selected||l;let n={},P=[];try{n=typeof a.sources_of_fund=="string"?JSON.parse(a.sources_of_fund||"{}"):a.sources_of_fund||{}}catch{}try{P=Array.isArray(a.uses_of_fund)?a.uses_of_fund:JSON.parse(a.uses_of_fund||"[]")}catch{}S.value={id:a.id,reference_code:a.reference_code,date_filed:a.date_filed||"",activity_design_id:a.activity_design_id||"",file_by_user_name:a.file_by_user_name||"",sources_of_fund:n,uses_of_fund:P,remarks:a.remarks||"",status:a.status||"draft"},R.value=!0},X=async l=>{const{id:a,...n}=l;await o.updateById(a,n),R.value=!1,await g({},!0)},te=async l=>{if(!l?.id)return;(await y.fire({title:`Delete liquidation "${l.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await o.deleteById(l.id),await g({},!0),await y.fire("Deleted","The liquidation fund has been deleted.","success"))},ae=async l=>{await U(l)},oe=async l=>{if((await y.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await o.submit(l.id),await g({},!0),await y.fire("Submitted","Liquidation is now pending approval.","success")}catch{await y.fire("Error",o.error||"Failed to submit.","error")}},M=D(!1),V=D(null),$=D({from_email:"",from_name:"",to:"",subject:"",html:"",attachments:[]}),Z=async l=>{try{await o.fetchById(l.id);const a=o.selected||l,P=(await ye(a)).output("datauristring"),he=String(P).split(",")[1]||"",be=`${a.reference_code||"Liquidation_Fund"}.pdf`;V.value=a,$.value={from_email:"osas@knp.edu.ph",from_name:`${p.user?.first_name||""} ${p.user?.last_name||""}`.trim(),to:"",subject:`Liquidation Fund ${a.reference_code||""}`.trim(),html:"Please see the attached file.",attachments:[{filename:be,content:he,type:"application/pdf"}]},M.value=!0}catch{await y.fire("Error",o.error||"Failed to prepare email.","error")}},ie=async()=>{const l=V.value;if(l)try{await o.sendEmail(l.id,{...$.value}),M.value=!1,await y.fire("Sent","Email sent successfully.","success")}catch{await y.fire("Error",o.error||"Failed to send email.","error")}},ne=async l=>{const a=await y.fire({title:"Approve liquidation?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(a.isConfirmed)try{await o.approve(l.id,a.value||""),await g({},!0),await y.fire("Approved","Liquidation has been approved.","success")}catch{await y.fire("Error",o.error||"Failed to approve.","error")}},t=async l=>{const a=await y.fire({title:"Reject liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(a.isConfirmed)try{await o.reject(l.id,a.value),await g({},!0),await y.fire("Rejected","Liquidation has been rejected.","success")}catch{await y.fire("Error",o.error||"Failed to reject.","error")}},d=async l=>{const a=await y.fire({title:"Cancel liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Liquidation",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(a.isConfirmed)try{await o.cancel(l.id,a.value),await g({},!0),await y.fire("Cancelled","Liquidation has been cancelled.","success")}catch{await y.fire("Error",o.error||"Failed to cancel.","error")}},c=async l=>{if(String(l?.status||"").toLowerCase()!=="approved"){await y.fire("Not allowed","Only approved liquidation can be printed.","info");return}try{await o.fetchById(l.id);const n=o.selected||l;await It(n)}catch(n){await y.fire("Error",o.error||"Failed to generate PDF.","error"),console.error(n)}},w=D(!1),N=D(null),j=async l=>{await o.fetchById(l.id),N.value=o.selected||l,w.value=!0};return(l,a)=>(b(),_(se,null,[k(Ne,null,{default:I(()=>[k(Oe,null,{default:I(()=>[F(o).error?(b(),Se(He,{key:0,icon:F(ze),color:"danger"},{default:I(()=>[G(T(F(o).error),1)]),_:1},8,["icon"])):H("",!0),k(Ge,{icon:F(Me),title:"Liquidation Funds",main:""},{default:I(()=>[i("div",Yt,[k(re,{icon:F(Ve),color:"primary",label:"New Liquidation",onClick:B},null,8,["icon"]),k(re,{icon:F(je),color:"info",label:"Refresh",onClick:a[0]||(a[0]=n=>g({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),i("div",Nt,[i("div",Ot,[(b(),_("svg",zt,[i("path",{d:F(We)},null,8,Mt)])),a[18]||(a[18]=i("span",{class:"font-medium text-sm"},"Filters",-1))]),i("div",Vt,[i("div",jt,[K(i("input",{"onUpdate:modelValue":a[1]||(a[1]=n=>u.value.q=n),placeholder:"Search by ref, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:a[2]||(a[2]=Ce(n=>g({page:1}),["enter"]))},null,544),[[ee,u.value.q]]),i("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:a[3]||(a[3]=n=>g({page:1}))},[(b(),_("svg",Wt,[i("path",{d:F(qe)},null,8,qt)]))])]),K(i("select",{"onUpdate:modelValue":a[4]||(a[4]=n=>u.value.status=n),class:"border rounded px-2 py-2"},[a[19]||(a[19]=i("option",{value:""},"All status",-1)),(b(),_(se,null,me(z,n=>i("option",{key:n,value:n},T(n),9,Gt)),64))],512),[[Fe,u.value.status]]),i("div",Ht,[k(F(Ee),Ae({modelValue:s.value,"onUpdate:modelValue":a[5]||(a[5]=n=>s.value=n)},f,{placeholder:"Date filed range"}),null,16,["modelValue"])]),i("div",Kt,[i("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:a[6]||(a[6]=n=>g({page:1}))}," Apply Filters "),i("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:a[7]||(a[7]=()=>{u.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",date_filed_from:"",date_filed_to:""},g({page:1},!0)})},"Reset")])])]),k(Ke,{columns:h,data:O.value,loading:F(o).isLoading,onQueryChange:x},{"cell-total_sources_amount":I(({value:n})=>[i("span",null,T(A(n)),1)]),"cell-total_uses_amount":I(({value:n})=>[i("span",null,T(A(n)),1)]),"cell-total_cash_on_hand":I(({value:n})=>[i("span",{class:le(["font-medium",Number(n)<0?"text-red-600":"text-emerald-700"])},T(A(n)),3)]),"cell-status":I(({value:n})=>[k(Je,{text:n||"—",tone:m(n)},null,8,["text","tone"])]),"cell-actions":I(({row:n})=>[k($e,{row:n,moderator:["admin","manager"].includes(String(F(p).user?.role||"").toLowerCase()),onAttachments:j,onSubmit:oe,onApprove:ne,onReject:t,onEdit:U,onDelete:te,onView:P=>ae(n),onCancel:d,onPrint:c,onEmail:Z},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),k(de,{modelValue:E.value,"onUpdate:modelValue":a[8]||(a[8]=n=>E.value=n),mode:"create",onSubmit:L},null,8,["modelValue"]),k(de,{modelValue:R.value,"onUpdate:modelValue":a[9]||(a[9]=n=>R.value=n),mode:"edit",initial:S.value||{},onSubmit:X},null,8,["modelValue","initial"]),k(Et,{modelValue:w.value,"onUpdate:modelValue":a[10]||(a[10]=n=>w.value=n),row:N.value},null,8,["modelValue","row"]),M.value?(b(),_("div",Jt,[i("div",Qt,[i("div",Xt,[a[20]||(a[20]=i("h3",{class:"text-base font-semibold"},"Send Email",-1)),i("button",{class:"px-2 py-1 text-xs bg-gray-200 rounded",onClick:a[11]||(a[11]=n=>M.value=!1)},"Close")]),i("div",Zt,[i("div",null,[a[21]||(a[21]=i("label",{class:"block mb-0.5"},"To",-1)),i("div",ea,[K(i("input",{"onUpdate:modelValue":a[12]||(a[12]=n=>$.value.to=n),class:"flex-1 border rounded px-2 py-1.5",placeholder:"recipient@example.com"},null,512),[[ee,$.value.to]]),i("button",{class:"px-2 py-1 text-[11px] rounded border bg-gray-50 hover:bg-gray-100",onClick:a[13]||(a[13]=()=>{const n=V.value?.filed_by_user_id||V.value?.filed_by?.id;n&&F(r).fetchById(n).then(()=>{const P=F(r).selectedUser?.email;P&&($.value.to=P)})})},"Use Filer"),i("button",{class:"px-2 py-1 text-[11px] rounded border bg-rose-50 hover:bg-rose-100",onClick:a[14]||(a[14]=()=>{$.value.attachments=[]})},"Remove Attachment")])]),i("div",null,[a[22]||(a[22]=i("label",{class:"block mb-0.5"},"Subject",-1)),K(i("input",{"onUpdate:modelValue":a[15]||(a[15]=n=>$.value.subject=n),class:"w-full border rounded px-2 py-1.5"},null,512),[[ee,$.value.subject]])]),i("div",null,[a[23]||(a[23]=i("label",{class:"block mb-0.5"},"Message",-1)),K(i("textarea",{"onUpdate:modelValue":a[16]||(a[16]=n=>$.value.html=n),rows:"4",class:"w-full border rounded px-2 py-1.5"},null,512),[[ee,$.value.html]])]),i("div",ta,"Attachment: "+T($.value.attachments?.[0]?.filename||"liquidation.pdf"),1)]),i("div",aa,[i("button",{class:"px-3 py-1.5 text-xs bg-gray-200 rounded",onClick:a[17]||(a[17]=n=>M.value=!1)},"Cancel"),i("button",{class:"px-3 py-1.5 text-xs bg-emerald-600 text-white rounded",onClick:ie},"Send")])])])):H("",!0)],64))}};export{va as default};
