import{c as v,u as ee,o as te,r as V,x as j,a as l,d as c,q as d,e as t,t as u,k as _,h as p,C as U,g as F,j as h,F as k,B as w,v as b,S as $}from"./index.BJlvp4Na.js";import{u as se}from"./clubScope.DQ_0X4Hj.js";import{u as ae}from"./utilizationRequest.Be3yxW8b.js";import{u as ie}from"./activityDesign.B6gLDy9B.js";const le={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},de={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-[720px] max-h-[85vh] overflow-y-auto"},ne={class:"flex items-center justify-between mb-2"},oe={class:"flex items-center gap-2"},re={class:"text-base font-semibold"},ue={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},ce={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},me={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},pe={class:"md:col-span-2"},ve=["disabled"],_e=["value"],be={key:0,class:"text-red-600 text-[11px] mt-0.5"},fe={key:1,class:"text-[11px] text-gray-500 mt-0.5"},ye={key:2,class:"text-[11px] text-amber-700 mt-0.5"},xe={key:0,class:"text-red-600 text-[11px] mt-0.5"},ge=["disabled"],he={key:0,class:"text-red-600 text-[11px] mt-0.5"},ke=["disabled"],we={key:0,class:"text-red-600 text-[11px] mt-0.5"},qe=["disabled"],Se={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ae={class:"mt-2 text-sm"},Be={class:"flex gap-1.5"},Ce=["disabled"],Ne=["value"],Ve=["disabled"],Ue={key:0,class:"text-red-600 text-[11px] mt-0.5"},$e={class:"mt-1.5 flex flex-wrap gap-1.5"},Ee=["onClick"],Oe={key:0,class:"text-gray-400 text-xs"},De={class:"mt-3 text-sm"},Te={class:"flex items-center justify-between"},je=["disabled"],Fe={class:"mt-1 border rounded overflow-hidden"},Le={class:"w-full text-[12px]"},Re={class:"p-1.5"},ze=["onUpdate:modelValue","disabled","onChange"],Ie=["value"],Me={key:0,class:"text-red-600 mt-0.5 text-[11px]"},Pe={class:"p-1.5"},We=["onUpdate:modelValue","disabled"],Ge={class:"p-1.5"},Qe=["onUpdate:modelValue","disabled"],Je={class:"p-1.5 text-right"},Ye=["disabled","onClick"],Ke={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},Xe=["disabled"],He={key:0},Ze=["disabled"],et={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},tt=["disabled"],st={class:"mt-2 p-2 rounded-lg border bg-white"},at={class:"flex items-center justify-between"},it=["disabled"],lt={class:"flex justify-end gap-1.5 mt-4"},ut={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(L,{emit:R}){const q=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],y=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],f=L,E=R,A=v({get:()=>f.modelValue,set:a=>E("update:modelValue",a)}),B=ee(),O=ae(),x=ie(),D=v(()=>String(B.user?.role||"").toLowerCase()==="admin"),C=v(()=>{const a=Array.isArray(x.items?.data)?x.items.data.filter(e=>String(e.status).toLowerCase()==="approved"):[];if(T.value&&S.value){const e=Number(S.value);return a.filter(i=>Number(i.club_id||i.club?.id)===e)}return a}),{isClub:T,activeClubId:S}=se();te(async()=>{const a={page:1,limit:200,status:"approved",officer:!0},e=T.value&&S.value?{...a,club_id:S.value}:a;await x.fetchAll(e,!0)});const s=V({...f.initial}),n=V({}),z=v(()=>{const a=Number(s.value.activity_design_id||0);return C.value.find(e=>Number(e.id)===a)||null});j(()=>f.initial,a=>{s.value={...a,facilities:Array.isArray(a.facilities)?a.facilities:(()=>{try{return JSON.parse(a.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(a.equipment_items)?a.equipment_items:(()=>{try{return JSON.parse(a.equipment_items||"[]")}catch{return[]}})()},s.value.facilities=(s.value.facilities||[]).filter(e=>q.includes(e)),s.value.equipment_items=(s.value.equipment_items||[]).filter(e=>!e?.name||y.includes(e.name)),n.value={}},{immediate:!0}),j(()=>s.value.activity_design_id,()=>{const a=z.value;a?.date_of_implementation?s.value.start_date=String(a.date_of_implementation).slice(0,10):s.value.start_date=""},{immediate:!0});const I=v(()=>String(s.value?.status||"").toLowerCase()),o=v(()=>f.mode==="edit"&&I.value!=="draft"),M=v(()=>f.mode!=="edit"?"New Utilization Request":o.value?"View Utilization (read-only)":"Edit Utilization"),P=v(()=>f.mode==="edit"?"Save Changes":"Create"),W=a=>{const e=a?.name_of_activity||"Untitled",i=a?.school_year?` • SY ${a.school_year}`:"",r=a?.semester?` • ${a.semester}`:"",m=a?.reference_code?` [${a.reference_code}]`:"";return`${e}${i}${r}${m}`},g=V(""),G=v(()=>q.filter(a=>!(s.value.facilities||[]).includes(a))),Q=()=>{const a=g.value;!a||!q.includes(a)||(Array.isArray(s.value.facilities)||(s.value.facilities=[]),s.value.facilities.includes(a)||s.value.facilities.push(a),g.value="")},J=a=>{s.value.facilities.splice(a,1)},Y=()=>{Array.isArray(s.value.equipment_items)||(s.value.equipment_items=[]);const a=new Set((s.value.equipment_items||[]).map(i=>i?.name).filter(Boolean)),e=y.find(i=>!a.has(i))||y[0];a.has(e)||s.value.equipment_items.push({name:e,qty:1,unit:""})},K=a=>{s.value.equipment_items.splice(a,1)},N=a=>{const e=new Set((s.value.equipment_items||[]).map((i,r)=>r===a?null:i?.name).filter(Boolean));return y.filter(i=>!e.has(i))},X=()=>{if(o.value)return!1;const a={};s.value.activity_design_id||(a.activity_design_id="Required"),s.value.start_date||(a.start_date="Start date is required (from Activity Design)"),s.value.start_time||(a.start_time="Required"),s.value.end_date||(a.end_date="Required"),s.value.end_time||(a.end_time="Required"),!Array.isArray(s.value.facilities)||!s.value.facilities.length?a.facilities="Select at least one":s.value.facilities.every(i=>q.includes(i))||(a.facilities="Invalid facility selected");const e=new Set;if(Array.isArray(s.value.equipment_items)&&s.value.equipment_items.forEach((i,r)=>{i?.name&&!y.includes(i.name)&&(a[`equipment_${r}`]="Invalid equipment"),i?.name&&e.has(i.name)&&(a[`equipment_${r}`]="Duplicate item; adjust quantity instead"),i?.name&&e.add(i.name),i?.name&&(isNaN(Number(i.qty))||Number(i.qty)<=0)&&(a[`equipment_${r}`]="Qty must be > 0")}),s.value.start_date&&s.value.end_date&&s.value.start_time&&s.value.end_time){const i=new Date(`${s.value.start_date}T${s.value.start_time}:00`);new Date(`${s.value.end_date}T${s.value.end_time}:00`)<i&&(a.end_time="End must be after or equal to start")}return n.value=a,Object.keys(a).length===0},H=async()=>{if(!s.value.start_date||!s.value.end_date||!s.value.facilities?.length){await $.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const a=await O.checkAvailability({start_date:s.value.start_date,start_time:s.value.start_time||"00:00",end_date:s.value.end_date,end_time:s.value.end_time||"00:00",facilities:s.value.facilities}),e=a.available_for_all?"All selected facilities are available.":`Conflicts on: ${(a.conflict_facilities||[]).join(", ")||"—"}`;await $.fire({icon:a.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(a.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${e}</div>
      </div>`})}catch(a){await $.fire("Error",O.error||"Failed to check availability.","error"),console.error(a)}},Z=()=>{if(o.value||!X())return;const a={...s.value};B.user?.id&&(a.filed_by_user_id=B.user.id),D.value||delete a.file_by_user_name,E("submit",a)};return(a,e)=>A.value?(d(),l("div",le,[t("div",de,[t("div",ne,[t("div",oe,[t("h2",re,u(M.value),1),t("span",ue,u(s.value.status),1)]),t("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:e[0]||(e[0]=i=>A.value=!1)},"Close")]),o.value?(d(),l("div",ce,[e[11]||(e[11]=_(" This request is ",-1)),t("strong",null,u(s.value.status),1),e[12]||(e[12]=_(". Editing is disabled. ",-1))])):c("",!0),t("div",me,[t("div",pe,[e[14]||(e[14]=t("label",{class:"block mb-0.5"},[_("Activity Design "),t("span",{class:"text-red-500"},"*")],-1)),p(t("select",{"onUpdate:modelValue":e[1]||(e[1]=i=>s.value.activity_design_id=i),class:h(["w-full border rounded px-2 py-1.5",n.value.activity_design_id?"border-red-500":""]),disabled:o.value||F(x).isLoading},[e[13]||(e[13]=t("option",{value:""},"Select approved activity design…",-1)),(d(!0),l(k,null,w(C.value,i=>(d(),l("option",{key:i.id,value:i.id},u(W(i)),9,_e))),128))],10,ve),[[U,s.value.activity_design_id]]),n.value.activity_design_id?(d(),l("p",be,u(n.value.activity_design_id),1)):c("",!0),F(x).isLoading?(d(),l("p",fe,"Loading approved activities… ")):C.value.length?c("",!0):(d(),l("p",ye," No approved activity designs found. Approve an Activity Design first. "))]),t("div",null,[e[15]||(e[15]=t("label",{class:"block mb-0.5"},[_("Start Date "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>s.value.start_date=i),type:"date",class:h(["w-full border rounded px-2 py-1.5 bg-gray-50",n.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[b,s.value.start_date]]),n.value.start_date?(d(),l("p",xe,u(n.value.start_date),1)):c("",!0)]),t("div",null,[e[16]||(e[16]=t("label",{class:"block mb-0.5"},[_("Start Time "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>s.value.start_time=i),type:"time",class:h(["w-full border rounded px-2 py-1.5",n.value.start_time?"border-red-500":""]),disabled:o.value},null,10,ge),[[b,s.value.start_time]]),n.value.start_time?(d(),l("p",he,u(n.value.start_time),1)):c("",!0)]),t("div",null,[e[17]||(e[17]=t("label",{class:"block mb-0.5"},[_("End Date "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>s.value.end_date=i),type:"date",class:h(["w-full border rounded px-2 py-1.5",n.value.end_date?"border-red-500":""]),disabled:o.value},null,10,ke),[[b,s.value.end_date]]),n.value.end_date?(d(),l("p",we,u(n.value.end_date),1)):c("",!0)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block mb-0.5"},[_("End Time "),t("span",{class:"text-red-500"},"*")],-1)),p(t("input",{"onUpdate:modelValue":e[5]||(e[5]=i=>s.value.end_time=i),type:"time",class:h(["w-full border rounded px-2 py-1.5",n.value.end_time?"border-red-500":""]),disabled:o.value},null,10,qe),[[b,s.value.end_time]]),n.value.end_time?(d(),l("p",Se,u(n.value.end_time),1)):c("",!0)])]),t("div",Ae,[e[20]||(e[20]=t("label",{class:"block mb-0.5"},[_("Facilities "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Be,[p(t("select",{"onUpdate:modelValue":e[6]||(e[6]=i=>g.value=i),class:"border rounded px-2 py-1.5 min-w-[200px]",disabled:o.value},[e[19]||(e[19]=t("option",{value:""},"Select facility…",-1)),(d(!0),l(k,null,w(G.value,i=>(d(),l("option",{key:i,value:i},u(i),9,Ne))),128))],8,Ce),[[U,g.value]]),t("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:o.value||!g.value,onClick:Q}," Add ",8,Ve)]),n.value.facilities?(d(),l("p",Ue,u(n.value.facilities),1)):c("",!0),t("div",$e,[(d(!0),l(k,null,w(s.value.facilities,(i,r)=>(d(),l("span",{key:i,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[_(u(i)+" ",1),o.value?c("",!0):(d(),l("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:m=>J(r)},"×",8,Ee))]))),128)),s.value.facilities?.length?c("",!0):(d(),l("span",Oe,"No facilities selected"))])]),t("div",De,[t("div",Te,[e[21]||(e[21]=t("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),t("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:o.value||N(-1).length===0,onClick:Y}," Add Row ",8,je)]),t("div",Fe,[t("table",Le,[e[22]||(e[22]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-1.5"},"Item"),t("th",{class:"text-left p-1.5"},"Qty"),t("th",{class:"text-left p-1.5"},"Unit"),t("th",{class:"p-1.5 w-14"})])],-1)),t("tbody",null,[(d(!0),l(k,null,w(s.value.equipment_items,(i,r)=>(d(),l("tr",{key:r,class:"border-t"},[t("td",Re,[p(t("select",{"onUpdate:modelValue":m=>i.name=m,class:"w-full border rounded px-2 py-1.5",disabled:o.value,onChange:()=>{(i.qty==null||i.qty<=0)&&(i.qty=1)}},[(d(!0),l(k,null,w(N(r).concat(i.name&&!N(r).includes(i.name)?[i.name]:[]),m=>(d(),l("option",{key:m,value:m},u(m),9,Ie))),128))],40,ze),[[U,i.name]]),n.value[`equipment_${r}`]?(d(),l("div",Me,u(n.value[`equipment_${r}`]),1)):c("",!0)]),t("td",Pe,[p(t("input",{"onUpdate:modelValue":m=>i.qty=m,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:o.value},null,8,We),[[b,i.qty,void 0,{number:!0}]])]),t("td",Ge,[p(t("input",{"onUpdate:modelValue":m=>i.unit=m,class:"w-24 border rounded px-2 py-1.5",disabled:o.value,placeholder:"e.g., pcs"},null,8,Qe),[[b,i.unit]])]),t("td",Je,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:o.value,onClick:m=>K(r)}," Remove ",8,Ye)])]))),128))])])]),e[23]||(e[23]=t("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),t("div",Ke,[t("div",null,[e[24]||(e[24]=t("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),p(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=i=>s.value.utilization_details=i),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:o.value},null,8,Xe),[[b,s.value.utilization_details]])]),D.value?(d(),l("div",He,[e[25]||(e[25]=t("label",{class:"block mb-0.5"},"Filer Name Override (optional)",-1)),p(t("input",{"onUpdate:modelValue":e[8]||(e[8]=i=>s.value.file_by_user_name=i),class:"w-full border rounded px-2 py-1.5",disabled:o.value,placeholder:"If provided, this name appears as the filer"},null,8,Ze),[[b,s.value.file_by_user_name]])])):c("",!0)]),t("div",et,[t("div",null,[e[26]||(e[26]=t("label",{class:"block mb-0.5"},"Remarks",-1)),p(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=i=>s.value.remarks=i),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:o.value},null,8,tt),[[b,s.value.remarks]])])]),t("div",st,[t("div",at,[e[27]||(e[27]=t("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),t("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:o.value,onClick:H}," Run Check ",8,it)]),e[28]||(e[28]=t("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),t("div",lt,[t("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:e[10]||(e[10]=i=>A.value=!1)},"Close"),o.value?c("",!0):(d(),l("button",{key:0,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs",onClick:Z},u(P.value),1))])])])):c("",!0)}};export{ut as _};
