import{z as se,u as ae,r as u,o as le,c as T,a as n,f as v,d as E,l as g,e as s,t as c,h as w,C as U,F as x,B as C,k as R,g as m,q as o,A as oe,M as ne,v as ie}from"./index.BiRlO2qs.js";import{_ as re,K as ue,a as de,w as ce,L as me,M as ve,r as pe,a0 as be}from"./SectionMain.BBFX33SJ.js";import{_ as fe,a as ge}from"./SectionTitleLineWithButton.asIt1xkD.js";import{_ as xe,B as _e,a as F}from"./Badge.BIgmlBhl.js";import{T as ye}from"./ToasterComponent.BXwuoPoD.js";import{u as he}from"./club.BTPgQUot.js";import"./appContext.CLfG1v8y.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./activityDesignService.CPY7Xbb1.js";import"./utilizationRequestService.r_qZRy2p.js";import"./liquidationFundService.DAvk-OsF.js";const we={class:"flex items-center gap-2"},Ce={key:1,class:"p-3 rounded-lg border bg-amber-50 text-amber-800 text-sm"},ke={key:2},Se={class:"p-3 mb-4 rounded-xl border bg-white/60"},Ae={class:"flex items-center gap-2 mb-2 text-gray-700"},Me={class:"w-4 h-4",viewBox:"0 0 24 24"},Te=["d"],Ue={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},$e=["value"],Re=["value"],Be={class:"flex items-center gap-2 md:col-span-2"},Le=["onClick"],Ve={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},Ee=["d"],qe={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},Ne={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[820px] max-h-screen overflow-auto"},Fe={class:"flex items-center justify-between mb-3"},Pe={class:"text-lg font-semibold"},ze={class:"mb-3 p-3 rounded-xl border bg-white/70"},Oe={class:"flex items-center gap-2"},We=["disabled"],je=["value"],Ke=["disabled"],Qe={class:"w-3.5 h-3.5 inline-block mr-1",viewBox:"0 0 24 24"},De=["d"],He={key:0,class:"text-xs text-gray-500 mt-1"},Ge={class:"p-3 rounded-xl border bg-white/70"},Ye={key:0,class:"text-xs text-gray-500"},Je={key:1,class:"text-xs text-gray-500"},Xe={key:2,class:"space-y-2"},Ze={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-2"},Ie={class:"truncate"},et={class:"text-sm font-medium"},tt={class:"text-[11px] text-gray-500"},st={class:"flex items-center gap-2 flex-wrap"},at=["onUpdate:modelValue","disabled","onChange"],lt=["value"],ot=["onUpdate:modelValue","disabled","onChange"],nt=["value"],it=["onClick"],rt={class:"w-3.5 h-3.5",viewBox:"0 0 24 24"},ut=["d"],wt={__name:"MembershipPage",setup(dt){const r=se(),p=he(),P=ae(),z=["admin","manager","officer","student"],O=[{label:"All",value:""},{label:"Yes",value:"true"},{label:"No",value:"false"}],d=u({page:1,limit:10,q:"",role:"",is_active:""}),_=async(a={},t=!0)=>{d.value={...d.value,...a};const e={...d.value};["q","role","is_active"].forEach(l=>{(e[l]===""||e[l]==null)&&delete e[l]}),e.q&&(e.username=e.q,delete e.q),await r.fetchAll(e,t)};le(async()=>{await _({page:1,limit:10},!0),await q()});const W=T(()=>({total:r.users.total||0,totalPages:r.users.totalPages||1,currentPage:r.users.currentPage||1,pageSize:r.users.pageSize||10,data:r.users.data||[]})),j=a=>a?"emerald":"zinc",K=[{key:"username",label:"Username",sortable:!0,minWidth:160},{key:"name",label:"Name",sortable:!1,minWidth:200,formatter:(a,t)=>`${t.first_name||""} ${t.last_name||""}`.trim()||"—"},{key:"email",label:"Email",sortable:!0,minWidth:220},{key:"has_club",label:"Club",sortable:!1,width:90},{key:"role",label:"Role",sortable:!0,width:120},{key:"is_active",label:"Active",sortable:!0,width:100}],Q=async a=>{await _(a)},B=u(!1),y=u(null),$=u([]),k=u([]),b=u({}),i=u(!1),S=u(""),h=u({}),A=u(null),D=async a=>{y.value=a,B.value=!0,await q(),await L(a.id)},q=async()=>{try{i.value=!0,await p.fetchAll({page:1,limit:500,filters:{include:"users"}},!0)}finally{i.value=!1}},L=async a=>{try{i.value=!0;const t=await r.fetchUserClubs(a,{force:!0});$.value=Array.isArray(t)?t:[],k.value=$.value.map(l=>({...l,membership:{...l.membership||{}}}));const e={};for(const l of $.value)e[l.id]={role:l.membership?.role||"member",status:l.membership?.status||""};b.value=e}finally{i.value=!1}},H=T(()=>new Set(($.value||[]).map(a=>a.id))),G=T(()=>{const a=new Set,t=p.clubs?.data||[];for(const e of t)if(Array.isArray(e.users))for(const l of e.users)l?.id!=null&&a.add(l.id);return a}),N=a=>G.value.has(a),V=T(()=>(p.clubs.data||[]).filter(t=>!H.value.has(t.id)).slice().sort((t,e)=>String(t.name||"").localeCompare(String(e.name||""),void 0,{sensitivity:"base"}))),Y=["member","officer","bod","business manager","pio","treasurer","secretary","vice-president","president"],J=["pending","active","inactive"],X=async()=>{const a=S.value,t=y.value?.id;if(!(!a||!t))try{i.value=!0,await p.addUsersToClub(a,[t]),await L(t),S.value=""}finally{i.value=!1}},Z=async a=>{const t=y.value?.id;if(!(!a||!t))try{i.value=!0,await p.removeUserFromClub(a,t),await L(t)}finally{i.value=!1}},I=async a=>{const t=y.value?.id;if(!t)return;const e=k.value.find(f=>f.id===a);if(!e)return;const l=String(e.membership?.role||"").toLowerCase(),M=String(b.value[a]?.role||"").toLowerCase();if(!(!l||l===M)){h.value[a]=!0;try{await p.updateMemberRole(a,t,l),b.value[a]={...b.value[a]||{},role:l},A.value?.showToast?.("success","Role updated")}catch(f){e.membership.role=M||"member",A.value?.showToast?.("warning",f?.message||"Failed to update role")}finally{h.value[a]=!1}}},ee=async a=>{const t=y.value?.id;if(!t)return;const e=k.value.find(f=>f.id===a);if(!e)return;const l=String(e.membership?.status||"").toLowerCase(),M=String(b.value[a]?.status||"").toLowerCase();if(!(!l||l===M)){h.value[a]=!0;try{await p.updateMemberStatus(a,t,l),b.value[a]={...b.value[a]||{},status:l},A.value?.showToast?.("success","Status updated")}catch(f){e.membership.status=M||"active",A.value?.showToast?.("warning",f?.message||"Failed to update status")}finally{h.value[a]=!1}}},te=T(()=>String(P.user?.role||"").toLowerCase()==="admin");return(a,t)=>(o(),n(x,null,[v(re,null,{default:g(()=>[v(de,null,{default:g(()=>[m(r).error?(o(),oe(xe,{key:0,color:"danger"},{default:g(()=>[R(c(m(r).error),1)]),_:1})):E("",!0),v(fe,{icon:m(ce),title:"Memberships",main:""},{default:g(()=>[s("div",we,[v(ge,{icon:m(me),color:"info",label:"Refresh",onClick:t[0]||(t[0]=e=>_({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),te.value?(o(),n("div",ke,[s("div",Se,[s("div",Ae,[(o(),n("svg",Me,[s("path",{d:m(ve)},null,8,Te)])),t[9]||(t[9]=s("span",{class:"font-medium text-sm"},"Filters",-1))]),s("div",Ue,[w(s("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>d.value.q=e),class:"border rounded px-2 py-2 md:col-span-2",placeholder:"Search username…",onKeyup:t[2]||(t[2]=ne(e=>_({page:1}),["enter"]))},null,544),[[ie,d.value.q]]),w(s("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>d.value.role=e),class:"border rounded px-2 py-2"},[t[10]||(t[10]=s("option",{value:""},"All roles",-1)),(o(),n(x,null,C(z,e=>s("option",{key:e,value:e},c(e),9,$e)),64))],512),[[U,d.value.role]]),w(s("select",{"onUpdate:modelValue":t[4]||(t[4]=e=>d.value.is_active=e),class:"border rounded px-2 py-2"},[(o(),n(x,null,C(O,e=>s("option",{key:e.label,value:e.value},"Active: "+c(e.label),9,Re)),64))],512),[[U,d.value.is_active]]),s("div",Be,[s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:t[5]||(t[5]=e=>_({page:1}))},"Apply"),s("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[6]||(t[6]=e=>_({q:"",role:"",is_active:"",page:1},!0))},"Reset")])])]),v(_e,{columns:K,data:W.value,loading:m(r).isLoading,onQueryChange:Q},{"cell-has_club":g(({row:e})=>[v(F,{text:N(e.id)?"Has Club":"None",tone:N(e.id)?"emerald":"zinc"},null,8,["text","tone"])]),"cell-is_active":g(({value:e})=>[v(F,{text:e?"Active":"Inactive",tone:j(e)},null,8,["text","tone"])]),"cell-actions":g(({row:e})=>[s("button",{class:"px-2 py-1 text-[12px] rounded bg-gray-100 hover:bg-gray-200 inline-flex items-center gap-1",onClick:l=>D(e)},[(o(),n("svg",Ve,[s("path",{d:m(pe)},null,8,Ee)])),t[11]||(t[11]=R(" Manage ",-1))],8,Le)]),_:1},8,["data","loading"])])):(o(),n("div",Ce," This page is only available to administrators. "))]),_:1})]),_:1}),B.value?(o(),n("div",qe,[s("div",Ne,[s("div",Fe,[s("h2",Pe,"Manage Membership — @"+c(y.value?.username),1),s("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:t[7]||(t[7]=e=>B.value=!1)},"Close")]),s("div",ze,[t[14]||(t[14]=s("div",{class:"text-sm font-medium mb-2"},"Add to a Club",-1)),s("div",Oe,[w(s("select",{"onUpdate:modelValue":t[8]||(t[8]=e=>S.value=e),class:"border rounded px-2.5 py-2 min-w-[260px]",disabled:i.value||!V.value.length},[t[12]||(t[12]=s("option",{value:"",disabled:""},"Select a club…",-1)),(o(!0),n(x,null,C(V.value,e=>(o(),n("option",{key:e.id,value:e.id},c(e.name),9,je))),128))],8,We),[[U,S.value]]),s("button",{class:"px-3 py-2 bg-blue-600 text-white rounded text-xs disabled:opacity-50",disabled:!S.value||i.value,onClick:X},[(o(),n("svg",Qe,[s("path",{d:m(ue)},null,8,De)])),t[13]||(t[13]=R(" Add ",-1))],8,Ke)]),V.value.length?E("",!0):(o(),n("div",He,"No more clubs available to add."))]),s("div",Ge,[t[18]||(t[18]=s("div",{class:"text-sm font-medium mb-2"},"Current Clubs",-1)),i.value?(o(),n("div",Ye,"Loading…")):k.value.length?(o(),n("ul",Xe,[(o(!0),n(x,null,C(k.value,e=>(o(),n("li",{key:e.id,class:"rounded border px-2 py-2 bg-gray-50"},[s("div",Ze,[s("div",Ie,[s("div",et,c(e.name),1),s("div",tt,"@"+c(e.code||""),1)]),s("div",st,[t[16]||(t[16]=s("div",{class:"text-xs text-gray-600"},"Role",-1)),w(s("select",{"onUpdate:modelValue":l=>e.membership.role=l,class:"border rounded px-2 py-1 text-sm",disabled:i.value||h.value[e.id],onChange:l=>I(e.id)},[(o(),n(x,null,C(Y,l=>s("option",{key:l,value:l},c(l),9,lt)),64))],40,at),[[U,e.membership.role]]),t[17]||(t[17]=s("div",{class:"text-xs text-gray-600 ml-2"},"Status",-1)),w(s("select",{"onUpdate:modelValue":l=>e.membership.status=l,class:"border rounded px-2 py-1 text-sm",disabled:i.value||h.value[e.id],onChange:l=>ee(e.id)},[(o(),n(x,null,C(J,l=>s("option",{key:l,value:l},c(l),9,nt)),64))],40,ot),[[U,e.membership.status]]),s("button",{class:"px-2 py-1 text-[12px] rounded bg-rose-100 hover:bg-rose-200 inline-flex items-center gap-1",onClick:l=>Z(e.id)},[(o(),n("svg",rt,[s("path",{d:m(be)},null,8,ut)])),t[15]||(t[15]=R(" Remove ",-1))],8,it)])])]))),128))])):(o(),n("div",Je,"This user is not a member of any club."))])])])):E("",!0),v(ye,{ref_key:"toast",ref:A},null,512)],64))}};export{wt as default};
