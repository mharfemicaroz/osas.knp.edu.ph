import{c as n,u as ce,o as _e,r as C,x as I,G as me,a as _,d as y,q as m,e as t,t as b,k as x,h as i,C as pe,g as z,j as f,F as H,B as Q,v as r,S as R}from"./index.DW713-jq.js";import{u as ve}from"./liquidationFund.CDtSIeMO.js";import{u as be}from"./activityDesign.YxPwFj_S.js";import{u as fe}from"./clubScope.FYw4NI-M.js";import{u as ye}from"./club.DLt05nn_.js";const xe={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ge={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1096px] max-h-screen overflow-auto"},he={class:"flex items-center justify-between mb-3"},we={class:"flex items-center gap-3"},ke={class:"text-lg font-semibold"},Se={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},Ce={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},Ue={class:"text-sm mb-3"},Ve=["disabled"],Ae=["value"],Ne={key:0,class:"text-red-600 text-[11px] mt-1"},qe={key:1,class:"text-[11px] text-gray-500 mt-1"},Le={key:2,class:"text-[11px] text-amber-700 mt-1"},$e={class:"mt-2 p-3 border rounded-lg bg-white"},Fe={class:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},Oe=["disabled"],De=["disabled"],Be=["disabled"],Ie=["disabled"],Re=["disabled"],Te=["disabled"],Me={class:"md:col-span-2"},je=["disabled"],Ee={class:"mt-3 text-sm"},Je={class:"flex flex-wrap gap-4"},Pe={class:"mt-4 text-sm"},Ye={class:"flex items-center justify-between"},ze=["disabled"],He={class:"mt-2 border rounded overflow-hidden"},Qe={class:"w-full text-xs"},Ge={class:"p-2"},Ke=["onUpdate:modelValue","disabled"],We={class:"p-2"},Xe=["onUpdate:modelValue","disabled"],Ze={class:"p-2"},et=["onUpdate:modelValue","disabled"],tt={class:"p-2"},st=["onUpdate:modelValue","disabled"],lt={class:"p-2"},ot=["onUpdate:modelValue","disabled"],at={class:"p-2"},dt=["onUpdate:modelValue","disabled"],nt={class:"p-2"},it=["onUpdate:modelValue","disabled"],ut={class:"p-2 text-right"},rt=["disabled","onClick"],ct={class:"mt-2 text-right text-sm"},_t={class:"mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},mt={class:"md:col-span-1"},pt=["disabled"],vt={key:0,class:"text-red-600 text-[11px] mt-1"},bt={key:0,class:"md:col-span-1"},ft=["disabled"],yt={key:1,class:"md:col-span-1 md:col-span-2"},xt={class:"flex justify-end gap-2 mt-5"},gt={key:1,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs"},Ut={__name:"LiquidationFundFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",noted_by:"",sources_of_fund:{contribution:0,payment_from_fines:0,solicitations:0,donations:0,other_sources:0,current_available_funds:0,other_sources_note:""},uses_of_fund:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(G,{emit:K}){const p=G,T=K,L=n({get:()=>p.modelValue,set:s=>T("update:modelValue",s)}),g=ce(),$=ve(),U=be(),S=ye(),F=n(()=>String(g.user?.role||"").toLowerCase()==="admin"),{isClub:M,activeClubId:h}=fe(),O=n(()=>{const s=Array.isArray(U.items?.data)?U.items.data.filter(e=>String(e.status).toLowerCase()==="approved"):[];if(M.value&&h.value){const e=Number(h.value);return s.filter(a=>Number(a.club_id||a.club?.id)===e)}return s});_e(async()=>{const s={page:1,limit:200,status:"approved"},e=M.value&&h.value?{...s,club_id:h.value}:s;await U.fetchAll(e,!0),(!Array.isArray(S.clubs?.data)||!S.clubs.data.length)&&await S.fetchAll({page:1,limit:200},!0)});const l=C(structuredClone(p.initial)),u=C({}),w=C([]),j=s=>{if(!s)return[];if(Array.isArray(s))return s;try{return JSON.parse(s||"[]")||[]}catch{return[]}},A=n(()=>{const s=g.user?.last_name||"",e=(g.user?.first_name||"").slice(0,1);return`${s}${s?", ":""}${e?e+".":""}`}),N=C(!0),V=C(""),E=C(!1);I(()=>p.initial,async s=>{let e=s.sources_of_fund,a=s.uses_of_fund;try{typeof e=="string"&&(e=JSON.parse(e||"{}"))}catch{}try{typeof a=="string"&&(a=JSON.parse(a||"[]"))}catch{}if(l.value={...s,sources_of_fund:{contribution:0,payment_from_fines:0,solicitations:0,donations:0,other_sources:0,current_available_funds:0,other_sources_note:"",...e||{}},uses_of_fund:Array.isArray(a)?a:[]},u.value={},w.value=j(s?.remarks),p.mode==="edit"&&(s?.id||l.value?.id)){if(!E.value)E.value=!0;else if(w.value.some(v=>v&&v.is_read===!1)){w.value=w.value.map(v=>({...v,is_read:!0}));try{await $.updateById(s?.id||l.value.id,{remarks:JSON.stringify(w.value)})}catch{}}}N.value=!(s&&String(s.noted_by||"").trim()),V.value=""},{immediate:!0});const W=n(()=>String(l.value?.status||"").toLowerCase()),d=n(()=>p.mode==="edit"&&W.value!=="draft"),X=n(()=>p.mode!=="edit"?"New Liquidation Fund":d.value?"View Liquidation (read-only)":"Edit Liquidation"),Z=n(()=>p.mode==="edit"?"Save Changes":"Create");n(()=>p.mode==="edit");const ee=n(()=>p.mode==="edit"),te=s=>{const e=s?.name_of_activity||"Untitled",a=s?.reference_code?` [${s.reference_code}]`:"",o=s?.date_of_implementation?` • ${s.date_of_implementation}`:"";return`${e}${a}${o}`},se=n(()=>{const s=Number(l.value.activity_design_id||0);return O.value.find(e=>Number(e.id)===s)||null}),J=n(()=>{const s=se.value;return Number(s?.club_id||s?.club?.id||0)||null}),D=s=>{const e=Number(s);return(S.clubs?.data||[]).find(o=>Number(o.id)===e)?.adviser||""},le=n(()=>{const s=J.value||h.value||null;return s?(D(s)||"").trim():""}),oe=n(()=>le.value.length>0);I(()=>[l.value.activity_design_id,S.clubs?.data?.length],()=>{const s=D(J.value)||"";(N.value||l.value.noted_by===V.value)&&(l.value.noted_by=s,V.value=s)},{immediate:!0}),I(()=>[h.value,S.clubs?.data?.length],()=>{const s=D(h.value)||"";(N.value||l.value.noted_by===V.value)&&(l.value.noted_by=s,V.value=s)},{immediate:!0});const k=s=>Number.isFinite(+s)?+s:0,P=n(()=>{const s=l.value.sources_of_fund||{};return k(s.contribution)+k(s.payment_from_fines)+k(s.solicitations)+k(s.donations)+k(s.other_sources)+k(s.current_available_funds)}),B=n(()=>Array.isArray(l.value.uses_of_fund)?l.value.uses_of_fund.reduce((s,e)=>s+k(e?.amount),0):0),Y=n(()=>P.value-B.value),q=s=>Number(s).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),ae=()=>{Array.isArray(l.value.uses_of_fund)||(l.value.uses_of_fund=[]),l.value.uses_of_fund.push({date:"",qty:1,unit:"",particulars:"",sheet_no:"",amount:0,in_charge:""})},de=s=>{l.value.uses_of_fund.splice(s,1)},ne=()=>{if(d.value)return!1;const s={};l.value.activity_design_id||(s.activity_design_id="Required"),l.value.noted_by?.trim()||(s.noted_by="Required");const e=l.value.sources_of_fund||{};return["contribution","payment_from_fines","solicitations","donations","other_sources","current_available_funds"].forEach(a=>{e[a]!=null&&Number(e[a])<0&&(s[`src_${a}`]="Must be ≥ 0")}),Array.isArray(l.value.uses_of_fund)&&l.value.uses_of_fund.forEach((a,o)=>{a?.qty!=null&&Number(a.qty)<=0&&(s[`use_${o}_qty`]="Qty must be > 0"),a?.amount!=null&&Number(a.amount)<0&&(s[`use_${o}_amount`]="Must be ≥ 0")}),u.value=s,Object.keys(s).length===0},ie=()=>{if(d.value||!ne())return;const s={...l.value};!s.filed_by_user_id&&g.user?.id&&(s.filed_by_user_id=g.user.id),F.value||delete s.file_by_user_name;const e=p.mode!=="edit"?"created liquidation fund":"updated liquidation fund";w.value.push({user_id:g.user?.id||null,user_name:A.value,message:`${A.value} ${e}.`,datetime:new Date().toISOString(),is_read:!1}),s.remarks=JSON.stringify(w.value),T("submit",s)},ue=n(()=>p.mode==="edit"&&F.value&&String(l.value.status||"").toLowerCase()==="pending"),re=async()=>{if(!l.value?.id)return;const{value:s,isConfirmed:e}=await R.fire({title:"Cancel Liquidation Fund?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Reason for cancellation",showCancelButton:!0,confirmButtonText:"Cancel Liquidation",confirmButtonColor:"#dc2626"});if(e)try{const a=j(l.value?.remarks),o=`${A.value} cancelled liquidation fund.${s?" - "+s:""}`;a.push({user_id:g.user?.id||null,user_name:A.value,message:o,datetime:new Date().toISOString()});const v=await $.cancel(l.value.id,JSON.stringify(a));l.value={...l.value,...v||{},status:"draft"},await R.fire("Cancelled","Liquidation Fund has been cancelled.","success")}catch{await R.fire("Error",$.error||"Failed to cancel liquidation fund.","error")}};return(s,e)=>{const a=me("pending-click");return L.value?(m(),_("div",xe,[t("div",ge,[t("div",he,[t("div",we,[t("h2",ke,b(X.value),1),t("span",Se,b(l.value.status),1)]),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:e[0]||(e[0]=o=>L.value=!1)},"Close")]),d.value?(m(),_("div",Ce,[e[13]||(e[13]=x(" This liquidation is ",-1)),t("strong",null,b(l.value.status),1),e[14]||(e[14]=x(". Editing is disabled. ",-1))])):y("",!0),t("div",Ue,[e[16]||(e[16]=t("label",{class:"block mb-1"},[x("Activity Design "),t("span",{class:"text-red-500"},"*")],-1)),i(t("select",{"onUpdate:modelValue":e[1]||(e[1]=o=>l.value.activity_design_id=o),class:f(["w-full border rounded px-2.5 py-2",u.value.activity_design_id?"border-red-500":""]),disabled:d.value||z(U).isLoading},[e[15]||(e[15]=t("option",{value:""},"Select approved activity design…",-1)),(m(!0),_(H,null,Q(O.value,o=>(m(),_("option",{key:o.id,value:o.id},b(te(o)),9,Ae))),128))],10,Ve),[[pe,l.value.activity_design_id]]),u.value.activity_design_id?(m(),_("p",Ne,b(u.value.activity_design_id),1)):y("",!0),z(U).isLoading?(m(),_("p",qe,"Loading approved activities…")):O.value.length?y("",!0):(m(),_("p",Le,"No approved activity designs found."))]),t("div",$e,[e[28]||(e[28]=t("div",{class:"text-sm font-medium mb-2"},"Sources of Fund",-1)),t("div",Fe,[t("div",null,[e[17]||(e[17]=t("label",{class:"block mb-1"},"Contribution",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_contribution?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[2]||(e[2]=o=>l.value.sources_of_fund.contribution=o),disabled:d.value},null,10,Oe),[[r,l.value.sources_of_fund.contribution,void 0,{number:!0}]])]),t("div",null,[e[18]||(e[18]=t("label",{class:"block mb-1"},"Payment from Fines",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_payment_from_fines?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[3]||(e[3]=o=>l.value.sources_of_fund.payment_from_fines=o),disabled:d.value},null,10,De),[[r,l.value.sources_of_fund.payment_from_fines,void 0,{number:!0}]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block mb-1"},"Solicitations",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_solicitations?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[4]||(e[4]=o=>l.value.sources_of_fund.solicitations=o),disabled:d.value},null,10,Be),[[r,l.value.sources_of_fund.solicitations,void 0,{number:!0}]])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block mb-1"},"Donations",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_donations?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[5]||(e[5]=o=>l.value.sources_of_fund.donations=o),disabled:d.value},null,10,Ie),[[r,l.value.sources_of_fund.donations,void 0,{number:!0}]])]),t("div",null,[e[21]||(e[21]=t("label",{class:"block mb-1"},"Other Sources",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_other_sources?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[6]||(e[6]=o=>l.value.sources_of_fund.other_sources=o),disabled:d.value},null,10,Re),[[r,l.value.sources_of_fund.other_sources,void 0,{number:!0}]])]),t("div",null,[e[22]||(e[22]=t("label",{class:"block mb-1"},"Current Available Funds",-1)),i(t("input",{type:"number",step:"0.01",min:"0",class:f(["w-full border rounded px-2.5 py-2",u.value.src_current_available_funds?"border-red-500":""]),placeholder:"0.00","onUpdate:modelValue":e[7]||(e[7]=o=>l.value.sources_of_fund.current_available_funds=o),disabled:d.value},null,10,Te),[[r,l.value.sources_of_fund.current_available_funds,void 0,{number:!0}]])]),t("div",Me,[e[23]||(e[23]=t("label",{class:"block mb-1"},"Other Sources Note (optional)",-1)),i(t("textarea",{rows:"2",class:"w-full border rounded px-2.5 py-2","onUpdate:modelValue":e[8]||(e[8]=o=>l.value.sources_of_fund.other_sources_note=o),disabled:d.value,placeholder:"Describe other sources (optional)"},null,8,je),[[r,l.value.sources_of_fund.other_sources_note]])])]),t("div",Ee,[t("div",Je,[t("div",null,[e[24]||(e[24]=x("Total Sources: ",-1)),t("strong",null,b(q(P.value)),1)]),t("div",null,[e[25]||(e[25]=x("Total Uses: ",-1)),t("strong",null,b(q(B.value)),1)]),t("div",null,[e[26]||(e[26]=x("Cash on Hand: ",-1)),t("strong",{class:f(Y.value<0?"text-red-600":"text-emerald-700")},b(q(Y.value)),3)])]),e[27]||(e[27]=t("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates totals on save.",-1))])]),t("div",Pe,[t("div",Ye,[e[29]||(e[29]=t("label",{class:"block mb-1 font-medium"},"Use of Fund",-1)),t("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:d.value,onClick:ae},"Add Row",8,ze)]),t("div",He,[t("table",Qe,[e[30]||(e[30]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-2"},"Date"),t("th",{class:"text-left p-2"},"Qty"),t("th",{class:"text-left p-2"},"Unit"),t("th",{class:"text-left p-2"},"Particulars"),t("th",{class:"text-left p-2"},"Sheet No."),t("th",{class:"text-left p-2"},"Amount"),t("th",{class:"text-left p-2"},"In-Charge"),t("th",{class:"p-2 w-16"})])],-1)),t("tbody",null,[(m(!0),_(H,null,Q(l.value.uses_of_fund,(o,v)=>(m(),_("tr",{key:v,class:"border-t"},[t("td",Ge,[i(t("input",{type:"date","onUpdate:modelValue":c=>o.date=c,class:"border rounded px-2 py-1",disabled:d.value,placeholder:"YYYY-MM-DD"},null,8,Ke),[[r,o.date]])]),t("td",We,[i(t("input",{type:"number",min:"1","onUpdate:modelValue":c=>o.qty=c,class:f(["w-20 border rounded px-2 py-1",u.value[`use_${v}_qty`]?"border-red-500":""]),disabled:d.value,placeholder:"1"},null,10,Xe),[[r,o.qty,void 0,{number:!0}]])]),t("td",Ze,[i(t("input",{"onUpdate:modelValue":c=>o.unit=c,class:"w-20 border rounded px-2 py-1",disabled:d.value,placeholder:"e.g., pcs"},null,8,et),[[r,o.unit]])]),t("td",tt,[i(t("input",{"onUpdate:modelValue":c=>o.particulars=c,class:"w-52 border rounded px-2 py-1",disabled:d.value,placeholder:"Item/service details"},null,8,st),[[r,o.particulars]])]),t("td",lt,[i(t("input",{"onUpdate:modelValue":c=>o.sheet_no=c,class:"w-24 border rounded px-2 py-1",disabled:d.value,placeholder:"Ref / Sheet No."},null,8,ot),[[r,o.sheet_no]])]),t("td",at,[i(t("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":c=>o.amount=c,class:f(["w-28 border rounded px-2 py-1",u.value[`use_${v}_amount`]?"border-red-500":""]),disabled:d.value,placeholder:"0.00"},null,10,dt),[[r,o.amount,void 0,{number:!0}]])]),t("td",nt,[i(t("input",{"onUpdate:modelValue":c=>o.in_charge=c,class:"w-32 border rounded px-2 py-1",disabled:d.value,placeholder:"Person responsible"},null,8,it),[[r,o.in_charge]])]),t("td",ut,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:d.value,onClick:c=>de(v)},"Remove",8,rt)])]))),128))])])]),t("div",ct,[e[31]||(e[31]=t("span",{class:"mr-4"},"Total Uses:",-1)),t("strong",null,b(q(B.value)),1)])]),t("div",_t,[t("div",mt,[e[32]||(e[32]=t("label",{class:"block mb-1"},[x("Adviser (Noted by) "),t("span",{class:"text-red-500"},"*")],-1)),i(t("input",{"onUpdate:modelValue":e[9]||(e[9]=o=>l.value.noted_by=o),class:f(["w-full border rounded px-2.5 py-2",u.value.noted_by?"border-red-500":""]),disabled:d.value||oe.value,placeholder:"Adviser name (noted by)",onInput:e[10]||(e[10]=o=>N.value=!1)},null,42,pt),[[r,l.value.noted_by]]),u.value.noted_by?(m(),_("p",vt,b(u.value.noted_by),1)):y("",!0)]),F.value?(m(),_("div",bt,[e[33]||(e[33]=t("label",{class:"block mb-1"},"Filer Name Override (optional)",-1)),i(t("input",{"onUpdate:modelValue":e[11]||(e[11]=o=>l.value.file_by_user_name=o),class:"w-full border rounded px-2.5 py-2",disabled:d.value,placeholder:"If provided, this name appears as the filer"},null,8,ft),[[r,l.value.file_by_user_name]])])):y("",!0),ee.value?(m(),_("div",yt)):y("",!0)]),t("div",xt,[t("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:e[12]||(e[12]=o=>L.value=!1)},"Close"),ue.value?(m(),_("button",{key:0,class:"px-4 py-2 bg-red-600 text-white rounded text-xs",onClick:re}," Cancel Liquidation ")):y("",!0),d.value?y("",!0):i((m(),_("button",gt,[x(b(Z.value),1)])),[[a,ie]])])])])):y("",!0)}}};export{Ut as _};
