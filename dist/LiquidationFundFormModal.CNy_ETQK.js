import{c as m,u as I,o as J,r as N,x as P,a as r,d as y,q as _,e,t as p,k as x,h as a,C as Q,g as F,j as b,F as L,B as $,v as n}from"./index.B-6tafY-.js";import{u as G}from"./liquidationFund.DCPowyHz.js";import{u as K}from"./activityDesign.CNmspB-s.js";const W={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},X={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1096px] max-h-screen overflow-auto"},Y={class:"flex items-center justify-between mb-3"},Z={class:"flex items-center gap-3"},ee={class:"text-lg font-semibold"},se={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},te={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},oe={class:"text-sm mb-3"},le=["disabled"],de=["value"],ae={key:0,class:"text-red-600 text-[11px] mt-1"},ne={key:1,class:"text-[11px] text-gray-500 mt-1"},ue={key:2,class:"text-[11px] text-amber-700 mt-1"},ie={class:"mt-2 p-3 border rounded-lg bg-white"},re={class:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},_e=["disabled"],me=["disabled"],pe=["disabled"],be=["disabled"],ce=["disabled"],fe=["disabled"],ve={class:"md:col-span-2"},ye=["disabled"],xe={class:"mt-3 text-sm"},ge={class:"flex flex-wrap gap-4"},he={class:"mt-4 text-sm"},we={class:"flex items-center justify-between"},ke=["disabled"],Ue={class:"mt-2 border rounded overflow-hidden"},Ve={class:"w-full text-xs"},Se={class:"p-2"},Ce=["onUpdate:modelValue","disabled"],Ae={class:"p-2"},qe=["onUpdate:modelValue","disabled"],Ne={class:"p-2"},Fe=["onUpdate:modelValue","disabled"],Le={class:"p-2"},$e=["onUpdate:modelValue","disabled"],Oe={class:"p-2"},De=["onUpdate:modelValue","disabled"],Te={class:"p-2"},je=["onUpdate:modelValue","disabled"],Me={class:"p-2"},Re=["onUpdate:modelValue","disabled"],Be={class:"p-2 text-right"},Ee=["disabled","onClick"],ze={class:"mt-2 text-right text-sm"},He={class:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},Ie={key:0},Je=["disabled"],Pe=["disabled"],Qe={class:"flex justify-end gap-2 mt-5"},Xe={__name:"LiquidationFundFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",sources_of_fund:{contribution:0,payment_from_fines:0,solicitations:0,donations:0,other_sources:0,current_available_funds:0,other_sources_note:""},uses_of_fund:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(O,{emit:D}){const v=O,V=D,w=m({get:()=>v.modelValue,set:o=>V("update:modelValue",o)}),k=I();G();const g=K(),S=m(()=>String(k.user?.role||"").toLowerCase()==="admin"),C=m(()=>Array.isArray(g.items?.data)?g.items.data.filter(o=>String(o.status).toLowerCase()==="approved"):[]);J(async()=>{await g.fetchAll({page:1,limit:200,status:"approved"},!0)});const l=N(structuredClone(v.initial)),i=N({});P(()=>v.initial,o=>{let s=o.sources_of_fund,t=o.uses_of_fund;try{typeof s=="string"&&(s=JSON.parse(s||"{}"))}catch{}try{typeof t=="string"&&(t=JSON.parse(t||"[]"))}catch{}l.value={...o,sources_of_fund:{contribution:0,payment_from_fines:0,solicitations:0,donations:0,other_sources:0,current_available_funds:0,other_sources_note:"",...s||{}},uses_of_fund:Array.isArray(t)?t:[]},i.value={}},{immediate:!0});const T=m(()=>String(l.value?.status||"").toLowerCase()),d=m(()=>v.mode==="edit"&&T.value!=="draft"),j=m(()=>v.mode!=="edit"?"New Liquidation Fund":d.value?"View Liquidation (read-only)":"Edit Liquidation"),M=m(()=>v.mode==="edit"?"Save Changes":"Create"),R=o=>{const s=o?.name_of_activity||"Untitled",t=o?.reference_code?` [${o.reference_code}]`:"",c=o?.date_of_implementation?` • ${o.date_of_implementation}`:"";return`${s}${t}${c}`},f=o=>Number.isFinite(+o)?+o:0,A=m(()=>{const o=l.value.sources_of_fund||{};return f(o.contribution)+f(o.payment_from_fines)+f(o.solicitations)+f(o.donations)+f(o.other_sources)+f(o.current_available_funds)}),U=m(()=>Array.isArray(l.value.uses_of_fund)?l.value.uses_of_fund.reduce((o,s)=>o+f(s?.amount),0):0),q=m(()=>A.value-U.value),h=o=>Number(o).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),B=()=>{Array.isArray(l.value.uses_of_fund)||(l.value.uses_of_fund=[]),l.value.uses_of_fund.push({date:"",qty:1,unit:"",particulars:"",sheet_no:"",amount:0,in_charge:""})},E=o=>{l.value.uses_of_fund.splice(o,1)},z=()=>{if(d.value)return!1;const o={};l.value.activity_design_id||(o.activity_design_id="Required");const s=l.value.sources_of_fund||{};return["contribution","payment_from_fines","solicitations","donations","other_sources","current_available_funds"].forEach(t=>{s[t]!=null&&Number(s[t])<0&&(o[`src_${t}`]="Must be ≥ 0")}),Array.isArray(l.value.uses_of_fund)&&l.value.uses_of_fund.forEach((t,c)=>{t?.qty!=null&&Number(t.qty)<=0&&(o[`use_${c}_qty`]="Qty must be > 0"),t?.amount!=null&&Number(t.amount)<0&&(o[`use_${c}_amount`]="Must be ≥ 0")}),i.value=o,Object.keys(o).length===0},H=()=>{if(d.value||!z())return;const o={...l.value};!o.filed_by_user_id&&k.user?.id&&(o.filed_by_user_id=k.user.id),S.value||delete o.file_by_user_name,V("submit",o)};return(o,s)=>w.value?(_(),r("div",W,[e("div",X,[e("div",Y,[e("div",Z,[e("h2",ee,p(j.value),1),e("span",se,p(l.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:s[0]||(s[0]=t=>w.value=!1)},"Close")]),d.value?(_(),r("div",te,[s[12]||(s[12]=x(" This liquidation is ",-1)),e("strong",null,p(l.value.status),1),s[13]||(s[13]=x(". Editing is disabled. ",-1))])):y("",!0),e("div",oe,[s[15]||(s[15]=e("label",{class:"block mb-1"},[x("Activity Design "),e("span",{class:"text-red-500"},"*")],-1)),a(e("select",{"onUpdate:modelValue":s[1]||(s[1]=t=>l.value.activity_design_id=t),class:b(["w-full border rounded px-2.5 py-2",i.value.activity_design_id?"border-red-500":""]),disabled:d.value||F(g).isLoading},[s[14]||(s[14]=e("option",{value:""},"Select approved activity design…",-1)),(_(!0),r(L,null,$(C.value,t=>(_(),r("option",{key:t.id,value:t.id},p(R(t)),9,de))),128))],10,le),[[Q,l.value.activity_design_id]]),i.value.activity_design_id?(_(),r("p",ae,p(i.value.activity_design_id),1)):y("",!0),F(g).isLoading?(_(),r("p",ne,"Loading approved activities…")):C.value.length?y("",!0):(_(),r("p",ue,"No approved activity designs found."))]),e("div",ie,[s[27]||(s[27]=e("div",{class:"text-sm font-medium mb-2"},"Sources of Fund",-1)),e("div",re,[e("div",null,[s[16]||(s[16]=e("label",{class:"block mb-1"},"Contribution",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_contribution?"border-red-500":""]),"onUpdate:modelValue":s[2]||(s[2]=t=>l.value.sources_of_fund.contribution=t),disabled:d.value},null,10,_e),[[n,l.value.sources_of_fund.contribution,void 0,{number:!0}]])]),e("div",null,[s[17]||(s[17]=e("label",{class:"block mb-1"},"Payment from Fines",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_payment_from_fines?"border-red-500":""]),"onUpdate:modelValue":s[3]||(s[3]=t=>l.value.sources_of_fund.payment_from_fines=t),disabled:d.value},null,10,me),[[n,l.value.sources_of_fund.payment_from_fines,void 0,{number:!0}]])]),e("div",null,[s[18]||(s[18]=e("label",{class:"block mb-1"},"Solicitations",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_solicitations?"border-red-500":""]),"onUpdate:modelValue":s[4]||(s[4]=t=>l.value.sources_of_fund.solicitations=t),disabled:d.value},null,10,pe),[[n,l.value.sources_of_fund.solicitations,void 0,{number:!0}]])]),e("div",null,[s[19]||(s[19]=e("label",{class:"block mb-1"},"Donations",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_donations?"border-red-500":""]),"onUpdate:modelValue":s[5]||(s[5]=t=>l.value.sources_of_fund.donations=t),disabled:d.value},null,10,be),[[n,l.value.sources_of_fund.donations,void 0,{number:!0}]])]),e("div",null,[s[20]||(s[20]=e("label",{class:"block mb-1"},"Other Sources",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_other_sources?"border-red-500":""]),"onUpdate:modelValue":s[6]||(s[6]=t=>l.value.sources_of_fund.other_sources=t),disabled:d.value},null,10,ce),[[n,l.value.sources_of_fund.other_sources,void 0,{number:!0}]])]),e("div",null,[s[21]||(s[21]=e("label",{class:"block mb-1"},"Current Available Funds",-1)),a(e("input",{type:"number",step:"0.01",min:"0",class:b(["w-full border rounded px-2.5 py-2",i.value.src_current_available_funds?"border-red-500":""]),"onUpdate:modelValue":s[7]||(s[7]=t=>l.value.sources_of_fund.current_available_funds=t),disabled:d.value},null,10,fe),[[n,l.value.sources_of_fund.current_available_funds,void 0,{number:!0}]])]),e("div",ve,[s[22]||(s[22]=e("label",{class:"block mb-1"},"Other Sources Note (optional)",-1)),a(e("textarea",{rows:"2",class:"w-full border rounded px-2.5 py-2","onUpdate:modelValue":s[8]||(s[8]=t=>l.value.sources_of_fund.other_sources_note=t),disabled:d.value},null,8,ye),[[n,l.value.sources_of_fund.other_sources_note]])])]),e("div",xe,[e("div",ge,[e("div",null,[s[23]||(s[23]=x("Total Sources: ",-1)),e("strong",null,p(h(A.value)),1)]),e("div",null,[s[24]||(s[24]=x("Total Uses: ",-1)),e("strong",null,p(h(U.value)),1)]),e("div",null,[s[25]||(s[25]=x("Cash on Hand: ",-1)),e("strong",{class:b(q.value<0?"text-red-600":"text-emerald-700")},p(h(q.value)),3)])]),s[26]||(s[26]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates totals on save.",-1))])]),e("div",he,[e("div",we,[s[28]||(s[28]=e("label",{class:"block mb-1 font-medium"},"Use of Fund",-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:d.value,onClick:B},"Add Row",8,ke)]),e("div",Ue,[e("table",Ve,[s[29]||(s[29]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Date"),e("th",{class:"text-left p-2"},"Qty"),e("th",{class:"text-left p-2"},"Unit"),e("th",{class:"text-left p-2"},"Particulars"),e("th",{class:"text-left p-2"},"Sheet No."),e("th",{class:"text-left p-2"},"Amount"),e("th",{class:"text-left p-2"},"In-Charge"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(_(!0),r(L,null,$(l.value.uses_of_fund,(t,c)=>(_(),r("tr",{key:c,class:"border-t"},[e("td",Se,[a(e("input",{type:"date","onUpdate:modelValue":u=>t.date=u,class:"border rounded px-2 py-1",disabled:d.value},null,8,Ce),[[n,t.date]])]),e("td",Ae,[a(e("input",{type:"number",min:"1","onUpdate:modelValue":u=>t.qty=u,class:b(["w-20 border rounded px-2 py-1",i.value[`use_${c}_qty`]?"border-red-500":""]),disabled:d.value},null,10,qe),[[n,t.qty,void 0,{number:!0}]])]),e("td",Ne,[a(e("input",{"onUpdate:modelValue":u=>t.unit=u,class:"w-20 border rounded px-2 py-1",disabled:d.value},null,8,Fe),[[n,t.unit]])]),e("td",Le,[a(e("input",{"onUpdate:modelValue":u=>t.particulars=u,class:"w-52 border rounded px-2 py-1",disabled:d.value},null,8,$e),[[n,t.particulars]])]),e("td",Oe,[a(e("input",{"onUpdate:modelValue":u=>t.sheet_no=u,class:"w-24 border rounded px-2 py-1",disabled:d.value},null,8,De),[[n,t.sheet_no]])]),e("td",Te,[a(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":u=>t.amount=u,class:b(["w-28 border rounded px-2 py-1",i.value[`use_${c}_amount`]?"border-red-500":""]),disabled:d.value},null,10,je),[[n,t.amount,void 0,{number:!0}]])]),e("td",Me,[a(e("input",{"onUpdate:modelValue":u=>t.in_charge=u,class:"w-32 border rounded px-2 py-1",disabled:d.value},null,8,Re),[[n,t.in_charge]])]),e("td",Be,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:d.value,onClick:u=>E(c)},"Remove",8,Ee)])]))),128))])])]),e("div",ze,[s[30]||(s[30]=e("span",{class:"mr-4"},"Total Uses:",-1)),e("strong",null,p(h(U.value)),1)])]),e("div",He,[S.value?(_(),r("div",Ie,[s[31]||(s[31]=e("label",{class:"block mb-1"},"Filer Name Override (optional)",-1)),a(e("input",{"onUpdate:modelValue":s[9]||(s[9]=t=>l.value.file_by_user_name=t),class:"w-full border rounded px-2.5 py-2",disabled:d.value,placeholder:"If provided, this name appears as the filer"},null,8,Je),[[n,l.value.file_by_user_name]])])):y("",!0),e("div",null,[s[32]||(s[32]=e("label",{class:"block mb-1"},"Remarks",-1)),a(e("textarea",{"onUpdate:modelValue":s[10]||(s[10]=t=>l.value.remarks=t),rows:"3",class:"w-full border rounded px-2.5 py-2",disabled:d.value},null,8,Pe),[[n,l.value.remarks]])])]),e("div",Qe,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:s[11]||(s[11]=t=>w.value=!1)},"Close"),d.value?y("",!0):(_(),r("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:H},p(M.value),1))])])])):y("",!0)}};export{Xe as _};
