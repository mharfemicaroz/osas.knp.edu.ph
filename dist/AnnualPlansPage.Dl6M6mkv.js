import{c as B,r as S,o as Q,E as xe,a as p,q as r,f as _,A as U,d as h,e as l,g as v,t as V,k as G,x as me,j as ve,F as X,B as ae,S as A,u as ke,l as L,N as Ce,h as te,M as $e,v as _e,C as ue}from"./index.B0nDbTtE.js";import{u as Ae,v as Se,a8 as Be,y as Ve,a9 as Re,aa as je,ab as De,ae as Ie,z as be,A as Ee,B as Fe,E as Oe,F as Pe,G as Ne,H as Te,I as Me,C as ze,D as Le,_ as Ue,a as We,g as Je,J as qe,i as Ge,K as Ye,L as Ke,M as Xe,V as Qe}from"./SectionMain.UXk0-_90.js";import{_ as He,a as ce}from"./SectionTitleLineWithButton.npj7wZyd.js";import{_ as Ze,B as et,a as tt}from"./Badge.yXC_QlIC.js";import{_ as M}from"./IconifyButton.CR86CifL.js";import{_ as ye}from"./AnnualPlanFormModal.DyDzbc28.js";import{u as pe}from"./annualPlan.-Mc40fhZ.js";import{i as at,a as nt,b as lt,F as st}from"./index.DHiFdjZf.js";import{_ as ot}from"./StatusTrailModal.CVnRvXtJ.js";import{u as it}from"./clubScope.kLvJrC39.js";import"./appContext.wAA_MWDz.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./activityDesignService.CP1gQRrR.js";import"./utilizationRequestService.DvpKKU8n.js";import"./liquidationFundService.B44nTPu_.js";import"./ToasterComponent.63zQXGGK.js";const rt={class:"flex items-center gap-1 md:gap-2"},dt={class:"relative inline-flex"},ut={key:0,class:"absolute -top-1 -right-1 text-[10px] leading-none px-1.5 py-0.5 rounded-full bg-rose-600 text-white"},ct=["aria-expanded"],mt={style:{width:"18px",height:"18px"},viewBox:"0 0 24 24"},pt=["d"],ft={key:0},vt={__name:"AnnualPlanRowActions",props:{row:{type:Object,required:!0},moderator:{type:Boolean,default:!1},busy:{type:Boolean,default:!1},currentUserId:{type:[String,Number],default:null}},emits:["attachments","submit","approve","reject","edit","delete","view","cancel","remarks"],setup(m,{emit:u}){const f=m,I=B(()=>String(f.row?.status||"").toLowerCase()),k=B(()=>I.value==="draft"),b=B(()=>I.value==="draft"),g=B(()=>I.value!=="draft"),R=B(()=>f.moderator&&I.value==="pending"),F=B(()=>f.moderator&&(I.value==="approved"||I.value==="pending")),C=B(()=>f.moderator),w=S(!1),P=S(null),N=S(null),E=o=>{if(!w.value)return;const s=P.value,i=N.value;s&&!s.contains(o.target)&&i&&!i.contains(o.target)&&(w.value=!1)};Q(()=>document.addEventListener("click",E)),xe(()=>document.removeEventListener("click",E));const y=o=>{if(!o)return[];if(Array.isArray(o))return o;try{return JSON.parse(o||"[]")||[]}catch{return[]}},x=B(()=>{const o=f.currentUserId==null?null:Number(f.currentUserId);return(y(f.row?.remarks)||[]).filter(i=>{if(!i||i.is_read===!0)return!1;const O=i.user_id==null?null:Number(i.user_id);if(o!=null&&O===o)return!1;const z=Array.isArray(i.read_by)?i.read_by.map(T=>Number(T)):[];return o!=null?!z.includes(o):!1}).length});return(o,s)=>(r(),p("div",rt,[_(M,{"icon-path":v(Ae),color:"text-indigo-600",label:"Attachments",tooltip:"Attachments",size:"sm",disabled:m.busy,onClick:s[0]||(s[0]=i=>o.$emit("attachments",m.row))},null,8,["icon-path","disabled"]),g.value?(r(),U(M,{key:0,"icon-path":v(Se),color:"text-gray-700",label:"View",tooltip:"View (read-only)",size:"sm",disabled:m.busy,onClick:s[1]||(s[1]=i=>o.$emit("view",m.row))},null,8,["icon-path","disabled"])):h("",!0),k.value?(r(),U(M,{key:1,"icon-path":v(Be),color:"text-blue-600",label:"Submit",tooltip:"Submit",size:"sm",disabled:m.busy,onClick:s[2]||(s[2]=i=>o.$emit("submit",m.row))},null,8,["icon-path","disabled"])):h("",!0),b.value?(r(),U(M,{key:2,"icon-path":v(Ve),color:"text-amber-600",label:"Edit",tooltip:"Edit",size:"sm",disabled:m.busy,onClick:s[3]||(s[3]=i=>o.$emit("edit",m.row))},null,8,["icon-path","disabled"])):h("",!0),R.value?(r(),U(M,{key:3,"icon-path":v(Re),color:"text-emerald-600",label:"Approve",tooltip:"Approve",size:"sm",disabled:m.busy,onClick:s[4]||(s[4]=i=>o.$emit("approve",m.row))},null,8,["icon-path","disabled"])):h("",!0),R.value?(r(),U(M,{key:4,"icon-path":v(je),color:"text-rose-600",label:"Reject",tooltip:"Reject",size:"sm",disabled:m.busy,onClick:s[5]||(s[5]=i=>o.$emit("reject",m.row))},null,8,["icon-path","disabled"])):h("",!0),F.value?(r(),U(M,{key:5,"icon-path":v(De),color:"text-orange-600",label:"Cancel",tooltip:"Cancel plan",size:"sm",disabled:m.busy,onClick:s[6]||(s[6]=i=>o.$emit("cancel",m.row))},null,8,["icon-path","disabled"])):h("",!0),l("div",dt,[_(M,{"icon-path":v(Ie),color:"text-slate-700",label:"Remarks",tooltip:"Remarks / Audit Trail",size:"sm",disabled:m.busy,onClick:s[7]||(s[7]=i=>o.$emit("remarks",m.row))},null,8,["icon-path","disabled"]),x.value>0?(r(),p("span",ut,V(x.value),1)):h("",!0)]),C.value?(r(),U(M,{key:6,"icon-path":v(be),color:"text-red-600",label:"Delete",tooltip:"Delete",size:"sm",disabled:m.busy,onClick:s[8]||(s[8]=i=>o.$emit("delete",m.row))},null,8,["icon-path","disabled"])):h("",!0),l("div",{class:"relative md:hidden",ref_key:"btnRef",ref:N},[l("button",{class:"inline-flex items-center justify-center rounded-xl p-1.5 hover:bg-gray-100","aria-expanded":w.value,"aria-haspopup":"menu",title:"More",onClick:s[9]||(s[9]=i=>w.value=!w.value)},[(r(),p("svg",mt,[l("path",{d:v(Ee)},null,8,pt)]))],8,ct),w.value?(r(),p("div",{key:0,ref_key:"menuRef",ref:P,role:"menu",class:"absolute right-0 z-20 mt-1 w-44 overflow-hidden rounded-xl border bg-white shadow-lg"},[l("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[10]||(s[10]=i=>{w.value=!1,o.$emit("attachments",m.row)})},"Attachments"),g.value?(r(),p("button",{key:0,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[11]||(s[11]=i=>{w.value=!1,o.$emit("view",m.row)})},"View (read-only)")):h("",!0),k.value?(r(),p("button",{key:1,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[12]||(s[12]=i=>{w.value=!1,o.$emit("submit",m.row)})},"Submit")):h("",!0),b.value?(r(),p("button",{key:2,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[13]||(s[13]=i=>{w.value=!1,o.$emit("edit",m.row)})},"Edit")):h("",!0),R.value?(r(),p("button",{key:3,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[14]||(s[14]=i=>{w.value=!1,o.$emit("approve",m.row)})},"Approve")):h("",!0),R.value?(r(),p("button",{key:4,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-rose-600 hover:bg-rose-50",onClick:s[15]||(s[15]=i=>{w.value=!1,o.$emit("reject",m.row)})},"Reject")):h("",!0),F.value?(r(),p("button",{key:5,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[16]||(s[16]=i=>{w.value=!1,o.$emit("cancel",m.row)})},"Cancel")):h("",!0),l("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:s[17]||(s[17]=i=>{w.value=!1,o.$emit("remarks",m.row)})},[s[19]||(s[19]=G("Remarks ",-1)),x.value?(r(),p("span",ft,"("+V(x.value)+" new)",1)):h("",!0)]),C.value?(r(),p("button",{key:6,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50",onClick:s[18]||(s[18]=i=>{w.value=!1,o.$emit("delete",m.row)})},"Delete")):h("",!0)],512)):h("",!0)],512)]))}},yt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},bt={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},gt={class:"flex items-center justify-between mb-3"},ht={class:"text-lg font-semibold"},wt={class:"text-gray-600"},xt={class:"flex items-center justify-between gap-2"},kt={class:"text-sm text-gray-600"},Ct={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},$t=["d"],_t=["disabled"],At={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},St={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Bt=["src"],Vt={key:1,class:"flex items-center justify-center w-full h-full"},Rt=["d"],jt={class:"mt-2 text-xs"},Dt=["title"],It={class:"text-gray-500 flex items-center justify-between"},Et={key:0},Ft={key:0},Ot={class:"mt-2 flex items-center justify-between gap-2"},Pt=["onClick","title"],Nt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Tt=["d"],Mt=["onClick"],zt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Lt=["d"],Ut={key:0,class:"mt-6 text-center text-sm text-gray-500"},Wt=10*1024*1024,Jt={__name:"AnnualPlanAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(m,{emit:u}){const f=m,I=u,k=B({get:()=>f.modelValue,set:e=>I("update:modelValue",e)}),b=pe(),g=S(null),R=S(!1),F=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),C=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),w=(e="")=>String(e).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",P=(e="")=>typeof e=="string"&&e.match(/^data:([^;]+);base64,/i)?.[1]||"",N=e=>e?.type&&F.has(e.type)||e?.name&&C.has(w(e.name)),E=(e="")=>String(e).startsWith("image/"),y=(e="")=>e==="application/pdf",x=(e="")=>e==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",o=(e="")=>e==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",s=(e="")=>y(e)?Oe:x(e)?Pe:o(e)?Ne:E(e)?Te:Me,i=(e="")=>y(e)?"PDF":x(e)?"Word":o(e)?"Excel":E(e)?"Image":"File",O=(e="")=>y(e)?"pdf":x(e)?"docx":o(e)?"xlsx":e==="image/png"?"png":e==="image/jpeg"?"jpg":e==="image/webp"?"webp":"",z=(e="attachment",d="")=>/\.[a-z0-9]+$/i.test(e)?e:d?`${e}.${d.startsWith(".")?d.slice(1):d}`:e,T=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`,$=B(()=>{const e=g.value?.attachments;if(!e)return[];try{return Array.isArray(e)?e:JSON.parse(e||"[]")}catch{return[]}}),H=B(()=>($.value||[]).map((e,d)=>{const c=e.mime||P(e.data)||"",j=w(e.name||"")||O(c),J=e.size??null,q=e.name||`${i(c)} ${d+1}`;return{id:e.id??d+1,name:q,data:e.data||"",url:e.url||e.href||e.path||"",mime:c,ext:j,size:J,filename:z(q,j)}}));me(()=>f.modelValue,async e=>{e&&f.row?.id&&(await b.fetchById(f.row.id),g.value=b.selected||f.row)});const ne=async e=>{const d=e.target.files?.[0];if(e.target.value="",!(!d||!g.value?.id)){if(d.size>Wt){await A.fire("File too large","Maximum size is 10 MB.","warning");return}if(!N(d)){await A.fire("Unsupported file","Only images, PDF, DOCX, XLSX allowed.","warning");return}try{R.value=!0,await b.uploadAttachment(g.value.id,d),await b.fetchById(g.value.id),g.value=b.selected}finally{R.value=!1}}},le=async e=>{!g.value?.id||!(await A.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await b.deleteAttachment(g.value.id,e),await b.fetchById(g.value.id),g.value=b.selected)},se=e=>{if(e.data&&String(e.data).startsWith("data:")&&E(e.mime)){const d=window.open();d&&d.document.write(`<img src="${e.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}e.url&&window.open(String(e.url),"_blank")},oe=e=>{const[d,c]=e.split(","),j=d.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",J=atob(c),q=new Uint8Array(J.length);for(let K=0;K<J.length;K++)q[K]=J.charCodeAt(K);return new Blob([q],{type:j})},Z=(e,d)=>{const c=URL.createObjectURL(e),j=document.createElement("a");j.href=c,j.download=d||"download",document.body.appendChild(j),j.click(),j.remove(),setTimeout(()=>URL.revokeObjectURL(c),1e3)},Y=async e=>{if(e.data&&String(e.data).startsWith("data:")){Z(oe(e.data),e.filename);return}if(e.url)try{const c=await(await fetch(e.url,{credentials:"include"})).blob();Z(c,e.filename)}catch{const d=document.createElement("a");d.href=String(e.url),d.setAttribute("download",e.filename),document.body.appendChild(d),d.click(),d.remove()}},W=e=>E(e.mime)?"Open":"Download",ee=e=>E(e.mime)?ze:Le,ie=e=>E(e.mime)?se(e):Y(e);return(e,d)=>k.value?(r(),p("div",yt,[l("div",bt,[l("div",gt,[l("h2",ht,[d[1]||(d[1]=G(" Annual Plan Attachments — ",-1)),l("span",wt,V(g.value?.reference_code||""),1)]),l("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=c=>k.value=!1)},"Close")]),l("div",xt,[l("div",kt,[d[2]||(d[2]=G(" School Year: ",-1)),l("strong",null,V(g.value?.school_year||"—"),1)]),l("label",{class:ve(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":R.value}])},[(r(),p("svg",Ct,[l("path",{d:v(Fe)},null,8,$t)])),l("span",null,V(R.value?"Uploading…":"Upload"),1),l("input",{type:"file",class:"hidden",disabled:R.value,onChange:ne,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,_t)],2)]),l("div",At,[(r(!0),p(X,null,ae(H.value,c=>(r(),p("div",{key:c.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[l("div",St,[c.data&&c.data.startsWith("data:")&&c.mime?.startsWith("image/")?(r(),p("img",{key:0,src:c.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Bt)):(r(),p("div",Vt,[(r(),p("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:ve({"text-red-600":c.mime==="application/pdf","text-blue-600":c.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":c.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!c.mime||!c.mime.startsWith("image/")&&c.mime!=="application/pdf"})},[l("path",{d:s(c.mime)},null,8,Rt)],2))]))]),l("div",jt,[l("div",{class:"font-medium truncate",title:c.name},V(c.name),9,Dt),l("div",It,[l("span",null,[G(V(i(c.mime))+" ",1),c.ext?(r(),p("span",Et,"("+V(c.ext.toUpperCase())+")",1)):h("",!0)]),c.size?(r(),p("span",Ft,V(T(c.size)),1)):h("",!0)])]),l("div",Ot,[l("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:j=>ie(c),title:W(c)},[(r(),p("svg",Nt,[l("path",{d:ee(c)},null,8,Tt)])),G(" "+V(W(c)),1)],8,Pt),l("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:j=>le(c.id),title:"Remove"},[(r(),p("svg",zt,[l("path",{d:v(be)},null,8,Lt)])),d[3]||(d[3]=G(" Remove ",-1))],8,Mt)])]))),128))]),H.value.length?h("",!0):(r(),p("div",Ut," No attachments yet. "))])])):h("",!0)}},qt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},Gt={class:"bg-white rounded-2xl shadow-2xl w-full sm:w-[1200px] max-w-[100vw] sm:max-w-[95vw] h-[100vh] sm:h-auto sm:max-h-[90vh] overflow-hidden"},Yt={class:"px-4 py-3 border-b flex items-center justify-between"},Kt={class:"p-2 overflow-auto"},Xt={__name:"AnnualPlansCalendarModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(m,{emit:u}){const f=m,I=u,k=B({get:()=>f.modelValue,set:y=>I("update:modelValue",y)}),b=pe(),g=S([]),R=y=>{if(Array.isArray(y))return y;try{return JSON.parse(y||"[]")}catch{return[]}},F=(y=[])=>{const x=[];y.forEach(o=>{const s=R(o.plans),i=o.club?.name?`[${o.club.name}] `:"";s.forEach((O,z)=>{const T=O?.date_of_implementation;if(!T)return;const $=`${i}${O.item||"Planned Activity"}`;x.push({id:`${o.id}-${z}`,title:$,start:`${T}T00:00:00`,end:`${T}T23:59:59`,backgroundColor:"#b45309",borderColor:"#92400e",textColor:"#ffffff",extendedProps:{annual_plan_id:o.id,reference_code:o.reference_code,school_year:o.school_year,funds:O?.funds??0,status:o.status}})})}),g.value=x},C=async()=>{await b.fetchAll({page:1,limit:500,status:"approved",sort:"created_at",order:"ASC"},!0),F(b.items.data||[])},w=y=>{const x=y?.event?.extendedProps?.annual_plan_id;x&&I("open",Number(x))},P=S(!1),N=()=>{P.value=window.innerWidth<640};Q(()=>{N(),window.addEventListener("resize",N)});const E=B(()=>({plugins:[at,nt,lt],initialView:"dayGridMonth",headerToolbar:P.value?{left:"prev,next",center:"title",right:"dayGridMonth"}:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",handleWindowResize:!0,expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:w,events:g.value}));return me(()=>f.modelValue,y=>{y&&C()}),me(()=>b.items.data,y=>{k.value&&F(y||[])},{deep:!0}),Q(()=>{k.value&&C()}),(y,x)=>k.value?(r(),p("div",qt,[l("div",Gt,[l("div",Yt,[x[1]||(x[1]=l("h2",{class:"text-base font-semibold"},"Annual Plans Calendar (Approved)",-1)),l("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:x[0]||(x[0]=o=>k.value=!1)},"Close")]),l("div",Kt,[_(v(st),{options:E.value},null,8,["options"])]),x[2]||(x[2]=l("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click a plan item to open its Annual Plan. ",-1))])])):h("",!0)}},Qt={class:"flex flex-wrap items-center gap-2 w-full sm:w-auto justify-start sm:justify-end"},Ht={class:"p-3 mb-4 rounded-xl border bg-white/60"},Zt={class:"flex items-center gap-2 mb-2 text-gray-700"},ea={class:"w-4 h-4",viewBox:"0 0 24 24"},ta=["d"],aa={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},na={class:"md:col-span-2 flex"},la={class:"w-5 h-5",viewBox:"0 0 24 24"},sa=["d"],oa=["value"],ia=["disabled"],ra=["value"],da=["value"],ua={class:"flex items-center gap-2 md:col-span-2"},ca={class:"font-medium"},Ba={__name:"AnnualPlansPage",setup(m){const u=pe(),f=ke(),I=B(()=>["admin","manager"].includes(String(f.user?.role||"").toLowerCase())),k=B(()=>{const n=f.user?.last_name||"",t=(f.user?.first_name||"").slice(0,1);return`${n}${n?", ":""}${t?t+".":""}`}),b=n=>{try{return((Array.isArray(n)?n:JSON.parse(n||"[]")||[])||[]).map(a=>(!a||typeof a!="object"||Array.isArray(a.read_by)||(a.read_by=a.user_id!=null?[a.user_id]:[]),a))}catch{return[]}},g=S(!1),R=()=>{g.value=!0},F=S(!1),C=S(null),w=async n=>{try{await u.fetchById(n.id),C.value=u.selected||n}catch{C.value=n}F.value=!0},P=async n=>{if(!C.value)return;const t=b(C.value.remarks);t.push({user_id:f.user?.id||null,user_name:k.value,message:n?.message||"",datetime:n?.datetime||new Date().toISOString(),is_read:!1,read_by:[f.user?.id||null]});try{C.value.remarks=JSON.stringify(t)}catch{}try{await u.updateById(C.value.id,{remarks:JSON.stringify(t)}),await $({},!0)}catch{}},N=async()=>{if(!C.value)return;const n=f.user?.id||null,a=b(C.value.remarks).map(D=>{if(!D||D.user_id===n)return D;const de=Array.isArray(D.read_by)?D.read_by.slice():[];return de.includes(n)||de.push(n),{...D,read_by:de}});try{C.value.remarks=JSON.stringify(a)}catch{}try{await u.updateById(C.value.id,{remarks:JSON.stringify(a)}),await $({},!0)}catch{}},E=async n=>{try{await u.fetchById(n);const t=u.selected;t&&await d(t)}catch(t){console.error(t)}finally{g.value=!1}},y=S([]);Q(async()=>{try{const{data:n}=await Ce.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});y.value=Array.isArray(n?.data)?n.data:[]}catch{y.value=[]}});const o=n=>y.value.find(t=>t.id===Number(n))?.name||"—",s=B(()=>{const n=new Date().getFullYear();return Array.from({length:6},(t,a)=>`${n-a}-${n-a+1}`)}),i=S({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:""}),{isClub:O,activeClubId:z,withClub:T}=it(),$=async(n={},t=!0)=>{i.value={...i.value,...n};const a=T({...i.value});["q","status","school_year","club_id","filed_by_user_id","approver_user_id"].forEach(D=>{(a[D]===""||a[D]==null)&&delete a[D]}),await u.fetchAll(a,t)};Q(async()=>{await $({page:1,limit:10,club_id:O?z:""})});const H=B(()=>({total:u.items.total||0,totalPages:u.items.totalPages||1,currentPage:u.items.currentPage||1,pageSize:u.items.pageSize||10,data:u.items.data||[]})),ne=["draft","pending","approved","rejected","cancelled","archived"],le=n=>{switch(String(n||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"archived":return"slate";default:return"gray"}},se=n=>{const t=Number(n);return Number.isFinite(t)?t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},oe=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"school_year",label:"School Year",sortable:!0,width:120},{key:"club",label:"Club",sortable:!1,minWidth:200,formatter:(n,t)=>t.club?.name||o(t.club_id)||""},{key:"total_budget",label:"Total Budget",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:110},{key:"created_at",label:"Created",sortable:!0,width:170}],Z=async n=>{await $(n)},Y=S(!1),W=S(!1),ee=S(null),ie=()=>{Y.value=!0},e=async n=>{await u.create(n),Y.value=!1,await $({},!0)},d=async n=>{await u.fetchById(n.id);const t=u.selected||n;let a=[];try{a=Array.isArray(t.plans)?t.plans:JSON.parse(t.plans||"[]")}catch{}ee.value={id:t.id,reference_code:t.reference_code,school_year:t.school_year||"",club_id:t.club_id||"",filed_by_user_id:t.filed_by_user_id||f.user?.id||"",approver_user_id:t.approver_user_id||"",plans:a,remarks:t.remarks||"",status:t.status||"draft"},W.value=!0},c=async n=>{const{id:t,...a}=n;await u.updateById(t,a),W.value=!1,await $({},!0)},j=async n=>{if(!n?.id)return;(await A.fire({title:`Delete annual plan "${n.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await u.deleteById(n.id),await $({},!0),await A.fire("Deleted","The annual plan has been deleted.","success"))},J=async n=>{await d(n)},q=async n=>{if((await A.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel"})).isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} submitted annual plan.`,datetime:new Date().toISOString(),is_read:!1}),await u.updateById(n.id,{remarks:JSON.stringify(a)}),await u.submit(n.id),await $({},!0),await A.fire("Submitted","Annual plan is now pending approval.","success")}catch{await A.fire("Error",u.error||"Failed to submit.","error")}},K=async n=>{const t=await A.fire({title:"Approve annual plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(t.isConfirmed)try{const a=b(n.remarks),D=t.value||"";a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} approved annual plan.${D?" - "+D:""}`,datetime:new Date().toISOString(),is_read:!1}),await u.approve(n.id,JSON.stringify(a)),await $({},!0),await A.fire("Approved","Annual plan has been approved.","success")}catch{await A.fire("Error",u.error||"Failed to approve.","error")}},ge=async n=>{const t=await A.fire({title:"Reject annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:a=>a?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(t.isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} rejected annual plan - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1}),await u.reject(n.id,JSON.stringify(a)),await $({},!0),await A.fire("Rejected","Annual plan has been rejected.","success")}catch{await A.fire("Error",u.error||"Failed to reject.","error")}},he=async n=>{const t=await A.fire({title:"Cancel annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:a=>a?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Plan",cancelButtonText:"Keep"});if(t.isConfirmed)try{const a=b(n.remarks);a.push({user_id:f.user?.id||null,user_name:k.value,message:`${k.value} cancelled annual plan - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1}),await u.cancel(n.id,JSON.stringify(a)),await u.updateById(n.id,{status:"draft"}),await $({},!0),await A.fire("Moved to Draft","Annual plan was cancelled and returned to Draft for editing.","success")}catch{await A.fire("Error",u.error||"Failed to cancel.","error")}},re=S(!1),fe=S(null),we=async n=>{await u.fetchById(n.id),fe.value=u.selected||n,re.value=!0};return(n,t)=>(r(),p(X,null,[_(Ue,null,{default:L(()=>[_(We,null,{default:L(()=>[v(u).error?(r(),U(Ze,{key:0,icon:v(Je),color:"danger"},{default:L(()=>[G(V(v(u).error),1)]),_:1},8,["icon"])):h("",!0),_(He,{icon:v(qe),title:"Annual Plans",main:""},{default:L(()=>[l("div",Qt,[_(ce,{icon:v(Ge),color:"info",label:"View Calendar",onClick:R},null,8,["icon"]),_(ce,{icon:v(Ye),color:"primary",label:"New Annual Plan",onClick:ie},null,8,["icon"]),_(ce,{icon:v(Ke),color:"info",label:"Refresh",onClick:t[0]||(t[0]=a=>$({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),l("div",Ht,[l("div",Zt,[(r(),p("svg",ea,[l("path",{d:v(Xe)},null,8,ta)])),t[14]||(t[14]=l("span",{class:"font-medium text-sm"},"Filters",-1))]),l("div",aa,[l("div",na,[te(l("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>i.value.q=a),placeholder:"Search by ref, school year, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:t[2]||(t[2]=$e(a=>$({page:1}),["enter"]))},null,544),[[_e,i.value.q]]),l("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:t[3]||(t[3]=a=>$({page:1}))},[(r(),p("svg",la,[l("path",{d:v(Qe)},null,8,sa)]))])]),te(l("select",{"onUpdate:modelValue":t[4]||(t[4]=a=>i.value.status=a),class:"border rounded px-2 py-2"},[t[15]||(t[15]=l("option",{value:""},"All status",-1)),(r(),p(X,null,ae(ne,a=>l("option",{key:a,value:a},V(a),9,oa)),64))],512),[[ue,i.value.status]]),te(l("select",{"onUpdate:modelValue":t[5]||(t[5]=a=>i.value.school_year=a),class:"border rounded px-2 py-2",disabled:n.readOnly},[t[16]||(t[16]=l("option",{value:""},"Select school year…",-1)),(r(!0),p(X,null,ae(s.value,a=>(r(),p("option",{key:a,value:a},V(a),9,ra))),128))],8,ia),[[ue,i.value.school_year]]),te(l("select",{"onUpdate:modelValue":t[6]||(t[6]=a=>i.value.club_id=a),class:"border rounded px-2 py-2"},[t[17]||(t[17]=l("option",{value:""},"Any club",-1)),(r(!0),p(X,null,ae(y.value,a=>(r(),p("option",{key:a.id,value:a.id},V(a.name),9,da))),128))],512),[[ue,i.value.club_id]]),l("div",ua,[l("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:t[7]||(t[7]=a=>$({page:1}))}," Apply Filters "),l("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[8]||(t[8]=()=>{i.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:""},$({page:1},!0)})},"Reset")])])]),_(et,{columns:oe,data:H.value,loading:v(u).isLoading,onQueryChange:Z},{"cell-total_budget":L(({value:a})=>[l("span",ca,V(se(a)),1)]),"cell-created_at":L(({value:a})=>[l("span",null,V(a?new Date(a).toLocaleString():"—"),1)]),"cell-status":L(({value:a})=>[_(tt,{text:a||"—",tone:le(a)},null,8,["text","tone"])]),"cell-actions":L(({row:a})=>[_(vt,{row:a,busy:v(u).isActing(a.id),"current-user-id":v(f).user?.id,moderator:I.value,onAttachments:we,onSubmit:q,onApprove:K,onReject:ge,onEdit:d,onDelete:j,onView:D=>J(a),onCancel:he,onRemarks:w},null,8,["row","busy","current-user-id","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),_(ye,{modelValue:Y.value,"onUpdate:modelValue":t[9]||(t[9]=a=>Y.value=a),mode:"create","locked-club-id":v(O)?v(z):"",onSubmit:e},null,8,["modelValue","locked-club-id"]),_(ye,{modelValue:W.value,"onUpdate:modelValue":t[10]||(t[10]=a=>W.value=a),mode:"edit",initial:ee.value||{},onSubmit:c},null,8,["modelValue","initial"]),_(Jt,{modelValue:re.value,"onUpdate:modelValue":t[11]||(t[11]=a=>re.value=a),row:fe.value},null,8,["modelValue","row"]),_(Xt,{modelValue:g.value,"onUpdate:modelValue":t[12]||(t[12]=a=>g.value=a),onOpen:E},null,8,["modelValue"]),_(ot,{modelValue:F.value,"onUpdate:modelValue":t[13]||(t[13]=a=>F.value=a),title:"Remarks • "+(C.value?.reference_code||"Annual Plan"),items:b(C.value?.remarks),"can-add":!0,onAdd:P,onMarkAllRead:N},null,8,["modelValue","title","items"])],64))}};export{Ba as default};
