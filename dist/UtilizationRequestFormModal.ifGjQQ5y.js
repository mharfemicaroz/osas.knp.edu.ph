import{c as v,u as re,o as ue,r as q,x as D,G as ce,a as i,d as c,q as d,e as t,t as u,k as b,h as m,C as T,g as H,j as h,F as S,B as A,v as y,S as F}from"./index.bm0HPCz8.js";import{u as me}from"./clubScope.BJla7Oy8.js";import{u as ve}from"./utilizationRequest.-TCmujlS.js";import{u as pe}from"./club.B90eGyu3.js";import{u as be}from"./activityDesign.CGBY-xgt.js";const _e={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ye={class:"bg-white p-3 md:p-4 rounded-xl shadow-lg w-full sm:w-[720px] max-w-[95vw] h-[100vh] sm:h-auto sm:max-h-[90vh] overflow-y-auto"},fe={class:"flex items-center justify-between mb-2"},xe={class:"flex items-center gap-2"},ge={class:"text-base font-semibold"},he={class:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100"},ke={key:0,class:"mb-2 text-[11px] px-2.5 py-1.5 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},we={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},qe={class:"md:col-span-2"},Se=["disabled"],Ae=["value"],Ce={key:0,class:"text-red-600 text-[11px] mt-0.5"},Be={key:1,class:"text-[11px] text-gray-500 mt-0.5"},Ne={key:2,class:"text-[11px] text-amber-700 mt-0.5"},Ue={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ve=["disabled"],$e={key:0,class:"text-red-600 text-[11px] mt-0.5"},Ee=["disabled"],Oe={key:0,class:"text-red-600 text-[11px] mt-0.5"},De=["disabled"],Te={key:0,class:"text-red-600 text-[11px] mt-0.5"},Fe={class:"mt-2 text-sm"},Le={class:"flex gap-1.5"},je=["disabled"],Re=["value"],Ie={class:"flex flex-col gap-1"},Me=["disabled"],ze={key:0,class:"text-red-600 text-[11px] mt-0.5"},Pe={class:"mt-1.5 flex flex-wrap gap-1.5"},Ge=["onClick"],He={key:0,class:"text-gray-400 text-xs"},We={class:"mt-3 text-sm"},Qe={class:"flex items-center justify-between"},Je=["disabled"],Ye={class:"mt-1 border rounded overflow-hidden"},Ke={class:"w-full text-[12px]"},Xe={class:"p-1.5"},Ze=["onUpdate:modelValue","disabled","onChange"],et=["value"],tt={key:0,class:"text-red-600 mt-0.5 text-[11px]"},st={class:"p-1.5"},lt=["onUpdate:modelValue","disabled"],at={class:"p-1.5"},it=["onUpdate:modelValue","disabled"],dt={class:"p-1.5 text-right"},nt=["disabled","onClick"],ot={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},rt=["disabled"],ut=["disabled"],ct={key:0,class:"text-red-600 text-[11px] mt-0.5"},mt={key:0},vt=["disabled"],pt={class:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},bt=["disabled"],_t={class:"mt-2 p-2 rounded-lg border bg-white"},yt={class:"flex items-center justify-between"},ft=["disabled"],xt={class:"flex justify-end gap-1.5 mt-4"},gt={key:0,class:"px-3 py-1.5 bg-blue-600 text-white rounded text-xs"},At={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",file_by_user_name:"",noted_by:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(W,{emit:Q}){const C=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],B=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],g=W,L=Q,N=v({get:()=>g.modelValue,set:s=>L("update:modelValue",s)}),U=re(),j=ve(),k=pe(),w=be(),R=v(()=>String(U.user?.role||"").toLowerCase()==="admin"),V=v(()=>{const s=Array.isArray(w.items?.data)?w.items.data.filter(e=>String(e.status).toLowerCase()==="approved"):[];if(I.value&&f.value){const e=Number(f.value);return s.filter(n=>Number(n.club_id||n.club?.id)===e)}return s}),{isClub:I,activeClubId:f}=me();ue(async()=>{const s={page:1,limit:200,status:"approved",officer:!0},e=I.value&&f.value?{...s,club_id:f.value}:s;await w.fetchAll(e,!0),(!Array.isArray(k.clubs?.data)||!k.clubs.data.length)&&await k.fetchAll({page:1,limit:200},!0)});const l=q({...g.initial}),o=q({}),$=q(!0),E=q(""),M=v(()=>{const s=Number(l.value.activity_design_id||0);return V.value.find(e=>Number(e.id)===s)||null}),z=v(()=>{const s=M.value;return Number(s?.club_id||s?.club?.id||0)||null}),P=s=>{const e=Number(s);return(k.clubs?.data||[]).find(a=>Number(a.id)===e)?.adviser||""},J=v(()=>{const s=z.value||f.value||null;return s?(P(s)||"").trim():""}),Y=v(()=>J.value.length>0),G=()=>{const s=z.value||f.value||null,e=s&&P(s)||"";($.value||l.value.noted_by===E.value)&&(l.value.noted_by=e,E.value=e)};D(()=>g.initial,s=>{l.value={...s,facilities:Array.isArray(s.facilities)?s.facilities:(()=>{try{return JSON.parse(s.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(s.equipment_items)?s.equipment_items:(()=>{try{return JSON.parse(s.equipment_items||"[]")}catch{return[]}})()},l.value.facilities=(l.value.facilities||[]).filter(e=>C.includes(e)),l.value.equipment_items=(l.value.equipment_items||[]).filter(e=>!e?.name||B.includes(e.name)),o.value={},$.value=!(s&&String(s.noted_by||"").trim()),E.value=""},{immediate:!0}),D(()=>l.value.activity_design_id,()=>{const s=M.value;s?.date_of_implementation?l.value.start_date=String(s.date_of_implementation).slice(0,10):l.value.start_date="",G()},{immediate:!0}),D(()=>[f.value,k.clubs?.data?.length],()=>{G()},{immediate:!0});const K=v(()=>String(l.value?.status||"").toLowerCase()),r=v(()=>g.mode==="edit"&&K.value!=="draft"),X=v(()=>g.mode!=="edit"?"New Utilization Request":r.value?"View Utilization (read-only)":"Edit Utilization"),Z=v(()=>g.mode==="edit"?"Save Changes":"Create"),ee=s=>{const e=s?.name_of_activity||"Untitled",n=s?.school_year?` • SY ${s.school_year}`:"",a=s?.semester?` • ${s.semester}`:"",_=s?.reference_code?` [${s.reference_code}]`:"";return`${e}${n}${a}${_}`},x=q([]),te=v(()=>C.filter(s=>!(l.value.facilities||[]).includes(s))),se=()=>{const s=Array.isArray(x.value)?x.value.slice():[];s.length&&(Array.isArray(l.value.facilities)||(l.value.facilities=[]),s.forEach(e=>{C.includes(e)&&!l.value.facilities.includes(e)&&l.value.facilities.push(e)}),x.value=[])},le=s=>{l.value.facilities.splice(s,1)},ae=()=>{Array.isArray(l.value.equipment_items)||(l.value.equipment_items=[]),l.value.equipment_items.push({name:"",qty:1,unit:""})},ie=s=>{l.value.equipment_items.splice(s,1)},O=s=>{const e=new Set((l.value.equipment_items||[]).map((n,a)=>a===s?null:n?.name).filter(Boolean));return B.filter(n=>!e.has(n))},de=()=>{if(r.value)return!1;const s={};l.value.activity_design_id||(s.activity_design_id="Required"),l.value.noted_by?.trim()||(s.noted_by="Required"),l.value.start_date||(s.start_date="Start date is required (from Activity Design)"),l.value.start_time||(s.start_time="Required"),l.value.end_date||(s.end_date="Required"),l.value.end_time||(s.end_time="Required"),!Array.isArray(l.value.facilities)||!l.value.facilities.length?s.facilities="Select at least one":l.value.facilities.every(n=>C.includes(n))||(s.facilities="Invalid facility selected");const e=new Set;if(Array.isArray(l.value.equipment_items)&&l.value.equipment_items.forEach((n,a)=>{n?.name&&!B.includes(n.name)&&(s[`equipment_${a}`]="Invalid equipment"),n?.name&&e.has(n.name)&&(s[`equipment_${a}`]="Duplicate item; adjust quantity instead"),n?.name&&e.add(n.name),n?.name&&(isNaN(Number(n.qty))||Number(n.qty)<=0)&&(s[`equipment_${a}`]="Qty must be > 0")}),l.value.start_date&&l.value.end_date&&l.value.start_time&&l.value.end_time){const n=new Date(`${l.value.start_date}T${l.value.start_time}:00`);new Date(`${l.value.end_date}T${l.value.end_time}:00`)<n&&(s.end_time="End must be after or equal to start")}return o.value=s,Object.keys(s).length===0},ne=async()=>{if(!l.value.start_date||!l.value.end_date||!l.value.facilities?.length){await F.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const s=await j.checkAvailability({start_date:l.value.start_date,start_time:l.value.start_time||"00:00",end_date:l.value.end_date,end_time:l.value.end_time||"00:00",facilities:l.value.facilities}),e=s.available_for_all?"All selected facilities are available.":`Conflicts on: ${(s.conflict_facilities||[]).join(", ")||"—"}`;await F.fire({icon:s.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(s.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${e}</div>
      </div>`})}catch(s){await F.fire("Error",j.error||"Failed to check availability.","error"),console.error(s)}},oe=()=>{if(r.value||!de())return;const s={...l.value};U.user?.id&&(s.filed_by_user_id=U.user.id),R.value||delete s.file_by_user_name,L("submit",s)};return(s,e)=>{const n=ce("pending-click");return N.value?(d(),i("div",_e,[t("div",ye,[t("div",fe,[t("div",xe,[t("h2",ge,u(X.value),1),t("span",he,u(l.value.status),1)]),t("button",{class:"px-2.5 py-1 text-[11px] bg-gray-200 rounded",onClick:e[0]||(e[0]=a=>N.value=!1)},"Close")]),r.value?(d(),i("div",ke,[e[13]||(e[13]=b(" This request is ",-1)),t("strong",null,u(l.value.status),1),e[14]||(e[14]=b(". Editing is disabled. ",-1))])):c("",!0),t("div",we,[t("div",qe,[e[16]||(e[16]=t("label",{class:"block mb-0.5"},[b("Activity Design "),t("span",{class:"text-red-500"},"*")],-1)),m(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.activity_design_id=a),class:h(["w-full border rounded px-2 py-1.5",o.value.activity_design_id?"border-red-500":""]),disabled:r.value||H(w).isLoading},[e[15]||(e[15]=t("option",{value:""},"Select approved activity design…",-1)),(d(!0),i(S,null,A(V.value,a=>(d(),i("option",{key:a.id,value:a.id},u(ee(a)),9,Ae))),128))],10,Se),[[T,l.value.activity_design_id]]),o.value.activity_design_id?(d(),i("p",Ce,u(o.value.activity_design_id),1)):c("",!0),H(w).isLoading?(d(),i("p",Be,"Loading approved activities… ")):V.value.length?c("",!0):(d(),i("p",Ne," No approved activity designs found. Approve an Activity Design first. "))]),t("div",null,[e[17]||(e[17]=t("label",{class:"block mb-0.5"},[b("Start Date "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.start_date=a),type:"date",class:h(["w-full border rounded px-2 py-1.5 bg-gray-50",o.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[y,l.value.start_date]]),o.value.start_date?(d(),i("p",Ue,u(o.value.start_date),1)):c("",!0)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block mb-0.5"},[b("Start Time "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.start_time=a),type:"time",class:h(["w-full border rounded px-2 py-1.5",o.value.start_time?"border-red-500":""]),placeholder:"HH:MM",disabled:r.value},null,10,Ve),[[y,l.value.start_time]]),o.value.start_time?(d(),i("p",$e,u(o.value.start_time),1)):c("",!0)]),t("div",null,[e[19]||(e[19]=t("label",{class:"block mb-0.5"},[b("End Date "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.end_date=a),type:"date",class:h(["w-full border rounded px-2 py-1.5",o.value.end_date?"border-red-500":""]),disabled:r.value},null,10,Ee),[[y,l.value.end_date]]),o.value.end_date?(d(),i("p",Oe,u(o.value.end_date),1)):c("",!0)]),t("div",null,[e[20]||(e[20]=t("label",{class:"block mb-0.5"},[b("End Time "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>l.value.end_time=a),type:"time",class:h(["w-full border rounded px-2 py-1.5",o.value.end_time?"border-red-500":""]),placeholder:"HH:MM",disabled:r.value},null,10,De),[[y,l.value.end_time]]),o.value.end_time?(d(),i("p",Te,u(o.value.end_time),1)):c("",!0)])]),t("div",Fe,[e[23]||(e[23]=t("label",{class:"block mb-0.5"},[b("Facilities "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Le,[m(t("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>x.value=a),multiple:"",size:"6",class:"border rounded px-2 py-1.5 min-w-[240px]",disabled:r.value},[e[21]||(e[21]=t("option",{value:""},"Select facility…",-1)),(d(!0),i(S,null,A(te.value,a=>(d(),i("option",{key:a,value:a},u(a),9,Re))),128))],8,je),[[T,x.value]]),t("div",Ie,[t("button",{class:"px-2.5 py-1.5 bg-gray-200 rounded text-[11px]",disabled:r.value||!(x.value&&x.value.length),onClick:se}," Add Selected ",8,Me),e[22]||(e[22]=t("span",{class:"text-[10px] text-gray-500"},"Use Ctrl/Cmd or Shift to select multiple.",-1))])]),o.value.facilities?(d(),i("p",ze,u(o.value.facilities),1)):c("",!0),t("div",Pe,[(d(!0),i(S,null,A(l.value.facilities,(a,_)=>(d(),i("span",{key:a,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[11px]"},[b(u(a)+" ",1),r.value?c("",!0):(d(),i("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:p=>le(_)},"×",8,Ge))]))),128)),l.value.facilities?.length?c("",!0):(d(),i("span",He,"No facilities selected"))])]),t("div",We,[t("div",Qe,[e[24]||(e[24]=t("label",{class:"block mb-0.5"},"Equipment / Materials (optional)",-1)),t("button",{class:"px-2.5 py-1 bg-gray-200 rounded text-[11px]",disabled:r.value||O(-1).length===0,onClick:ae}," Add Row ",8,Je)]),t("div",Ye,[t("table",Ke,[e[26]||(e[26]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-1.5"},"Item"),t("th",{class:"text-left p-1.5"},"Qty"),t("th",{class:"text-left p-1.5"},"Unit"),t("th",{class:"p-1.5 w-14"})])],-1)),t("tbody",null,[(d(!0),i(S,null,A(l.value.equipment_items,(a,_)=>(d(),i("tr",{key:_,class:"border-t"},[t("td",Xe,[m(t("select",{"onUpdate:modelValue":p=>a.name=p,class:"w-full border rounded px-2 py-1.5",disabled:r.value,onChange:()=>{(a.qty==null||a.qty<=0)&&(a.qty=1)}},[e[25]||(e[25]=t("option",{disabled:"",value:""},"Select item…",-1)),(d(!0),i(S,null,A(O(_).concat(a.name&&!O(_).includes(a.name)?[a.name]:[]),p=>(d(),i("option",{key:p,value:p},u(p),9,et))),128))],40,Ze),[[T,a.name]]),o.value[`equipment_${_}`]?(d(),i("div",tt,u(o.value[`equipment_${_}`]),1)):c("",!0)]),t("td",st,[m(t("input",{"onUpdate:modelValue":p=>a.qty=p,type:"number",min:"1",class:"w-20 border rounded px-2 py-1.5",disabled:r.value,placeholder:"1"},null,8,lt),[[y,a.qty,void 0,{number:!0}]])]),t("td",at,[m(t("input",{"onUpdate:modelValue":p=>a.unit=p,class:"w-24 border rounded px-2 py-1.5",disabled:r.value,placeholder:"e.g., pcs"},null,8,it),[[y,a.unit]])]),t("td",dt,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded text-[11px]",disabled:r.value,onClick:p=>ie(_)}," Remove ",8,nt)])]))),128))])])]),e[27]||(e[27]=t("p",{class:"text-[11px] text-gray-500 mt-0.5"},"Each equipment name must be unique; adjust quantity for multiples.",-1))]),t("div",ot,[t("div",null,[e[28]||(e[28]=t("label",{class:"block mb-0.5"},"Utilization Details (duration, purpose, notes)",-1)),m(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=a=>l.value.utilization_details=a),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"e.g., 2 hours practice; stage and sound system"},null,8,rt),[[y,l.value.utilization_details]])]),t("div",null,[e[29]||(e[29]=t("label",{class:"block mb-0.5"},[b("Adviser (Noted by) "),t("span",{class:"text-red-500"},"*")],-1)),m(t("input",{"onUpdate:modelValue":e[8]||(e[8]=a=>l.value.noted_by=a),class:h(["w-full border rounded px-2 py-1.5",o.value.noted_by?"border-red-500":""]),disabled:r.value||Y.value,placeholder:"Adviser name (noted by)",onInput:e[9]||(e[9]=a=>$.value=!1)},null,42,ut),[[y,l.value.noted_by]]),o.value.noted_by?(d(),i("p",ct,u(o.value.noted_by),1)):c("",!0)]),R.value?(d(),i("div",mt,[e[30]||(e[30]=t("label",{class:"block mb-0.5"},"Filer Name Override (optional)",-1)),m(t("input",{"onUpdate:modelValue":e[10]||(e[10]=a=>l.value.file_by_user_name=a),class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"If provided, this name appears as the filer"},null,8,vt),[[y,l.value.file_by_user_name]])])):c("",!0)]),t("div",pt,[t("div",null,[e[31]||(e[31]=t("label",{class:"block mb-0.5"},"Remarks",-1)),m(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=a=>l.value.remarks=a),rows:"3",class:"w-full border rounded px-2 py-1.5",disabled:r.value,placeholder:"Optional notes for approvers"},null,8,bt),[[y,l.value.remarks]])])]),t("div",_t,[t("div",yt,[e[32]||(e[32]=t("div",{class:"text-[13px] font-medium"},"Check Availability",-1)),t("button",{class:"px-2.5 py-1 bg-indigo-600 text-white rounded text-[11px]",disabled:r.value,onClick:ne}," Run Check ",8,ft)]),e[33]||(e[33]=t("div",{class:"mt-0.5 text-[11px] text-gray-500"},"Uses current form values (start/end & facilities) to detect overlaps.",-1))]),t("div",xt,[t("button",{class:"px-3 py-1.5 bg-gray-200 rounded text-xs",onClick:e[12]||(e[12]=a=>N.value=!1)},"Close"),r.value?c("",!0):m((d(),i("button",gt,[b(u(Z.value),1)])),[[n,oe]])])])])):c("",!0)}}};export{At as _};
