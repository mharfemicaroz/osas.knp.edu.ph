import{c as V,r as S,o as Q,G as ve,a as u,q as i,f as F,A as W,d as y,e as t,g as h,u as ce,E as ae,t as w,k as D,h as R,v as L,j as q,C as de,F as X,B as H,M as me,S as A,l as Y,O as fe}from"./index.BoABrvm7.js";import{u as be,v as ye,W as xe,y as ge,X as he,Y as we,Z as _e,z as pe,A as $e,B as Ce,E as ke,F as Ae,G as Se,H as Ve,I as Be,C as je,D as Fe,_ as Pe,a as Re,g as Ee,J as Ue,i as De,K as Te,T as Ie,U as Le,V as ze}from"./SectionMain.fMhQq8Wq.js";import{_ as N,a as Me,b as Ye,c as re,B as Ne,d as Oe}from"./IconifyButton.Du8mikII.js";import{u as le}from"./annualPlan.izNH0yv2.js";import{t as We,u as qe,v as Ge,F as Xe}from"./index.DctLQwyd.js";import"./ToasterComponent.CMTvAW6n.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";const Je={class:"flex items-center gap-1 md:gap-2"},Ke=["aria-expanded"],Qe={style:{width:"18px",height:"18px"},viewBox:"0 0 24 24"},He=["d"],Ze={__name:"AnnualPlanRowActions",props:{row:{type:Object,required:!0},moderator:{type:Boolean,default:!1}},emits:["attachments","submit","approve","reject","edit","delete","view","cancel"],setup(x,{emit:v}){const _=x,C=V(()=>String(_.row?.status||"").toLowerCase()),B=V(()=>C.value==="draft"),$=V(()=>C.value==="draft"),b=V(()=>C.value!=="draft"),P=V(()=>_.moderator&&C.value==="pending"),m=V(()=>C.value==="approved"),o=S(!1),d=S(null),T=S(null),g=r=>{if(!o.value)return;const n=d.value,f=T.value;n&&!n.contains(r.target)&&f&&!f.contains(r.target)&&(o.value=!1)};return Q(()=>document.addEventListener("click",g)),ve(()=>document.removeEventListener("click",g)),(r,n)=>(i(),u("div",Je,[F(N,{"icon-path":h(be),color:"text-indigo-600",label:"Attachments",tooltip:"Attachments",size:"sm",onClick:n[0]||(n[0]=f=>r.$emit("attachments",x.row))},null,8,["icon-path"]),b.value?(i(),W(N,{key:0,"icon-path":h(ye),color:"text-gray-700",label:"View",tooltip:"View (read-only)",size:"sm",onClick:n[1]||(n[1]=f=>r.$emit("view",x.row))},null,8,["icon-path"])):y("",!0),B.value?(i(),W(N,{key:1,"icon-path":h(xe),color:"text-blue-600",label:"Submit",tooltip:"Submit",size:"sm",onClick:n[2]||(n[2]=f=>r.$emit("submit",x.row))},null,8,["icon-path"])):y("",!0),$.value?(i(),W(N,{key:2,"icon-path":h(ge),color:"text-amber-600",label:"Edit",tooltip:"Edit",size:"sm",onClick:n[3]||(n[3]=f=>r.$emit("edit",x.row))},null,8,["icon-path"])):y("",!0),P.value?(i(),W(N,{key:3,"icon-path":h(he),color:"text-emerald-600",label:"Approve",tooltip:"Approve",size:"sm",onClick:n[4]||(n[4]=f=>r.$emit("approve",x.row))},null,8,["icon-path"])):y("",!0),P.value?(i(),W(N,{key:4,"icon-path":h(we),color:"text-rose-600",label:"Reject",tooltip:"Reject",size:"sm",onClick:n[5]||(n[5]=f=>r.$emit("reject",x.row))},null,8,["icon-path"])):y("",!0),m.value?(i(),W(N,{key:5,"icon-path":h(_e),color:"text-orange-600",label:"Cancel",tooltip:"Cancel plan",size:"sm",onClick:n[6]||(n[6]=f=>r.$emit("cancel",x.row))},null,8,["icon-path"])):y("",!0),F(N,{"icon-path":h(pe),color:"text-red-600",label:"Delete",tooltip:"Delete",size:"sm",onClick:n[7]||(n[7]=f=>r.$emit("delete",x.row))},null,8,["icon-path"]),t("div",{class:"relative md:hidden",ref_key:"btnRef",ref:T},[t("button",{class:"inline-flex items-center justify-center rounded-xl p-1.5 hover:bg-gray-100","aria-expanded":o.value,"aria-haspopup":"menu",title:"More",onClick:n[8]||(n[8]=f=>o.value=!o.value)},[(i(),u("svg",Qe,[t("path",{d:h($e)},null,8,He)]))],8,Ke),o.value?(i(),u("div",{key:0,ref_key:"menuRef",ref:d,role:"menu",class:"absolute right-0 z-20 mt-1 w-44 overflow-hidden rounded-xl border bg-white shadow-lg"},[t("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[9]||(n[9]=f=>{o.value=!1,r.$emit("attachments",x.row)})},"Attachments"),b.value?(i(),u("button",{key:0,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[10]||(n[10]=f=>{o.value=!1,r.$emit("view",x.row)})},"View (read-only)")):y("",!0),B.value?(i(),u("button",{key:1,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[11]||(n[11]=f=>{o.value=!1,r.$emit("submit",x.row)})},"Submit")):y("",!0),$.value?(i(),u("button",{key:2,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[12]||(n[12]=f=>{o.value=!1,r.$emit("edit",x.row)})},"Edit")):y("",!0),P.value?(i(),u("button",{key:3,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[13]||(n[13]=f=>{o.value=!1,r.$emit("approve",x.row)})},"Approve")):y("",!0),P.value?(i(),u("button",{key:4,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-rose-600 hover:bg-rose-50",onClick:n[14]||(n[14]=f=>{o.value=!1,r.$emit("reject",x.row)})},"Reject")):y("",!0),m.value?(i(),u("button",{key:5,role:"menuitem",class:"w-full px-3 py-2 text-left text-sm hover:bg-gray-50",onClick:n[15]||(n[15]=f=>{o.value=!1,r.$emit("cancel",x.row)})},"Cancel")):y("",!0),t("button",{role:"menuitem",class:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50",onClick:n[16]||(n[16]=f=>{o.value=!1,r.$emit("delete",x.row)})},"Delete")],512)):y("",!0)],512)]))}},et={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},tt={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},at={class:"flex items-center justify-between mb-3"},lt={class:"flex items-center gap-3"},nt={class:"text-lg font-semibold"},st={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},ot={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},it={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},rt=["disabled"],dt={key:0,class:"text-[11px] text-red-600 mt-1"},ut=["disabled"],ct=["value"],mt={key:0,class:"text-[11px] text-red-600 mt-1"},pt=["disabled"],vt={class:"mt-4"},ft={class:"flex items-center justify-between"},bt=["disabled"],yt={key:0,class:"text-[12px] text-red-600 mb-1"},xt={class:"mt-1 border rounded overflow-hidden"},gt={class:"w-full text-xs"},ht={class:"p-2"},wt=["onUpdate:modelValue","disabled"],_t={class:"p-2"},$t=["onUpdate:modelValue","disabled"],Ct={class:"p-2"},kt=["onUpdate:modelValue","disabled"],At={class:"p-2"},St=["onUpdate:modelValue","disabled"],Vt={class:"p-2"},Bt=["onUpdate:modelValue","disabled"],jt={class:"p-2"},Ft=["onUpdate:modelValue","disabled"],Pt={class:"p-2 text-right"},Rt=["disabled","onClick"],Et={class:"mt-2 text-right text-sm"},Ut={class:"flex justify-end gap-2 mt-5"},ue={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(x,{emit:v}){const _=x,C=v,B=V({get:()=>_.modelValue,set:c=>C("update:modelValue",c)}),$=ce();le();const b=S([]);Q(async()=>{try{const{data:c}=await me.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});b.value=Array.isArray(c?.data)?c.data:[]}catch{b.value=[]}});const m=S(structuredClone(_.initial)),o=S({});ae(()=>_.initial,c=>{let s=c?.plans;try{s=Array.isArray(s)?s:JSON.parse(s||"[]")}catch{s=[]}m.value={...c,filed_by_user_id:c?.filed_by_user_id||$.user?.id||"",plans:Array.isArray(s)?s:[]},o.value={}},{immediate:!0});const d=V(()=>_.mode==="edit"&&String(m.value.status||"").toLowerCase()!=="draft"),T=V(()=>_.mode!=="edit"?"New Annual Plan":d.value?"View Annual Plan (read-only)":"Edit Annual Plan"),g=V(()=>_.mode==="edit"?"Save Changes":"Create"),r=c=>Number(c||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),n=c=>Number.isFinite(+c)?+c:0,f=V(()=>Array.isArray(m.value.plans)?m.value.plans.reduce((c,s)=>c+n(s?.funds),0):0),z=()=>{Array.isArray(m.value.plans)||(m.value.plans=[]),m.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},E=c=>{m.value.plans.splice(c,1)},U=/^\d{4}-\d{4}$/,I=()=>{if(d.value)return!1;const c={};return(!m.value.school_year||!U.test(m.value.school_year))&&(c.school_year="Format: YYYY-YYYY"),m.value.club_id||(c.club_id="Required"),(!Array.isArray(m.value.plans)||!m.value.plans.length)&&(c.plans="Add at least one plan item"(m.value.plans||[]).forEach((s,p)=>{s.item||(c[`plans_${p}_item`]="Required"),s.date_of_implementation||(c[`plans_${p}_date`]="Required"),s.funds!=null&&Number(s.funds)<0&&(c[`plans_${p}_funds`]="Must be ≥ 0")})),o.value=c,Object.keys(c).length===0},O=()=>{if(d.value||!I())return;const c={...m.value};!c.filed_by_user_id&&$.user?.id&&(c.filed_by_user_id=$.user.id),C("submit",c)};return(c,s)=>B.value?(i(),u("div",et,[t("div",tt,[t("div",at,[t("div",lt,[t("h2",nt,w(T.value),1),t("span",st,w(m.value.status),1)]),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:s[0]||(s[0]=p=>B.value=!1)},"Close")]),d.value?(i(),u("div",ot,[s[5]||(s[5]=D(" This plan is ",-1)),t("strong",null,w(m.value.status),1),s[6]||(s[6]=D(". Editing is disabled. ",-1))])):y("",!0),t("div",it,[t("div",null,[s[7]||(s[7]=t("label",{class:"block mb-1"},[D("School Year "),t("span",{class:"text-red-500"},"*")],-1)),R(t("input",{"onUpdate:modelValue":s[1]||(s[1]=p=>m.value.school_year=p),placeholder:"e.g. 2025-2026",class:q(["w-full border rounded px-2.5 py-2",o.value.school_year?"border-red-500":""]),disabled:d.value},null,10,rt),[[L,m.value.school_year]]),o.value.school_year?(i(),u("p",dt,w(o.value.school_year),1)):y("",!0)]),t("div",null,[s[9]||(s[9]=t("label",{class:"block mb-1"},[D("Club "),t("span",{class:"text-red-500"},"*")],-1)),R(t("select",{"onUpdate:modelValue":s[2]||(s[2]=p=>m.value.club_id=p),class:q(["w-full border rounded px-2.5 py-2",o.value.club_id?"border-red-500":""]),disabled:d.value||!b.value.length},[s[8]||(s[8]=t("option",{value:""},"Select club…",-1)),(i(!0),u(X,null,H(b.value,p=>(i(),u("option",{key:p.id,value:p.id},w(p.name)+" ("+w(p.code)+") ",9,ct))),128))],10,ut),[[de,m.value.club_id]]),o.value.club_id?(i(),u("p",mt,w(o.value.club_id),1)):y("",!0)]),t("div",null,[s[10]||(s[10]=t("label",{class:"block mb-1"},"Remarks",-1)),R(t("input",{"onUpdate:modelValue":s[3]||(s[3]=p=>m.value.remarks=p),class:"w-full border rounded px-2.5 py-2",disabled:d.value},null,8,pt),[[L,m.value.remarks]])])]),t("div",vt,[t("div",ft,[s[11]||(s[11]=t("label",{class:"block mb-1 font-medium"},[D("Plan Items "),t("span",{class:"text-red-500"},"*")],-1)),t("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:d.value,onClick:z},"Add Item",8,bt)]),o.value.plans?(i(),u("p",yt,w(o.value.plans),1)):y("",!0),t("div",xt,[t("table",gt,[s[12]||(s[12]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"text-left p-2"},"Item"),t("th",{class:"text-left p-2"},"Description"),t("th",{class:"text-left p-2"},"Date of Implementation"),t("th",{class:"text-left p-2"},"Funds"),t("th",{class:"text-left p-2"},"Venue"),t("th",{class:"text-left p-2"},"Notes"),t("th",{class:"p-2 w-16"})])],-1)),t("tbody",null,[(i(!0),u(X,null,H(m.value.plans,(p,M)=>(i(),u("tr",{key:M,class:"border-t"},[t("td",ht,[R(t("input",{"onUpdate:modelValue":j=>p.item=j,class:q(["w-40 border rounded px-2 py-1",o.value[`plans_${M}_item`]?"border-red-500":""]),disabled:d.value},null,10,wt),[[L,p.item]])]),t("td",_t,[R(t("input",{"onUpdate:modelValue":j=>p.description=j,class:"w-60 border rounded px-2 py-1",disabled:d.value},null,8,$t),[[L,p.description]])]),t("td",Ct,[R(t("input",{type:"date","onUpdate:modelValue":j=>p.date_of_implementation=j,class:q(["border rounded px-2 py-1",o.value[`plans_${M}_date`]?"border-red-500":""]),disabled:d.value},null,10,kt),[[L,p.date_of_implementation]])]),t("td",At,[R(t("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":j=>p.funds=j,class:q(["w-28 border rounded px-2 py-1",o.value[`plans_${M}_funds`]?"border-red-500":""]),disabled:d.value},null,10,St),[[L,p.funds,void 0,{number:!0}]])]),t("td",Vt,[R(t("input",{"onUpdate:modelValue":j=>p.venue=j,class:"w-40 border rounded px-2 py-1",disabled:d.value},null,8,Bt),[[L,p.venue]])]),t("td",jt,[R(t("input",{"onUpdate:modelValue":j=>p.notes=j,class:"w-52 border rounded px-2 py-1",disabled:d.value},null,8,Ft),[[L,p.notes]])]),t("td",Pt,[t("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:d.value,onClick:j=>E(M)},"Remove",8,Rt)])]))),128))])])]),t("div",Et,[s[13]||(s[13]=t("span",{class:"mr-4"},"Client total (preview):",-1)),t("strong",null,w(r(f.value)),1),s[14]||(s[14]=t("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),t("div",Ut,[t("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:s[4]||(s[4]=p=>B.value=!1)},"Close"),d.value?y("",!0):(i(),u("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:O},w(g.value),1))])])])):y("",!0)}},Dt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},Tt={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},It={class:"flex items-center justify-between mb-3"},Lt={class:"text-lg font-semibold"},zt={class:"text-gray-600"},Mt={class:"flex items-center justify-between gap-2"},Yt={class:"text-sm text-gray-600"},Nt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Ot=["d"],Wt=["disabled"],qt={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},Gt={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},Xt=["src"],Jt={key:1,class:"flex items-center justify-center w-full h-full"},Kt=["d"],Qt={class:"mt-2 text-xs"},Ht=["title"],Zt={class:"text-gray-500 flex items-center justify-between"},ea={key:0},ta={key:0},aa={class:"mt-2 flex items-center justify-between gap-2"},la=["onClick","title"],na={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},sa=["d"],oa=["onClick"],ia={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},ra=["d"],da={key:0,class:"mt-6 text-center text-sm text-gray-500"},ua=10*1024*1024,ca={__name:"AnnualPlanAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(x,{emit:v}){const _=x,C=v,B=V({get:()=>_.modelValue,set:e=>C("update:modelValue",e)}),$=le(),b=S(null),P=S(!1),m=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),o=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),d=(e="")=>String(e).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",T=(e="")=>typeof e=="string"&&e.match(/^data:([^;]+);base64,/i)?.[1]||"",g=e=>e?.type&&m.has(e.type)||e?.name&&o.has(d(e.name)),r=(e="")=>String(e).startsWith("image/"),n=(e="")=>e==="application/pdf",f=(e="")=>e==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",z=(e="")=>e==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",E=(e="")=>n(e)?ke:f(e)?Ae:z(e)?Se:r(e)?Ve:Be,U=(e="")=>n(e)?"PDF":f(e)?"Word":z(e)?"Excel":r(e)?"Image":"File",I=(e="")=>n(e)?"pdf":f(e)?"docx":z(e)?"xlsx":e==="image/png"?"png":e==="image/jpeg"?"jpg":e==="image/webp"?"webp":"",O=(e="attachment",a="")=>/\.[a-z0-9]+$/i.test(e)?e:a?`${e}.${a.startsWith(".")?a.slice(1):a}`:e,c=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`,s=V(()=>{const e=b.value?.attachments;if(!e)return[];try{return Array.isArray(e)?e:JSON.parse(e||"[]")}catch{return[]}}),p=V(()=>(s.value||[]).map((e,a)=>{const l=e.mime||T(e.data)||"",k=d(e.name||"")||I(l),J=e.size??null,K=e.name||`${U(l)} ${a+1}`;return{id:e.id??a+1,name:K,data:e.data||"",url:e.url||e.href||e.path||"",mime:l,ext:k,size:J,filename:O(K,k)}}));ae(()=>_.modelValue,async e=>{e&&_.row?.id&&(await $.fetchById(_.row.id),b.value=$.selected||_.row)});const M=async e=>{const a=e.target.files?.[0];if(e.target.value="",!(!a||!b.value?.id)){if(a.size>ua){await A.fire("File too large","Maximum size is 10 MB.","warning");return}if(!g(a)){await A.fire("Unsupported file","Only images, PDF, DOCX, XLSX allowed.","warning");return}try{P.value=!0,await $.uploadAttachment(b.value.id,a),await $.fetchById(b.value.id),b.value=$.selected}finally{P.value=!1}}},j=async e=>{!b.value?.id||!(await A.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await $.deleteAttachment(b.value.id,e),await $.fetchById(b.value.id),b.value=$.selected)},ne=e=>{if(e.data&&String(e.data).startsWith("data:")&&r(e.mime)){const a=window.open();a&&a.document.write(`<img src="${e.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}e.url&&window.open(String(e.url),"_blank")},se=e=>{const[a,l]=e.split(","),k=a.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",J=atob(l),K=new Uint8Array(J.length);for(let te=0;te<J.length;te++)K[te]=J.charCodeAt(te);return new Blob([K],{type:k})},Z=(e,a)=>{const l=URL.createObjectURL(e),k=document.createElement("a");k.href=l,k.download=a||"download",document.body.appendChild(k),k.click(),k.remove(),setTimeout(()=>URL.revokeObjectURL(l),1e3)},oe=async e=>{if(e.data&&String(e.data).startsWith("data:")){Z(se(e.data),e.filename);return}if(e.url)try{const l=await(await fetch(e.url,{credentials:"include"})).blob();Z(l,e.filename)}catch{const a=document.createElement("a");a.href=String(e.url),a.setAttribute("download",e.filename),document.body.appendChild(a),a.click(),a.remove()}},G=e=>r(e.mime)?"Open":"Download",ee=e=>r(e.mime)?je:Fe,ie=e=>r(e.mime)?ne(e):oe(e);return(e,a)=>B.value?(i(),u("div",Dt,[t("div",Tt,[t("div",It,[t("h2",Lt,[a[1]||(a[1]=D(" Annual Plan Attachments — ",-1)),t("span",zt,w(b.value?.reference_code||""),1)]),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:a[0]||(a[0]=l=>B.value=!1)},"Close")]),t("div",Mt,[t("div",Yt,[a[2]||(a[2]=D(" School Year: ",-1)),t("strong",null,w(b.value?.school_year||"—"),1)]),t("label",{class:q(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":P.value}])},[(i(),u("svg",Nt,[t("path",{d:h(Ce)},null,8,Ot)])),t("span",null,w(P.value?"Uploading…":"Upload"),1),t("input",{type:"file",class:"hidden",disabled:P.value,onChange:M,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,Wt)],2)]),t("div",qt,[(i(!0),u(X,null,H(p.value,l=>(i(),u("div",{key:l.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[t("div",Gt,[l.data&&l.data.startsWith("data:")&&l.mime?.startsWith("image/")?(i(),u("img",{key:0,src:l.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,Xt)):(i(),u("div",Jt,[(i(),u("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:q({"text-red-600":l.mime==="application/pdf","text-blue-600":l.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":l.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!l.mime||!l.mime.startsWith("image/")&&l.mime!=="application/pdf"})},[t("path",{d:E(l.mime)},null,8,Kt)],2))]))]),t("div",Qt,[t("div",{class:"font-medium truncate",title:l.name},w(l.name),9,Ht),t("div",Zt,[t("span",null,[D(w(U(l.mime))+" ",1),l.ext?(i(),u("span",ea,"("+w(l.ext.toUpperCase())+")",1)):y("",!0)]),l.size?(i(),u("span",ta,w(c(l.size)),1)):y("",!0)])]),t("div",aa,[t("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:k=>ie(l),title:G(l)},[(i(),u("svg",na,[t("path",{d:ee(l)},null,8,sa)])),D(" "+w(G(l)),1)],8,la),t("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:k=>j(l.id),title:"Remove"},[(i(),u("svg",ia,[t("path",{d:h(pe)},null,8,ra)])),a[3]||(a[3]=D(" Remove ",-1))],8,oa)])]))),128))]),p.value.length?y("",!0):(i(),u("div",da," No attachments yet. "))])])):y("",!0)}},ma={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},pa={class:"bg-white rounded-2xl shadow-2xl w-[1200px] max-w-[95vw] max-h-[90vh] overflow-hidden"},va={class:"px-4 py-3 border-b flex items-center justify-between"},fa={class:"p-3 overflow-auto"},ba={__name:"AnnualPlansCalendarModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(x,{emit:v}){const _=x,C=v,B=V({get:()=>_.modelValue,set:g=>C("update:modelValue",g)}),$=le(),b=S([]),P=g=>{if(Array.isArray(g))return g;try{return JSON.parse(g||"[]")}catch{return[]}},m=(g=[])=>{const r=[];g.forEach(n=>{const f=P(n.plans),z=n.club?.name?`[${n.club.name}] `:"";f.forEach((E,U)=>{const I=E?.date_of_implementation;if(!I)return;const O=`${z}${E.item||"Planned Activity"}`;r.push({id:`${n.id}-${U}`,title:O,start:`${I}T00:00:00`,end:`${I}T23:59:59`,backgroundColor:"#10b981",borderColor:"#0ea5e9",textColor:"#0b1b13",extendedProps:{annual_plan_id:n.id,reference_code:n.reference_code,school_year:n.school_year,funds:E?.funds??0,status:n.status}})})}),b.value=r},o=async()=>{await $.fetchAll({page:1,limit:500,status:"approved",sort:"created_at",order:"ASC"},!0),m($.items.data||[])},d=g=>{const r=g?.event?.extendedProps?.annual_plan_id;r&&C("open",Number(r))},T=V(()=>({plugins:[We,qe,Ge],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:d,events:b.value}));return ae(()=>_.modelValue,g=>{g&&o()}),ae(()=>$.items.data,g=>{B.value&&m(g||[])},{deep:!0}),Q(()=>{B.value&&o()}),(g,r)=>B.value?(i(),u("div",ma,[t("div",pa,[t("div",va,[r[1]||(r[1]=t("h2",{class:"text-base font-semibold"},"Annual Plans Calendar (Approved)",-1)),t("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:r[0]||(r[0]=n=>B.value=!1)},"Close")]),t("div",fa,[F(h(Xe),{options:T.value},null,8,["options"])]),r[2]||(r[2]=t("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click a plan item to open its Annual Plan. ",-1))])])):y("",!0)}},ya={class:"flex items-center gap-2"},xa={class:"p-3 mb-4 rounded-xl border bg-white/60"},ga={class:"flex items-center gap-2 mb-2 text-gray-700"},ha={class:"w-4 h-4",viewBox:"0 0 24 24"},wa=["d"],_a={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},$a={class:"md:col-span-2 flex"},Ca={class:"w-5 h-5",viewBox:"0 0 24 24"},ka=["d"],Aa=["value"],Sa=["value"],Va={class:"flex items-center gap-2 md:col-span-2"},Ba={class:"font-medium"},Ta={__name:"AnnualPlansPage",setup(x){const v=le(),_=ce(),C=S(!1),B=()=>{C.value=!0},$=async e=>{try{await v.fetchById(e);const a=v.selected;a&&await s(a)}catch(a){console.error(a)}finally{C.value=!1}},b=S([]);Q(async()=>{try{const{data:e}=await me.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});b.value=Array.isArray(e?.data)?e.data:[]}catch{b.value=[]}});const m=e=>b.value.find(a=>a.id===Number(e))?.name||"—",o=S({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:""}),d=async(e={},a=!0)=>{o.value={...o.value,...e};const l={...o.value};["q","status","school_year","club_id","filed_by_user_id","approver_user_id"].forEach(k=>{(l[k]===""||l[k]==null)&&delete l[k]}),await v.fetchAll(l,a)};Q(async()=>{await d({page:1,limit:10})});const T=V(()=>({total:v.items.total||0,totalPages:v.items.totalPages||1,currentPage:v.items.currentPage||1,pageSize:v.items.pageSize||10,data:v.items.data||[]})),g=["draft","pending","approved","rejected","cancelled","archived"],r=e=>{switch(String(e||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"archived":return"slate";default:return"gray"}},n=e=>{const a=Number(e);return Number.isFinite(a)?a.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},f=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"school_year",label:"School Year",sortable:!0,width:120},{key:"club",label:"Club",sortable:!1,minWidth:200,formatter:(e,a)=>a.club?.name||m(a.club_id)||""},{key:"total_budget",label:"Total Budget",sortable:!0,width:140},{key:"status",label:"Status",sortable:!0,width:110},{key:"created_at",label:"Created",sortable:!0,width:170}],z=async e=>{await d(e)},E=S(!1),U=S(!1),I=S(null),O=()=>{E.value=!0},c=async e=>{await v.create(e),E.value=!1,await d({},!0)},s=async e=>{await v.fetchById(e.id);const a=v.selected||e;let l=[];try{l=Array.isArray(a.plans)?a.plans:JSON.parse(a.plans||"[]")}catch{}I.value={id:a.id,reference_code:a.reference_code,school_year:a.school_year||"",club_id:a.club_id||"",filed_by_user_id:a.filed_by_user_id||_.user?.id||"",approver_user_id:a.approver_user_id||"",plans:l,remarks:a.remarks||"",status:a.status||"draft"},U.value=!0},p=async e=>{const{id:a,...l}=e;await v.updateById(a,l),U.value=!1,await d({},!0)},M=async e=>{if(!e?.id)return;(await A.fire({title:`Delete annual plan "${e.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await v.deleteById(e.id),await d({},!0),await A.fire("Deleted","The annual plan has been deleted.","success"))},j=async e=>{await s(e)},ne=async e=>{if((await A.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel"})).isConfirmed)try{await v.submit(e.id),await d({},!0),await A.fire("Submitted","Annual plan is now pending approval.","success")}catch{await A.fire("Error",v.error||"Failed to submit.","error")}},se=async e=>{const a=await A.fire({title:"Approve annual plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel"});if(a.isConfirmed)try{await v.approve(e.id,a.value||""),await d({},!0),await A.fire("Approved","Annual plan has been approved.","success")}catch{await A.fire("Error",v.error||"Failed to approve.","error")}},Z=async e=>{const a=await A.fire({title:"Reject annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:l=>l?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel"});if(a.isConfirmed)try{await v.reject(e.id,a.value),await d({},!0),await A.fire("Rejected","Annual plan has been rejected.","success")}catch{await A.fire("Error",v.error||"Failed to reject.","error")}},oe=async e=>{const a=await A.fire({title:"Cancel annual plan?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:l=>l?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Plan",cancelButtonText:"Keep"});if(a.isConfirmed)try{await v.cancel(e.id,a.value),await d({},!0),await A.fire("Cancelled","Annual plan has been cancelled.","success")}catch{await A.fire("Error",v.error||"Failed to cancel.","error")}},G=S(!1),ee=S(null),ie=async e=>{await v.fetchById(e.id),ee.value=v.selected||e,G.value=!0};return(e,a)=>(i(),u(X,null,[F(Pe,null,{default:Y(()=>[F(Re,null,{default:Y(()=>[h(v).error?(i(),W(Me,{key:0,icon:h(Ee),color:"danger"},{default:Y(()=>[D(w(h(v).error),1)]),_:1},8,["icon"])):y("",!0),F(Ye,{icon:h(Ue),title:"Annual Plans",main:""},{default:Y(()=>[t("div",ya,[F(re,{icon:h(De),color:"info",label:"View Calendar",onClick:B},null,8,["icon"]),F(re,{icon:h(Te),color:"primary",label:"New Annual Plan",onClick:O},null,8,["icon"]),F(re,{icon:h(Ie),color:"info",label:"Refresh",onClick:a[0]||(a[0]=l=>d({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),t("div",xa,[t("div",ga,[(i(),u("svg",ha,[t("path",{d:h(Le)},null,8,wa)])),a[13]||(a[13]=t("span",{class:"font-medium text-sm"},"Filters",-1))]),t("div",_a,[t("div",$a,[R(t("input",{"onUpdate:modelValue":a[1]||(a[1]=l=>o.value.q=l),placeholder:"Search by ref, school year, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:a[2]||(a[2]=fe(l=>d({page:1}),["enter"]))},null,544),[[L,o.value.q]]),t("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:a[3]||(a[3]=l=>d({page:1}))},[(i(),u("svg",Ca,[t("path",{d:h(ze)},null,8,ka)]))])]),R(t("select",{"onUpdate:modelValue":a[4]||(a[4]=l=>o.value.status=l),class:"border rounded px-2 py-2"},[a[14]||(a[14]=t("option",{value:""},"All status",-1)),(i(),u(X,null,H(g,l=>t("option",{key:l,value:l},w(l),9,Aa)),64))],512),[[de,o.value.status]]),R(t("input",{"onUpdate:modelValue":a[5]||(a[5]=l=>o.value.school_year=l),placeholder:"School Year (YYYY-YYYY)",class:"border rounded px-2 py-2"},null,512),[[L,o.value.school_year]]),R(t("select",{"onUpdate:modelValue":a[6]||(a[6]=l=>o.value.club_id=l),class:"border rounded px-2 py-2"},[a[15]||(a[15]=t("option",{value:""},"Any club",-1)),(i(!0),u(X,null,H(b.value,l=>(i(),u("option",{key:l.id,value:l.id},w(l.name),9,Sa))),128))],512),[[de,o.value.club_id]]),t("div",Va,[t("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:a[7]||(a[7]=l=>d({page:1}))}," Apply Filters "),t("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:a[8]||(a[8]=()=>{o.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",school_year:"",club_id:""},d({page:1},!0)})},"Reset")])])]),F(Ne,{columns:f,data:T.value,loading:h(v).isLoading,onQueryChange:z},{"cell-total_budget":Y(({value:l})=>[t("span",Ba,w(n(l)),1)]),"cell-created_at":Y(({value:l})=>[t("span",null,w(l?new Date(l).toLocaleString():"—"),1)]),"cell-status":Y(({value:l})=>[F(Oe,{text:l||"—",tone:r(l)},null,8,["text","tone"])]),"cell-actions":Y(({row:l})=>[F(Ze,{row:l,moderator:["admin","manager"].includes(String(h(_).user?.role||"").toLowerCase()),onAttachments:ie,onSubmit:ne,onApprove:se,onReject:Z,onEdit:s,onDelete:M,onView:k=>j(l),onCancel:oe},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),F(ue,{modelValue:E.value,"onUpdate:modelValue":a[9]||(a[9]=l=>E.value=l),mode:"create",onSubmit:c},null,8,["modelValue"]),F(ue,{modelValue:U.value,"onUpdate:modelValue":a[10]||(a[10]=l=>U.value=l),mode:"edit",initial:I.value||{},onSubmit:p},null,8,["modelValue","initial"]),F(ca,{modelValue:G.value,"onUpdate:modelValue":a[11]||(a[11]=l=>G.value=l),row:ee.value},null,8,["modelValue","row"]),F(ba,{modelValue:C.value,"onUpdate:modelValue":a[12]||(a[12]=l=>C.value=l),onOpen:$},null,8,["modelValue"])],64))}};export{Ta as default};
