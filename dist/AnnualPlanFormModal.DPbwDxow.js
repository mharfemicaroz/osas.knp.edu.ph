import{c as b,u as I,r as k,o as O,x as q,a as u,d as _,q as r,e,t as i,k as y,h as p,C,F as w,B as V,j as f,v as c,M as E}from"./index.BnmwlPkf.js";import{u as L}from"./annualPlan.CdGgE31k.js";const z={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},J={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},G={class:"flex items-center justify-between mb-3"},H={class:"flex items-center gap-3"},K={class:"text-lg font-semibold"},Q={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},W={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},X={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},Z=["disabled"],ee=["value"],te={key:0,class:"text-[11px] text-red-600 mt-1"},se=["disabled"],le=["value"],ae={key:0,class:"text-[11px] text-red-600 mt-1"},oe=["disabled"],de={class:"mt-4"},ne={class:"flex items-center justify-between"},ue=["disabled"],re={key:0,class:"text-[12px] text-red-600 mb-1"},ie={class:"mt-1 border rounded overflow-hidden"},pe={class:"w-full text-xs"},ce={class:"p-2"},me=["onUpdate:modelValue","disabled"],be={class:"p-2"},_e=["onUpdate:modelValue","disabled"],ve={class:"p-2"},ye=["onUpdate:modelValue","disabled"],xe={class:"p-2"},fe=["onUpdate:modelValue","disabled"],he={class:"p-2"},ge=["onUpdate:modelValue","disabled"],ke={class:"p-2"},we=["onUpdate:modelValue","disabled"],Ve={class:"p-2 text-right"},Ae=["disabled","onClick"],Ce={class:"mt-2 text-right text-sm"},Se={class:"flex justify-end gap-2 mt-5"},Fe={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(S,{emit:U}){const m=S,A=U,h=b({get:()=>m.modelValue,set:l=>A("update:modelValue",l)}),g=I();L();const Y=b(()=>{const l=new Date().getFullYear();return Array.from({length:6},(t,s)=>`${l-s}-${l-s+1}`)}),x=k([]);O(async()=>{try{const{data:l}=await E.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});x.value=Array.isArray(l?.data)?l.data:[]}catch{x.value=[]}});const a=k(structuredClone(m.initial)),d=k({});q(()=>m.initial,l=>{let t=l?.plans;try{t=Array.isArray(t)?t:JSON.parse(t||"[]")}catch{t=[]}a.value={...l,filed_by_user_id:l?.filed_by_user_id||g.user?.id||"",plans:Array.isArray(t)?t:[]},d.value={}},{immediate:!0});const o=b(()=>m.mode==="edit"&&String(a.value.status||"").toLowerCase()!=="draft"),$=b(()=>m.mode!=="edit"?"New Annual Plan":o.value?"View Annual Plan (read-only)":"Edit Annual Plan"),F=b(()=>m.mode==="edit"?"Save Changes":"Create"),N=l=>Number(l||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),P=l=>Number.isFinite(+l)?+l:0,R=b(()=>Array.isArray(a.value.plans)?a.value.plans.reduce((l,t)=>l+P(t?.funds),0):0),j=()=>{Array.isArray(a.value.plans)||(a.value.plans=[]),a.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},D=l=>{a.value.plans.splice(l,1)},M=/^\d{4}-\d{4}$/,T=()=>{if(o.value)return!1;const l={};return(!a.value.school_year||!M.test(a.value.school_year))&&(l.school_year="Format: YYYY-YYYY"),a.value.club_id||(l.club_id="Required"),(!Array.isArray(a.value.plans)||!a.value.plans.length)&&(l.plans="Add at least one plan item"(a.value.plans||[]).forEach((t,s)=>{t.item||(l[`plans_${s}_item`]="Required"),t.date_of_implementation||(l[`plans_${s}_date`]="Required"),t.funds!=null&&Number(t.funds)<0&&(l[`plans_${s}_funds`]="Must be ≥ 0")})),d.value=l,Object.keys(l).length===0},B=()=>{if(o.value||!T())return;const l={...a.value};!l.filed_by_user_id&&g.user?.id&&(l.filed_by_user_id=g.user.id),A("submit",l)};return(l,t)=>h.value?(r(),u("div",z,[e("div",J,[e("div",G,[e("div",H,[e("h2",K,i($.value),1),e("span",Q,i(a.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:t[0]||(t[0]=s=>h.value=!1)},"Close")]),o.value?(r(),u("div",W,[t[5]||(t[5]=y(" This plan is ",-1)),e("strong",null,i(a.value.status),1),t[6]||(t[6]=y(". Editing is disabled. ",-1))])):_("",!0),e("div",X,[e("div",null,[t[8]||(t[8]=e("label",{class:"block mb-1"},[y("School Year "),e("span",{class:"text-red-500"},"*")],-1)),p(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>a.value.school_year=s),class:"w-full border rounded px-2.5 py-2",disabled:o.value},[t[7]||(t[7]=e("option",{value:""},"Select school year…",-1)),(r(!0),u(w,null,V(Y.value,s=>(r(),u("option",{key:s,value:s},i(s),9,ee))),128))],8,Z),[[C,a.value.school_year]]),d.value.school_year?(r(),u("p",te,i(d.value.school_year),1)):_("",!0)]),e("div",null,[t[10]||(t[10]=e("label",{class:"block mb-1"},[y("Club "),e("span",{class:"text-red-500"},"*")],-1)),p(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>a.value.club_id=s),class:f(["w-full border rounded px-2.5 py-2",d.value.club_id?"border-red-500":""]),disabled:o.value||!x.value.length},[t[9]||(t[9]=e("option",{value:""},"Select club…",-1)),(r(!0),u(w,null,V(x.value,s=>(r(),u("option",{key:s.id,value:s.id},i(s.name)+" ("+i(s.code)+") ",9,le))),128))],10,se),[[C,a.value.club_id]]),d.value.club_id?(r(),u("p",ae,i(d.value.club_id),1)):_("",!0)]),e("div",null,[t[11]||(t[11]=e("label",{class:"block mb-1"},"Remarks",-1)),p(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>a.value.remarks=s),class:"w-full border rounded px-2.5 py-2",disabled:o.value},null,8,oe),[[c,a.value.remarks]])])]),e("div",de,[e("div",ne,[t[12]||(t[12]=e("label",{class:"block mb-1 font-medium"},[y("Plan Items "),e("span",{class:"text-red-500"},"*")],-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:o.value,onClick:j},"Add Item",8,ue)]),d.value.plans?(r(),u("p",re,i(d.value.plans),1)):_("",!0),e("div",ie,[e("table",pe,[t[13]||(t[13]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Description"),e("th",{class:"text-left p-2"},"Date of Implementation"),e("th",{class:"text-left p-2"},"Funds"),e("th",{class:"text-left p-2"},"Venue"),e("th",{class:"text-left p-2"},"Notes"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(r(!0),u(w,null,V(a.value.plans,(s,v)=>(r(),u("tr",{key:v,class:"border-t"},[e("td",ce,[p(e("input",{"onUpdate:modelValue":n=>s.item=n,class:f(["w-40 border rounded px-2 py-1",d.value[`plans_${v}_item`]?"border-red-500":""]),disabled:o.value},null,10,me),[[c,s.item]])]),e("td",be,[p(e("input",{"onUpdate:modelValue":n=>s.description=n,class:"w-60 border rounded px-2 py-1",disabled:o.value},null,8,_e),[[c,s.description]])]),e("td",ve,[p(e("input",{type:"date","onUpdate:modelValue":n=>s.date_of_implementation=n,class:f(["border rounded px-2 py-1",d.value[`plans_${v}_date`]?"border-red-500":""]),disabled:o.value},null,10,ye),[[c,s.date_of_implementation]])]),e("td",xe,[p(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":n=>s.funds=n,class:f(["w-28 border rounded px-2 py-1",d.value[`plans_${v}_funds`]?"border-red-500":""]),disabled:o.value},null,10,fe),[[c,s.funds,void 0,{number:!0}]])]),e("td",he,[p(e("input",{"onUpdate:modelValue":n=>s.venue=n,class:"w-40 border rounded px-2 py-1",disabled:o.value},null,8,ge),[[c,s.venue]])]),e("td",ke,[p(e("input",{"onUpdate:modelValue":n=>s.notes=n,class:"w-52 border rounded px-2 py-1",disabled:o.value},null,8,we),[[c,s.notes]])]),e("td",Ve,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:o.value,onClick:n=>D(v)},"Remove",8,Ae)])]))),128))])])]),e("div",Ce,[t[14]||(t[14]=e("span",{class:"mr-4"},"Client total (preview):",-1)),e("strong",null,i(N(R.value)),1),t[15]||(t[15]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),e("div",Se,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[4]||(t[4]=s=>h.value=!1)},"Close"),o.value?_("",!0):(r(),u("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:B},i(F.value),1))])])])):_("",!0)}};export{Fe as _};
