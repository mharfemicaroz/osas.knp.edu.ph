import{c as f,r as k,o as N,E as C,a as o,q as d,d as v,e as s,t as m,F as I,B as R,h as $,v as j,j as M,n as T,u as E,f as D}from"./index.Dmn8qN4r.js";const L={class:"border rounded-lg bg-white"},z={key:0,class:"flex items-center justify-between px-2 py-1 border-b bg-gray-50 text-[11px] text-gray-600"},F={class:"w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-600"},O={class:"flex-1 min-w-0"},P={class:"flex items-center justify-between text-[11px] text-gray-500"},q={class:"truncate"},H={class:"text-sm text-gray-800 break-words flex items-center gap-2"},G={class:"inline-block"},J={key:0,class:"inline-block text-[10px] px-1.5 py-0.5 rounded bg-rose-100 text-rose-700"},K={key:0,class:"p-3 text-sm text-gray-500"},Q={key:1,class:"p-2 border-t bg-gray-50"},W={class:"flex items-start gap-2"},X=["placeholder"],Y=["disabled"],Z={__name:"StatusTrail",props:{modelValue:{type:Array,default:()=>[]},canAdd:{type:Boolean,default:!1},addPlaceholder:{type:String,default:"Add a note…"},dense:{type:Boolean,default:!1},currentUserId:{type:[String,Number],default:null}},emits:["update:modelValue","add","markAllRead"],setup(r,{emit:b}){const n=r,u=b,i=f(()=>Array.isArray(n.modelValue)?n.modelValue:[]),g=t=>{if(!t||typeof t!="object")return t;const e={...t};return Array.isArray(e.read_by)||(e.read_by=e.user_id!=null?[e.user_id]:[]),e},_=f(()=>n.currentUserId==null?null:Number(n.currentUserId)),p=t=>{if(!t)return!1;const e=g(t),a=_.value;return a==null||Number(e.user_id??null)===a?!1:!(Array.isArray(e.read_by)?e.read_by.map(U=>Number(U)):[]).includes(a)},l=k(""),c=f(()=>n.canAdd&&l.value.trim().length>0),S=async()=>{if(!c.value)return;const t={message:l.value.trim(),datetime:new Date().toISOString()};u("add",t),l.value="",await T();const e=document.getElementById("status-trail-scroll");e&&(e.scrollTop=e.scrollHeight)},V=t=>{try{return new Date(t).toLocaleString()}catch{return t}},B=(t="")=>{const e=String(t).trim().split(/[\s,]+/).filter(Boolean);if(!e.length)return"—";const a=e[0],x=(e[1]||"").slice(0,1);return`${(a[0]||"").toUpperCase()}${(x||"").toUpperCase()}`},h=f(()=>(i.value||[]).filter(t=>p(t)).length),A=k(!1),y=k(null),w=()=>{A.value||h.value>0&&(A.value=!0,u("markAllRead"))};return N(()=>{y.value&&y.value.addEventListener("scroll",w,{passive:!0})}),C(()=>{y.value&&y.value.removeEventListener("scroll",w)}),(t,e)=>(d(),o("div",L,[h.value>0?(d(),o("div",z,[s("span",null,m(h.value)+" new",1),s("button",{class:"px-2 py-0.5 rounded bg-emerald-600 text-white",onClick:e[0]||(e[0]=a=>u("markAllRead"))},"Mark all read")])):v("",!0),s("div",{id:"status-trail-scroll",ref_key:"scrollRef",ref:y,class:"max-h-60 overflow-y-auto divide-y"},[(d(!0),o(I,null,R(i.value,(a,x)=>(d(),o("div",{key:x,class:"flex items-start gap-2 p-2"},[s("div",F,m(B(a.user_name)),1),s("div",O,[s("div",P,[s("span",q,m(a.user_name||"System"),1),s("span",null,m(V(a.datetime)),1)]),s("div",H,[s("span",G,m(a.message||""),1),p(a)?(d(),o("span",J,"[new]")):v("",!0)])])]))),128)),i.value.length?v("",!0):(d(),o("div",K,"No remarks yet."))],512),r.canAdd?(d(),o("div",Q,[s("div",W,[$(s("textarea",{"onUpdate:modelValue":e[1]||(e[1]=a=>l.value=a),rows:"2",placeholder:r.addPlaceholder,class:"flex-1 border rounded px-2 py-1.5 text-sm"},null,8,X),[[j,l.value]]),s("button",{class:M(["px-3 py-1.5 text-xs rounded text-white",c.value?"bg-blue-600":"bg-blue-300 cursor-not-allowed"]),disabled:!c.value,onClick:S},"Add",10,Y)])])):v("",!0)]))}},ee={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},te={class:"bg-white w-[560px] max-w-[95vw] rounded-xl shadow-lg p-3"},se={class:"flex items-center justify-between mb-2"},ae={class:"text-base font-semibold"},re={__name:"StatusTrailModal",props:{modelValue:{type:Boolean,default:!1},title:{type:String,default:"Remarks / Audit Trail"},items:{type:Array,default:()=>[]},canAdd:{type:Boolean,default:!0},currentUserId:{type:[String,Number],default:null}},emits:["update:modelValue","add","markAllRead"],setup(r,{emit:b}){const n=r,u=b,i=f({get:()=>n.modelValue,set:p=>u("update:modelValue",p)}),g=E(),_=f(()=>n.currentUserId??g.user?.id??null);return(p,l)=>i.value?(d(),o("div",ee,[s("div",te,[s("div",se,[s("h3",ae,m(r.title),1),s("button",{class:"px-2 py-1 text-xs bg-gray-200 rounded",onClick:l[0]||(l[0]=c=>i.value=!1)},"Close")]),D(Z,{"model-value":r.items,"can-add":r.canAdd,"current-user-id":_.value,onAdd:l[1]||(l[1]=c=>u("add",c)),onMarkAllRead:l[2]||(l[2]=()=>u("markAllRead"))},null,8,["model-value","can-add","current-user-id"])])])):v("",!0)}};export{re as _};
