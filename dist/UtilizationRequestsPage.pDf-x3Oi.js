import{M as H,N as ze,r as T,c as Q,u as Be,o as Fe,C as pe,a as h,d as I,q as b,e as a,t as A,k as G,h as z,E as ue,g as O,j as de,F as ee,G as te,v as X,S as k,f as J,l as se,A as ge,O as Re,P as be}from"./index.B-Q-J4WK.js";import{u as Ie,E as Ue,a as K,d as ve,Q as Ne,b as _e,_ as Oe}from"./browser.DTA1du4U.js";import{y as De,B as Le,C as Pe,D as Ve,E as je,F as Ye,z as Me,A as We,j as Ge,_ as Je,a as Ke,l as Qe,n as He,o as Xe,G as Ze,H as et,I as tt,J as at}from"./SectionMain.C5xrv34b.js";import{a as st,b as lt,c as he,B as it,d as me}from"./IconifyButton.Dm77Uu99.js";import"./ToasterComponent.DeljTacu.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";function nt(e={}){const{filters:t={},page:d,limit:f,sort:g,order:_,q:p,status:F,availability_status:$,activity_design_id:D,filed_by_user_id:L,start_from:o,start_to:C,end_from:R,end_to:P,facilities_any:w,...q}=e,V={page:d,limit:f,sort:g,order:_,q:p,status:F,availability_status:$,activity_design_id:D,filed_by_user_id:L,start_from:o,start_to:C,end_from:R,end_to:P,facilities_any:w,...q,filters:{...t}};return Object.keys(V).forEach(j=>V[j]===void 0&&delete V[j]),V}function ot(e){return typeof Blob<"u"&&(e instanceof Blob||e instanceof File)}function xe(e,t=!0){if(typeof e=="string")return e;if(e==null)return t?"[]":"null";try{return JSON.stringify(e)}catch{return t?"[]":"null"}}function we(e={}){const t={...e};return t.facilities!==void 0&&(t.facilities=xe(t.facilities,!0)),t.equipment_items!==void 0&&(t.equipment_items=xe(t.equipment_items,!0)),t}const Z={async create(e){const{data:t}=await H.post("/utilization-requests",we(e));return t},async getById(e){const{data:t}=await H.get(`/utilization-requests/${e}`);return t},async updateById(e,t){const{data:d}=await H.put(`/utilization-requests/${e}`,we(t));return d},async delete(e){const{data:t}=await H.delete(`/utilization-requests/${e}`);return t},async list(e={}){const t=nt(e),{data:d}=await H.get("/utilization-requests",{params:t});return d},async submit(e){const{data:t}=await H.post(`/utilization-requests/${e}/submit`);return t},async approve(e,{remarks:t}={}){const{data:d}=await H.post(`/utilization-requests/${e}/approve`,{remarks:t});return d},async reject(e,{remarks:t}={}){const{data:d}=await H.post(`/utilization-requests/${e}/reject`,{remarks:t});return d},async cancel(e,{remarks:t}={}){const{data:d}=await H.post(`/utilization-requests/${e}/cancel`,{remarks:t});return d},async uploadAttachment(e,t){if(ot(t)){const d=new FormData;d.append("file",t);const{data:f}=await H.post(`/utilization-requests/${e}/attachments`,d,{headers:{"Content-Type":"multipart/form-data"}});return f}else{const{data:d}=await H.post(`/utilization-requests/${e}/attachments`,{file:t});return d}},async deleteAttachment(e,t){const{data:d}=await H.delete(`/utilization-requests/${e}/attachments/${t}`);return d},async availability({start_date:e,start_time:t,end_date:d,end_time:f,facilities:g=[]}){const _={start_date:e,start_time:t,end_date:d,end_time:f,facilities:g},{data:p}=await H.get("/utilization-requests/_utils/availability",{params:_});return p}},ye=ze("utilizationRequest",()=>{const e=T({total:0,totalPages:1,currentPage:1,pageSize:10,data:[]}),t=T(!1),d=T(null),f=T(!1),g=T(null),_=T(null),p=v=>{if(!v?.id)return;const c=e.value.data.findIndex(r=>r.id===v.id);c!==-1&&(e.value.data[c]=v)};return{items:e,selected:g,availabilityProbe:_,isLoading:t,error:d,isLoaded:f,fetchAll:async(v={},c=!1)=>{if(d.value=null,!(!c&&f.value))try{t.value=!0;const r=await Z.list(v);Object.assign(e.value,{total:r.total||0,totalPages:r.totalPages||1,currentPage:v.page||1,pageSize:v.limit||10,data:r.data||[]}),f.value=!0}catch(r){d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to fetch utilization requests"}finally{t.value=!1}},fetchById:async v=>{d.value=null;try{t.value=!0;const c=await Z.getById(v);g.value=c,p(c)}catch(c){d.value=c?.response?.data?.message||c?.response?.message||c?.message||"Failed to fetch utilization request"}finally{t.value=!1}},create:async v=>{d.value=null;try{t.value=!0;const c=await Z.create(v);return e.value.data.push(c),e.value.total+=1,c}catch(c){throw d.value=c?.response?.data?.message||c?.response?.message||c?.message||"Failed to create utilization request",c}finally{t.value=!1}},updateById:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.updateById(v,c);return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to update utilization request",r}finally{t.value=!1}},deleteById:async v=>{d.value=null;try{t.value=!0,await Z.delete(v),e.value.data=e.value.data.filter(c=>c.id!==v),e.value.total=Math.max(0,e.value.total-1),g.value?.id===v&&(g.value=null)}catch(c){d.value=c?.response?.data?.message||c?.response?.message||c?.message||"Failed to delete utilization request"}finally{t.value=!1}},submit:async v=>{d.value=null;try{t.value=!0;const c=await Z.submit(v);return p(c),g.value?.id===v&&(g.value=c),c}catch(c){throw d.value=c?.response?.data?.message||c?.response?.message||c?.message||"Failed to submit utilization request",c}finally{t.value=!1}},approve:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.approve(v,{remarks:c});return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to approve utilization request",r}finally{t.value=!1}},reject:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.reject(v,{remarks:c});return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to reject utilization request",r}finally{t.value=!1}},cancel:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.cancel(v,{remarks:c});return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to cancel utilization request",r}finally{t.value=!1}},uploadAttachment:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.uploadAttachment(v,c);return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to upload attachment",r}finally{t.value=!1}},deleteAttachment:async(v,c)=>{d.value=null;try{t.value=!0;const r=await Z.deleteAttachment(v,c);return p(r),g.value?.id===v&&(g.value=r),r}catch(r){throw d.value=r?.response?.data?.message||r?.response?.message||r?.message||"Failed to delete attachment",r}finally{t.value=!1}},checkAvailability:async v=>{d.value=null;try{t.value=!0;const c=await Z.availability(v);return _.value=c,c}catch(c){throw d.value=c?.response?.data?.message||c?.response?.message||c?.message||"Failed to check availability",c}finally{t.value=!1}},resetStore:()=>{e.value={total:0,totalPages:1,currentPage:1,pageSize:10,data:[]},g.value=null,_.value=null,f.value=!1,t.value=!1,d.value=null}}}),rt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},dt={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[980px] max-h-screen overflow-auto"},ut={class:"flex items-center justify-between mb-3"},ct={class:"flex items-center gap-3"},mt={class:"text-lg font-semibold"},pt={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},ft={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},vt={class:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},yt={class:"md:col-span-2"},gt=["disabled"],bt=["value"],_t={key:0,class:"text-red-600 text-[11px] mt-1"},ht={key:1,class:"text-[11px] text-gray-500 mt-1"},xt={key:2,class:"text-[11px] text-amber-700 mt-1"},wt={key:0,class:"text-red-600 text-[11px] mt-1"},St=["disabled"],Ct={key:0,class:"text-red-600 text-[11px] mt-1"},At=["disabled"],$t={key:0,class:"text-red-600 text-[11px] mt-1"},kt=["disabled"],Bt={key:0,class:"text-red-600 text-[11px] mt-1"},Ft={class:"mt-3 text-sm"},Tt={class:"flex gap-2"},Et=["disabled"],qt=["value"],zt=["disabled"],Rt={key:0,class:"text-red-600 text-[11px] mt-1"},It={class:"mt-2 flex flex-wrap gap-2"},Ut=["onClick"],Nt={key:0,class:"text-gray-400"},Ot={class:"mt-4 text-sm"},Dt={class:"flex items-center justify-between"},Lt=["disabled"],Pt={class:"mt-2 border rounded overflow-hidden"},Vt={class:"w-full text-xs"},jt={class:"p-2"},Yt=["onUpdate:modelValue","disabled","onChange"],Mt=["value"],Wt={key:0,class:"text-red-600 mt-1"},Gt={class:"p-2"},Jt=["onUpdate:modelValue","disabled"],Kt={class:"p-2"},Qt=["onUpdate:modelValue","disabled"],Ht={class:"p-2 text-right"},Xt=["disabled","onClick"],Zt={class:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},ea=["disabled"],ta=["disabled"],aa={class:"mt-3 p-3 rounded-lg border bg-white"},sa={class:"flex items-center justify-between"},la=["disabled"],ia={class:"flex justify-end gap-2 mt-5"},Se={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(e,{emit:t}){const d=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],f=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],g=e,_=t,p=Q({get:()=>g.modelValue,set:m=>_("update:modelValue",m)}),F=Be(),$=ye(),D=Ie(),L=Q(()=>Array.isArray(D.items?.data)?D.items.data.filter(m=>String(m.status).toLowerCase()==="approved"):[]);Fe(async()=>{await D.fetchAll({page:1,limit:200,status:"approved",officer:!0},!0)});const o=T({...g.initial}),C=T({}),R=Q(()=>{const m=Number(o.value.activity_design_id||0);return L.value.find(n=>Number(n.id)===m)||null});pe(()=>g.initial,m=>{o.value={...m,facilities:Array.isArray(m.facilities)?m.facilities:(()=>{try{return JSON.parse(m.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(m.equipment_items)?m.equipment_items:(()=>{try{return JSON.parse(m.equipment_items||"[]")}catch{return[]}})()},o.value.facilities=(o.value.facilities||[]).filter(n=>d.includes(n)),o.value.equipment_items=(o.value.equipment_items||[]).filter(n=>!n?.name||f.includes(n.name)),C.value={}},{immediate:!0}),pe(()=>o.value.activity_design_id,()=>{const m=R.value;m?.date_of_implementation?o.value.start_date=String(m.date_of_implementation).slice(0,10):o.value.start_date=""},{immediate:!0});const P=Q(()=>String(o.value?.status||"").toLowerCase()),w=Q(()=>g.mode==="edit"&&P.value!=="draft"),q=Q(()=>g.mode!=="edit"?"New Utilization Request":w.value?"View Utilization (read-only)":"Edit Utilization"),V=Q(()=>g.mode==="edit"?"Save Changes":"Create"),j=m=>{const n=m?.name_of_activity||"Untitled",u=m?.school_year?` • SY ${m.school_year}`:"",E=m?.semester?` • ${m.semester}`:"",s=m?.reference_code?` [${m.reference_code}]`:"";return`${n}${u}${E}${s}`},B=T(""),v=Q(()=>d.filter(m=>!(o.value.facilities||[]).includes(m))),c=()=>{const m=B.value;!m||!d.includes(m)||(Array.isArray(o.value.facilities)||(o.value.facilities=[]),o.value.facilities.includes(m)||o.value.facilities.push(m),B.value="")},r=m=>{o.value.facilities.splice(m,1)},U=()=>{Array.isArray(o.value.equipment_items)||(o.value.equipment_items=[]);const m=new Set((o.value.equipment_items||[]).map(u=>u?.name).filter(Boolean)),n=f.find(u=>!m.has(u))||f[0];m.has(n)||o.value.equipment_items.push({name:n,qty:1,unit:""})},Y=m=>{o.value.equipment_items.splice(m,1)},W=m=>{const n=new Set((o.value.equipment_items||[]).map((u,E)=>E===m?null:u?.name).filter(Boolean));return f.filter(u=>!n.has(u))},le=()=>{if(w.value)return!1;const m={};o.value.activity_design_id||(m.activity_design_id="Required"),o.value.start_date||(m.start_date="Start date is required (from Activity Design)"),o.value.start_time||(m.start_time="Required"),o.value.end_date||(m.end_date="Required"),o.value.end_time||(m.end_time="Required"),!Array.isArray(o.value.facilities)||!o.value.facilities.length?m.facilities="Select at least one":o.value.facilities.every(u=>d.includes(u))||(m.facilities="Invalid facility selected");const n=new Set;if(Array.isArray(o.value.equipment_items)&&o.value.equipment_items.forEach((u,E)=>{u?.name&&!f.includes(u.name)&&(m[`equipment_${E}`]="Invalid equipment"),u?.name&&n.has(u.name)&&(m[`equipment_${E}`]="Duplicate item; adjust quantity instead"),u?.name&&n.add(u.name),u?.name&&(isNaN(Number(u.qty))||Number(u.qty)<=0)&&(m[`equipment_${E}`]="Qty must be > 0")}),o.value.start_date&&o.value.end_date&&o.value.start_time&&o.value.end_time){const u=new Date(`${o.value.start_date}T${o.value.start_time}:00`);new Date(`${o.value.end_date}T${o.value.end_time}:00`)<u&&(m.end_time="End must be after or equal to start")}return C.value=m,Object.keys(m).length===0},ne=async()=>{if(!o.value.start_date||!o.value.end_date||!o.value.facilities?.length){await k.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const m=await $.checkAvailability({start_date:o.value.start_date,start_time:o.value.start_time||"00:00",end_date:o.value.end_date,end_time:o.value.end_time||"00:00",facilities:o.value.facilities}),n=m.available_for_all?"All selected facilities are available.":`Conflicts on: ${(m.conflict_facilities||[]).join(", ")||"—"}`;await k.fire({icon:m.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(m.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${n}</div>
      </div>`})}catch(m){await k.fire("Error",$.error||"Failed to check availability.","error"),console.error(m)}},ae=()=>{if(w.value||!le())return;const m={...o.value};F.user?.id&&(m.filed_by_user_id=F.user.id),_("submit",m)};return(m,n)=>p.value?(b(),h("div",rt,[a("div",dt,[a("div",ut,[a("div",ct,[a("h2",mt,A(q.value),1),a("span",pt,A(o.value.status),1)]),a("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:n[0]||(n[0]=u=>p.value=!1)},"Close")]),w.value?(b(),h("div",ft,[n[10]||(n[10]=G(" This request is ",-1)),a("strong",null,A(o.value.status),1),n[11]||(n[11]=G(". Editing is disabled. ",-1))])):I("",!0),a("div",vt,[a("div",yt,[n[13]||(n[13]=a("label",{class:"block mb-1"},[G("Activity Design "),a("span",{class:"text-red-500"},"*")],-1)),z(a("select",{"onUpdate:modelValue":n[1]||(n[1]=u=>o.value.activity_design_id=u),class:de(["w-full border rounded px-2.5 py-2",C.value.activity_design_id?"border-red-500":""]),disabled:w.value||O(D).isLoading},[n[12]||(n[12]=a("option",{value:""},"Select approved activity design…",-1)),(b(!0),h(ee,null,te(L.value,u=>(b(),h("option",{key:u.id,value:u.id},A(j(u)),9,bt))),128))],10,gt),[[ue,o.value.activity_design_id]]),C.value.activity_design_id?(b(),h("p",_t,A(C.value.activity_design_id),1)):I("",!0),O(D).isLoading?(b(),h("p",ht," Loading approved activities… ")):L.value.length?I("",!0):(b(),h("p",xt," No approved activity designs found. Approve an Activity Design first. "))]),a("div",null,[n[14]||(n[14]=a("label",{class:"block mb-1"},[G("Start Date "),a("span",{class:"text-red-500"},"*")],-1)),z(a("input",{"onUpdate:modelValue":n[2]||(n[2]=u=>o.value.start_date=u),type:"date",class:de(["w-full border rounded px-2.5 py-2 bg-gray-50",C.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[X,o.value.start_date]]),C.value.start_date?(b(),h("p",wt,A(C.value.start_date),1)):I("",!0)]),a("div",null,[n[15]||(n[15]=a("label",{class:"block mb-1"},[G("Start Time "),a("span",{class:"text-red-500"},"*")],-1)),z(a("input",{"onUpdate:modelValue":n[3]||(n[3]=u=>o.value.start_time=u),type:"time",class:de(["w-full border rounded px-2.5 py-2",C.value.start_time?"border-red-500":""]),disabled:w.value},null,10,St),[[X,o.value.start_time]]),C.value.start_time?(b(),h("p",Ct,A(C.value.start_time),1)):I("",!0)]),a("div",null,[n[16]||(n[16]=a("label",{class:"block mb-1"},[G("End Date "),a("span",{class:"text-red-500"},"*")],-1)),z(a("input",{"onUpdate:modelValue":n[4]||(n[4]=u=>o.value.end_date=u),type:"date",class:de(["w-full border rounded px-2.5 py-2",C.value.end_date?"border-red-500":""]),disabled:w.value},null,10,At),[[X,o.value.end_date]]),C.value.end_date?(b(),h("p",$t,A(C.value.end_date),1)):I("",!0)]),a("div",null,[n[17]||(n[17]=a("label",{class:"block mb-1"},[G("End Time "),a("span",{class:"text-red-500"},"*")],-1)),z(a("input",{"onUpdate:modelValue":n[5]||(n[5]=u=>o.value.end_time=u),type:"time",class:de(["w-full border rounded px-2.5 py-2",C.value.end_time?"border-red-500":""]),disabled:w.value},null,10,kt),[[X,o.value.end_time]]),C.value.end_time?(b(),h("p",Bt,A(C.value.end_time),1)):I("",!0)])]),a("div",Ft,[n[19]||(n[19]=a("label",{class:"block mb-1"},[G("Facilities "),a("span",{class:"text-red-500"},"*")],-1)),a("div",Tt,[z(a("select",{"onUpdate:modelValue":n[6]||(n[6]=u=>B.value=u),class:"border rounded px-2.5 py-2",disabled:w.value},[n[18]||(n[18]=a("option",{value:""},"Select facility…",-1)),(b(!0),h(ee,null,te(v.value,u=>(b(),h("option",{key:u,value:u},A(u),9,qt))),128))],8,Et),[[ue,B.value]]),a("button",{class:"px-3 py-2 bg-gray-200 rounded text-xs",disabled:w.value||!B.value,onClick:c}," Add ",8,zt)]),C.value.facilities?(b(),h("p",Rt,A(C.value.facilities),1)):I("",!0),a("div",It,[(b(!0),h(ee,null,te(o.value.facilities,(u,E)=>(b(),h("span",{key:u,class:"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700"},[G(A(u)+" ",1),w.value?I("",!0):(b(),h("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:s=>r(E)},"×",8,Ut))]))),128)),o.value.facilities?.length?I("",!0):(b(),h("span",Nt,"No facilities selected"))])]),a("div",Ot,[a("div",Dt,[n[20]||(n[20]=a("label",{class:"block mb-1"},"Equipment / Materials (optional)",-1)),a("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:w.value||W(-1).length===0,onClick:U}," Add Row ",8,Lt)]),a("div",Pt,[a("table",Vt,[n[21]||(n[21]=a("thead",{class:"bg-gray-50"},[a("tr",null,[a("th",{class:"text-left p-2"},"Item"),a("th",{class:"text-left p-2"},"Qty"),a("th",{class:"text-left p-2"},"Unit"),a("th",{class:"p-2 w-16"})])],-1)),a("tbody",null,[(b(!0),h(ee,null,te(o.value.equipment_items,(u,E)=>(b(),h("tr",{key:E,class:"border-t"},[a("td",jt,[z(a("select",{"onUpdate:modelValue":s=>u.name=s,class:"w-full border rounded px-2 py-1",disabled:w.value,onChange:()=>{(u.qty==null||u.qty<=0)&&(u.qty=1)}},[(b(!0),h(ee,null,te(W(E).concat(u.name&&!W(E).includes(u.name)?[u.name]:[]),s=>(b(),h("option",{key:s,value:s},A(s),9,Mt))),128))],40,Yt),[[ue,u.name]]),C.value[`equipment_${E}`]?(b(),h("div",Wt,A(C.value[`equipment_${E}`]),1)):I("",!0)]),a("td",Gt,[z(a("input",{"onUpdate:modelValue":s=>u.qty=s,type:"number",min:"1",class:"w-24 border rounded px-2 py-1",disabled:w.value},null,8,Jt),[[X,u.qty,void 0,{number:!0}]])]),a("td",Kt,[z(a("input",{"onUpdate:modelValue":s=>u.unit=s,class:"w-28 border rounded px-2 py-1",disabled:w.value,placeholder:"e.g., pcs"},null,8,Qt),[[X,u.unit]])]),a("td",Ht,[a("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:w.value,onClick:s=>Y(E)},"Remove",8,Xt)])]))),128))])])]),n[22]||(n[22]=a("p",{class:"text-[11px] text-gray-500 mt-1"}," Each equipment name must be unique; adjust quantity for multiples. ",-1))]),a("div",Zt,[a("div",null,[n[23]||(n[23]=a("label",{class:"block mb-1"},"Utilization Details (duration, purpose, notes)",-1)),z(a("textarea",{"onUpdate:modelValue":n[7]||(n[7]=u=>o.value.utilization_details=u),rows:"4",class:"w-full border rounded px-2.5 py-2",disabled:w.value},null,8,ea),[[X,o.value.utilization_details]])]),a("div",null,[n[24]||(n[24]=a("label",{class:"block mb-1"},"Remarks",-1)),z(a("textarea",{"onUpdate:modelValue":n[8]||(n[8]=u=>o.value.remarks=u),rows:"4",class:"w-full border rounded px-2.5 py-2",disabled:w.value},null,8,ta),[[X,o.value.remarks]])])]),a("div",aa,[a("div",sa,[n[25]||(n[25]=a("div",{class:"text-sm font-medium"},"Check Availability",-1)),a("button",{class:"px-3 py-1 bg-indigo-600 text-white rounded text-xs",disabled:w.value,onClick:ne}," Run Check ",8,la)]),n[26]||(n[26]=a("div",{class:"mt-1 text-xs text-gray-500"}," Uses current form values (start/end & facilities) to detect overlaps. ",-1))]),a("div",ia,[a("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:n[9]||(n[9]=u=>p.value=!1)},"Close"),w.value?I("",!0):(b(),h("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:ae},A(V.value),1))])])])):I("",!0)}},na={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},oa={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},ra={class:"flex items-center justify-between mb-3"},da={class:"text-lg font-semibold"},ua={class:"text-gray-600"},ca={class:"flex items-center justify-between gap-2"},ma={class:"text-sm text-gray-600"},pa={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},fa=["d"],va=["disabled"],ya={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},ga={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},ba=["src"],_a={key:1,class:"flex items-center justify-center w-full h-full"},ha=["d"],xa={class:"mt-2 text-xs"},wa=["title"],Sa={class:"text-gray-500 flex items-center justify-between"},Ca={key:0},Aa={key:0},$a={class:"mt-2 flex items-center justify-between gap-2"},ka=["onClick","title"],Ba={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},Fa=["d"],Ta=["onClick"],Ea={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},qa=["d"],za={key:0,class:"mt-6 text-center text-sm text-gray-500"},Ra=10*1024*1024,Ia={__name:"UtilizationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(e,{emit:t}){const d=e,f=t,g=Q({get:()=>d.modelValue,set:s=>f("update:modelValue",s)}),_=ye(),p=T(null),F=T(!1),$=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),D=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),L=(s="")=>String(s).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",o=(s="")=>typeof s=="string"&&s.match(/^data:([^;]+);base64,/i)?.[1]||"",C=s=>{const x=s?.type&&$.has(s.type),S=s?.name&&D.has(L(s.name));return x||S},R=(s="")=>String(s).startsWith("image/"),P=(s="")=>s==="application/pdf",w=(s="")=>s==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",q=(s="")=>s==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",V=(s="")=>P(s)?Le:w(s)?Pe:q(s)?Ve:R(s)?je:Ye,j=(s="")=>P(s)?"PDF":w(s)?"Word":q(s)?"Excel":R(s)?"Image":"File",B=(s="")=>P(s)?"pdf":w(s)?"docx":q(s)?"xlsx":s==="image/png"?"png":s==="image/jpeg"?"jpg":s==="image/webp"?"webp":"",v=(s="attachment",x="")=>/\.[a-z0-9]+$/i.test(s)?s:x?`${s}.${x.startsWith(".")?x.slice(1):x}`:s,c=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`,r=Q(()=>{const s=p.value?.attachments;if(!s)return[];try{return Array.isArray(s)?s:JSON.parse(s||"[]")}catch{return[]}}),U=Q(()=>(r.value||[]).map((s,x)=>{const S=s.mime||o(s.data)||(s.name?L(s.name)==="pdf"&&"application/pdf":"")||"",M=L(s.name||"")||B(S),ie=s.size??null,oe=s.name||`${j(S)} ${x+1}`;return{id:s.id??x+1,name:oe,data:s.data||"",url:s.url||s.href||s.path||"",mime:S,ext:M,size:ie,filename:v(oe,M)}}));pe(()=>d.modelValue,async s=>{s&&d.row?.id&&(await _.fetchById(d.row.id),p.value=_.selected||d.row)},{immediate:!1});const Y=async s=>{const x=s.target.files?.[0];if(s.target.value="",!(!x||!p.value?.id)){if(x.size>Ra){await k.fire("File too large","Maximum size is 10 MB.","warning");return}if(!C(x)){await k.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{F.value=!0,await _.uploadAttachment(p.value.id,x),await _.fetchById(p.value.id),p.value=_.selected}finally{F.value=!1}}},W=async s=>{!p.value?.id||!(await k.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await _.deleteAttachment(p.value.id,s),await _.fetchById(p.value.id),p.value=_.selected)},le=s=>{if(s.data&&String(s.data).startsWith("data:")&&R(s.mime)){const x=window.open();x&&x.document.write(`<img src="${s.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}s.url&&window.open(String(s.url),"_blank")},ne=s=>{const[x,S]=s.split(","),M=x.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",ie=atob(S),oe=ie.length,re=new Uint8Array(oe);for(let ce=0;ce<oe;ce++)re[ce]=ie.charCodeAt(ce);return new Blob([re],{type:M})},ae=(s,x)=>{const S=URL.createObjectURL(s),M=document.createElement("a");M.href=S,M.download=x||"download",document.body.appendChild(M),M.click(),M.remove(),setTimeout(()=>URL.revokeObjectURL(S),1e3)},m=async s=>{if(s.data&&String(s.data).startsWith("data:")){const x=ne(s.data);ae(x,s.filename);return}if(s.url)try{const S=await(await fetch(s.url,{credentials:"include"})).blob();ae(S,s.filename)}catch{const x=document.createElement("a");x.href=String(s.url),x.setAttribute("download",s.filename),document.body.appendChild(x),x.click(),x.remove()}},n=s=>R(s.mime)?"Open":"Download",u=s=>R(s.mime)?Me:We,E=s=>R(s.mime)?le(s):m(s);return(s,x)=>g.value?(b(),h("div",na,[a("div",oa,[a("div",ra,[a("h2",da,[x[1]||(x[1]=G(" Utilization Attachments — ",-1)),a("span",ua,A(p.value?.reference_code||""),1)]),a("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:x[0]||(x[0]=S=>g.value=!1)},"Close")]),a("div",ca,[a("div",ma,[x[2]||(x[2]=G(" Activity: ",-1)),a("strong",null,A(p.value?.activity_design?.name_of_activity||"—"),1)]),a("label",{class:de(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":F.value}])},[(b(),h("svg",pa,[a("path",{d:O(De)},null,8,fa)])),a("span",null,A(F.value?"Uploading…":"Upload"),1),a("input",{type:"file",class:"hidden",disabled:F.value,onChange:Y,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,va)],2)]),a("div",ya,[(b(!0),h(ee,null,te(U.value,S=>(b(),h("div",{key:S.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[a("div",ga,[R(S.mime)&&S.data&&S.data.startsWith("data:")?(b(),h("img",{key:0,src:S.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,ba)):(b(),h("div",_a,[(b(),h("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24","aria-hidden":"true",class:de({"text-red-600":P(S.mime),"text-blue-600":w(S.mime),"text-emerald-600":q(S.mime),"text-gray-500":!S.mime||!R(S.mime)&&!P(S.mime)})},[a("path",{d:V(S.mime)},null,8,ha)],2))]))]),a("div",xa,[a("div",{class:"font-medium truncate",title:S.name},A(S.name),9,wa),a("div",Sa,[a("span",null,[G(A(j(S.mime))+" ",1),S.ext?(b(),h("span",Ca,"("+A(S.ext.toUpperCase())+")",1)):I("",!0)]),S.size?(b(),h("span",Aa,A(c(S.size)),1)):I("",!0)])]),a("div",$a,[a("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:M=>E(S),title:n(S)},[(b(),h("svg",Ba,[a("path",{d:u(S)},null,8,Fa)])),G(" "+A(n(S)),1)],8,ka),a("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:M=>W(S.id),title:"Remove"},[(b(),h("svg",Ea,[a("path",{d:O(Ge)},null,8,qa)])),x[3]||(x[3]=G(" Remove ",-1))],8,Ta)])]))),128))]),U.value.length?I("",!0):(b(),h("div",za," No attachments yet. "))])])):I("",!0)}},Ua="KOLEHIYO NG PANTUKAN",Na="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",Oa="https://osas.knp.edu.ph/verify-utilization?id=",fe=e=>e?ve(e).format("MMMM DD, YYYY"):"—",Ce=e=>e?ve(e).format("MMM DD, YYYY, h:mm A"):"—",Ae=(e,t=0)=>e==null||e===""||Number.isNaN(Number(e))?"—":Number(e).toLocaleString(void 0,{minimumFractionDigits:t,maximumFractionDigits:t}),$e=(e,t)=>{if(Array.isArray(e))return e;try{return JSON.parse(e||"null")??t}catch{return t}},Te="./",Da=`${Te}images/logo.png`,La=`${Te}images/bg.jpg`;async function ke(e){const d=await(await fetch(e)).blob();return new Promise(f=>{const g=new FileReader;g.onloadend=()=>f(g.result),g.readAsDataURL(d)})}function Pa(e){switch(e){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}function Va(e){switch(String(e||"").toUpperCase()){case"AVAILABLE":return[16,185,129];case"RESERVED":return[99,102,241];case"CONFLICT":return[239,68,68];case"MAINTENANCE":return[245,158,11];case"PENDING-CHECK":return[245,158,11];default:return[107,114,128]}}async function ja(e){const t=e.internal.pageSize.getWidth(),d=110,f=36;try{const g=await ke(La);e.addImage(g,"JPEG",0,0,t,d,void 0,"FAST")}catch{e.setFillColor(21,62,121),e.rect(0,0,t,d,"F")}e.setGState(new e.GState({opacity:.18})),e.setFillColor(0,0,0),e.rect(0,0,t,d,"F"),e.setGState(new e.GState({opacity:1}));try{const g=await ke(Da);e.addImage(g,"PNG",f,20,70,70,void 0,"FAST")}catch{}return e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(20),e.text(Ua,f+86,38),e.setFont("helvetica","normal"),e.setFontSize(10),e.text(Na,f+86,58),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(14),e.text("UTILIZATION REQUEST",t/2,d+24,{align:"center"}),d+34}async function Ya(e,t,d){const f=e.internal.pageSize.getWidth(),g=36,_=t?.id??t?.reference_code??"",p=`${Oa}${encodeURIComponent(String(_))}`,F=await Ne.toDataURL(p,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),$=String(t.status||"").toUpperCase(),[D,L,o]=Pa($),C=String(t.availability_status||"").toUpperCase(),[R,P,w]=Va(C),q=t.approved_at?fe(t.approved_at):t.date_filed?fe(t.date_filed):"—",V=`osas.knp.edu.ph/verify-utilization?id=${String(_)}`;return K(e,{startY:d,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:g,right:g},tableWidth:f-g*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:f-g*2-260},1:{cellWidth:260}},didDrawCell:j=>{if(j.section!=="body")return;const{x:B,y:v,width:c,height:r}=j.cell,U=10;if(j.column.index===0){e.setFillColor(255,255,255),e.roundedRect(B,v,c-1,r,6,6,"F");const Y=24,W=Math.min(160,c-22);e.setFillColor(D,L,o),e.roundedRect(B+U,v+U,W,Y,12,12,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text($||"STATUS",B+U+10,v+U+16);const le=v+U+Y+10,ne=Math.min(160,c-22);e.setFillColor(R,P,w),e.roundedRect(B+U,le,ne,Y,12,12,"F"),e.setTextColor(255,255,255),e.text(C||"AVAILABILITY",B+U+10,le+16),e.setTextColor(20),e.setFont("helvetica","normal"),e.setFontSize(9);let ae=le+Y+12;e.text(`Ref No.: ${t.reference_code||"—"}`,B+U,ae),ae+=16,e.text(`Date Issued: ${q}`,B+U,ae),e.setDrawColor(230),e.roundedRect(B,v,c-1,r,6,6,"S")}if(j.column.index===1){e.setFillColor(255,255,255),e.roundedRect(B,v,c-1,r,6,6,"F"),e.setFillColor(66,103,178),e.roundedRect(B,v,c-1,22,6,6,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("VERIFY",B+U,v+15);const Y=B+U,W=v+28;e.addImage(F,"PNG",Y,W,75,75,void 0,"FAST"),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("Scan to verify",Y+100,W+14),e.setFont("helvetica","normal"),e.setFontSize(9),e.text("This document can be verified",Y+100,W+32),e.text("online via the OSAS portal.",Y+100,W+46),e.setTextColor(110),e.setFontSize(8),e.text(V,Y+100,W+72),e.setDrawColor(230),e.roundedRect(B,v,c-1,r,6,6,"S")}}}),e.lastAutoTable.finalY}async function Ma(e){const t=new Ue({unit:"pt",format:[612,936],orientation:"portrait"}),d=t.internal.pageSize.getWidth(),f=36,g=$e(e.facilities,[]),_=$e(e.equipment_items,[]);let p=await ja(t);p=await Ya(t,e,p)+10,K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY;const F=e.activity_design||{};K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},F.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},fe(F.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},F.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},F.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},F.office_department||F?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:f,right:f}}),p=t.lastAutoTable.finalY+10,K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"SCHEDULE",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY;const $=e.start_at||(e.start_date&&e.start_time?`${e.start_date}T${e.start_time}:00`:null),D=e.end_at||(e.end_date&&e.end_time?`${e.end_date}T${e.end_time}:00`:null);K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"START",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ce($)],[{content:"END",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ce(D)],[{content:"DURATION (mins)",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ae(e.duration_minutes)]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:f,right:f}}),p=t.lastAutoTable.finalY+10,K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"FACILITIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY;const L=Array.isArray(g)&&g.length?"• "+g.join(`
• `):"—";K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[L]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY+10,K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"EQUIPMENT / MATERIALS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY,Array.isArray(_)&&_.length?K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["ITEM","QTY","UNIT"]],body:_.map(w=>[w?.name||"—",Ae(w?.qty),w?.unit||"—"]),columnStyles:{0:{cellWidth:300},1:{cellWidth:70},2:{cellWidth:"auto"}},margin:{left:f,right:f}}):K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY+10;const o=[["UTILIZATION DETAILS",e.utilization_details],["REMARKS",e.remarks]];for(const[w,q]of o)K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:w,styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY,K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[q&&String(q).trim()?q:"—"]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY+10;K(t,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"APPROVAL",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:f,right:f}}),p=t.lastAutoTable.finalY;const C=e?.filed_by?`${e.filed_by.first_name||""} ${e.filed_by.last_name||""}`.trim():"",R=e?.approver?`${e.approver.first_name||""} ${e.approver.last_name||""}`.trim():"";K(t,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PREPARED BY:","APPROVED BY:"]],body:[[C||" ",R||" "]],columnStyles:{0:{cellWidth:(d-f*2)/2},1:{cellWidth:"auto"}},didParseCell:w=>{w.section==="body"&&(w.cell.styles.halign="center",w.cell.styles.fontStyle="bold",w.cell.styles.cellPadding={top:16,right:10,bottom:18,left:10})},margin:{left:f,right:f}});const P=t.internal.pageSize.getHeight()-20;t.setFontSize(8),t.setTextColor(120),t.text(`Generated on ${ve().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,f,P),t.save(`${e.reference_code||"Utilization_Request"}.pdf`)}const Wa={class:"flex items-center gap-2"},Ga={class:"p-3 mb-4 rounded-xl border bg-white/60"},Ja={class:"flex items-center gap-2 mb-2 text-gray-700"},Ka={class:"w-4 h-4",viewBox:"0 0 24 24"},Qa=["d"],Ha={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},Xa={class:"md:col-span-2 flex"},Za={class:"w-5 h-5",viewBox:"0 0 24 24"},es=["d"],ts=["value"],as=["value"],ss={class:"md:col-span-1"},ls={class:"md:col-span-1"},is={class:"md:col-span-2"},ns=["value"],os={class:"p-3 mb-4 rounded-xl border bg-white/60"},rs={class:"flex items-center gap-2 mb-2 text-gray-700"},ds={class:"w-4 h-4",viewBox:"0 0 24 24"},us=["d"],cs={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},ms={class:"md:col-span-2"},ps={class:"md:col-span-1"},fs={class:"md:col-span-2"},vs={class:"md:col-span-1"},ys={class:"md:col-span-2"},gs=["value"],bs={class:"flex items-center gap-2 md:col-span-2"},_s={class:"flex flex-wrap gap-1 max-w-[380px]"},hs={key:0,class:"text-gray-400"},ks={__name:"UtilizationRequestsPage",setup(e){const t=ye(),d=Be(),f=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],g={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},_=T({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[]}),p=Q({get:()=>{const{start_from:y,start_to:l}=_.value;return y||l?[y||null,l||null]:null},set:y=>{if(!y)_.value.start_from=null,_.value.start_to=null;else{const[l,i]=y;_.value.start_from=l||null,_.value.start_to=i||null}}}),F=Q({get:()=>{const{end_from:y,end_to:l}=_.value;return y||l?[y||null,l||null]:null},set:y=>{if(!y)_.value.end_from=null,_.value.end_to=null;else{const[l,i]=y;_.value.end_from=l||null,_.value.end_to=i||null}}}),$=async(y={},l=!0)=>{_.value={..._.value,...y};const i={..._.value};["q","status","availability_status","start_from","start_to","end_from","end_to"].forEach(N=>{(i[N]===""||i[N]==null)&&delete i[N]}),(!Array.isArray(i.facilities_any)||!i.facilities_any.length)&&delete i.facilities_any,await t.fetchAll(i,l)};Fe(async()=>{await $({page:1,limit:10})});const D=Q(()=>({total:t.items.total||0,totalPages:t.items.totalPages||1,currentPage:t.items.currentPage||1,pageSize:t.items.pageSize||10,data:t.items.data||[]})),L=["draft","pending","approved","rejected","cancelled","completed"],o=["unknown","pending-check","available","conflict","reserved","maintenance"],C=y=>{switch(String(y||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},R=y=>{switch(String(y||"").toLowerCase()){case"available":return"emerald";case"reserved":return"indigo";case"conflict":return"red";case"maintenance":return"orange";case"pending-check":return"amber";default:return"gray"}},P=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:220,formatter:(y,l)=>l.activity_design?l.activity_design.name_of_activity:""},{key:"facilities",label:"Facilities",sortable:!1,minWidth:260},{key:"start_at",label:"Start",sortable:!0,width:170},{key:"end_at",label:"End",sortable:!0,width:170},{key:"availability_status",label:"Availability",sortable:!0,width:130},{key:"status",label:"Status",sortable:!0,width:120}],w=async y=>{await $(y)},q=T(!1),V=T(!1),j=T(null),B=()=>{q.value=!0},v=async y=>{await t.create(y),q.value=!1,await $({},!0)},c=async y=>{await t.fetchById(y.id);const l=t.selected||y;let i=[],N=[];try{i=Array.isArray(l.facilities)?l.facilities:JSON.parse(l.facilities||"[]")}catch{}try{N=Array.isArray(l.equipment_items)?l.equipment_items:JSON.parse(l.equipment_items||"[]")}catch{}j.value={id:l.id,reference_code:l.reference_code,date_filed:l.date_filed||"",activity_design_id:l.activity_design_id||"",facilities:i,equipment_items:N,utilization_details:l.utilization_details||"",start_date:l.start_date||String(l.start_at||"").slice(0,10),start_time:l.start_time||(l.start_at?new Date(l.start_at).toTimeString().slice(0,5):""),end_date:l.end_date||String(l.end_at||"").slice(0,10),end_time:l.end_time||(l.end_at?new Date(l.end_at).toTimeString().slice(0,5):""),status:l.status||"draft",availability_status:l.availability_status||"pending-check",remarks:l.remarks||""},V.value=!0},r=async y=>{const{id:l,...i}=y;await t.updateById(l,i),V.value=!1,await $({},!0)},U=async y=>{if(!y?.id)return;(await k.fire({title:`Delete utilization "${y.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await t.deleteById(y.id),await $({},!0),await k.fire("Deleted","The utilization request has been deleted.","success"))},Y=async y=>{await c(y)},W=async y=>{if((await k.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await t.submit(y.id),await $({},!0),await k.fire("Submitted","Utilization request is now pending approval.","success")}catch{await k.fire("Error",t.error||"Failed to submit request.","error")}},le=async y=>{const l=await k.fire({title:"Approve utilization?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const i=l.value||"";try{await t.approve(y.id,i),await $({},!0),await k.fire("Approved","Utilization has been approved and reserved.","success")}catch{await k.fire("Error",t.error||"Failed to approve request.","error")}},ne=async y=>{const l=await k.fire({title:"Reject utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:N=>N?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const i=l.value;try{await t.reject(y.id,i),await $({},!0),await k.fire("Rejected","Utilization has been rejected.","success")}catch{await k.fire("Error",t.error||"Failed to reject request.","error")}},ae=async y=>{const l=await k.fire({title:"Cancel utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:N=>N?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Utilization",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(!l.isConfirmed)return;const i=l.value;try{await t.cancel(y.id,i),await $({},!0),await k.fire("Cancelled","Utilization has been cancelled.","success")}catch{await k.fire("Error",t.error||"Failed to cancel request.","error")}},m=async y=>{if(String(y?.status||"").toLowerCase()!=="approved"){await k.fire("Not allowed","Only approved utilization request can be printed.","info");return}try{await t.fetchById(y.id);const i=t.selected||y;await Ma(i)}catch(i){await k.fire("Error",t.error||"Failed to generate PDF.","error"),console.error(i)}},n=T(!1),u=T(null),E=async y=>{await t.fetchById(y.id),u.value=t.selected||y,n.value=!0},s=T(""),x=T("08:00"),S=T(""),M=T("10:00"),ie=T([]),oe=async()=>{const y=(ie.value||[]).filter(l=>f.includes(l));if(!s.value||!S.value||!y.length){await k.fire("Missing fields","Start/End dates and at least one facility are required.","info");return}try{const l=await t.checkAvailability({start_date:s.value,start_time:x.value||"00:00",end_date:S.value,end_time:M.value||"00:00",facilities:y}),i=l.available_for_all?"All selected facilities are available.":`Conflicts on: ${(l.conflict_facilities||[]).join(", ")||"—"}`;await k.fire({icon:l.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(l.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${i}</div>
        <div class="mt-2"><strong>Conflicts:</strong> ${Array.isArray(l.conflicts)&&l.conflicts.length?`<ul class="list-disc ml-5">${l.conflicts.map(N=>`<li>${N.reference_code} — ${new Date(N.start_at).toLocaleString()} to ${new Date(N.end_at).toLocaleString()}</li>`).join("")}</ul>`:"None"}</div>
      </div>`})}catch(l){await k.fire("Error",t.error||"Failed to check availability.","error"),console.error(l)}},re=T([]),ce=async()=>{_.value.facilities_any=(re.value||[]).slice(),await $({page:1})},Ee=async()=>{re.value=[],await $({q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[],page:1})};return(y,l)=>(b(),h(ee,null,[J(Je,null,{default:se(()=>[J(Ke,null,{default:se(()=>[O(t).error?(b(),ge(st,{key:0,icon:O(Qe),color:"danger"},{default:se(()=>[G(A(O(t).error),1)]),_:1},8,["icon"])):I("",!0),J(lt,{icon:O(He),title:"Utilization Requests",main:""},{default:se(()=>[a("div",Wa,[J(he,{icon:O(Xe),color:"primary",label:"New Request",onClick:B},null,8,["icon"]),J(he,{icon:O(Ze),color:"info",label:"Refresh",onClick:l[0]||(l[0]=i=>$({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),a("div",Ga,[a("div",Ja,[(b(),h("svg",Ka,[a("path",{d:O(et)},null,8,Qa)])),l[18]||(l[18]=a("span",{class:"font-medium text-sm"},"Filters",-1))]),a("div",Ha,[a("div",Xa,[z(a("input",{"onUpdate:modelValue":l[1]||(l[1]=i=>_.value.q=i),placeholder:"Search by ref, details, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:l[2]||(l[2]=Re(i=>$({page:1}),["enter"]))},null,544),[[X,_.value.q]]),a("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:l[3]||(l[3]=i=>$({page:1}))},[(b(),h("svg",Za,[a("path",{d:O(tt)},null,8,es)]))])]),z(a("select",{"onUpdate:modelValue":l[4]||(l[4]=i=>_.value.status=i),class:"border rounded px-2 py-2"},[l[19]||(l[19]=a("option",{value:""},"All status",-1)),(b(),h(ee,null,te(L,i=>a("option",{key:i,value:i},A(i),9,ts)),64))],512),[[ue,_.value.status]]),z(a("select",{"onUpdate:modelValue":l[5]||(l[5]=i=>_.value.availability_status=i),class:"border rounded px-2 py-2"},[l[20]||(l[20]=a("option",{value:""},"Any availability",-1)),(b(),h(ee,null,te(o,i=>a("option",{key:i,value:i},A(i),9,as)),64))],512),[[ue,_.value.availability_status]]),a("div",ss,[J(O(_e),be({modelValue:p.value,"onUpdate:modelValue":l[6]||(l[6]=i=>p.value=i)},g,{placeholder:"Start date range"}),null,16,["modelValue"])]),a("div",ls,[J(O(_e),be({modelValue:F.value,"onUpdate:modelValue":l[7]||(l[7]=i=>F.value=i)},g,{placeholder:"End date range"}),null,16,["modelValue"])]),a("div",is,[l[21]||(l[21]=a("label",{class:"block text-[11px] text-gray-600 mb-1"},"Facilities (any)",-1)),z(a("select",{"onUpdate:modelValue":l[8]||(l[8]=i=>re.value=i),multiple:"",class:"w-full border rounded px-2 py-2 min-h-[38px]"},[(b(),h(ee,null,te(f,i=>a("option",{key:i,value:i},A(i),9,ns)),64))],512),[[ue,re.value]])]),a("div",{class:"flex items-center gap-2 md:col-span-2"},[a("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:ce}," Apply Filters "),a("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:Ee},"Reset")])])]),a("div",os,[a("div",rs,[(b(),h("svg",ds,[a("path",{d:O(at)},null,8,us)])),l[22]||(l[22]=a("span",{class:"font-medium text-sm"},"Quick Availability Check",-1))]),a("div",cs,[a("div",ms,[z(a("input",{"onUpdate:modelValue":l[9]||(l[9]=i=>s.value=i),type:"date",class:"border rounded px-2 py-2 w-full",placeholder:"Start date"},null,512),[[X,s.value]])]),a("div",ps,[z(a("input",{"onUpdate:modelValue":l[10]||(l[10]=i=>x.value=i),type:"time",class:"border rounded px-2 py-2 w-full",placeholder:"Start time"},null,512),[[X,x.value]])]),a("div",fs,[z(a("input",{"onUpdate:modelValue":l[11]||(l[11]=i=>S.value=i),type:"date",class:"border rounded px-2 py-2 w-full",placeholder:"End date"},null,512),[[X,S.value]])]),a("div",vs,[z(a("input",{"onUpdate:modelValue":l[12]||(l[12]=i=>M.value=i),type:"time",class:"border rounded px-2 py-2 w-full",placeholder:"End time"},null,512),[[X,M.value]])]),a("div",ys,[l[23]||(l[23]=a("label",{class:"block text-[11px] text-gray-600 mb-1"},"Facilities",-1)),z(a("select",{"onUpdate:modelValue":l[13]||(l[13]=i=>ie.value=i),multiple:"",class:"w-full border rounded px-2 py-2 min-h-[38px]"},[(b(),h(ee,null,te(f,i=>a("option",{key:i,value:i},A(i),9,gs)),64))],512),[[ue,ie.value]])]),a("div",bs,[a("button",{class:"px-4 py-2 bg-indigo-600 text-white rounded text-xs",onClick:oe}," Check "),a("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:l[14]||(l[14]=(...i)=>y.resetAvailability&&y.resetAvailability(...i))}," Reset ")])])]),J(it,{columns:P,data:D.value,loading:O(t).isLoading,onQueryChange:w},{"cell-facilities":se(({row:i})=>[a("div",_s,[(b(!0),h(ee,null,te((()=>{try{return Array.isArray(i.facilities)?i.facilities:JSON.parse(i.facilities||"[]")}catch{return[]}})(),(N,qe)=>(b(),ge(me,{key:qe,text:N,tone:"slate"},null,8,["text"]))),128)),i.facilities&&JSON.parse(i.facilities||"[]").length?I("",!0):(b(),h("span",hs,"—"))])]),"cell-start_at":se(({value:i})=>[a("span",null,A(i?new Date(i).toLocaleString():"—"),1)]),"cell-end_at":se(({value:i})=>[a("span",null,A(i?new Date(i).toLocaleString():"—"),1)]),"cell-availability_status":se(({value:i})=>[J(me,{text:i||"—",tone:R(i)},null,8,["text","tone"])]),"cell-status":se(({value:i})=>[J(me,{text:i||"—",tone:C(i)},null,8,["text","tone"])]),"cell-actions":se(({row:i})=>[J(Oe,{row:i,moderator:["admin","manager"].includes(String(O(d).user?.role||"").toLowerCase()),onAttachments:E,onSubmit:W,onApprove:le,onReject:ne,onEdit:c,onDelete:U,onView:N=>Y(i),onCancel:ae,onPrint:m},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),J(Se,{modelValue:q.value,"onUpdate:modelValue":l[15]||(l[15]=i=>q.value=i),mode:"create",onSubmit:v},null,8,["modelValue"]),J(Se,{modelValue:V.value,"onUpdate:modelValue":l[16]||(l[16]=i=>V.value=i),mode:"edit",initial:j.value||{},onSubmit:r},null,8,["modelValue","initial"]),J(Ia,{modelValue:n.value,"onUpdate:modelValue":l[17]||(l[17]=i=>n.value=i),row:u.value},null,8,["modelValue","row"])],64))}};export{ks as default};
