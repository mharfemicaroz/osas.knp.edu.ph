import{c as m,u as Q,r as w,o as W,x as X,G as Z,a as d,d as y,q as r,e,t as p,k as x,h as b,C as P,F as V,B as $,j as C,v as h,N as ee,S as N}from"./index.Cn36LOKA.js";import{u as te}from"./annualPlan.DYAoXs3f.js";const ae={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},se={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[1400px] max-h-screen overflow-auto"},le={class:"flex items-center justify-between mb-3"},ne={class:"flex items-center gap-3"},oe={class:"text-lg font-semibold"},de={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},re={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},ue={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},ie=["disabled"],ce=["value"],pe={key:0,class:"text-[11px] text-red-600 mt-1"},me=["disabled"],be=["value"],_e={key:0,class:"text-[11px] text-red-600 mt-1"},ve={class:"mt-4"},fe={class:"flex items-center justify-between"},ye=["disabled"],xe={key:0,class:"text-[12px] text-red-600 mb-1"},he={class:"mt-1 border rounded overflow-hidden"},ge={class:"w-full text-xs"},ke={class:"p-2"},we=["onUpdate:modelValue","disabled"],Ce={class:"p-2"},Se=["onUpdate:modelValue","disabled"],Ae={class:"p-2"},Ve=["onUpdate:modelValue","disabled"],$e={class:"p-2"},Ne=["onUpdate:modelValue","disabled"],Ue={class:"p-2"},Ye=["onUpdate:modelValue","disabled"],Ie={class:"p-2"},Pe=["onUpdate:modelValue","disabled"],De={class:"p-2 text-right"},Oe=["disabled","onClick"],Fe={class:"mt-2 text-right text-sm"},Re={class:"flex justify-end gap-2 mt-5"},Be={key:1,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs"},Me={__name:"AnnualPlanFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},lockedClubId:{type:[String,Number],default:""},initial:{type:Object,default:()=>({id:null,reference_code:"",school_year:"",club_id:"",filed_by_user_id:"",approver_user_id:null,plans:[],remarks:"",status:"draft"})}},emits:["update:modelValue","submit"],setup(U,{emit:D}){const c=U,Y=D,S=m({get:()=>c.modelValue,set:a=>Y("update:modelValue",a)}),_=Q(),A=te(),O=m(()=>String(_.user?.role||"").toLowerCase()==="admin"),F=m(()=>{const a=new Date().getFullYear();return Array.from({length:6},(t,o)=>`${a-o}-${a-o+1}`)}),g=w([]),R=async()=>{try{const{data:a}=await ee.get("/clubs",{params:{page:1,limit:500,order:"ASC",sort:"name"}});g.value=Array.isArray(a?.data)?a.data:[]}catch{g.value=[]}};W(async()=>{await R(),c.lockedClubId&&(l.value.club_id=Number(c.lockedClubId))});const l=w(structuredClone(c.initial)),u=w({}),v=w([]),I=a=>{if(!a)return[];if(Array.isArray(a))return a;try{return JSON.parse(a||"[]")||[]}catch{return[]}},k=m(()=>{const a=_.user?.last_name||"",t=(_.user?.first_name||"").slice(0,1);return`${a}${a?", ":""}${t?t+".":""}`});X(()=>c.initial,async a=>{let t=a?.plans;try{t=Array.isArray(t)?t:JSON.parse(t||"[]")}catch{t=[]}if(l.value={...a,filed_by_user_id:a?.filed_by_user_id||_.user?.id||"",plans:Array.isArray(t)?t:[]},u.value={},v.value=I(a?.remarks),c.mode==="edit"&&(a?.id||l.value?.id)&&v.value.some(s=>s&&s.is_read===!1)){v.value=v.value.map(s=>({...s,is_read:!0}));try{await A.updateById(a?.id||l.value.id,{remarks:JSON.stringify(v.value)})}catch{}}},{immediate:!0});const n=m(()=>c.mode==="edit"&&String(l.value.status||"").toLowerCase()!=="draft"),B=m(()=>c.mode!=="edit"?"New Annual Plan":n.value?"View Annual Plan (read-only)":"Edit Annual Plan"),j=m(()=>c.mode==="edit"?"Save Changes":"Create"),L=a=>Number(a||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),M=a=>Number.isFinite(+a)?+a:0,T=m(()=>Array.isArray(l.value.plans)?l.value.plans.reduce((a,t)=>a+M(t?.funds),0):0),E=()=>{Array.isArray(l.value.plans)||(l.value.plans=[]),l.value.plans.push({item:"",description:"",date_of_implementation:"",funds:0,venue:"",notes:""})},J=a=>{l.value.plans.splice(a,1)},q=/^\d{4}-\d{4}$/,z=()=>{if(n.value)return!1;const a={};return(!l.value.school_year||!q.test(l.value.school_year))&&(a.school_year="Format: YYYY-YYYY"),l.value.club_id||(a.club_id="Required"),(!Array.isArray(l.value.plans)||!l.value.plans.length)&&(a.plans="Add at least one plan item"(l.value.plans||[]).forEach((t,o)=>{t.item||(a[`plans_${o}_item`]="Required"),t.date_of_implementation||(a[`plans_${o}_date`]="Required"),t.funds!=null&&Number(t.funds)<0&&(a[`plans_${o}_funds`]="Must be ≥ 0")})),u.value=a,Object.keys(a).length===0},G=()=>{if(n.value||!z())return;const a={...l.value};!a.filed_by_user_id&&_.user?.id&&(a.filed_by_user_id=_.user.id);const t=c.mode!=="edit"?"created annual plan":"updated annual plan";v.value.push({user_id:_.user?.id||null,user_name:k.value,message:`${k.value} ${t}.`,datetime:new Date().toISOString(),is_read:!1}),a.remarks=JSON.stringify(v.value),Y("submit",a)},H=m(()=>c.mode==="edit"&&O.value&&String(l.value.status||"").toLowerCase()==="pending"),K=async()=>{if(!l.value?.id)return;const{value:a,isConfirmed:t}=await N.fire({title:"Cancel Annual Plan?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Reason for cancellation",showCancelButton:!0,confirmButtonText:"Cancel Plan",confirmButtonColor:"#dc2626"});if(t)try{const o=I(l.value?.remarks),s=`${k.value} cancelled annual plan.${a?" - "+a:""}`;o.push({user_id:_.user?.id||null,user_name:k.value,message:s,datetime:new Date().toISOString()});const f=await A.cancel(l.value.id,JSON.stringify(o));l.value={...l.value,...f||{},status:"draft"},await N.fire("Cancelled","Annual Plan has been cancelled.","success")}catch{await N.fire("Error",A.error||"Failed to cancel annual plan.","error")}};return(a,t)=>{const o=Z("pending-click");return S.value?(r(),d("div",ae,[e("div",se,[e("div",le,[e("div",ne,[e("h2",oe,p(B.value),1),e("span",de,p(l.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:t[0]||(t[0]=s=>S.value=!1)},"Close")]),n.value?(r(),d("div",re,[t[4]||(t[4]=x(" This plan is ",-1)),e("strong",null,p(l.value.status),1),t[5]||(t[5]=x(". Editing is disabled. ",-1))])):y("",!0),e("div",ue,[e("div",null,[t[7]||(t[7]=e("label",{class:"block mb-1"},[x("School Year "),e("span",{class:"text-red-500"},"*")],-1)),b(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>l.value.school_year=s),class:"w-full border rounded px-2.5 py-2",disabled:n.value},[t[6]||(t[6]=e("option",{value:""},"Select school year…",-1)),(r(!0),d(V,null,$(F.value,s=>(r(),d("option",{key:s,value:s},p(s),9,ce))),128))],8,ie),[[P,l.value.school_year]]),u.value.school_year?(r(),d("p",pe,p(u.value.school_year),1)):y("",!0)]),e("div",null,[t[9]||(t[9]=e("label",{class:"block mb-1"},[x("Club "),e("span",{class:"text-red-500"},"*")],-1)),b(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>l.value.club_id=s),class:C(["w-full border rounded px-2.5 py-2",u.value.club_id?"border-red-500":""]),disabled:n.value||!g.value.length||!!U.lockedClubId},[t[8]||(t[8]=e("option",{value:""},"Select club…",-1)),(r(!0),d(V,null,$(g.value,s=>(r(),d("option",{key:s.id,value:s.id},p(s.name)+" ("+p(s.code)+") ",9,be))),128))],10,me),[[P,l.value.club_id]]),u.value.club_id?(r(),d("p",_e,p(u.value.club_id),1)):y("",!0)])]),e("div",ve,[e("div",fe,[t[10]||(t[10]=e("label",{class:"block mb-1 font-medium"},[x("Plan Items "),e("span",{class:"text-red-500"},"*")],-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:n.value,onClick:E},"Add Item",8,ye)]),u.value.plans?(r(),d("p",xe,p(u.value.plans),1)):y("",!0),e("div",he,[e("table",ge,[t[11]||(t[11]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Description"),e("th",{class:"text-left p-2"},"Date of Implementation"),e("th",{class:"text-left p-2"},"Funds"),e("th",{class:"text-left p-2"},"Venue"),e("th",{class:"text-left p-2"},"Notes"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(r(!0),d(V,null,$(l.value.plans,(s,f)=>(r(),d("tr",{key:f,class:"border-t"},[e("td",ke,[b(e("input",{"onUpdate:modelValue":i=>s.item=i,class:C(["w-40 border rounded px-2 py-1",u.value[`plans_${f}_item`]?"border-red-500":""]),disabled:n.value,placeholder:"Item name"},null,10,we),[[h,s.item]])]),e("td",Ce,[b(e("input",{"onUpdate:modelValue":i=>s.description=i,class:"w-60 border rounded px-2 py-1",disabled:n.value,placeholder:"Short description"},null,8,Se),[[h,s.description]])]),e("td",Ae,[b(e("input",{type:"date","onUpdate:modelValue":i=>s.date_of_implementation=i,class:C(["border rounded px-2 py-1",u.value[`plans_${f}_date`]?"border-red-500":""]),disabled:n.value,placeholder:"YYYY-MM-DD"},null,10,Ve),[[h,s.date_of_implementation]])]),e("td",$e,[b(e("input",{type:"number",step:"0.01",min:"0","onUpdate:modelValue":i=>s.funds=i,class:C(["w-28 border rounded px-2 py-1",u.value[`plans_${f}_funds`]?"border-red-500":""]),disabled:n.value,placeholder:"0.00"},null,10,Ne),[[h,s.funds,void 0,{number:!0}]])]),e("td",Ue,[b(e("input",{"onUpdate:modelValue":i=>s.venue=i,class:"w-40 border rounded px-2 py-1",disabled:n.value,placeholder:"Venue / location"},null,8,Ye),[[h,s.venue]])]),e("td",Ie,[b(e("input",{"onUpdate:modelValue":i=>s.notes=i,class:"w-52 border rounded px-2 py-1",disabled:n.value,placeholder:"Notes (optional)"},null,8,Pe),[[h,s.notes]])]),e("td",De,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:n.value,onClick:i=>J(f)},"Remove",8,Oe)])]))),128))])])]),e("div",Fe,[t[12]||(t[12]=e("span",{class:"mr-4"},"Client total (preview):",-1)),e("strong",null,p(L(T.value)),1),t[13]||(t[13]=e("p",{class:"text-[11px] text-gray-500 mt-1"},"Server recalculates total_budget on save.",-1))])]),e("div",Re,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[3]||(t[3]=s=>S.value=!1)},"Close"),H.value?(r(),d("button",{key:0,class:"px-4 py-2 bg-red-600 text-white rounded text-xs",onClick:K}," Cancel Plan ")):y("",!0),n.value?y("",!0):b((r(),d("button",Be,[x(p(j.value),1)])),[[o,G]])])])])):y("",!0)}}};export{Me as _};
