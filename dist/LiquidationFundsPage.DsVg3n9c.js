import{c as H,r as R,x as Fe,a as w,d as J,q as x,e as s,k as G,t as T,j as de,g as A,F as ue,B as ge,S as v,u as Te,z as ke,o as Ee,f as E,l as L,h as Q,v as ne,A as Re,M as $e,C as Be,Q as De}from"./index.BiRlO2qs.js";import{E as Ne,a as C,d as he,Q as Oe,_ as Pe}from"./dayjs.min.YD6aXnVN.js";import{B as Ie,E as Le,F as Ue,G as Ye,H as Me,I as Ve,C as ze,D as je,z as qe,_ as We,a as Ge,g as Je,J as He,K as Ke,L as Qe,M as Xe,V as Ze}from"./SectionMain.BBFX33SJ.js";import{_ as et,a as me}from"./SectionTitleLineWithButton.asIt1xkD.js";import{_ as tt,B as at,a as it}from"./Badge.BIgmlBhl.js";import{_ as fe}from"./LiquidationFundFormModal.DjbBRw5K.js";import{u as _e}from"./liquidationFund.DfJbXQKI.js";import{u as nt}from"./clubScope.JJLzrS1R.js";import{Q as ot}from"./browser.DyRfEmcM.js";import{_ as st}from"./StatusTrailModal.DMuA1MlL.js";import"./IconifyButton.DP1J64iI.js";import"./appContext.CLfG1v8y.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";import"./activityDesignService.CPY7Xbb1.js";import"./utilizationRequestService.r_qZRy2p.js";import"./liquidationFundService.DAvk-OsF.js";import"./ToasterComponent.BXwuoPoD.js";import"./activityDesign.CyLx0Gic.js";import"./club.BTPgQUot.js";const lt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},rt={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},dt={class:"flex items-center justify-between mb-3"},ut={class:"text-lg font-semibold"},ct={class:"text-gray-600"},mt={class:"flex items-center justify-between gap-2"},ft={class:"text-sm text-gray-600"},pt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},yt=["d"],gt=["disabled"],ht={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},_t={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},bt=["src"],vt={key:1,class:"flex items-center justify-center w-full h-full"},xt=["d"],wt={class:"mt-2 text-xs"},St=["title"],Ct={class:"text-gray-500 flex items-center justify-between"},At={key:0},Ft={key:0},Tt={class:"mt-2 flex items-center justify-between gap-2"},kt=["onClick","title"],Et={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Rt=["d"],$t=["onClick"],Bt={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24"},Dt=["d"],Nt={key:0,class:"mt-6 text-center text-sm text-gray-500"},Ot=10*1024*1024,Pt={__name:"LiquidationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(e,{emit:i}){const c=e,r=i,f=H({get:()=>c.modelValue,set:a=>r("update:modelValue",a)}),g=_e(),l=R(null),p=R(!1),N=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),z=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),O=(a="")=>String(a).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",U=(a="")=>typeof a=="string"&&a.match(/^data:([^;]+);base64,/i)?.[1]||"",_=a=>{const d=a?.type&&N.has(a.type),u=a?.name&&z.has(O(a.name));return d||u},$=(a="")=>String(a).startsWith("image/"),y=(a="")=>a==="application/pdf",m=(a="")=>a==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",S=(a="")=>a==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",D=(a="")=>y(a)?Le:m(a)?Ue:S(a)?Ye:$(a)?Me:Ve,P=(a="")=>y(a)?"PDF":m(a)?"Word":S(a)?"Excel":$(a)?"Image":"File",F=(a="")=>y(a)?"pdf":m(a)?"docx":S(a)?"xlsx":a==="image/png"?"png":a==="image/jpeg"?"jpg":a==="image/webp"?"webp":"",B=(a="attachment",d="")=>/\.[a-z0-9]+$/i.test(a)?a:d?`${a}.${d.startsWith(".")?d.slice(1):d}`:a,k=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,I=H(()=>{const a=l.value?.attachments;if(!a)return[];try{return Array.isArray(a)?a:JSON.parse(a||"[]")}catch{return[]}}),Z=H(()=>(I.value||[]).map((a,d)=>{const u=a.mime||U(a.data)||(a.name?O(a.name)==="pdf"&&"application/pdf":"")||"",h=O(a.name||"")||F(u),Y=a.size??null,M=a.name||`${P(u)} ${d+1}`;return{id:a.id??d+1,name:M,data:a.data||"",url:a.url||a.href||a.path||"",mime:u,ext:h,size:Y,filename:B(M,h)}}));Fe(()=>c.modelValue,async a=>{a&&c.row?.id&&(await g.fetchById(c.row.id),l.value=g.selected||c.row)});const j=async a=>{const d=a.target.files?.[0];if(a.target.value="",!(!d||!l.value?.id)){if(d.size>Ot){await v.fire("File too large","Maximum size is 10 MB.","warning");return}if(!_(d)){await v.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{p.value=!0,await g.uploadAttachment(l.value.id,d),await g.fetchById(l.value.id),l.value=g.selected}finally{p.value=!1}}},q=async a=>{!l.value?.id||!(await v.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await g.deleteAttachment(l.value.id,a),await g.fetchById(l.value.id),l.value=g.selected)},ee=a=>{if(a.data&&String(a.data).startsWith("data:")&&$(a.mime)){const d=window.open();d&&d.document.write(`<img src="${a.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}a.url&&window.open(String(a.url),"_blank")},oe=a=>{const[d,u]=a.split(","),h=d.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",Y=atob(u),M=new Uint8Array(Y.length);for(let W=0;W<Y.length;W++)M[W]=Y.charCodeAt(W);return new Blob([M],{type:h})},te=(a,d)=>{const u=URL.createObjectURL(a),h=document.createElement("a");h.href=u,h.download=d||"download",document.body.appendChild(h),h.click(),h.remove(),setTimeout(()=>URL.revokeObjectURL(u),1e3)},ae=async a=>{if(a.data&&String(a.data).startsWith("data:")){const d=oe(a.data);te(d,a.filename);return}if(a.url)try{const u=await(await fetch(a.url,{credentials:"include"})).blob();te(u,a.filename)}catch{const d=document.createElement("a");d.href=String(a.url),d.setAttribute("download",a.filename),document.body.appendChild(d),d.click(),d.remove()}},ie=a=>$(a.mime)?"Open":"Download",se=a=>$(a.mime)?ze:je,le=a=>$(a.mime)?ee(a):ae(a);return(a,d)=>f.value?(x(),w("div",lt,[s("div",rt,[s("div",dt,[s("h2",ut,[d[1]||(d[1]=G(" Liquidation Attachments — ",-1)),s("span",ct,T(l.value?.reference_code||""),1)]),s("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:d[0]||(d[0]=u=>f.value=!1)},"Close")]),s("div",mt,[s("div",ft,[d[2]||(d[2]=G(" Activity: ",-1)),s("strong",null,T(l.value?.activity_design?.name_of_activity||"—"),1)]),s("label",{class:de(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":p.value}])},[(x(),w("svg",pt,[s("path",{d:A(Ie)},null,8,yt)])),s("span",null,T(p.value?"Uploading…":"Upload"),1),s("input",{type:"file",class:"hidden",disabled:p.value,onChange:j,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,gt)],2)]),s("div",ht,[(x(!0),w(ue,null,ge(Z.value,u=>(x(),w("div",{key:u.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[s("div",_t,[u.data&&u.data.startsWith("data:")&&u.mime?.startsWith("image/")?(x(),w("img",{key:0,src:u.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,bt)):(x(),w("div",vt,[(x(),w("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24",class:de({"text-red-600":u.mime==="application/pdf","text-blue-600":u.mime==="application/vnd.openxmlformats-officedocument.wordprocessingml.document","text-emerald-600":u.mime==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text-gray-500":!u.mime||!u.mime.startsWith("image/")&&u.mime!=="application/pdf"})},[s("path",{d:D(u.mime)},null,8,xt)],2))]))]),s("div",wt,[s("div",{class:"font-medium truncate",title:u.name},T(u.name),9,St),s("div",Ct,[s("span",null,[G(T(P(u.mime))+" ",1),u.ext?(x(),w("span",At,"("+T(u.ext.toUpperCase())+")",1)):J("",!0)]),u.size?(x(),w("span",Ft,T(k(u.size)),1)):J("",!0)])]),s("div",Tt,[s("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:h=>le(u),title:ie(u)},[(x(),w("svg",Et,[s("path",{d:se(u)},null,8,Rt)])),G(" "+T(ie(u)),1)],8,kt),s("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:h=>q(u.id),title:"Remove"},[(x(),w("svg",Bt,[s("path",{d:A(qe)},null,8,Dt)])),d[3]||(d[3]=G(" Remove ",-1))],8,$t)])]))),128))]),Z.value.length?J("",!0):(x(),w("div",Nt," No attachments yet. "))])])):J("",!0)}},It="KOLEHIYO NG PANTUKAN",Lt="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",Ut="https://osas.knp.edu.ph/#/verify-liquidation?id=",X=e=>e?he(e).format("MMMM DD, YYYY"):"—",V=(e,i=2)=>e==null||e===""||Number.isNaN(Number(e))?"—":Number(e).toLocaleString(void 0,{minimumFractionDigits:i,maximumFractionDigits:i}),pe=(e,i)=>{if(Array.isArray(e)||e&&typeof e=="object")return e;try{return JSON.parse(e||"null")??i}catch{return i}},be="./",Yt=`${be}images/logo.png`,Mt=`${be}images/bg.jpg`;async function ye(e){try{const c=await(await fetch(e)).blob();return new Promise(r=>{const f=new FileReader;f.onloadend=()=>r(f.result),f.readAsDataURL(c)})}catch{return null}}function Vt(e){switch(e){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}async function zt(e){const i=e.internal.pageSize.getWidth(),c=110,r=36,f=await ye(Mt);f?(e.addImage(f,"JPEG",0,0,i,c,void 0,"FAST"),e.setGState(new e.GState({opacity:.18})),e.setFillColor(0,0,0),e.rect(0,0,i,c,"F"),e.setGState(new e.GState({opacity:1}))):(e.setFillColor(21,62,121),e.rect(0,0,i,c,"F"));const g=await ye(Yt);return g&&e.addImage(g,"PNG",r,20,70,70,void 0,"FAST"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(20),e.text(It,r+86,38),e.setFont("helvetica","normal"),e.setFontSize(10),e.text(Lt,r+86,58),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(14),e.text("LIQUIDATION FUND",i/2,c+24,{align:"center"}),c+34}async function jt(e,i,c){const r=e.internal.pageSize.getWidth(),f=36,g=i?.id??i?.reference_code??"",l=`${Ut}${encodeURIComponent(String(g))}`,p=await ot.toDataURL(l,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),N=String(i.status||"").toUpperCase(),[z,O,U]=Vt(N),_=i.approved_at?X(i.approved_at):i.date_filed?X(i.date_filed):"—",$=`osas.knp.edu.ph/#/verify-liquidation?id=${String(g)}`;return C(e,{startY:c,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:f,right:f},tableWidth:r-f*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:r-f*2-260},1:{cellWidth:260}},didDrawCell:y=>{if(y.section!=="body")return;const{x:m,y:S,width:D,height:P}=y.cell,F=10;if(y.column.index===0){e.setFillColor(255,255,255),e.roundedRect(m,S,D-1,P,6,6,"F");const B=24,k=Math.min(180,D-22);e.setFillColor(z,O,U),e.roundedRect(m+F,S+F,k,B,12,12,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text(N||"STATUS",m+F+10,S+F+16),e.setTextColor(20),e.setFont("helvetica","normal"),e.setFontSize(9);let I=S+F+B+16;e.text(`Ref No.: ${i.reference_code||"—"}`,m+F,I),I+=16,e.text(`Date Filed: ${X(i.date_filed)}`,m+F,I),I+=16,e.text(`Date Issued: ${_}`,m+F,I),e.setDrawColor(230),e.roundedRect(m,S,D-1,P,6,6,"S")}if(y.column.index===1){e.setFillColor(255,255,255),e.roundedRect(m,S,D-1,P,6,6,"F"),e.setFillColor(66,103,178),e.roundedRect(m,S,D-1,22,6,6,"F"),e.setTextColor(255,255,255),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("VERIFY",m+F,S+15);const B=m+F,k=S+28;e.addImage(p,"PNG",B,k,75,75,void 0,"FAST"),e.setTextColor(20),e.setFont("helvetica","bold"),e.setFontSize(10),e.text("Scan to verify",B+100,k+14),e.setFont("helvetica","normal"),e.setFontSize(9),e.text("This document can be verified",B+100,k+32),e.text("online via the OSAS portal.",B+100,k+46),e.setTextColor(110),e.setFontSize(8),e.text($,B+100,k+72),e.setDrawColor(230),e.roundedRect(m,S,D-1,P,6,6,"S")}}}),e.lastAutoTable.finalY}async function ve(e){const i=new Ne({unit:"pt",format:[612,936],orientation:"landscape"}),c=i.internal.pageSize.getWidth(),r=36,f=pe(e.sources_of_fund,{}),g=pe(e.uses_of_fund,[]);let l=await zt(i);l=await jt(i,e,l)+10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY;const p=e.activity_design||{};C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},p.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},X(p.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},p.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},p.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},p.office_department||p?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),l=i.lastAutoTable.finalY+10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SUMMARY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY,C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["Total Sources",V(e.total_sources_amount,2)],["Total Uses",V(e.total_uses_amount,2)],["Total Cash on Hand",V(e.total_cash_on_hand,2)]],columnStyles:{0:{cellWidth:220,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:r,right:r}}),l=i.lastAutoTable.finalY+10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SOURCES OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY;const N=[["Contribution",f.contribution],["Payment from Fines",f.payment_from_fines],["Solicitations",f.solicitations],["Donations",f.donations],["Other Sources",f.other_sources],["Current Available Funds",f.current_available_funds]];C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PARTICULAR","AMOUNT"]],body:N.map(([y,m])=>[y,V(m,2)]),columnStyles:{0:{cellWidth:320},1:{cellWidth:"auto",halign:"right"}},margin:{left:r,right:r}}),l=i.lastAutoTable.finalY,f?.other_sources_note&&(C(i,{startY:l,theme:"plain",styles:{fontSize:9},body:[[{content:`Note: ${String(f.other_sources_note)}`,styles:{cellPadding:6,textColor:[71,85,105]}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY),l+=10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"USE OF FUND",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY,Array.isArray(g)&&g.length?C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["DATE","QTY","UNIT","PARTICULARS","SHEET NO.","AMOUNT","IN-CHARGE"]],body:g.map(y=>[y?.date?X(y.date):"—",V(y?.qty??"",0),y?.unit||"—",y?.particulars||"—",y?.sheet_no||"—",V(y?.amount??"",2),y?.in_charge||"—"]),columnStyles:{0:{cellWidth:82},1:{cellWidth:44,halign:"right"},2:{cellWidth:56},3:{cellWidth:200},4:{cellWidth:76},5:{cellWidth:78,halign:"right"},6:{cellWidth:"auto"}},margin:{left:r,right:r},foot:[["","","","","TOTAL",V(e.total_uses_amount,2),""]],footStyles:{fontStyle:"bold"}}):C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY+10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"REMARKS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY,C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[e.remarks&&String(e.remarks).trim()?e.remarks:"—"]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY+10,C(i,{startY:l,theme:"plain",styles:{fontSize:10},body:[[{content:"SIGNATORIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:r,right:r}}),l=i.lastAutoTable.finalY;const O=String(e?.file_by_user_name||"").trim()||(e?.filed_by?`${e.filed_by.first_name||""} ${e.filed_by.last_name||""}`.trim():""),U=String(e?.noted_by||"").trim(),_=e?.approver?`${e.approver.first_name||""} ${e.approver.last_name||""}`.trim():"";C(i,{startY:l,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PREPARED BY:","NOTED BY:","RECOMMENDING APPROVAL:"]],body:[[O||" ",U||" ",_||" "]],columnStyles:{0:{cellWidth:(c-r*2)/2},1:{cellWidth:"auto"}},didParseCell:y=>{y.section==="body"&&(y.cell.styles.halign="center",y.cell.styles.fontStyle="bold",y.cell.styles.cellPadding={top:16,right:10,bottom:18,left:10})},margin:{left:r,right:r}}),l=i.lastAutoTable.finalY+6,C(i,{startY:l,theme:"plain",styles:{fontSize:10,halign:"center"},body:[[{content:"Approved by: DR. MARY ANN R. ARAULA (Acting College President)"}]],margin:{left:r,right:r}});const $=i.internal.pageSize.getHeight()-20;return i.setFontSize(8),i.setTextColor(120),i.text(`Generated on ${he().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,r,$),i}async function qt(e){(await ve(e)).save(`${e.reference_code||"Liquidation_Fund"}.pdf`)}const Wt={class:"flex items-center gap-2"},Gt={class:"p-2 mb-4 rounded-xl border bg-white/60"},Jt={class:"flex items-center gap-2 mb-2 text-gray-700"},Ht={class:"w-4 h-4",viewBox:"0 0 24 24"},Kt=["d"],Qt={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},Xt={class:"md:col-span-2 flex"},Zt={class:"w-5 h-5",viewBox:"0 0 24 24"},ea=["d"],ta=["value"],aa={class:"md:col-span-2"},ia={class:"flex items-center gap-2 md:col-span-1"},na={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30"},oa={class:"bg-white w-[560px] rounded-xl shadow p-4"},sa={class:"flex items-center justify-between mb-2"},la={class:"grid grid-cols-1 gap-2 text-sm"},ra={class:"flex gap-2"},da={class:"text-[11px] text-gray-600"},ua={class:"mt-3 flex justify-end gap-2"},Ra={__name:"LiquidationFundsPage",setup(e){const i=_e(),c=Te(),r=ke(),f=H(()=>{const o=c.user?.last_name||"",t=(c.user?.first_name||"").slice(0,1);return`${o}${o?", ":""}${t?t+".":""}`}),g=o=>{try{return((Array.isArray(o)?o:JSON.parse(o||"[]")||[])||[]).map(n=>(!n||typeof n!="object"||Array.isArray(n.read_by)||(n.read_by=n.user_id!=null?[n.user_id]:[]),n))}catch{return[]}},l={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},p=R({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",activity_design_id:"",filed_by_user_id:"",date_filed_from:"",date_filed_to:""}),N=H({get:()=>{const{date_filed_from:o,date_filed_to:t}=p.value;return o||t?[o||null,t||null]:null},set:o=>{if(!o)p.value.date_filed_from=null,p.value.date_filed_to=null;else{const[t,n]=o;p.value.date_filed_from=t||null,p.value.date_filed_to=n||null}}}),{isClub:z,activeClubId:O,withClub:U}=nt(),_=async(o={},t=!0)=>{p.value={...p.value,...o};const n=U({...p.value});["q","status","activity_design_id","filed_by_user_id","date_filed_from","date_filed_to"].forEach(b=>{(n[b]===""||n[b]==null)&&delete n[b]}),await i.fetchAll(n,t)};Ee(async()=>{await _({page:1,limit:10,club_id:z?O:""})});const $=H(()=>({total:i.items.total||0,totalPages:i.items.totalPages||1,currentPage:i.items.currentPage||1,pageSize:i.items.pageSize||10,data:i.items.data||[]})),y=R(!1),m=R(null),S=async o=>{try{await i.fetchById(o.id),m.value=i.selected||o}catch{m.value=o}y.value=!0},D=async o=>{if(!m.value)return;const t=g(m.value.remarks);t.push({user_id:c.user?.id||null,user_name:f.value,message:o?.message||"",datetime:o?.datetime||new Date().toISOString(),is_read:!1,read_by:[c.user?.id||null]});try{m.value.remarks=JSON.stringify(t)}catch{}try{await i.updateById(m.value.id,{remarks:JSON.stringify(t)}),await _({},!0)}catch{}},P=async()=>{if(!m.value)return;const o=c.user?.id||null,n=g(m.value.remarks).map(b=>{if(!b||b.user_id===o)return b;const K=Array.isArray(b.read_by)?b.read_by.slice():[];return K.includes(o)||K.push(o),{...b,read_by:K}});try{m.value.remarks=JSON.stringify(n)}catch{}try{await i.updateById(m.value.id,{remarks:JSON.stringify(n)}),await _({},!0)}catch{}},F=["draft","pending","approved","rejected","cancelled","completed"],B=o=>{switch(String(o||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},k=o=>{const t=Number(o);return Number.isFinite(t)?t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}):"—"},I=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:240,formatter:(o,t)=>t.activity_design?t.activity_design.name_of_activity:""},{key:"total_sources_amount",label:"Sources",sortable:!0,width:120},{key:"total_uses_amount",label:"Uses",sortable:!0,width:120},{key:"total_cash_on_hand",label:"Cash on Hand",sortable:!0,width:140},{key:"date_filed",label:"Date Filed",sortable:!0,width:120},{key:"status",label:"Status",sortable:!0,width:120}],Z=async o=>{await _(o)},j=R(!1),q=R(!1),ee=R(null),oe=()=>{j.value=!0},te=async o=>{await i.create(o),j.value=!1,await _({},!0)},ae=async o=>{await i.fetchById(o.id);const t=i.selected||o;let n={},b=[];try{n=typeof t.sources_of_fund=="string"?JSON.parse(t.sources_of_fund||"{}"):t.sources_of_fund||{}}catch{}try{b=Array.isArray(t.uses_of_fund)?t.uses_of_fund:JSON.parse(t.uses_of_fund||"[]")}catch{}ee.value={id:t.id,reference_code:t.reference_code,date_filed:t.date_filed||"",activity_design_id:t.activity_design_id||"",file_by_user_name:t.file_by_user_name||"",sources_of_fund:n,uses_of_fund:b,remarks:t.remarks||"",status:t.status||"draft"},q.value=!0},ie=async o=>{const{id:t,...n}=o;await i.updateById(t,n),q.value=!1,await _({},!0)},se=async o=>{if(!o?.id)return;(await v.fire({title:`Delete liquidation "${o.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await i.deleteById(o.id),await _({},!0),await v.fire("Deleted","The liquidation fund has been deleted.","success"))},le=async o=>{await ae(o)},a=async o=>{if((await v.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await i.submit(o.id),await _({},!0),await v.fire("Submitted","Liquidation is now pending approval.","success")}catch{await v.fire("Error",i.error||"Failed to submit.","error")}},d=R(!1),u=R(null),h=R({from_email:"",from_name:"",to:"",subject:"",html:"",attachments:[]}),Y=async o=>{try{await i.fetchById(o.id);const t=i.selected||o,b=(await ve(t)).output("datauristring"),K=String(b).split(",")[1]||"",Ae=`${t.reference_code||"Liquidation_Fund"}.pdf`;u.value=t,h.value={from_email:"osas@knp.edu.ph",from_name:`${c.user?.first_name||""} ${c.user?.last_name||""}`.trim(),to:"",subject:`Liquidation Fund ${t.reference_code||""}`.trim(),html:"Please see the attached file.",attachments:[{filename:Ae,content:K,type:"application/pdf"}]},d.value=!0}catch{await v.fire("Error",i.error||"Failed to prepare email.","error")}},M=async()=>{const o=u.value;if(o)try{await i.sendEmail(o.id,{...h.value}),d.value=!1,await v.fire("Sent","Email sent successfully.","success")}catch{await v.fire("Error",i.error||"Failed to send email.","error")}},W=async o=>{const t=await v.fire({title:"Approve liquidation?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(t.isConfirmed)try{const n=g(o.remarks),b=t.value||"";n.push({user_id:c.user?.id||null,user_name:f.value,message:`${f.value} approved liquidation.${b?" - "+b:""}`,datetime:new Date().toISOString(),is_read:!1,read_by:[c.user?.id||null]}),await i.approve(o.id,JSON.stringify(n)),await _({},!0),await v.fire("Approved","Liquidation has been approved.","success")}catch{await v.fire("Error",i.error||"Failed to approve.","error")}},xe=async o=>{const t=await v.fire({title:"Reject liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(t.isConfirmed)try{const n=g(o.remarks);n.push({user_id:c.user?.id||null,user_name:f.value,message:`${f.value} rejected liquidation - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1,read_by:[c.user?.id||null]}),await i.reject(o.id,JSON.stringify(n)),await _({},!0),await v.fire("Rejected","Liquidation has been rejected.","success")}catch{await v.fire("Error",i.error||"Failed to reject.","error")}},we=async o=>{const t=await v.fire({title:"Cancel liquidation?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:n=>n?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Liquidation",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(t.isConfirmed)try{const n=g(o.remarks);n.push({user_id:c.user?.id||null,user_name:f.value,message:`${f.value} cancelled liquidation - ${t.value}.`,datetime:new Date().toISOString(),is_read:!1,read_by:[c.user?.id||null]}),await i.cancel(o.id,JSON.stringify(n)),await _({},!0),await v.fire("Cancelled","Liquidation has been cancelled.","success")}catch{await v.fire("Error",i.error||"Failed to cancel.","error")}},Se=async o=>{if(String(o?.status||"").toLowerCase()!=="approved"){await v.fire("Not allowed","Only approved liquidation can be printed.","info");return}try{await i.fetchById(o.id);const n=i.selected||o;await qt(n)}catch(n){await v.fire("Error",i.error||"Failed to generate PDF.","error"),console.error(n)}},re=R(!1),ce=R(null),Ce=async o=>{await i.fetchById(o.id),ce.value=i.selected||o,re.value=!0};return(o,t)=>(x(),w(ue,null,[E(We,null,{default:L(()=>[E(Ge,null,{default:L(()=>[A(i).error?(x(),Re(tt,{key:0,icon:A(Je),color:"danger"},{default:L(()=>[G(T(A(i).error),1)]),_:1},8,["icon"])):J("",!0),E(et,{icon:A(He),title:"Liquidation Funds",main:""},{default:L(()=>[s("div",Wt,[E(me,{icon:A(Ke),color:"primary",label:"New Liquidation",onClick:oe},null,8,["icon"]),E(me,{icon:A(Qe),color:"info",label:"Refresh",onClick:t[0]||(t[0]=n=>_({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),s("div",Gt,[s("div",Jt,[(x(),w("svg",Ht,[s("path",{d:A(Xe)},null,8,Kt)])),t[19]||(t[19]=s("span",{class:"font-medium text-sm"},"Filters",-1))]),s("div",Qt,[s("div",Xt,[Q(s("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>p.value.q=n),placeholder:"Search by ref, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:t[2]||(t[2]=$e(n=>_({page:1}),["enter"]))},null,544),[[ne,p.value.q]]),s("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:t[3]||(t[3]=n=>_({page:1}))},[(x(),w("svg",Zt,[s("path",{d:A(Ze)},null,8,ea)]))])]),Q(s("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>p.value.status=n),class:"border rounded px-2 py-2"},[t[20]||(t[20]=s("option",{value:""},"All status",-1)),(x(),w(ue,null,ge(F,n=>s("option",{key:n,value:n},T(n),9,ta)),64))],512),[[Be,p.value.status]]),s("div",aa,[E(A(Oe),De({modelValue:N.value,"onUpdate:modelValue":t[5]||(t[5]=n=>N.value=n)},l,{placeholder:"Date filed range"}),null,16,["modelValue"])]),s("div",ia,[s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:t[6]||(t[6]=n=>_({page:1}))}," Apply Filters "),s("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:t[7]||(t[7]=()=>{p.value.value={page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",date_filed_from:"",date_filed_to:""},_({page:1},!0)})},"Reset")])])]),E(at,{columns:I,data:$.value,loading:A(i).isLoading,onQueryChange:Z},{"cell-total_sources_amount":L(({value:n})=>[s("span",null,T(k(n)),1)]),"cell-total_uses_amount":L(({value:n})=>[s("span",null,T(k(n)),1)]),"cell-total_cash_on_hand":L(({value:n})=>[s("span",{class:de(["font-medium",Number(n)<0?"text-red-600":"text-emerald-700"])},T(k(n)),3)]),"cell-status":L(({value:n})=>[E(it,{text:n||"—",tone:B(n)},null,8,["text","tone"])]),"cell-actions":L(({row:n})=>[E(Pe,{row:n,"current-user-id":A(c).user?.id,moderator:["admin","manager"].includes(String(A(c).user?.role||"").toLowerCase()),onAttachments:Ce,onSubmit:a,onApprove:W,onReject:xe,onRemarks:S,onEdit:ae,onDelete:se,onView:b=>le(n),onCancel:we,onPrint:Se,onEmail:Y},null,8,["row","current-user-id","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),E(fe,{modelValue:j.value,"onUpdate:modelValue":t[8]||(t[8]=n=>j.value=n),mode:"create",onSubmit:te},null,8,["modelValue"]),E(fe,{modelValue:q.value,"onUpdate:modelValue":t[9]||(t[9]=n=>q.value=n),mode:"edit",initial:ee.value||{},onSubmit:ie},null,8,["modelValue","initial"]),E(Pt,{modelValue:re.value,"onUpdate:modelValue":t[10]||(t[10]=n=>re.value=n),row:ce.value},null,8,["modelValue","row"]),E(st,{modelValue:y.value,"onUpdate:modelValue":t[11]||(t[11]=n=>y.value=n),title:"Remarks • "+(m.value?.reference_code||m.value?.activity_design?.name_of_activity||"Item"),items:g(m.value?.remarks),"can-add":!0,onAdd:D,onMarkAllRead:P},null,8,["modelValue","title","items"]),d.value?(x(),w("div",na,[s("div",oa,[s("div",sa,[t[21]||(t[21]=s("h3",{class:"text-base font-semibold"},"Send Email",-1)),s("button",{class:"px-2 py-1 text-xs bg-gray-200 rounded",onClick:t[12]||(t[12]=n=>d.value=!1)},"Close")]),s("div",la,[s("div",null,[t[22]||(t[22]=s("label",{class:"block mb-0.5"},"To",-1)),s("div",ra,[Q(s("input",{"onUpdate:modelValue":t[13]||(t[13]=n=>h.value.to=n),class:"flex-1 border rounded px-2 py-1.5",placeholder:"recipient@example.com"},null,512),[[ne,h.value.to]]),s("button",{class:"px-2 py-1 text-[11px] rounded border bg-gray-50 hover:bg-gray-100",onClick:t[14]||(t[14]=()=>{const n=u.value?.filed_by_user_id||u.value?.filed_by?.id;n&&A(r).fetchById(n).then(()=>{const b=A(r).selectedUser?.email;b&&(h.value.to=b)})})},"Use Filer"),s("button",{class:"px-2 py-1 text-[11px] rounded border bg-rose-50 hover:bg-rose-100",onClick:t[15]||(t[15]=()=>{h.value.attachments=[]})},"Remove Attachment")])]),s("div",null,[t[23]||(t[23]=s("label",{class:"block mb-0.5"},"Subject",-1)),Q(s("input",{"onUpdate:modelValue":t[16]||(t[16]=n=>h.value.subject=n),class:"w-full border rounded px-2 py-1.5"},null,512),[[ne,h.value.subject]])]),s("div",null,[t[24]||(t[24]=s("label",{class:"block mb-0.5"},"Message",-1)),Q(s("textarea",{"onUpdate:modelValue":t[17]||(t[17]=n=>h.value.html=n),rows:"4",class:"w-full border rounded px-2 py-1.5"},null,512),[[ne,h.value.html]])]),s("div",da,"Attachment: "+T(h.value.attachments?.[0]?.filename||"liquidation.pdf"),1)]),s("div",ua,[s("button",{class:"px-3 py-1.5 text-xs bg-gray-200 rounded",onClick:t[18]||(t[18]=n=>d.value=!1)},"Cancel"),s("button",{class:"px-3 py-1.5 text-xs bg-emerald-600 text-white rounded",onClick:M},"Send")])])])):J("",!0)],64))}};export{Ra as default};
