import{c as Y,u as Te,o as be,r as R,E as ue,a as y,d as B,q as f,e,t as w,k as M,h as E,C as de,g as U,j as re,F as Q,B as X,v as J,S as C,f as D,l as ie,A as ge,O as Ve,Q as he}from"./index.BoABrvm7.js";import{E as qe,a as K,d as _e,Q as Ne,b as xe,_ as Oe}from"./browser.Dho54DPN.js";import{B as De,E as ze,F as Ie,G as Le,H as Pe,I as Ye,C as je,D as Me,z as We,_ as Ge,a as Ke,g as Je,J as Qe,i as we,K as He,T as Xe,U as Ze,V as et}from"./SectionMain.fMhQq8Wq.js";import{a as tt,b as at,c as fe,B as it,d as ve}from"./IconifyButton.Du8mikII.js";import{u as pe}from"./utilizationRequest.01g2GJHQ.js";import{u as lt}from"./activityDesign.DMwRquP2.js";import{t as st,u as nt,v as ot,F as rt}from"./index.DctLQwyd.js";import"./ToasterComponent.CMTvAW6n.js";import"./_plugin-vue_export-helper.DlAUqK2U.js";const dt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ut={class:"bg-white p-4 md:p-5 rounded-2xl shadow-xl w-[980px] max-h-screen overflow-auto"},ct={class:"flex items-center justify-between mb-3"},mt={class:"flex items-center gap-3"},pt={class:"text-lg font-semibold"},ft={class:"text-[11px] px-2 py-1 rounded bg-gray-100"},vt={key:0,class:"mb-3 text-xs px-3 py-2 rounded-lg border bg-amber-50 border-amber-200 text-amber-800"},yt={class:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},bt={class:"md:col-span-2"},_t=["disabled"],gt=["value"],ht={key:0,class:"text-red-600 text-[11px] mt-1"},xt={key:1,class:"text-[11px] text-gray-500 mt-1"},wt={key:2,class:"text-[11px] text-amber-700 mt-1"},St={key:0,class:"text-red-600 text-[11px] mt-1"},Ct=["disabled"],At={key:0,class:"text-red-600 text-[11px] mt-1"},$t=["disabled"],kt={key:0,class:"text-red-600 text-[11px] mt-1"},Tt=["disabled"],Bt={key:0,class:"text-red-600 text-[11px] mt-1"},Et={class:"mt-3 text-sm"},Ft={class:"flex gap-2"},Ut=["disabled"],Rt=["value"],Vt=["disabled"],qt={key:0,class:"text-red-600 text-[11px] mt-1"},Nt={class:"mt-2 flex flex-wrap gap-2"},Ot=["onClick"],Dt={key:0,class:"text-gray-400"},zt={class:"mt-4 text-sm"},It={class:"flex items-center justify-between"},Lt=["disabled"],Pt={class:"mt-2 border rounded overflow-hidden"},Yt={class:"w-full text-xs"},jt={class:"p-2"},Mt=["onUpdate:modelValue","disabled","onChange"],Wt=["value"],Gt={key:0,class:"text-red-600 mt-1"},Kt={class:"p-2"},Jt=["onUpdate:modelValue","disabled"],Qt={class:"p-2"},Ht=["onUpdate:modelValue","disabled"],Xt={class:"p-2 text-right"},Zt=["disabled","onClick"],ea={class:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"},ta=["disabled"],aa=["disabled"],ia={class:"mt-3 p-3 rounded-lg border bg-white"},la={class:"flex items-center justify-between"},sa=["disabled"],na={class:"flex justify-end gap-2 mt-5"},Se={__name:"UtilizationRequestFormModal",props:{modelValue:{type:Boolean,default:!1},mode:{type:String,default:"create"},initial:{type:Object,default:()=>({id:null,reference_code:"",date_filed:"",activity_design_id:"",facilities:[],equipment_items:[],utilization_details:"",start_date:"",start_time:"08:00",end_date:"",end_time:"10:00",status:"draft",availability_status:"pending-check",remarks:""})}},emits:["update:modelValue","submit"],setup(t,{emit:s}){const S=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],m=["Sound system","Projector / LCD projector","White screen / projection screen","Microphone (wired & wireless)","Extension cords & power strips","Laptop / desktop computer","Television / monitor","Document camera / visualizer","Laser pointer / presenter remote","National Flag","Department / College / Institutional Flag","Podium / lectern","Cloth décor / backdrops","Banners / tarpaulin stands","Whiteboard markers","Whiteboard erasers","Bulletin boards / pin boards","Chairs","Tables","Stage platforms / risers","Portable tents / canopies","Easel stands","Drums","Xylophone","Guitar","Keyboard","Tambourine","Basketball","Volleyball","Soccer ball / Football","Badminton racket","Badminton shuttlecock","Badminton net","Volleyball net","Whistle","Stopwatch","Beakers","Test tubes","Microscopes","Measuring instruments"],x=t,A=s,p=Y({get:()=>x.modelValue,set:r=>A("update:modelValue",r)}),$=Te(),j=pe(),h=lt(),z=Y(()=>Array.isArray(h.items?.data)?h.items.data.filter(r=>String(r.status).toLowerCase()==="approved"):[]);be(async()=>{await h.fetchAll({page:1,limit:200,status:"approved",officer:!0},!0)});const n=R({...x.initial}),u=R({}),v=Y(()=>{const r=Number(n.value.activity_design_id||0);return z.value.find(o=>Number(o.id)===r)||null});ue(()=>x.initial,r=>{n.value={...r,facilities:Array.isArray(r.facilities)?r.facilities:(()=>{try{return JSON.parse(r.facilities||"[]")}catch{return[]}})(),equipment_items:Array.isArray(r.equipment_items)?r.equipment_items:(()=>{try{return JSON.parse(r.equipment_items||"[]")}catch{return[]}})()},n.value.facilities=(n.value.facilities||[]).filter(o=>S.includes(o)),n.value.equipment_items=(n.value.equipment_items||[]).filter(o=>!o?.name||m.includes(o.name)),u.value={}},{immediate:!0}),ue(()=>n.value.activity_design_id,()=>{const r=v.value;r?.date_of_implementation?n.value.start_date=String(r.date_of_implementation).slice(0,10):n.value.start_date=""},{immediate:!0});const V=Y(()=>String(n.value?.status||"").toLowerCase()),b=Y(()=>x.mode==="edit"&&V.value!=="draft"),I=Y(()=>x.mode!=="edit"?"New Utilization Request":b.value?"View Utilization (read-only)":"Edit Utilization"),Z=Y(()=>x.mode==="edit"?"Save Changes":"Create"),W=r=>{const o=r?.name_of_activity||"Untitled",d=r?.school_year?` • SY ${r.school_year}`:"",T=r?.semester?` • ${r.semester}`:"",i=r?.reference_code?` [${r.reference_code}]`:"";return`${o}${d}${T}${i}`},k=R(""),F=Y(()=>S.filter(r=>!(n.value.facilities||[]).includes(r))),L=()=>{const r=k.value;!r||!S.includes(r)||(Array.isArray(n.value.facilities)||(n.value.facilities=[]),n.value.facilities.includes(r)||n.value.facilities.push(r),k.value="")},H=r=>{n.value.facilities.splice(r,1)},q=()=>{Array.isArray(n.value.equipment_items)||(n.value.equipment_items=[]);const r=new Set((n.value.equipment_items||[]).map(d=>d?.name).filter(Boolean)),o=m.find(d=>!r.has(d))||m[0];r.has(o)||n.value.equipment_items.push({name:o,qty:1,unit:""})},P=r=>{n.value.equipment_items.splice(r,1)},N=r=>{const o=new Set((n.value.equipment_items||[]).map((d,T)=>T===r?null:d?.name).filter(Boolean));return m.filter(d=>!o.has(d))},le=()=>{if(b.value)return!1;const r={};n.value.activity_design_id||(r.activity_design_id="Required"),n.value.start_date||(r.start_date="Start date is required (from Activity Design)"),n.value.start_time||(r.start_time="Required"),n.value.end_date||(r.end_date="Required"),n.value.end_time||(r.end_time="Required"),!Array.isArray(n.value.facilities)||!n.value.facilities.length?r.facilities="Select at least one":n.value.facilities.every(d=>S.includes(d))||(r.facilities="Invalid facility selected");const o=new Set;if(Array.isArray(n.value.equipment_items)&&n.value.equipment_items.forEach((d,T)=>{d?.name&&!m.includes(d.name)&&(r[`equipment_${T}`]="Invalid equipment"),d?.name&&o.has(d.name)&&(r[`equipment_${T}`]="Duplicate item; adjust quantity instead"),d?.name&&o.add(d.name),d?.name&&(isNaN(Number(d.qty))||Number(d.qty)<=0)&&(r[`equipment_${T}`]="Qty must be > 0")}),n.value.start_date&&n.value.end_date&&n.value.start_time&&n.value.end_time){const d=new Date(`${n.value.start_date}T${n.value.start_time}:00`);new Date(`${n.value.end_date}T${n.value.end_time}:00`)<d&&(r.end_time="End must be after or equal to start")}return u.value=r,Object.keys(r).length===0},oe=async()=>{if(!n.value.start_date||!n.value.end_date||!n.value.facilities?.length){await C.fire("Missing fields","Start/End dates and facilities are required.","info");return}try{const r=await j.checkAvailability({start_date:n.value.start_date,start_time:n.value.start_time||"00:00",end_date:n.value.end_date,end_time:n.value.end_time||"00:00",facilities:n.value.facilities}),o=r.available_for_all?"All selected facilities are available.":`Conflicts on: ${(r.conflict_facilities||[]).join(", ")||"—"}`;await C.fire({icon:r.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(r.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${o}</div>
      </div>`})}catch(r){await C.fire("Error",j.error||"Failed to check availability.","error"),console.error(r)}},ee=()=>{if(b.value||!le())return;const r={...n.value};$.user?.id&&(r.filed_by_user_id=$.user.id),A("submit",r)};return(r,o)=>p.value?(f(),y("div",dt,[e("div",ut,[e("div",ct,[e("div",mt,[e("h2",pt,w(I.value),1),e("span",ft,w(n.value.status),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:o[0]||(o[0]=d=>p.value=!1)},"Close")]),b.value?(f(),y("div",vt,[o[10]||(o[10]=M(" This request is ",-1)),e("strong",null,w(n.value.status),1),o[11]||(o[11]=M(". Editing is disabled. ",-1))])):B("",!0),e("div",yt,[e("div",bt,[o[13]||(o[13]=e("label",{class:"block mb-1"},[M("Activity Design "),e("span",{class:"text-red-500"},"*")],-1)),E(e("select",{"onUpdate:modelValue":o[1]||(o[1]=d=>n.value.activity_design_id=d),class:re(["w-full border rounded px-2.5 py-2",u.value.activity_design_id?"border-red-500":""]),disabled:b.value||U(h).isLoading},[o[12]||(o[12]=e("option",{value:""},"Select approved activity design…",-1)),(f(!0),y(Q,null,X(z.value,d=>(f(),y("option",{key:d.id,value:d.id},w(W(d)),9,gt))),128))],10,_t),[[de,n.value.activity_design_id]]),u.value.activity_design_id?(f(),y("p",ht,w(u.value.activity_design_id),1)):B("",!0),U(h).isLoading?(f(),y("p",xt," Loading approved activities… ")):z.value.length?B("",!0):(f(),y("p",wt," No approved activity designs found. Approve an Activity Design first. "))]),e("div",null,[o[14]||(o[14]=e("label",{class:"block mb-1"},[M("Start Date "),e("span",{class:"text-red-500"},"*")],-1)),E(e("input",{"onUpdate:modelValue":o[2]||(o[2]=d=>n.value.start_date=d),type:"date",class:re(["w-full border rounded px-2.5 py-2 bg-gray-50",u.value.start_date?"border-red-500":""]),readonly:!0,disabled:!0},null,2),[[J,n.value.start_date]]),u.value.start_date?(f(),y("p",St,w(u.value.start_date),1)):B("",!0)]),e("div",null,[o[15]||(o[15]=e("label",{class:"block mb-1"},[M("Start Time "),e("span",{class:"text-red-500"},"*")],-1)),E(e("input",{"onUpdate:modelValue":o[3]||(o[3]=d=>n.value.start_time=d),type:"time",class:re(["w-full border rounded px-2.5 py-2",u.value.start_time?"border-red-500":""]),disabled:b.value},null,10,Ct),[[J,n.value.start_time]]),u.value.start_time?(f(),y("p",At,w(u.value.start_time),1)):B("",!0)]),e("div",null,[o[16]||(o[16]=e("label",{class:"block mb-1"},[M("End Date "),e("span",{class:"text-red-500"},"*")],-1)),E(e("input",{"onUpdate:modelValue":o[4]||(o[4]=d=>n.value.end_date=d),type:"date",class:re(["w-full border rounded px-2.5 py-2",u.value.end_date?"border-red-500":""]),disabled:b.value},null,10,$t),[[J,n.value.end_date]]),u.value.end_date?(f(),y("p",kt,w(u.value.end_date),1)):B("",!0)]),e("div",null,[o[17]||(o[17]=e("label",{class:"block mb-1"},[M("End Time "),e("span",{class:"text-red-500"},"*")],-1)),E(e("input",{"onUpdate:modelValue":o[5]||(o[5]=d=>n.value.end_time=d),type:"time",class:re(["w-full border rounded px-2.5 py-2",u.value.end_time?"border-red-500":""]),disabled:b.value},null,10,Tt),[[J,n.value.end_time]]),u.value.end_time?(f(),y("p",Bt,w(u.value.end_time),1)):B("",!0)])]),e("div",Et,[o[19]||(o[19]=e("label",{class:"block mb-1"},[M("Facilities "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Ft,[E(e("select",{"onUpdate:modelValue":o[6]||(o[6]=d=>k.value=d),class:"border rounded px-2.5 py-2",disabled:b.value},[o[18]||(o[18]=e("option",{value:""},"Select facility…",-1)),(f(!0),y(Q,null,X(F.value,d=>(f(),y("option",{key:d,value:d},w(d),9,Rt))),128))],8,Ut),[[de,k.value]]),e("button",{class:"px-3 py-2 bg-gray-200 rounded text-xs",disabled:b.value||!k.value,onClick:L}," Add ",8,Vt)]),u.value.facilities?(f(),y("p",qt,w(u.value.facilities),1)):B("",!0),e("div",Nt,[(f(!0),y(Q,null,X(n.value.facilities,(d,T)=>(f(),y("span",{key:d,class:"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700"},[M(w(d)+" ",1),b.value?B("",!0):(f(),y("button",{key:0,class:"text-slate-500 hover:text-red-600",onClick:i=>H(T)},"×",8,Ot))]))),128)),n.value.facilities?.length?B("",!0):(f(),y("span",Dt,"No facilities selected"))])]),e("div",zt,[e("div",It,[o[20]||(o[20]=e("label",{class:"block mb-1"},"Equipment / Materials (optional)",-1)),e("button",{class:"px-3 py-1 bg-gray-200 rounded text-xs",disabled:b.value||N(-1).length===0,onClick:q}," Add Row ",8,Lt)]),e("div",Pt,[e("table",Yt,[o[21]||(o[21]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"text-left p-2"},"Item"),e("th",{class:"text-left p-2"},"Qty"),e("th",{class:"text-left p-2"},"Unit"),e("th",{class:"p-2 w-16"})])],-1)),e("tbody",null,[(f(!0),y(Q,null,X(n.value.equipment_items,(d,T)=>(f(),y("tr",{key:T,class:"border-t"},[e("td",jt,[E(e("select",{"onUpdate:modelValue":i=>d.name=i,class:"w-full border rounded px-2 py-1",disabled:b.value,onChange:()=>{(d.qty==null||d.qty<=0)&&(d.qty=1)}},[(f(!0),y(Q,null,X(N(T).concat(d.name&&!N(T).includes(d.name)?[d.name]:[]),i=>(f(),y("option",{key:i,value:i},w(i),9,Wt))),128))],40,Mt),[[de,d.name]]),u.value[`equipment_${T}`]?(f(),y("div",Gt,w(u.value[`equipment_${T}`]),1)):B("",!0)]),e("td",Kt,[E(e("input",{"onUpdate:modelValue":i=>d.qty=i,type:"number",min:"1",class:"w-24 border rounded px-2 py-1",disabled:b.value},null,8,Jt),[[J,d.qty,void 0,{number:!0}]])]),e("td",Qt,[E(e("input",{"onUpdate:modelValue":i=>d.unit=i,class:"w-28 border rounded px-2 py-1",disabled:b.value,placeholder:"e.g., pcs"},null,8,Ht),[[J,d.unit]])]),e("td",Xt,[e("button",{class:"px-2 py-1 bg-red-50 text-red-700 rounded",disabled:b.value,onClick:i=>P(T)},"Remove",8,Zt)])]))),128))])])]),o[22]||(o[22]=e("p",{class:"text-[11px] text-gray-500 mt-1"}," Each equipment name must be unique; adjust quantity for multiples. ",-1))]),e("div",ea,[e("div",null,[o[23]||(o[23]=e("label",{class:"block mb-1"},"Utilization Details (duration, purpose, notes)",-1)),E(e("textarea",{"onUpdate:modelValue":o[7]||(o[7]=d=>n.value.utilization_details=d),rows:"4",class:"w-full border rounded px-2.5 py-2",disabled:b.value},null,8,ta),[[J,n.value.utilization_details]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"block mb-1"},"Remarks",-1)),E(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=d=>n.value.remarks=d),rows:"4",class:"w-full border rounded px-2.5 py-2",disabled:b.value},null,8,aa),[[J,n.value.remarks]])])]),e("div",ia,[e("div",la,[o[25]||(o[25]=e("div",{class:"text-sm font-medium"},"Check Availability",-1)),e("button",{class:"px-3 py-1 bg-indigo-600 text-white rounded text-xs",disabled:b.value,onClick:oe}," Run Check ",8,sa)]),o[26]||(o[26]=e("div",{class:"mt-1 text-xs text-gray-500"}," Uses current form values (start/end & facilities) to detect overlaps. ",-1))]),e("div",na,[e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:o[9]||(o[9]=d=>p.value=!1)},"Close"),b.value?B("",!0):(f(),y("button",{key:0,class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:ee},w(Z.value),1))])])])):B("",!0)}},oa={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm"},ra={class:"bg-white p-4 rounded-xl shadow-xl w-[980px] max-h-screen overflow-auto"},da={class:"flex items-center justify-between mb-3"},ua={class:"text-lg font-semibold"},ca={class:"text-gray-600"},ma={class:"flex items-center justify-between gap-2"},pa={class:"text-sm text-gray-600"},fa={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},va=["d"],ya=["disabled"],ba={class:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"},_a={class:"aspect-video bg-white border rounded overflow-hidden flex items-center justify-center"},ga=["src"],ha={key:1,class:"flex items-center justify-center w-full h-full"},xa=["d"],wa={class:"mt-2 text-xs"},Sa=["title"],Ca={class:"text-gray-500 flex items-center justify-between"},Aa={key:0},$a={key:0},ka={class:"mt-2 flex items-center justify-between gap-2"},Ta=["onClick","title"],Ba={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},Ea=["d"],Fa=["onClick"],Ua={style:{width:"16px",height:"16px"},viewBox:"0 0 24 24","aria-hidden":"true"},Ra=["d"],Va={key:0,class:"mt-6 text-center text-sm text-gray-500"},qa=10*1024*1024,Na={__name:"UtilizationAttachmentsModal",props:{modelValue:{type:Boolean,default:!1},row:{type:Object,default:null}},emits:["update:modelValue"],setup(t,{emit:s}){const S=t,m=s,x=Y({get:()=>S.modelValue,set:i=>m("update:modelValue",i)}),A=pe(),p=R(null),$=R(!1),j=new Set(["image/png","image/jpeg","image/webp","application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),h=new Set(["png","jpg","jpeg","webp","pdf","docx","xlsx"]),z=(i="")=>String(i).toLowerCase().match(/\.([a-z0-9]+)$/i)?.[1]||"",n=(i="")=>typeof i=="string"&&i.match(/^data:([^;]+);base64,/i)?.[1]||"",u=i=>{const _=i?.type&&j.has(i.type),g=i?.name&&h.has(z(i.name));return _||g},v=(i="")=>String(i).startsWith("image/"),V=(i="")=>i==="application/pdf",b=(i="")=>i==="application/vnd.openxmlformats-officedocument.wordprocessingml.document",I=(i="")=>i==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",Z=(i="")=>V(i)?ze:b(i)?Ie:I(i)?Le:v(i)?Pe:Ye,W=(i="")=>V(i)?"PDF":b(i)?"Word":I(i)?"Excel":v(i)?"Image":"File",k=(i="")=>V(i)?"pdf":b(i)?"docx":I(i)?"xlsx":i==="image/png"?"png":i==="image/jpeg"?"jpg":i==="image/webp"?"webp":"",F=(i="attachment",_="")=>/\.[a-z0-9]+$/i.test(i)?i:_?`${i}.${_.startsWith(".")?_.slice(1):_}`:i,L=i=>i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(1)} MB`,H=Y(()=>{const i=p.value?.attachments;if(!i)return[];try{return Array.isArray(i)?i:JSON.parse(i||"[]")}catch{return[]}}),q=Y(()=>(H.value||[]).map((i,_)=>{const g=i.mime||n(i.data)||(i.name?z(i.name)==="pdf"&&"application/pdf":"")||"",G=z(i.name||"")||k(g),te=i.size??null,ae=i.name||`${W(g)} ${_+1}`;return{id:i.id??_+1,name:ae,data:i.data||"",url:i.url||i.href||i.path||"",mime:g,ext:G,size:te,filename:F(ae,G)}}));ue(()=>S.modelValue,async i=>{i&&S.row?.id&&(await A.fetchById(S.row.id),p.value=A.selected||S.row)},{immediate:!1});const P=async i=>{const _=i.target.files?.[0];if(i.target.value="",!(!_||!p.value?.id)){if(_.size>qa){await C.fire("File too large","Maximum size is 10 MB.","warning");return}if(!u(_)){await C.fire("Unsupported file","Only images (PNG/JPEG/WEBP), PDF, DOCX, and XLSX are allowed.","warning");return}try{$.value=!0,await A.uploadAttachment(p.value.id,_),await A.fetchById(p.value.id),p.value=A.selected}finally{$.value=!1}}},N=async i=>{!p.value?.id||!(await C.fire({title:"Remove attachment?",icon:"warning",showCancelButton:!0,confirmButtonText:"Remove",confirmButtonColor:"#d33"})).isConfirmed||(await A.deleteAttachment(p.value.id,i),await A.fetchById(p.value.id),p.value=A.selected)},le=i=>{if(i.data&&String(i.data).startsWith("data:")&&v(i.mime)){const _=window.open();_&&_.document.write(`<img src="${i.data}" style="display:block;max-width:100%;height:auto;margin:0 auto;object-fit:contain"/>`);return}i.url&&window.open(String(i.url),"_blank")},oe=i=>{const[_,g]=i.split(","),G=_.match(/data:([^;]+);base64/i)?.[1]||"application/octet-stream",te=atob(g),ae=te.length,ne=new Uint8Array(ae);for(let se=0;se<ae;se++)ne[se]=te.charCodeAt(se);return new Blob([ne],{type:G})},ee=(i,_)=>{const g=URL.createObjectURL(i),G=document.createElement("a");G.href=g,G.download=_||"download",document.body.appendChild(G),G.click(),G.remove(),setTimeout(()=>URL.revokeObjectURL(g),1e3)},r=async i=>{if(i.data&&String(i.data).startsWith("data:")){const _=oe(i.data);ee(_,i.filename);return}if(i.url)try{const g=await(await fetch(i.url,{credentials:"include"})).blob();ee(g,i.filename)}catch{const _=document.createElement("a");_.href=String(i.url),_.setAttribute("download",i.filename),document.body.appendChild(_),_.click(),_.remove()}},o=i=>v(i.mime)?"Open":"Download",d=i=>v(i.mime)?je:Me,T=i=>v(i.mime)?le(i):r(i);return(i,_)=>x.value?(f(),y("div",oa,[e("div",ra,[e("div",da,[e("h2",ua,[_[1]||(_[1]=M(" Utilization Attachments — ",-1)),e("span",ca,w(p.value?.reference_code||""),1)]),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:_[0]||(_[0]=g=>x.value=!1)},"Close")]),e("div",ma,[e("div",pa,[_[2]||(_[2]=M(" Activity: ",-1)),e("strong",null,w(p.value?.activity_design?.name_of_activity||"—"),1)]),e("label",{class:re(["inline-flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-xs cursor-pointer disabled:opacity-60",{"opacity-60 pointer-events-none":$.value}])},[(f(),y("svg",fa,[e("path",{d:U(De)},null,8,va)])),e("span",null,w($.value?"Uploading…":"Upload"),1),e("input",{type:"file",class:"hidden",disabled:$.value,onChange:P,accept:".png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/png,image/jpeg,image/webp"},null,40,ya)],2)]),e("div",ba,[(f(!0),y(Q,null,X(q.value,g=>(f(),y("div",{key:g.id,class:"border rounded-lg p-2 bg-gray-50 flex flex-col"},[e("div",_a,[v(g.mime)&&g.data&&g.data.startsWith("data:")?(f(),y("img",{key:0,src:g.data,class:"object-contain w-full h-full",alt:"Attachment preview"},null,8,ga)):(f(),y("div",ha,[(f(),y("svg",{style:{width:"64px",height:"64px"},viewBox:"0 0 24 24","aria-hidden":"true",class:re({"text-red-600":V(g.mime),"text-blue-600":b(g.mime),"text-emerald-600":I(g.mime),"text-gray-500":!g.mime||!v(g.mime)&&!V(g.mime)})},[e("path",{d:Z(g.mime)},null,8,xa)],2))]))]),e("div",wa,[e("div",{class:"font-medium truncate",title:g.name},w(g.name),9,Sa),e("div",Ca,[e("span",null,[M(w(W(g.mime))+" ",1),g.ext?(f(),y("span",Aa,"("+w(g.ext.toUpperCase())+")",1)):B("",!0)]),g.size?(f(),y("span",$a,w(L(g.size)),1)):B("",!0)])]),e("div",ka,[e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",onClick:G=>T(g),title:o(g)},[(f(),y("svg",Ba,[e("path",{d:d(g)},null,8,Ea)])),M(" "+w(o(g)),1)],8,Ta),e("button",{class:"inline-flex items-center gap-1 px-2 py-1 bg-red-600 text-white rounded text-xs",onClick:G=>N(g.id),title:"Remove"},[(f(),y("svg",Ua,[e("path",{d:U(We)},null,8,Ra)])),_[3]||(_[3]=M(" Remove ",-1))],8,Fa)])]))),128))]),q.value.length?B("",!0):(f(),y("div",Va," No attachments yet. "))])])):B("",!0)}},Oa={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/35 backdrop-blur-sm"},Da={class:"bg-white rounded-2xl shadow-2xl w-[1200px] max-w-[95vw] max-h-[90vh] overflow-hidden"},za={class:"px-4 py-3 border-b flex items-center justify-between"},Ia={class:"p-3 overflow-auto"},La={__name:"CalendarViewModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","open"],setup(t,{emit:s}){const S=t,m=s,x=Y({get:()=>S.modelValue,set:u=>m("update:modelValue",u)}),A=pe(),p=R([]),$=(u,v=[])=>{if(Array.isArray(u))return u;try{return JSON.parse(u||"[]")||v}catch{return v}},j=(u=[])=>{p.value=u.map(v=>{const V=$(v.facilities),b=[];v.activity_design?.name_of_activity&&b.push(v.activity_design.name_of_activity),V.length&&b.push(V.join(", "));const I=b.join(" — ")||v.reference_code||"Utilization",Z=v.start_date&&v.start_time&&`${v.start_date}T${v.start_time}:00`||v.start_at||null,W=v.end_date&&v.end_time&&`${v.end_date}T${v.end_time}:00`||v.end_at||null;return!Z||!W?null:{id:String(v.id),title:I,start:Z,end:W,backgroundColor:"#10b981",borderColor:"#0ea5e9",textColor:"#0b1b13",extendedProps:{reference_code:v.reference_code,facilities:V,availability_status:v.availability_status,status:v.status}}}).filter(Boolean)},h=async()=>{await A.fetchAll({page:1,limit:500,status:"approved",order:"ASC",sort:"start_at"},!0),j(A.items.data||[])},z=u=>{const v=u?.event?.id;v&&m("open",Number(v))},n=Y(()=>({plugins:[st,nt,ot],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},height:"auto",expandRows:!0,navLinks:!0,eventDisplay:"block",eventClick:z,events:p.value}));return ue(()=>S.modelValue,u=>{u&&h()}),ue(()=>A.items.data,u=>{x.value&&j(u||[])},{deep:!0}),be(()=>{x.value&&h()}),(u,v)=>x.value?(f(),y("div",Oa,[e("div",Da,[e("div",za,[v[1]||(v[1]=e("h2",{class:"text-base font-semibold"},"Utilization Calendar (Approved)",-1)),e("button",{class:"px-3 py-1 text-xs bg-gray-200 rounded",onClick:v[0]||(v[0]=V=>x.value=!1)},"Close")]),e("div",Ia,[D(U(rt),{options:n.value},null,8,["options"])]),v[2]||(v[2]=e("div",{class:"px-4 py-2 text-[11px] text-gray-500 border-t"}," Click an event to open it. ",-1))])])):B("",!0)}},Pa="KOLEHIYO NG PANTUKAN",Ya="Juan A. Sarenas Campus, Kingking, Pantukan, Davao de Oro",ja="https://osas.knp.edu.ph/verify-utilization?id=",ye=t=>t?_e(t).format("MMMM DD, YYYY"):"—",Ce=t=>t?_e(t).format("MMM DD, YYYY, h:mm A"):"—",Ae=(t,s=0)=>t==null||t===""||Number.isNaN(Number(t))?"—":Number(t).toLocaleString(void 0,{minimumFractionDigits:s,maximumFractionDigits:s}),$e=(t,s)=>{if(Array.isArray(t))return t;try{return JSON.parse(t||"null")??s}catch{return s}},Be="./",Ma=`${Be}images/logo.png`,Wa=`${Be}images/bg.jpg`;async function ke(t){const S=await(await fetch(t)).blob();return new Promise(m=>{const x=new FileReader;x.onloadend=()=>m(x.result),x.readAsDataURL(S)})}function Ga(t){switch(t){case"APPROVED":return[32,141,85];case"PENDING":return[240,158,47];case"REJECTED":return[220,53,69];case"CANCELLED":return[107,114,128];case"COMPLETED":return[37,99,235];default:return[90,90,90]}}function Ka(t){switch(String(t||"").toUpperCase()){case"AVAILABLE":return[16,185,129];case"RESERVED":return[99,102,241];case"CONFLICT":return[239,68,68];case"MAINTENANCE":return[245,158,11];case"PENDING-CHECK":return[245,158,11];default:return[107,114,128]}}async function Ja(t){const s=t.internal.pageSize.getWidth(),S=110,m=36;try{const x=await ke(Wa);t.addImage(x,"JPEG",0,0,s,S,void 0,"FAST")}catch{t.setFillColor(21,62,121),t.rect(0,0,s,S,"F")}t.setGState(new t.GState({opacity:.18})),t.setFillColor(0,0,0),t.rect(0,0,s,S,"F"),t.setGState(new t.GState({opacity:1}));try{const x=await ke(Ma);t.addImage(x,"PNG",m,20,70,70,void 0,"FAST")}catch{}return t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(20),t.text(Pa,m+86,38),t.setFont("helvetica","normal"),t.setFontSize(10),t.text(Ya,m+86,58),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(14),t.text("UTILIZATION REQUEST",s/2,S+24,{align:"center"}),S+34}async function Qa(t,s,S){const m=t.internal.pageSize.getWidth(),x=36,A=s?.id??s?.reference_code??"",p=`${ja}${encodeURIComponent(String(A))}`,$=await Ne.toDataURL(p,{margin:0,width:75,errorCorrectionLevel:"M",color:{dark:"#000000",light:"#FFFFFF"}}),j=String(s.status||"").toUpperCase(),[h,z,n]=Ga(j),u=String(s.availability_status||"").toUpperCase(),[v,V,b]=Ka(u),I=s.approved_at?ye(s.approved_at):s.date_filed?ye(s.date_filed):"—",Z=`osas.knp.edu.ph/verify-utilization?id=${String(A)}`;return K(t,{startY:S,theme:"plain",styles:{cellPadding:0,fontSize:9},bodyStyles:{minCellHeight:120},margin:{left:x,right:x},tableWidth:m-x*2,body:[[{content:""},{content:""}]],columnStyles:{0:{cellWidth:m-x*2-260},1:{cellWidth:260}},didDrawCell:W=>{if(W.section!=="body")return;const{x:k,y:F,width:L,height:H}=W.cell,q=10;if(W.column.index===0){t.setFillColor(255,255,255),t.roundedRect(k,F,L-1,H,6,6,"F");const P=24,N=Math.min(160,L-22);t.setFillColor(h,z,n),t.roundedRect(k+q,F+q,N,P,12,12,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text(j||"STATUS",k+q+10,F+q+16);const le=F+q+P+10,oe=Math.min(160,L-22);t.setFillColor(v,V,b),t.roundedRect(k+q,le,oe,P,12,12,"F"),t.setTextColor(255,255,255),t.text(u||"AVAILABILITY",k+q+10,le+16),t.setTextColor(20),t.setFont("helvetica","normal"),t.setFontSize(9);let ee=le+P+12;t.text(`Ref No.: ${s.reference_code||"—"}`,k+q,ee),ee+=16,t.text(`Date Issued: ${I}`,k+q,ee),t.setDrawColor(230),t.roundedRect(k,F,L-1,H,6,6,"S")}if(W.column.index===1){t.setFillColor(255,255,255),t.roundedRect(k,F,L-1,H,6,6,"F"),t.setFillColor(66,103,178),t.roundedRect(k,F,L-1,22,6,6,"F"),t.setTextColor(255,255,255),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("VERIFY",k+q,F+15);const P=k+q,N=F+28;t.addImage($,"PNG",P,N,75,75,void 0,"FAST"),t.setTextColor(20),t.setFont("helvetica","bold"),t.setFontSize(10),t.text("Scan to verify",P+100,N+14),t.setFont("helvetica","normal"),t.setFontSize(9),t.text("This document can be verified",P+100,N+32),t.text("online via the OSAS portal.",P+100,N+46),t.setTextColor(110),t.setFontSize(8),t.text(Z,P+100,N+72),t.setDrawColor(230),t.roundedRect(k,F,L-1,H,6,6,"S")}}}),t.lastAutoTable.finalY}async function Ha(t){const s=new qe({unit:"pt",format:[612,936],orientation:"portrait"}),S=s.internal.pageSize.getWidth(),m=36,x=$e(t.facilities,[]),A=$e(t.equipment_items,[]);let p=await Ja(s);p=await Qa(s,t,p)+10,K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"LINKED ACTIVITY",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",halign:"left",valign:"middle",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY;const $=t.activity_design||{};K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"NAME OF ACTIVITY",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.name_of_activity||"—"],[{content:"DATE OF IMPLEMENTATION",styles:{fillColor:[243,248,255],fontStyle:"bold"}},ye($.date_of_implementation)],[{content:"SEMESTER",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.semester||"—"],[{content:"SCHOOL YEAR",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.school_year||"—"],[{content:"OFFICE/DEPARTMENT",styles:{fillColor:[243,248,255],fontStyle:"bold"}},$.office_department||$?.club?.name||"—"]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:m,right:m}}),p=s.lastAutoTable.finalY+10,K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"SCHEDULE",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY;const j=t.start_at||(t.start_date&&t.start_time?`${t.start_date}T${t.start_time}:00`:null),h=t.end_at||(t.end_date&&t.end_time?`${t.end_date}T${t.end_time}:00`:null);K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},body:[[{content:"START",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ce(j)],[{content:"END",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ce(h)],[{content:"DURATION (mins)",styles:{fillColor:[243,248,255],fontStyle:"bold"}},Ae(t.duration_minutes)]],columnStyles:{0:{cellWidth:200,fontStyle:"bold"},1:{cellWidth:"auto"}},margin:{left:m,right:m}}),p=s.lastAutoTable.finalY+10,K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"FACILITIES",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY;const z=Array.isArray(x)&&x.length?"• "+x.join(`
• `):"—";K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[z]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY+10,K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"EQUIPMENT / MATERIALS",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY,Array.isArray(A)&&A.length?K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:6},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["ITEM","QTY","UNIT"]],body:A.map(b=>[b?.name||"—",Ae(b?.qty),b?.unit||"—"]),columnStyles:{0:{cellWidth:300},1:{cellWidth:70},2:{cellWidth:"auto"}},margin:{left:m,right:m}}):K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[["—"]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY+10;const n=[["UTILIZATION DETAILS",t.utilization_details],["REMARKS",t.remarks]];for(const[b,I]of n)K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:b,styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY,K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:8},body:[[I&&String(I).trim()?I:"—"]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY+10;K(s,{startY:p,theme:"plain",styles:{fontSize:10},body:[[{content:"APPROVAL",styles:{fillColor:[66,103,178],textColor:255,fontStyle:"bold",cellPadding:6}}]],margin:{left:m,right:m}}),p=s.lastAutoTable.finalY;const u=t?.filed_by?`${t.filed_by.first_name||""} ${t.filed_by.last_name||""}`.trim():"",v=t?.approver?`${t.approver.first_name||""} ${t.approver.last_name||""}`.trim():"";K(s,{startY:p,theme:"grid",styles:{fontSize:9,cellPadding:10},headStyles:{fillColor:[241,245,249],textColor:20,fontStyle:"bold"},head:[["PREPARED BY:","APPROVED BY:"]],body:[[u||" ",v||" "]],columnStyles:{0:{cellWidth:(S-m*2)/2},1:{cellWidth:"auto"}},didParseCell:b=>{b.section==="body"&&(b.cell.styles.halign="center",b.cell.styles.fontStyle="bold",b.cell.styles.cellPadding={top:16,right:10,bottom:18,left:10})},margin:{left:m,right:m}});const V=s.internal.pageSize.getHeight()-20;s.setFontSize(8),s.setTextColor(120),s.text(`Generated on ${_e().format("YYYY-MM-DD HH:mm")} • ${window.location.origin}`,m,V),s.save(`${t.reference_code||"Utilization_Request"}.pdf`)}const Xa={class:"flex items-center gap-2"},Za={class:"p-3 mb-4 rounded-xl border bg-white/60"},ei={class:"flex items-center gap-2 mb-2 text-gray-700"},ti={class:"w-4 h-4",viewBox:"0 0 24 24"},ai=["d"],ii={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},li={class:"md:col-span-2 flex"},si={class:"w-5 h-5",viewBox:"0 0 24 24"},ni=["d"],oi=["value"],ri=["value"],di={class:"md:col-span-1"},ui={class:"md:col-span-1"},ci={class:"md:col-span-2"},mi=["value"],pi={class:"p-3 mb-4 rounded-xl border bg-white/60"},fi={class:"flex items-center gap-2 mb-2 text-gray-700"},vi={class:"w-4 h-4",viewBox:"0 0 24 24"},yi=["d"],bi={class:"grid grid-cols-1 md:grid-cols-6 gap-2 text-sm"},_i={class:"md:col-span-2"},gi={class:"md:col-span-1"},hi={class:"md:col-span-2"},xi={class:"md:col-span-1"},wi={class:"md:col-span-2"},Si=["value"],Ci={class:"flex flex-wrap gap-1 max-w-[380px]"},Ai={key:0,class:"text-gray-400"},qi={__name:"UtilizationRequestsPage",setup(t){const s=pe(),S=Te(),m=R(!1),x=()=>{m.value=!0},A=async c=>{try{await s.fetchById(c);const a=s.selected;a&&await N(a)}catch(a){console.error(a)}finally{m.value=!1}},p=()=>{te.value="",ae.value="08:00",ne.value="",se.value="10:00",ce.value=[]},$=["EB 101","EB 102","EB 103","NB 104","NB 105","NB Lobby","NB 106","NB 107","NB 201","NB 3SR","OB 108","OB 109","OB 110","OB 111","OB 112","OB 113","OB 114","OB 115","OB 116","OB 117","Gym","AVR","Student Lobby","Activity Center","Library","Ground"],j={range:!0,partialRange:!0,multiCalendars:2,modelType:"yyyy-MM-dd",enableTimePicker:!1,autoApply:!0,clearable:!0},h=R({page:1,limit:10,sort:"created_at",order:"DESC",q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[]}),z=Y({get:()=>{const{start_from:c,start_to:a}=h.value;return c||a?[c||null,a||null]:null},set:c=>{if(!c)h.value.start_from=null,h.value.start_to=null;else{const[a,l]=c;h.value.start_from=a||null,h.value.start_to=l||null}}}),n=Y({get:()=>{const{end_from:c,end_to:a}=h.value;return c||a?[c||null,a||null]:null},set:c=>{if(!c)h.value.end_from=null,h.value.end_to=null;else{const[a,l]=c;h.value.end_from=a||null,h.value.end_to=l||null}}}),u=async(c={},a=!0)=>{h.value={...h.value,...c};const l={...h.value};["q","status","availability_status","start_from","start_to","end_from","end_to"].forEach(O=>{(l[O]===""||l[O]==null)&&delete l[O]}),(!Array.isArray(l.facilities_any)||!l.facilities_any.length)&&delete l.facilities_any,await s.fetchAll(l,a)};be(async()=>{await u({page:1,limit:10})});const v=Y(()=>({total:s.items.total||0,totalPages:s.items.totalPages||1,currentPage:s.items.currentPage||1,pageSize:s.items.pageSize||10,data:s.items.data||[]})),V=["draft","pending","approved","rejected","cancelled","completed"],b=["unknown","pending-check","available","conflict","reserved","maintenance"],I=c=>{switch(String(c||"").toLowerCase()){case"draft":return"gray";case"pending":return"amber";case"approved":return"emerald";case"rejected":return"red";case"cancelled":return"zinc";case"completed":return"blue";default:return"gray"}},Z=c=>{switch(String(c||"").toLowerCase()){case"available":return"emerald";case"reserved":return"indigo";case"conflict":return"red";case"maintenance":return"orange";case"pending-check":return"amber";default:return"gray"}},W=[{key:"reference_code",label:"Ref Code",sortable:!0,width:140},{key:"activity_design",label:"Activity",sortable:!1,minWidth:220,formatter:(c,a)=>a.activity_design?a.activity_design.name_of_activity:""},{key:"facilities",label:"Facilities",sortable:!1,minWidth:260},{key:"start_at",label:"Start",sortable:!0,width:170},{key:"end_at",label:"End",sortable:!0,width:170},{key:"availability_status",label:"Availability",sortable:!0,width:130},{key:"status",label:"Status",sortable:!0,width:120}],k=async c=>{await u(c)},F=R(!1),L=R(!1),H=R(null),q=()=>{F.value=!0},P=async c=>{await s.create(c),F.value=!1,await u({},!0)},N=async c=>{await s.fetchById(c.id);const a=s.selected||c;let l=[],O=[];try{l=Array.isArray(a.facilities)?a.facilities:JSON.parse(a.facilities||"[]")}catch{}try{O=Array.isArray(a.equipment_items)?a.equipment_items:JSON.parse(a.equipment_items||"[]")}catch{}H.value={id:a.id,reference_code:a.reference_code,date_filed:a.date_filed||"",activity_design_id:a.activity_design_id||"",facilities:l,equipment_items:O,utilization_details:a.utilization_details||"",start_date:a.start_date||String(a.start_at||"").slice(0,10),start_time:a.start_time||(a.start_at?new Date(a.start_at).toTimeString().slice(0,5):""),end_date:a.end_date||String(a.end_at||"").slice(0,10),end_time:a.end_time||(a.end_at?new Date(a.end_at).toTimeString().slice(0,5):""),status:a.status||"draft",availability_status:a.availability_status||"pending-check",remarks:a.remarks||""},L.value=!0},le=async c=>{const{id:a,...l}=c;await s.updateById(a,l),L.value=!1,await u({},!0)},oe=async c=>{if(!c?.id)return;(await C.fire({title:`Delete utilization "${c.reference_code}"?`,text:"This cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it",cancelButtonText:"Cancel"})).isConfirmed&&(await s.deleteById(c.id),await u({},!0),await C.fire("Deleted","The utilization request has been deleted.","success"))},ee=async c=>{await N(c)},r=async c=>{if((await C.fire({title:"Submit for approval?",text:"You can no longer edit after submission.",icon:"question",showCancelButton:!0,confirmButtonText:"Submit",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed)try{await s.submit(c.id),await u({},!0),await C.fire("Submitted","Utilization request is now pending approval.","success")}catch{await C.fire("Error",s.error||"Failed to submit request.","error")}},o=async c=>{const a=await C.fire({title:"Approve utilization?",input:"textarea",inputLabel:"Remarks (optional)",inputPlaceholder:"Add a note…",showCancelButton:!0,confirmButtonText:"Approve",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!a.isConfirmed)return;const l=a.value||"";try{await s.approve(c.id,l),await u({},!0),await C.fire("Approved","Utilization has been approved and reserved.","success")}catch{await C.fire("Error",s.error||"Failed to approve request.","error")}},d=async c=>{const a=await C.fire({title:"Reject utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:O=>O?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Reject",cancelButtonText:"Cancel",allowOutsideClick:!1,allowEscapeKey:!1});if(!a.isConfirmed)return;const l=a.value;try{await s.reject(c.id,l),await u({},!0),await C.fire("Rejected","Utilization has been rejected.","success")}catch{await C.fire("Error",s.error||"Failed to reject request.","error")}},T=async c=>{const a=await C.fire({title:"Cancel utilization?",input:"textarea",inputLabel:"Reason (required)",inputPlaceholder:"State the reason…",inputValidator:O=>O?.trim()?void 0:"Reason is required",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Cancel Utilization",cancelButtonText:"Keep",allowOutsideClick:!1,allowEscapeKey:!1});if(!a.isConfirmed)return;const l=a.value;try{await s.cancel(c.id,l),await u({},!0),await C.fire("Cancelled","Utilization has been cancelled.","success")}catch{await C.fire("Error",s.error||"Failed to cancel request.","error")}},i=async c=>{if(String(c?.status||"").toLowerCase()!=="approved"){await C.fire("Not allowed","Only approved utilization request can be printed.","info");return}try{await s.fetchById(c.id);const l=s.selected||c;await Ha(l)}catch(l){await C.fire("Error",s.error||"Failed to generate PDF.","error"),console.error(l)}},_=R(!1),g=R(null),G=async c=>{await s.fetchById(c.id),g.value=s.selected||c,_.value=!0},te=R(""),ae=R("08:00"),ne=R(""),se=R("10:00"),ce=R([]),Ee=async()=>{const c=(ce.value||[]).filter(a=>$.includes(a));if(!te.value||!ne.value||!c.length){await C.fire("Missing fields","Start/End dates and at least one facility are required.","info");return}try{const a=await s.checkAvailability({start_date:te.value,start_time:ae.value||"00:00",end_date:ne.value,end_time:se.value||"00:00",facilities:c}),l=a.available_for_all?"All selected facilities are available.":`Conflicts on: ${(a.conflict_facilities||[]).join(", ")||"—"}`;await C.fire({icon:a.available_for_all?"success":"warning",title:"Availability Result",html:`<div class="text-left text-sm">
        <div><strong>Facilities:</strong> ${(a.facilities||[]).join(", ")}</div>
        <div class="mt-2"><strong>Status:</strong> ${l}</div>
        <div class="mt-2"><strong>Conflicts:</strong> ${Array.isArray(a.conflicts)&&a.conflicts.length?`<ul class="list-disc ml-5">${a.conflicts.map(O=>`<li>${O.reference_code} — ${new Date(O.start_at).toLocaleString()} to ${new Date(O.end_at).toLocaleString()}</li>`).join("")}</ul>`:"None"}</div>
      </div>`})}catch(a){await C.fire("Error",s.error||"Failed to check availability.","error"),console.error(a)}},me=R([]),Fe=async()=>{h.value.facilities_any=(me.value||[]).slice(),await u({page:1})},Ue=async()=>{me.value=[],await u({q:"",status:"",availability_status:"",start_from:"",start_to:"",end_from:"",end_to:"",facilities_any:[],page:1})};return(c,a)=>(f(),y(Q,null,[D(Ge,null,{default:ie(()=>[D(Ke,null,{default:ie(()=>[U(s).error?(f(),ge(tt,{key:0,icon:U(Je),color:"danger"},{default:ie(()=>[M(w(U(s).error),1)]),_:1},8,["icon"])):B("",!0),D(at,{icon:U(Qe),title:"Utilization Requests",main:""},{default:ie(()=>[e("div",Xa,[D(fe,{icon:U(we),color:"info",label:"View Calendar",onClick:x},null,8,["icon"]),D(fe,{icon:U(He),color:"primary",label:"New Request",onClick:q},null,8,["icon"]),D(fe,{icon:U(Xe),color:"info",label:"Refresh",onClick:a[0]||(a[0]=l=>u({},!0))},null,8,["icon"])])]),_:1},8,["icon"]),e("div",Za,[e("div",ei,[(f(),y("svg",ti,[e("path",{d:U(Ze)},null,8,ai)])),a[18]||(a[18]=e("span",{class:"font-medium text-sm"},"Filters",-1))]),e("div",ii,[e("div",li,[E(e("input",{"onUpdate:modelValue":a[1]||(a[1]=l=>h.value.q=l),placeholder:"Search by ref, details, remarks…",class:"border rounded-s px-2 py-2 flex-1",onKeyup:a[2]||(a[2]=Ve(l=>u({page:1}),["enter"]))},null,544),[[J,h.value.q]]),e("button",{class:"px-3 border border-l-0 rounded-e bg-gray-50",title:"Search",onClick:a[3]||(a[3]=l=>u({page:1}))},[(f(),y("svg",si,[e("path",{d:U(et)},null,8,ni)]))])]),E(e("select",{"onUpdate:modelValue":a[4]||(a[4]=l=>h.value.status=l),class:"border rounded px-2 py-2"},[a[19]||(a[19]=e("option",{value:""},"All status",-1)),(f(),y(Q,null,X(V,l=>e("option",{key:l,value:l},w(l),9,oi)),64))],512),[[de,h.value.status]]),E(e("select",{"onUpdate:modelValue":a[5]||(a[5]=l=>h.value.availability_status=l),class:"border rounded px-2 py-2"},[a[20]||(a[20]=e("option",{value:""},"Any availability",-1)),(f(),y(Q,null,X(b,l=>e("option",{key:l,value:l},w(l),9,ri)),64))],512),[[de,h.value.availability_status]]),e("div",di,[D(U(xe),he({modelValue:z.value,"onUpdate:modelValue":a[6]||(a[6]=l=>z.value=l)},j,{placeholder:"Start date range"}),null,16,["modelValue"])]),e("div",ui,[D(U(xe),he({modelValue:n.value,"onUpdate:modelValue":a[7]||(a[7]=l=>n.value=l)},j,{placeholder:"End date range"}),null,16,["modelValue"])]),e("div",ci,[a[21]||(a[21]=e("label",{class:"block text-[11px] text-gray-600 mb-1"},"Facilities (any)",-1)),E(e("select",{"onUpdate:modelValue":a[8]||(a[8]=l=>me.value=l),multiple:"",class:"w-full border rounded px-2 py-2 min-h-[38px]"},[(f(),y(Q,null,X($,l=>e("option",{key:l,value:l},w(l),9,mi)),64))],512),[[de,me.value]])]),e("div",{class:"flex items-center gap-2 md:col-span-2"},[e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded text-xs",onClick:Fe}," Apply Filters "),e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:Ue},"Reset")])])]),e("div",pi,[e("div",fi,[(f(),y("svg",vi,[e("path",{d:U(we)},null,8,yi)])),a[22]||(a[22]=e("span",{class:"font-medium text-sm"},"Quick Availability Check",-1))]),e("div",bi,[e("div",_i,[E(e("input",{"onUpdate:modelValue":a[9]||(a[9]=l=>te.value=l),type:"date",class:"border rounded px-2 py-2 w-full",placeholder:"Start date"},null,512),[[J,te.value]])]),e("div",gi,[E(e("input",{"onUpdate:modelValue":a[10]||(a[10]=l=>ae.value=l),type:"time",class:"border rounded px-2 py-2 w-full",placeholder:"Start time"},null,512),[[J,ae.value]])]),e("div",hi,[E(e("input",{"onUpdate:modelValue":a[11]||(a[11]=l=>ne.value=l),type:"date",class:"border rounded px-2 py-2 w-full",placeholder:"End date"},null,512),[[J,ne.value]])]),e("div",xi,[E(e("input",{"onUpdate:modelValue":a[12]||(a[12]=l=>se.value=l),type:"time",class:"border rounded px-2 py-2 w-full",placeholder:"End time"},null,512),[[J,se.value]])]),e("div",wi,[a[23]||(a[23]=e("label",{class:"block text-[11px] text-gray-600 mb-1"},"Facilities",-1)),E(e("select",{"onUpdate:modelValue":a[13]||(a[13]=l=>ce.value=l),multiple:"",class:"w-full border rounded px-2 py-2 min-h-[38px]"},[(f(),y(Q,null,X($,l=>e("option",{key:l,value:l},w(l),9,Si)),64))],512),[[de,ce.value]])]),e("div",{class:"flex items-center gap-2 md:col-span-2"},[e("button",{class:"px-4 py-2 bg-indigo-600 text-white rounded text-xs",onClick:Ee}," Check "),e("button",{class:"px-4 py-2 bg-gray-200 rounded text-xs",onClick:p}," Reset ")])])]),D(it,{columns:W,data:v.value,loading:U(s).isLoading,onQueryChange:k},{"cell-facilities":ie(({row:l})=>[e("div",Ci,[(f(!0),y(Q,null,X((()=>{try{return Array.isArray(l.facilities)?l.facilities:JSON.parse(l.facilities||"[]")}catch{return[]}})(),(O,Re)=>(f(),ge(ve,{key:Re,text:O,tone:"slate"},null,8,["text"]))),128)),l.facilities&&JSON.parse(l.facilities||"[]").length?B("",!0):(f(),y("span",Ai,"—"))])]),"cell-start_at":ie(({value:l})=>[e("span",null,w(l?new Date(l).toLocaleString():"—"),1)]),"cell-end_at":ie(({value:l})=>[e("span",null,w(l?new Date(l).toLocaleString():"—"),1)]),"cell-availability_status":ie(({value:l})=>[D(ve,{text:l||"—",tone:Z(l)},null,8,["text","tone"])]),"cell-status":ie(({value:l})=>[D(ve,{text:l||"—",tone:I(l)},null,8,["text","tone"])]),"cell-actions":ie(({row:l})=>[D(Oe,{row:l,moderator:["admin","manager"].includes(String(U(S).user?.role||"").toLowerCase()),onAttachments:G,onSubmit:r,onApprove:o,onReject:d,onEdit:N,onDelete:oe,onView:O=>ee(l),onCancel:T,onPrint:i},null,8,["row","moderator","onView"])]),_:1},8,["data","loading"])]),_:1})]),_:1}),D(Se,{modelValue:F.value,"onUpdate:modelValue":a[14]||(a[14]=l=>F.value=l),mode:"create",onSubmit:P},null,8,["modelValue"]),D(Se,{modelValue:L.value,"onUpdate:modelValue":a[15]||(a[15]=l=>L.value=l),mode:"edit",initial:H.value||{},onSubmit:le},null,8,["modelValue","initial"]),D(Na,{modelValue:_.value,"onUpdate:modelValue":a[16]||(a[16]=l=>_.value=l),row:g.value},null,8,["modelValue","row"]),D(La,{modelValue:m.value,"onUpdate:modelValue":a[17]||(a[17]=l=>m.value=l),onOpen:A},null,8,["modelValue"])],64))}};export{qi as default};
